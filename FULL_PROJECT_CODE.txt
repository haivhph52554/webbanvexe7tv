=== PROJECT STRUCTURE ===
backend\controllers\adminController.js
backend\controllers\assistantController.js
backend\controllers\authController.js
backend\controllers\bookingController.js
backend\controllers\feedbackController.js
backend\controllers\paymentController.js
backend\controllers\routeController.js
backend\controllers\ticketController.js
backend\controllers\tripController.js
backend\data\assistants.json
backend\data\assistants_simple.json
backend\db.js
backend\middleware\authMiddleware.js
backend\models\Assistant.js
backend\models\Booking.js
backend\models\Bus.js
backend\models\Checkin.js
backend\models\Contact.js
backend\models\Driver.js
backend\models\Feedback.js
backend\models\Payment.js
backend\models\Review.js
backend\models\Route.js
backend\models\RouteStop.js
backend\models\Ticket.js
backend\models\Trip.js
backend\models\TripSeatStatus.js
backend\models\User.js
backend\package.json
backend\routes\adminRoutes.js
backend\routes\assistantRoutes.js
backend\routes\authRoutes.js
backend\routes\bookingRoutes.js
backend\routes\feedbackRoutes.js
backend\routes\paymentRoutes.js
backend\routes\routeRoutes.js
backend\routes\ticketRoutes.js
backend\routes\tripRoutes.js
backend\routes\userRoutes.js
backend\scripts\migrate_bookings_total.js
backend\seed.js
backend\server.js
backend\utils\mailer.js
backend\utils\send_test_email.js
backend\views\admin\assistants.ejs
backend\views\admin\assistant_detail.ejs
backend\views\admin\assistant_form.ejs
backend\views\admin\bookings.ejs
backend\views\admin\buses.ejs
backend\views\admin\bus_form.ejs
backend\views\admin\dashboard.ejs
backend\views\admin\drivers.ejs
backend\views\admin\driver_detail.ejs
backend\views\admin\driver_form.ejs
backend\views\admin\layout.ejs
backend\views\admin\login.ejs
backend\views\admin\routes.ejs
backend\views\admin\route_form.ejs
backend\views\admin\statistics.ejs
backend\views\admin\trips.ejs
backend\views\admin\trip_form.ejs
backend\views\admin\users.ejs
frontend\index.html
frontend\package.json
frontend\src\App.css
frontend\src\App.tsx
frontend\src\components\AdminPage.tsx
frontend\src\components\BookingDetail.tsx
frontend\src\components\ContactPage.tsx
frontend\src\components\HomePage.tsx
frontend\src\components\LoginPage.tsx
frontend\src\components\MyTicketsPage.tsx
frontend\src\components\PaymentPage.tsx
frontend\src\components\PaymentSuccess.tsx
frontend\src\components\RegisterPage.tsx
frontend\src\components\RoutesPage.tsx
frontend\src\components\TicketDetailPage.tsx
frontend\src\main.tsx
frontend\tsconfig.json
frontend\tsconfig.node.json
frontend\vite.config.ts
scan_project.js

=========================



--- START OF FILE: backend\controllers\adminController.js ---
// ...existing code...
const Trip = require('../models/Trip');
const Booking = require('../models/Booking');
const Route = require('../models/Route');
const Bus = require('../models/Bus');
const User = require('../models/User');
const Assistant = require('../models/Assistant');
const TripSeatStatus = require('../models/TripSeatStatus');
const jwt = require('jsonwebtoken');

// --- Buses CRUD helpers for admin UI --- 12345
exports.newBus = async (req, res) => {
  try {
    res.render('admin/bus_form', { bus: null, page: 'buses', errors: null });
  } catch (err) {
    console.error('Error rendering new bus form:', err);
    res.status(500).send('Lỗi khi tải form tạo xe: ' + err.message);
  }
};

exports.createBus = async (req, res) => {
  try {
    const payload = {
      license_plate: req.body.license_plate,
      bus_type: req.body.bus_type,
      seat_count: Number(req.body.seat_count) || 0,
      active: req.body.active === 'on'
    };
    await Bus.create(payload);
    res.redirect('/admin/buses');
  } catch (err) {
    console.error('Error creating bus:', err);
    res.status(500).send('Lỗi khi tạo xe: ' + err.message);
  }
};

exports.editBus = async (req, res) => {
  try {
    const bus = await Bus.findById(req.params.id);
    if (!bus) return res.status(404).send('Xe không tồn tại');
    res.render('admin/bus_form', { bus, page: 'buses', errors: null });
  } catch (err) {
    console.error('Error rendering edit bus form:', err);
    res.status(500).send('Lỗi khi tải form sửa xe: ' + err.message);
  }
};

exports.updateBus = async (req, res) => {
  try {
    const payload = {
      license_plate: req.body.license_plate,
      bus_type: req.body.bus_type,
      seat_count: Number(req.body.seat_count) || 0,
      active: req.body.active === 'on'
    };
    await Bus.findByIdAndUpdate(req.params.id, payload);
    res.redirect('/admin/buses');
  } catch (err) {
    console.error('Error updating bus:', err);
    res.status(500).send('Lỗi khi cập nhật xe: ' + err.message);
  }
};

// --- Routes CRUD helpers for admin UI ---
exports.newRoute = async (req, res) => {
  try {
    res.render('admin/route_form', { route: null, page: 'routes', errors: null });
  } catch (err) {
    console.error('Error rendering new route form:', err);
    res.status(500).send('Lỗi khi tải form tạo tuyến: ' + err.message);
  }
};

exports.createRouteAdmin = async (req, res) => {
  try {
    const payload = {
      name: req.body.name,
      from_city: req.body.from_city,
      to_city: req.body.to_city,
      total_distance_km: Number(req.body.total_distance_km) || 0,
      estimated_duration_min: Number(req.body.estimated_duration_min) || 0,
      active: req.body.active === 'on'
    };
    await Route.create(payload);
    res.redirect('/admin/routes');
  } catch (err) {
    console.error('Error creating route:', err);
    res.status(500).send('Lỗi khi tạo tuyến: ' + err.message);
  }
};

exports.editRoute = async (req, res) => {
  try {
    const route = await Route.findById(req.params.id);
    if (!route) return res.status(404).send('Tuyến không tồn tại');
    res.render('admin/route_form', { route, page: 'routes', errors: null });
  } catch (err) {
    console.error('Error rendering edit route form:', err);
    res.status(500).send('Lỗi khi tải form sửa tuyến: ' + err.message);
  }
};

exports.updateRoute = async (req, res) => {
  try {
    const payload = {
      name: req.body.name,
      from_city: req.body.from_city,
      to_city: req.body.to_city,
      total_distance_km: Number(req.body.total_distance_km) || 0,
      estimated_duration_min: Number(req.body.estimated_duration_min) || 0,
      active: req.body.active === 'on'
    };
    await Route.findByIdAndUpdate(req.params.id, payload);
    res.redirect('/admin/routes');
  } catch (err) {
    console.error('Error updating route:', err);
    res.status(500).send('Lỗi khi cập nhật tuyến: ' + err.message);
  }
};

exports.adminLoginPage = async (req, res) => {
  try {
    // Bootstrap đảm bảo admin mặc định đúng email/mật khẩu
    const adminEmail = process.env.DEFAULT_ADMIN_EMAIL || 'admin@basevexe.com';
    const adminPassword = process.env.DEFAULT_ADMIN_PASSWORD || '123456';
    let adminUser = await User.findOne({ email: adminEmail });
    if (!adminUser) {
      adminUser = await User.create({
        name: 'Admin Hệ Thống',
        email: adminEmail,
        phone: '0900000000',
        password: adminPassword,
        role: 'admin'
      });
    } else {
      let changed = false;
      if (adminUser.role !== 'admin') { adminUser.role = 'admin'; changed = true; }
      if (!adminUser.password) { adminUser.password = adminPassword; changed = true; }
      if (changed) await adminUser.save();
    }
    res.render('admin/login', { error: null });
  } catch (err) {
    res.status(500).send(err.message);
  }
};

exports.adminLoginPost = async (req, res) => {
  try {
    const { email, password } = req.body;
    if (!email || !password) {
      return res.render('admin/login', { error: 'Vui lòng nhập email và mật khẩu' });
    }
    const defaultEmail = process.env.DEFAULT_ADMIN_EMAIL || 'admin@basevexe.com';
    const defaultPassword = process.env.DEFAULT_ADMIN_PASSWORD || '123456';

    let user = await User.findOne({ email }).select('+password');
    if (!user) {
      // Nếu là email admin mặc định, khởi tạo ngay và cho đăng nhập
      if (email === defaultEmail) {
        user = await User.create({
          name: 'Admin Hệ Thống',
          email: defaultEmail,
          phone: '0900000000',
          password: defaultPassword,
          role: 'admin'
        });
        user = await User.findOne({ email: defaultEmail }).select('+password');
      } else {
        return res.render('admin/login', { error: 'Email hoặc mật khẩu không đúng' });
      }
    }
    const bcrypt = require('bcryptjs');
    let isMatch = await bcrypt.compare(password, user.password);
    if (!isMatch && email === defaultEmail) {
      // Cưỡng chế đặt lại mật khẩu admin mặc định nếu khác
      user.password = defaultPassword;
      user.role = 'admin';
      await user.save();
      user = await User.findOne({ email: defaultEmail }).select('+password');
      isMatch = await bcrypt.compare(password, user.password);
    }
    if (!isMatch) {
      return res.render('admin/login', { error: 'Email hoặc mật khẩu không đúng' });
    }
    const token = jwt.sign({ id: user._id }, process.env.JWT_SECRET || 'secretkey', { expiresIn: '30d' });
    res.cookie('token', token, {
      expires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production'
    });
    if (user.role === 'admin') return res.redirect('/admin');
    if (user.role === 'driver') {
      const Driver = require('../models/Driver');
      const driver = await Driver.findOne({ $or: [{ userId: user._id }, { email: user.email }] });
      if (driver) return res.redirect(`/admin/drivers/${driver._id}`);
      return res.redirect('/admin/drivers');
    }
    if (user.role === 'assistant') {
      const Assistant = require('../models/Assistant');
      const assistant = await Assistant.findOne({ $or: [{ userId: user._id }, { email: user.email }] });
      if (assistant) return res.redirect(`/admin/assistants/${assistant._id}`);
      return res.redirect('/admin/assistants');
    }
    return res.redirect('/admin');
  } catch (err) {
    res.render('admin/login', { error: 'Đã xảy ra lỗi. Vui lòng thử lại.' });
  }
};

exports.adminLogout = async (req, res) => {
  try {
    res.cookie('token', 'none', { expires: new Date(Date.now() + 10 * 1000), httpOnly: true });
    res.redirect('/admin/login');
  } catch (err) {
    res.redirect('/admin/login');
  }
};



// Hiển thị admin dashboard
exports.dashboard = async (req, res) => {
  try {
    const trips = await Trip.find()
      .populate('route')
      .populate('bus')
      .sort({ createdAt: -1 });

    const bookings = await Booking.find()
      .populate('user')
      .populate('trip')
      .sort({ createdAt: -1 });

    const stats = {
      totalTrips: trips.length,
      totalBookings: bookings.length,
      completedBookings: bookings.filter(b => b.status === 'completed').length,
      pendingBookings: bookings.filter(b => b.status === 'pending').length,
      totalRevenue: bookings
        .filter(b => b.status === 'paid' || b.status === 'completed')
        .reduce((sum, b) => sum + (b.total_price || 0), 0)
    };

    res.render('admin/dashboard', {
      trips,
      bookings,
      stats,
      page: 'dashboard'
    });
  } catch (err) {
    console.error('Admin dashboard error:', err);
    res.status(500).send('Lỗi khi tải trang admin: ' + err.message);
  }
};

// API endpoint để xóa booking
exports.deleteBooking = async (req, res) => {
  try {
    const booking = await Booking.findById(req.params.id);
    if (!booking) {
      return res.status(404).json({ error: 'Không tìm thấy đơn đặt chỗ' });
    }

    // Bảo vệ: Không cho phép xóa booking đã thanh toán hoặc đã hoàn thành
    // Bảo vệ: Không cho phép xóa booking đã thanh toán hoặc đã hoàn thành
    if (booking.status === 'paid' || booking.status === 'completed') {
      return res.status(403).json({ 
        error: 'Không thể xóa đơn đặt chỗ đã thanh toán hoặc đã hoàn thành. Vui lòng hủy đơn thay vì xóa.' 
      });
    }

    // Nếu booking đã bị hủy (cancelled) thì cho phép admin xóa, ngay cả khi có record payment.
    // Trong trường hợp này, cố gắng xóa bản ghi Payment liên quan (nếu có) để tránh rác dữ liệu.
    // Nếu booking còn ở trạng thái khác và có payment thì vẫn chặn xóa.
    const Payment = require('../models/Payment');
    if (booking.status !== 'cancelled' && (booking.payment_id || booking.payment)) {
      return res.status(403).json({ 
        error: 'Không thể xóa đơn đặt chỗ đã có thanh toán. Vui lòng hủy đơn thay vì xóa.' 
      });
    }

    if (booking.trip && booking.seat_numbers && booking.seat_numbers.length > 0) {
      const seatStatuses = await TripSeatStatus.find({
        trip: booking.trip,
        seat_number: { $in: booking.seat_numbers }
      });

      await TripSeatStatus.updateMany(
        {
          trip: booking.trip,
          seat_number: { $in: booking.seat_numbers }
        },
        {
          $set: {
            status: 'available',
            booking_id: null
          }
        }
      );

      console.log(`Reset ${seatStatuses.length} seats to available for booking ${booking._id}`);
    }

    // Nếu có payment liên kết và booking đã cancelled, xoá payment record (nếu tồn tại)
    try {
      if (booking.status === 'cancelled' && (booking.payment_id || booking.payment)) {
        const paymentId = booking.payment_id || booking.payment;
        // Xóa document Payment nếu tồn tại
        await Payment.findByIdAndDelete(paymentId).catch(err => {
          console.warn('Không thể xóa payment liên quan:', err.message);
        });
      }
    } catch (err) {
      console.warn('Lỗi khi xóa payment liên quan:', err.message);
    }

    await Booking.findByIdAndDelete(req.params.id);

    res.json({ success: true, message: 'Đã xóa đặt chỗ và cập nhật trạng thái ghế thành công' });
  } catch (err) {
    console.error('Error deleting booking:', err);
    res.status(500).json({ error: 'Lỗi khi xóa đặt chỗ: ' + err.message });
  }
};

// API endpoint để xóa trip
exports.deleteTrip = async (req, res) => {
  try {
    await Trip.findByIdAndDelete(req.params.id);
    res.json({ success: true, message: 'Đã xóa chuyến xe thành công' });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// API endpoint để thay đổi status của booking
exports.updateBookingStatus = async (req, res) => {
  try {
    const { status } = req.body;
    const booking = await Booking.findByIdAndUpdate(
      req.params.id,
      { status },
      { new: true }
    );
    res.json({ success: true, booking });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// Trang Users Management (hỗ trợ lọc ?role=assistant và phân trang)
exports.users = async (req, res) => {
  try {
    const roleFilter = req.query.role; // ?role=assistant
    const pageNum = req.query.page ? Math.max(1, parseInt(req.query.page, 10) || 1) : 1;
    const limit = 50;
    const query = roleFilter ? { role: roleFilter } : {};

    const [users, total] = await Promise.all([
      User.find(query).sort({ createdAt: -1 }).skip((pageNum - 1) * limit).limit(limit).lean(),
      User.countDocuments(query)
    ]);

    const statsAll = await User.find().lean();
    const stats = {
      total: statsAll.length,
      customers: statsAll.filter(u => u.role === 'customer').length,
      drivers: statsAll.filter(u => u.role === 'driver').length,
      assistants: statsAll.filter(u => u.role === 'assistant').length,
      admins: statsAll.filter(u => u.role === 'admin').length
    };

    const totalPages = Math.ceil(total / limit);

    res.render('admin/users', {
      users,
      stats,
      page: 'users',
      roleFilter,
      pagination: {
        page: pageNum,
        totalPages,
        total
      }
    });
  } catch (err) {
    console.error('Error loading users:', err);
    res.status(500).send('Lỗi khi tải trang users: ' + err.message);
  }
};

// --- Assistants Management ---
// Trang Assistants Management
exports.assistants = async (req, res) => {
  try {
    const assistants = await Assistant.find()
      .populate('assigned_routes')
      .populate('assigned_trips')
      .sort({ createdAt: -1 });
    
    const stats = {
      total: assistants.length,
      active: assistants.filter(a => !a.status || a.status === 'active').length,
      withRoutes: assistants.filter(a => a.assigned_routes && a.assigned_routes.length > 0).length,
      withoutRoutes: assistants.filter(a => (!a.assigned_routes || a.assigned_routes.length === 0) && (!a.assigned_trips || a.assigned_trips.length === 0)).length
    };
    
    res.render('admin/assistants', { assistants, stats, page: 'assistants' });
  } catch (err) {
    console.error('Error loading assistants:', err);
    res.status(500).send('Lỗi khi tải trang assistants: ' + err.message);
  }
};

// Form tạo assistant mới
exports.newAssistant = async (req, res) => {
  try {
    const Route = require('../models/Route');
    const routes = await Route.find().sort({ origin: 1 });
    res.render('admin/assistant_form', { assistant: null, routes, page: 'assistants', errors: null });
  } catch (err) {
    console.error('Error rendering new assistant form:', err);
    res.status(500).send('Lỗi khi tải form tạo phụ xe: ' + err.message);
  }
};

// Tạo assistant mới
exports.createAssistant = async (req, res) => {
  try {
    // Tạo User cho phụ xe nếu chưa có
    let assistantUser = null;
    if (req.body.email) {
      assistantUser = await User.findOne({ email: req.body.email });
      if (!assistantUser) {
        assistantUser = await User.create({
          name: req.body.name || 'Phụ xe',
          email: req.body.email,
          phone: req.body.phone || '0900000000',
          password: '123456',
          role: 'assistant'
        });
      } else {
        assistantUser.role = 'assistant';
        await assistantUser.save();
      }
    }

    const payload = {
      name: req.body.name,
      email: req.body.email,
      phone: req.body.phone,
      employee_id: req.body.employee_id,
      license_number: req.body.license_number,
      experience_years: Number(req.body.experience_years) || 0,
      status: 'active',
      assigned_trips: [],
      assigned_routes: [],
      userId: assistantUser ? assistantUser._id : undefined
    };
    
    // Xử lý assigned_routes nếu có
    if (req.body.assigned_routes) {
      const routeIds = Array.isArray(req.body.assigned_routes) 
        ? req.body.assigned_routes 
        : [req.body.assigned_routes];
      payload.assigned_routes = routeIds.filter(id => id);
    }
    
    await Assistant.create(payload);
    res.redirect('/admin/assistants');
  } catch (err) {
    console.error('Error creating assistant:', err);
    res.status(500).send('Lỗi khi tạo phụ xe: ' + err.message);
  }
};

// Form sửa assistant
exports.editAssistant = async (req, res) => {
  try {
    const Route = require('../models/Route');
    const assistant = await Assistant.findById(req.params.id);
    if (!assistant) return res.status(404).send('Phụ xe không tồn tại');
    
    const routes = await Route.find().sort({ origin: 1 });
    res.render('admin/assistant_form', { assistant, routes, page: 'assistants', errors: null });
  } catch (err) {
    console.error('Error rendering edit assistant form:', err);
    res.status(500).send('Lỗi khi tải form sửa phụ xe: ' + err.message);
  }
};

// Cập nhật assistant
exports.updateAssistant = async (req, res) => {
  try {
    const payload = {
      name: req.body.name,
      email: req.body.email,
      phone: req.body.phone,
      employee_id: req.body.employee_id,
      license_number: req.body.license_number,
      experience_years: Number(req.body.experience_years) || 0,
      status: req.body.status || 'active'
    };
    
    // Cập nhật assigned_routes nếu có
    if (req.body.assigned_routes) {
      const routeIds = Array.isArray(req.body.assigned_routes) 
        ? req.body.assigned_routes 
        : [req.body.assigned_routes];
      payload.assigned_routes = routeIds.filter(id => id);
    } else {
      payload.assigned_routes = [];
    }
    
    await Assistant.findByIdAndUpdate(req.params.id, payload);
    res.redirect('/admin/assistants');
  } catch (err) {
    console.error('Error updating assistant:', err);
    res.status(500).send('Lỗi khi cập nhật phụ xe: ' + err.message);
  }
};

// Xóa assistant
exports.deleteAssistant = async (req, res) => {
  try {
    await Assistant.findByIdAndDelete(req.params.id);
    res.json({ success: true, message: 'Đã xóa phụ xe thành công' });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// Xem chi tiết assistant
exports.assistantDetail = async (req, res) => {
  try {
    const Checkin = require('../models/Checkin');
    const Route = require('../models/Route');
    const assistant = await Assistant.findById(req.params.id)
      .populate('assigned_routes')
      .populate({
        path: 'assigned_trips',
        populate: [
          { path: 'route' },
          { path: 'bus' }
        ]
      });
    
    if (!assistant) {
      return res.status(404).send('Phụ xe không tồn tại');
    }
    
    // Lấy lịch sử check-in của assistant này
    const checkins = await Checkin.find({ assistant: assistant._id })
      .populate({
        path: 'booking',
        populate: {
          path: 'trip',
          populate: [
            { path: 'route' },
            { path: 'bus' }
          ]
        }
      })
      .sort({ checkin_time: -1 })
      .limit(50);
    
    // Thống kê
    const totalCheckins = await Checkin.countDocuments({ assistant: assistant._id });
    const checkedInCount = await Checkin.countDocuments({ 
      assistant: assistant._id, 
      status: 'checked_in' 
    });
    const noShowCount = await Checkin.countDocuments({ 
      assistant: assistant._id, 
      status: 'no_show' 
    });
    
    // Lấy danh sách booking từ các route được gán
    const upcomingBookings = [];
    const allBookings = [];
    
    // Lấy tất cả trips từ các routes được gán
    const routeIds = assistant.assigned_routes ? assistant.assigned_routes.map(r => r._id || r) : [];
    
    if (routeIds.length > 0) {
      // Tìm tất cả trips thuộc các routes này
      const trips = await Trip.find({ route: { $in: routeIds } })
        .populate('route')
        .populate('bus');
      
      // Lấy booking từ các trips này
      for (const trip of trips) {
        const bookings = await Booking.find({ 
          trip: trip._id,
          status: { $in: ['paid', 'completed'] }
        })
        .populate('user')
        .populate({
          path: 'trip',
          populate: [
            { path: 'route' },
            { path: 'bus' }
          ]
        })
        .sort({ createdAt: -1 });
        
        // Kiểm tra xem booking đã được check-in chưa
        for (const booking of bookings) {
          const checkin = await Checkin.findOne({ booking: booking._id });
          const bookingInfo = {
            booking,
            trip,
            checkin: checkin || null,
            needsCheckin: !checkin
          };
          
          allBookings.push(bookingInfo);
          
          if (!checkin) {
            upcomingBookings.push(bookingInfo);
          }
        }
      }
    }
    
    // Nếu vẫn còn assigned_trips (tương thích ngược), lấy booking từ đó
    if (assistant.assigned_trips && assistant.assigned_trips.length > 0) {
      for (const trip of assistant.assigned_trips) {
        // Kiểm tra xem trip này đã được xử lý chưa (nếu route đã được gán)
        const tripRouteId = trip.route ? (trip.route._id || trip.route) : null;
        const alreadyProcessed = tripRouteId && routeIds.some(rid => rid.toString() === tripRouteId.toString());
        
        if (!alreadyProcessed) {
          const bookings = await Booking.find({ 
            trip: trip._id,
            status: { $in: ['paid', 'completed'] }
          })
          .populate('user')
          .populate({
            path: 'trip',
            populate: [
              { path: 'route' },
              { path: 'bus' }
            ]
          })
          .sort({ createdAt: -1 });
          
          for (const booking of bookings) {
            const checkin = await Checkin.findOne({ booking: booking._id });
            const bookingInfo = {
              booking,
              trip,
              checkin: checkin || null,
              needsCheckin: !checkin
            };
            
            allBookings.push(bookingInfo);
            
            if (!checkin) {
              upcomingBookings.push(bookingInfo);
            }
          }
        }
      }
    }
    
    const stats = {
      totalCheckins,
      checkedInCount,
      noShowCount,
      checkinRate: totalCheckins > 0 ? ((checkedInCount / totalCheckins) * 100).toFixed(1) : 0,
      assignedRoutesCount: assistant.assigned_routes ? assistant.assigned_routes.length : 0,
      assignedTripsCount: assistant.assigned_trips ? assistant.assigned_trips.length : 0,
      pendingCheckins: upcomingBookings.length,
      totalBookings: allBookings.length
    };
    
    res.render('admin/assistant_detail', { 
      assistant, 
      checkins, 
      stats, 
      upcomingBookings: upcomingBookings.slice(0, 50),
      allBookings: allBookings.slice(0, 100),
      page: 'assistants' 
    });
  } catch (err) {
    console.error('Error loading assistant detail:', err);
    res.status(500).send('Lỗi khi tải chi tiết phụ xe: ' + err.message);
  }
};

// API: Check-in hành khách
exports.checkinPassenger = async (req, res) => {
  try {
    const Checkin = require('../models/Checkin');
    const { bookingId, status } = req.body; // status: 'checked_in' hoặc 'no_show'
    const assistantId = req.params.id;
    
    if (!bookingId || !status) {
      return res.status(400).json({ 
        success: false,
        message: 'Thiếu bookingId hoặc status' 
      });
    }
    
    if (!['checked_in', 'no_show'].includes(status)) {
      return res.status(400).json({ 
        success: false,
        message: 'Status không hợp lệ' 
      });
    }
    
    // Kiểm tra assistant tồn tại
    const assistant = await Assistant.findById(assistantId);
    if (!assistant) {
      return res.status(404).json({ 
        success: false,
        message: 'Phụ xe không tồn tại' 
      });
    }
    
    // Kiểm tra booking tồn tại
    const booking = await Booking.findById(bookingId);
    if (!booking) {
      return res.status(404).json({ 
        success: false,
        message: 'Booking không tồn tại' 
      });
    }
    
    // Kiểm tra xem đã check-in chưa
    const existingCheckin = await Checkin.findOne({ booking: bookingId });
    
    if (existingCheckin) {
      // Cập nhật check-in hiện có
      existingCheckin.status = status;
      existingCheckin.checkin_time = new Date();
      existingCheckin.assistant = assistantId;
      await existingCheckin.save();
    } else {
      // Tạo check-in mới
      await Checkin.create({
        booking: bookingId,
        assistant: assistantId,
        checkin_time: new Date(),
        status: status
      });
    }
    
    res.json({ 
      success: true, 
      message: status === 'checked_in' ? 'Đã đánh dấu hành khách đã lên xe' : 'Đã đánh dấu hành khách không đến'
    });
  } catch (err) {
    console.error('Error checking in passenger:', err);
    res.status(500).json({ 
      success: false,
      message: 'Lỗi khi check-in: ' + err.message 
    });
  }
};

// Trang Buses Management
exports.buses = async (req, res) => {
  try {
    const buses = await Bus.find().sort({ createdAt: -1 });
    const stats = {
      total: buses.length,
      active: buses.filter(b => b.active).length,
      inactive: buses.filter(b => !b.active).length
    };
    res.render('admin/buses', { buses, stats, page: 'buses' });
  } catch (err) {
    console.error('Error loading buses:', err);
    res.status(500).send('Lỗi khi tải trang buses: ' + err.message);
  }
};

// Trang Routes Management
exports.routes = async (req, res) => {
  try {
    const RouteStop = require('../models/RouteStop');
    const routes = await Route.find().sort({ createdAt: -1 });
    
    for (let route of routes) {
      route.stops = await RouteStop.find({ route: route._id }).sort({ order: 1 });
    }
    
    const stats = {
      total: routes.length,
      active: routes.filter(r => r.active).length,
      inactive: routes.filter(r => !r.active).length
    };
    
    res.render('admin/routes', { routes, stats, page: 'routes' });
  } catch (err) {
    console.error('Error loading routes:', err);
    res.status(500).send('Lỗi khi tải trang routes: ' + err.message);
  }
};

// Trang Trips Management
exports.trips = async (req, res) => {
  try {
    const trips = await Trip.find()
      .populate('route')
      .populate('bus')
      .sort({ createdAt: -1 });
    
    const recurringTrips = trips.filter(t => t.is_recurring);
    const singleTrips = trips.filter(t => !t.is_recurring);

    const stats = {
      total: trips.length,
      scheduled: trips.filter(t => t.status === 'scheduled').length,
      departed: trips.filter(t => t.status === 'departed').length,
      completed: trips.filter(t => t.status === 'completed').length,
      recurring: recurringTrips.length,
      nonRecurring: singleTrips.length
    };
    
    res.render('admin/trips', { trips, recurringTrips, singleTrips, stats, page: 'trips' });
  } catch (err) {
    console.error('Error loading trips:', err);
    res.status(500).send('Lỗi khi tải trang trips: ' + err.message);
  }
};

// Trang Bookings Management
exports.bookings = async (req, res) => {
  try {
    const bookings = await Booking.find()
      .populate('user')
      .populate('trip')
      .sort({ createdAt: -1 });
    
    const stats = {
      total: bookings.length,
      pending: bookings.filter(b => b.status === 'pending').length,
      paid: bookings.filter(b => b.status === 'paid').length,
      completed: bookings.filter(b => b.status === 'completed').length,
      cancelled: bookings.filter(b => b.status === 'cancelled').length,
      totalRevenue: bookings
        .filter(b => b.status === 'paid' || b.status === 'completed')
        .reduce((sum, b) => sum + (b.total_price || 0), 0)
    };
    
    res.render('admin/bookings', { bookings, stats, page: 'bookings' });
  } catch (err) {
    console.error('Error loading bookings:', err);
    res.status(500).send('Lỗi khi tải trang bookings: ' + err.message);
  }
};

// Trang Statistics
exports.statistics = async (req, res) => {
  try {
    const users = await User.find();
    const trips = await Trip.find().populate('route').populate('bus');
    const bookings = await Booking.find().populate('user').populate('trip');
    const buses = await Bus.find();
    const routes = await Route.find();
    
    const stats = {
      users: {
        total: users.length,
        byRole: {
          customer: users.filter(u => u.role === 'customer').length,
          driver: users.filter(u => u.role === 'driver').length,
          assistant: users.filter(u => u.role === 'assistant').length,
          admin: users.filter(u => u.role === 'admin').length
        }
      },
      buses: {
        total: buses.length,
        active: buses.filter(b => b.active).length
      },
      routes: {
        total: routes.length,
        active: routes.filter(r => r.active).length
      },
      trips: {
        total: trips.length,
        byStatus: {
          scheduled: trips.filter(t => t.status === 'scheduled').length,
          departed: trips.filter(t => t.status === 'departed').length,
          completed: trips.filter(t => t.status === 'completed').length,
          cancelled: trips.filter(t => t.status === 'cancelled').length
        }
      },
      bookings: {
        total: bookings.length,
        byStatus: {
          pending: bookings.filter(b => b.status === 'pending').length,
          paid: bookings.filter(b => b.status === 'paid').length,
          completed: bookings.filter(b => b.status === 'completed').length,
          cancelled: bookings.filter(b => b.status === 'cancelled').length
        },
        revenue: bookings
          .filter(b => b.status === 'paid' || b.status === 'completed')
          .reduce((sum, b) => sum + (b.total_price || 0), 0)
      }
    };
    
    res.render('admin/statistics', { stats, page: 'statistics' });
  } catch (err) {
    console.error('Error loading statistics:', err);
    res.status(500).send('Lỗi khi tải trang statistics: ' + err.message);
  }
};

// API endpoints để xóa
exports.deleteUser = async (req, res) => {
  try {
    await User.findByIdAndDelete(req.params.id);
    res.json({ success: true, message: 'Đã xóa user thành công' });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

exports.deleteBus = async (req, res) => {
  try {
    await Bus.findByIdAndDelete(req.params.id);
    res.json({ success: true, message: 'Đã xóa xe buýt thành công' });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

exports.deleteRoute = async (req, res) => {
  try {
    await Route.findByIdAndDelete(req.params.id);
    res.json({ success: true, message: 'Đã xóa tuyến đường thành công' });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// --- Trips CRUD helpers for admin UI ---
exports.newTrip = async (req, res) => {
  try {
    const routes = await Route.find().sort({ createdAt: -1 });
    const buses = await Bus.find().sort({ createdAt: -1 });
    res.render('admin/trip_form', { trip: null, routes, buses, page: 'trips', errors: null });
  } catch (err) {
    console.error('Error rendering new trip form:', err);
    res.status(500).send('Lỗi khi tải form tạo chuyến: ' + err.message);
  }
};

exports.createTrip = async (req, res) => {
  try {
    const payload = {
      route: req.body.route,
      bus: req.body.bus,
      start_time: req.body.start_time ? new Date(req.body.start_time) : null,
      end_time: req.body.end_time ? new Date(req.body.end_time) : null,
      base_price: Number(req.body.base_price) || 0,
      direction: req.body.direction || 'go',
      status: req.body.status || 'scheduled'
    };

    const trip = await Trip.create(payload);

    const bus = await Bus.findById(trip.bus);
    const seatCount = bus?.seat_count || 0;
    const seatDocs = [];
    for (let i = 1; i <= seatCount; i++) {
      seatDocs.push({ trip: trip._id, seat_number: String(i), status: 'available' });
    }
    if (seatDocs.length) await TripSeatStatus.insertMany(seatDocs);

    res.redirect('/admin/trips');
  } catch (err) {
    console.error('Error creating trip:', err);
    res.status(500).send('Lỗi khi tạo chuyến: ' + err.message);
  }
};

exports.editTrip = async (req, res) => {
  try {
    const trip = await Trip.findById(req.params.id);
    if (!trip) return res.status(404).send('Chuyến không tồn tại');
    const routes = await Route.find().sort({ createdAt: -1 });
    const buses = await Bus.find().sort({ createdAt: -1 });
    res.render('admin/trip_form', { trip, routes, buses, page: 'trips', errors: null });
  } catch (err) {
    console.error('Error rendering edit trip form:', err);
    res.status(500).send('Lỗi khi tải form sửa chuyến: ' + err.message);
  }
};

exports.updateTrip = async (req, res) => {
  try {
    const payload = {
      route: req.body.route,
      bus: req.body.bus,
      start_time: req.body.start_time ? new Date(req.body.start_time) : null,
      end_time: req.body.end_time ? new Date(req.body.end_time) : null,
      base_price: Number(req.body.base_price) || 0,
      direction: req.body.direction || 'go',
      status: req.body.status || 'scheduled'
    };

    await Trip.findByIdAndUpdate(req.params.id, payload);
    res.redirect('/admin/trips');
  } catch (err) {
    console.error('Error updating trip:', err);
    res.status(500).send('Lỗi khi cập nhật chuyến: ' + err.message);
  }
};

exports.createRecurringTrips = async (req, res) => {
  try {
    const routeId = req.body.route;
    const busId = req.body.bus;
    const basePrice = Number(req.body.base_price) || 0;
    const direction = req.body.direction || 'go';
    const frequency = req.body.frequency || 'daily';
    const daysOfWeek = req.body.days_of_week;
    const timeOfDay = req.body.time_of_day;
    const startDateStr = req.body.start_date;
    const endDateStr = req.body.end_date;

    const today = new Date();
    const startDate = startDateStr ? new Date(startDateStr) : new Date(today);
    startDate.setHours(0, 0, 0, 0);
    let endDate = endDateStr ? new Date(endDateStr) : new Date(startDate);
    if (!endDateStr) {
      endDate.setDate(endDate.getDate() + 180);
    }
    endDate.setHours(23, 59, 59, 999);

    let hours = 8;
    let minutes = 0;
    if (timeOfDay && typeof timeOfDay === 'string') {
      const parts = timeOfDay.split(':');
      hours = parseInt(parts[0], 10) || 8;
      minutes = parseInt(parts[1], 10) || 0;
    }

    const route = await Route.findById(routeId);
    const bus = await Bus.findById(busId);
    if (!route || !bus) {
      return res.status(400).send('Route hoặc Bus không hợp lệ');
    }

    const durationMin = Number(route.estimated_duration_min) || null;

    const dows = Array.isArray(daysOfWeek)
      ? daysOfWeek.map(x => parseInt(x, 10))
      : (typeof daysOfWeek === 'string' ? [parseInt(daysOfWeek, 10)] : []);
    const isWeekly = frequency === 'weekly' && dows.length > 0;

    let created = 0;
    let skipped = 0;

    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      const dow = d.getDay();
      if (frequency === 'daily' || (isWeekly && dows.includes(dow))) {
        const start = new Date(d);
        start.setHours(hours, minutes, 0, 0);

        const existed = await Trip.findOne({ route: routeId, bus: busId, start_time: start });
        if (existed) { skipped++; continue; }

        const payload = {
          route: routeId,
          bus: busId,
          start_time: start,
          end_time: durationMin ? new Date(start.getTime() + durationMin * 60000) : null,
          base_price: basePrice,
          direction,
          status: 'scheduled',
          is_recurring: true
        };

        const trip = await Trip.create(payload);

        const seatDocs = [];
        const seatCount = bus.seat_count || 0;
        for (let i = 1; i <= seatCount; i++) {
          seatDocs.push({ trip: trip._id, seat_number: String(i), status: 'available' });
        }
        if (seatDocs.length) await TripSeatStatus.insertMany(seatDocs);

        created++;
      }
    }

    res.redirect('/admin/trips');
  } catch (err) {
    console.error('Error creating recurring trips:', err);
    res.status(500).send('Lỗi khi tạo chuyến cố định: ' + err.message);
  }
};

const Driver = require('../models/Driver'); // Nhớ import model

// 1. Hiển thị danh sách tài xế
exports.drivers = async (req, res) => {
  try {
    const drivers = await Driver.find().sort({ createdAt: -1 });
    // Thống kê nhanh
    const stats = {
      total: drivers.length,
      active: drivers.filter(d => d.status === 'active').length
    };
    res.render('admin/drivers', { drivers, stats, page: 'drivers' });
  } catch (err) {
    res.status(500).send(err.message);
  }
};

// 2. Form thêm tài xế mới
exports.newDriver = async (req, res) => {
  try {
    // Lấy danh sách các chuyến "Sắp chạy" để admin có thể gán luôn lúc tạo (nếu muốn)
    const trips = await Trip.find({ status: 'scheduled' })
        .populate('route').populate('bus');
    
    res.render('admin/driver_form', { driver: null, trips, page: 'drivers' });
  } catch (err) {
    res.status(500).send(err.message);
  }
};

// 3. Xử lý tạo tài xế (Lưu vào DB)
exports.createDriver = async (req, res) => {
  try {
    // A. Tạo tài khoản User trước (để có thể đăng nhập)
    let user = await User.findOne({ email: req.body.email });
    if (!user) {
        user = await User.create({
            name: req.body.name,
            email: req.body.email,
            phone: req.body.phone,
            password: '123456', // Mật khẩu mặc định
            role: 'driver'      // Role là driver
        });
    } else {
        // Nếu email đã tồn tại, cập nhật role
        user.role = 'driver';
        await user.save();
    }

    // B. Tạo hồ sơ Driver
    const payload = {
        userId: user._id,
        name: req.body.name,
        email: req.body.email,
        phone: req.body.phone,
        license_number: req.body.license_number,
        experience_years: req.body.experience_years,
        employee_id: req.body.employee_id,
        status: 'active',
        assigned_trips: req.body.assigned_trips || [] // Lưu các chuyến được gán
    };

    await Driver.create(payload);
    res.redirect('/admin/drivers');

  } catch (err) {
    console.error(err);
    res.status(500).send('Lỗi tạo tài xế: ' + err.message);
  }
};

// 4. Form sửa tài xế
exports.editDriver = async (req, res) => {
  try {
    const driver = await Driver.findById(req.params.id);
    const trips = await Trip.find({ status: 'scheduled' }).populate('route').populate('bus');
    res.render('admin/driver_form', { driver, trips, page: 'drivers' });
  } catch (err) {
    res.status(500).send(err.message);
  }
};

// 5. Cập nhật tài xế
exports.updateDriver = async (req, res) => {
  try {
    const payload = {
        name: req.body.name,
        email: req.body.email,
        phone: req.body.phone,
        license_number: req.body.license_number,
        experience_years: req.body.experience_years,
        employee_id: req.body.employee_id,
        status: req.body.status,
        assigned_trips: req.body.assigned_trips || []
    };
    await Driver.findByIdAndUpdate(req.params.id, payload);
    res.redirect('/admin/drivers');
  } catch (err) {
    res.status(500).send(err.message);
  }
};

// 6. Xóa tài xế
exports.deleteDriver = async (req, res) => {
  try {
    await Driver.findByIdAndDelete(req.params.id);
    res.json({ success: true });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// 7. XEM CHI TIẾT TÀI XẾ (Chức năng quan trọng bạn yêu cầu)
// Xem tài xế gán chuyến nào, trạng thái ra sao
exports.driverDetail = async (req, res) => {
  try {
    const driver = await Driver.findById(req.params.id);
    if (!driver) return res.status(404).send('Không tìm thấy');

    // Tìm các chuyến xe nằm trong danh sách assigned_trips của tài xế
    // Populate đầy đủ để hiển thị tên tuyến, biển số, trạng thái
    const trips = await Trip.find({ _id: { $in: driver.assigned_trips } })
        .populate('route')
        .populate('bus')
        .sort({ start_time: -1 }); // Mới nhất lên đầu

    // Thống kê nhanh trạng thái chuyến
    const stats = {
        total: trips.length,
        scheduled: trips.filter(t => t.status === 'scheduled').length, // Sắp chạy
        departed: trips.filter(t => t.status === 'departed').length,   // Đang chạy
        completed: trips.filter(t => t.status === 'completed').length  // Đã xong
    };

    res.render('admin/driver_detail', { driver, trips, stats, page: 'drivers' });
  } catch (err) {
    res.status(500).send(err.message);
  }
};

--- END OF FILE: backend\controllers\adminController.js ---


--- START OF FILE: backend\controllers\assistantController.js ---
const Assistant = require('../models/Assistant');
const Ticket = require('../models/Ticket');
const Checkin = require('../models/Checkin');
const Trip = require('../models/Trip');
const TripSeatStatus = require('../models/TripSeatStatus');

exports.getAssistantInfo = async (req, res) => {
  try {
    const assistant = await Assistant.findOne({ userId: req.user.id })
      .populate('userId', 'name phone email role')
      .populate('busId')
      .populate('currentTrip');

    if (!assistant) return res.status(404).json({ message: 'Không tìm thấy lơ xe' });
    res.json(assistant);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

exports.getPassengerList = async (req, res) => {
  try {
    const assistant = await Assistant.findOne({ userId: req.user.id });
    if (!assistant || !assistant.currentTrip) {
      return res.status(400).json({ message: 'Không có chuyến hiện tại' });
    }

    const tickets = await Ticket.find({ tripId: assistant.currentTrip })
      .populate('userId', 'name phone email')
      .populate('seatId');

    res.json(tickets);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

exports.checkInPassenger = async (req, res) => {
  try {
    const { ticketId } = req.body;
    if (!ticketId) return res.status(400).json({ message: 'ticketId là bắt buộc' });

    const assistant = await Assistant.findOne({ userId: req.user.id });
    if (!assistant) return res.status(404).json({ message: 'Không tìm thấy lơ xe' });

    const ticket = await Ticket.findById(ticketId);
    if (!ticket) return res.status(404).json({ message: 'Không tìm thấy vé' });

    // Kiểm tra vé thuộc chuyến hiện tại
    if (assistant.currentTrip && ticket.tripId.toString() !== assistant.currentTrip.toString()) {
      return res.status(400).json({ message: 'Vé không thuộc chuyến hiện tại' });
    }

    // Tạo bản ghi checkin
    const checkin = new Checkin({
      ticketId: ticket._id,
      assistantId: assistant._id,
      checkedInTime: new Date(),
      status: 'checked_in'
    });
    await checkin.save();

    // Cập nhật vé và danh sách checkIn của assistant
    ticket.status = 'checked_in';
    await ticket.save();

    assistant.checkInList.push({
      passengerId: ticket.userId,
      ticketId: ticket._id,
      checkedIn: true,
      checkedInTime: new Date()
    });
    await assistant.save();

    res.json({ message: 'Check-in thành công', checkin });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

exports.reportSeatIssue = async (req, res) => {
  try {
    const { seatStatusId, issue } = req.body;
    if (!seatStatusId || !issue) return res.status(400).json({ message: 'seatStatusId và issue là bắt buộc' });

    const assistant = await Assistant.findOne({ userId: req.user.id });
    if (!assistant) return res.status(404).json({ message: 'Không tìm thấy lơ xe' });

    const updated = await TripSeatStatus.findByIdAndUpdate(
      seatStatusId,
      { status: 'broken', issue },
      { new: true }
    );

    if (!updated) return res.status(404).json({ message: 'Không tìm thấy trạng thái ghế' });
    res.json({ message: 'Báo cáo sự cố thành công', seat: updated });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

exports.endTrip = async (req, res) => {
  try {
    const { tripId, notes } = req.body;
    if (!tripId) return res.status(400).json({ message: 'tripId là bắt buộc' });

    const assistant = await Assistant.findOne({ userId: req.user.id });
    if (!assistant) return res.status(404).json({ message: 'Không tìm thấy lơ xe' });

    const trip = await Trip.findByIdAndUpdate(tripId, { status: 'completed', assistantNotes: notes }, { new: true });
    if (!trip) return res.status(404).json({ message: 'Không tìm thấy chuyến' });

    assistant.currentTrip = null;
    assistant.status = 'available';
    assistant.totalTrips = (assistant.totalTrips || 0) + 1;
    await assistant.save();

    res.json({ message: 'Kết thúc chuyến thành công', trip });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

exports.updateRating = async (req, res) => {
  try {
    const { rating } = req.body;
    if (typeof rating !== 'number') return res.status(400).json({ message: 'rating phải là số' });

    const assistant = await Assistant.findOne({ userId: req.user.id });
    if (!assistant) return res.status(404).json({ message: 'Không tìm thấy lơ xe' });

    // Cập nhật trung bình đơn giản
    assistant.rating = (assistant.rating + rating) / 2;
    await assistant.save();

    res.json({ message: 'Cập nhật đánh giá thành công', assistant });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};
--- END OF FILE: backend\controllers\assistantController.js ---


--- START OF FILE: backend\controllers\authController.js ---
const User = require("../models/User");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");

// Generate JWT Token
const generateToken = (id) => {
  return jwt.sign({ id }, process.env.JWT_SECRET || "secretkey", {
    expiresIn: '30d',
  });
};

// Set token cookie
const sendTokenResponse = (user, statusCode, res) => {
  const token = generateToken(user._id);

  const options = {
    expires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
  };

  // Remove password from response
  const userResponse = { ...user._doc };
  delete userResponse.password;

  res
    .status(statusCode)
    .cookie('token', token, options)
    .json({
      success: true,
      token,
      user: userResponse,
    });
};

// @desc    Register user
// @route   POST /api/auth/register
exports.register = async (req, res) => {
  try {
    const { name, email, phone, password } = req.body;

    // Check if email exists
    const existingUser = await User.findOne({ email });
    if (existingUser) {
      return res.status(400).json({ message: "Email đã được sử dụng" });
    }

    // Create user
    const user = await User.create({
      name,
      email,
      phone,
      password,  // Password will be hashed via mongoose pre-save middleware
      role: 'user'
    });

    sendTokenResponse(user, 201, res);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

// @desc    Login user
// @route   POST /api/auth/login
exports.login = async (req, res) => {
  try {
    const { email, password } = req.body;

    // Validate email & password
    if (!email || !password) {
      return res.status(400).json({ message: 'Vui lòng nhập email và mật khẩu' });
    }

    // Check for user
    const user = await User.findOne({ email }).select('+password');
    if (!user) {
      return res.status(401).json({ message: 'Email hoặc mật khẩu không đúng' });
    }

    // Check password
    const isMatch = await bcrypt.compare(password, user.password);
    if (!isMatch) {
      return res.status(401).json({ message: 'Email hoặc mật khẩu không đúng' });
    }

    sendTokenResponse(user, 200, res);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

// @desc    Logout user / clear cookie
// @route   GET /api/auth/logout
exports.logout = async (req, res) => {
  res.cookie('token', 'none', {
    expires: new Date(Date.now() + 10 * 1000),
    httpOnly: true,
  });

  res.status(200).json({
    success: true,
    message: 'Đã đăng xuất'
  });
};

// @desc    Get current logged in user
// @route   GET /api/auth/me
exports.getMe = async (req, res) => {
  try {
    const user = await User.findById(req.user.id);
    res.status(200).json({
      success: true,
      data: user,
    });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

--- END OF FILE: backend\controllers\authController.js ---


--- START OF FILE: backend\controllers\bookingController.js ---
// controllers/bookingController.js
const mongoose = require('mongoose');
const Booking = require('../models/Booking');
const Payment = require('../models/Payment');
const Trip = require('../models/Trip');
const TripSeatStatus = require('../models/TripSeatStatus');
const RouteStop = require('../models/RouteStop');
const { sendBookingConfirmationEmail } = require('../utils/mailer');

const normalizeToNumber = (v) => {
  const num = parseInt(String(v).replace(/\D/g, ''), 10);
  return Number.isNaN(num) ? null : num;
};

exports.checkout = async (req, res) => {
  const session = await mongoose.startSession();
  try {
    const { tripId, seatNumbers, passenger, paymentMethod, amount, stops } = req.body;

    if (!tripId || !Array.isArray(seatNumbers) || seatNumbers.length === 0) {
      return res.status(400).json({ error: 'Thiếu tripId hoặc seatNumbers' });
    }

    const runFlow = async (maybeSession) => {
      const s = (query) => (maybeSession ? query.session(maybeSession) : query);
      const wopt = maybeSession ? { session: maybeSession } : {};

      // 1) Lấy trip + tham chiếu bus/route
      const trip = await s(
        Trip.findById(tripId)
          .populate('route')
          .populate('bus')
      );
      if (!trip) throw new Error('Trip không tồn tại');

      const seatCount = trip.bus?.seat_count || 0;
      if (!seatCount) throw new Error('Chuyến chưa có seat_count của bus');

      // 2) Chuẩn hoá danh sách ghế người dùng chọn (dưới dạng số)
      const requestedNums = (seatNumbers || [])
        .map(normalizeToNumber)
        .filter((n) => n != null);
      if (!requestedNums.length) throw new Error('Thiếu seatNumbers');

      // 3) Lấy ghế hiện có của trip
      let allSeatDocs = await s(TripSeatStatus.find({ trip: trip._id }));

      // 3a) Nếu CHƯA có ghế nào => seed toàn bộ 1..seat_count
      if (allSeatDocs.length === 0) {
        const seedDocs = [];
        for (let i = 1; i <= seatCount; i++) {
          seedDocs.push({
            trip: trip._id,
            seat_number: String(i), // "1","2",...
            status: 'available',
            booking_id: null
          });
        }
        await TripSeatStatus.insertMany(seedDocs, wopt);
        allSeatDocs = await s(TripSeatStatus.find({ trip: trip._id }));
      }

      // 3b) Map số ghế -> doc
      const seatByNum = new Map();
      // num -> doc
      for (const s of allSeatDocs) {
        const n = normalizeToNumber(s.seat_number);
        if (n != null && !seatByNum.has(n)) seatByNum.set(n, s);
      }

      // 3c) Nếu thiếu doc cho các ghế người dùng chọn => seed bổ sung (miễn là trong 1..seat_count)
      const missingNums = requestedNums.filter((n) => !seatByNum.has(n));
      if (missingNums.length) {
        const invalid = missingNums.filter((n) => n < 1 || n > seatCount);
        if (invalid.length) throw new Error('Số ghế vượt quá seat_count của xe');
        const addDocs = missingNums.map((n) => ({
          trip: trip._id,
          seat_number: String(n),
          status: 'available',
          booking_id: null
        }));
        await TripSeatStatus.insertMany(addDocs, wopt);

        // nạp bổ sung vào map
        const fresh = await s(TripSeatStatus.find({
          trip: trip._id,
          seat_number: { $in: missingNums.map(String) }
        }));
        for (const s of fresh) {
          const n = normalizeToNumber(s.seat_number);
          if (n != null) seatByNum.set(n, s);
        }
      }

      // 4) Lấy doc thật để đặt
      const willBookDocs = requestedNums.map((n) => seatByNum.get(n));
      if (willBookDocs.some((d) => !d)) throw new Error('Một số ghế không tồn tại trong chuyến');

      // 5) Kiểm tra trạng thái available
      if (willBookDocs.some((d) => d.status !== 'available')) {
        throw new Error('Có ghế đã được giữ/đặt');
      }

      // 6) Tính tiền ở server — nếu client truyền thông tin điểm dừng, tính theo đoạn giữa pickup/dropoff
      let pricePerSeat = trip.base_price || 0;
      let computedTotal = pricePerSeat * requestedNums.length;

      if (stops && stops.pickupId && stops.dropoffId) {
        // Load stops for route to compute relative fraction by order
        const pickupStop = await RouteStop.findById(stops.pickupId);
        const dropoffStop = await RouteStop.findById(stops.dropoffId);
        if (pickupStop && dropoffStop && String(pickupStop.route) === String(dropoffStop.route)) {
          const routeStops = await RouteStop.find({ route: pickupStop.route }).sort({ order: 1 });
          if (routeStops && routeStops.length > 0) {
            const orders = routeStops.map(s => (typeof s.order === 'number' ? s.order : 0));
            const minOrder = Math.min(...orders);
            const maxOrder = Math.max(...orders);
            const totalSegments = (maxOrder - minOrder) || 1;
            const segmentsBetween = Math.max(0, dropoffStop.order - pickupStop.order);
            const fraction = Math.min(1, segmentsBetween / totalSegments);
            // Compute prorated price per seat based on fraction of route length
            pricePerSeat = Math.round((trip.base_price || 0) * fraction);
            if (pricePerSeat <= 0) pricePerSeat = Math.max(1, Math.floor((trip.base_price || 0) * 0.2));
            computedTotal = pricePerSeat * requestedNums.length;
          }
        }
      }
      
      // 7) Tạo booking
      const seatLabels = willBookDocs.map((d) => d.seat_number);
      
      // --- LOGIC MỚI: Xác định trạng thái ---
      // Nếu là Banking hoặc MoMo -> Pending. COD -> Paid (hoặc pending tùy bạn, ở đây để paid cho đơn giản)
      const initialStatus = (paymentMethod === 'banking' || paymentMethod === 'momo') ? 'pending' : 'paid';

      const [booking] = await Booking.create(
        [
          {
            // Gắn user nếu đã đăng nhập
            user: req.user ? req.user._id : undefined,
            trip: trip._id,
            start_time: trip.start_time,
            end_time: trip.end_time || null,
            seat_numbers: seatLabels,
            passenger: passenger || null,
            total_amount: computedTotal,
            total_price: computedTotal,
            
            // --- SỬA Ở ĐÂY ---
            status: initialStatus, 
            stops: stops, 
            // -----------------

            route_snapshot: {
              from: trip.route?.from_city || '',
              to: trip.route?.to_city || '',
              estimated_duration_min: trip.route?.estimated_duration_min || null
            },
            pickup: stops && stops.pickupId ? String(stops.pickupId) : undefined,
            dropoff: stops && stops.dropoffId ? String(stops.dropoffId) : undefined,
            pickup_name: (stops && stops.pickupId && typeof stops.pickupName === 'string') ? stops.pickupName : undefined,
            dropoff_name: (stops && stops.dropoffId && typeof stops.dropoffName === 'string') ? stops.dropoffName : undefined,
            bus_snapshot: {
              bus_type: trip.bus?.bus_type || '',
              license_plate: trip.bus?.license_plate || '',
              seat_count: trip.bus?.seat_count || 0
            }
          }
        ],
        wopt
      );

      // 8) Tạo payment
      const [payment] = await Payment.create(
        [
          {
            booking: booking._id,
            method: paymentMethod || 'banking',
            amount: computedTotal,
            transaction_code: `TX${Date.now()}`,
            
            // --- SỬA Ở ĐÂY ---
            status: initialStatus === 'paid' ? 'success' : 'pending',
            paid_at: initialStatus === 'paid' ? new Date() : null
            // -----------------
          }
        ],
        wopt
      );

      // Link payment vào booking (nếu schema có field)
      booking.payment = payment._id;
      booking.payment_id = payment._id;
      // Ensure user is saved on booking (if middleware set req.user)
      if (req.user && !booking.user) booking.user = req.user._id;
      await booking.save(wopt);

      // 9) Cập nhật trạng thái ghế theo _id (an toàn nhất)
      const idsToUpdate = willBookDocs.map((d) => d._id);
      await TripSeatStatus.updateMany(
        { _id: { $in: idsToUpdate } },
        { $set: { status: 'booked', booking_id: booking._id, updated_at: new Date() } },
        wopt
      );

      // 10) Chuẩn bị payload trả về FE (seats trả về dạng SỐ cho UI)
      // --- BẮT ĐẦU ĐOẠN CODE CẦN THAY THẾ ---
      
      // Tính toán lại giờ đến dự kiến dựa trên tỷ lệ quãng đường (fraction)
      // (Biến fraction đã được tính ở đoạn code bên trên của m rồi)
      // Đoạn này phải nằm NGAY TRÊN cái const payload của m
      let calculatedArrivalTime = booking.end_time;
      if (trip.start_time && trip.end_time && typeof fraction === 'number') {
          const startTime = new Date(trip.start_time).getTime();
          const endTime = new Date(trip.end_time).getTime();
          const totalDuration = endTime - startTime;
          const passengerDuration = totalDuration * fraction;
          calculatedArrivalTime = new Date(startTime + passengerDuration);
      }

      // 10) Chuẩn bị payload trả về FE (Sửa lại để ưu tiên lấy tên điểm dừng)
      const payload = {
        bookingId: String(booking._id),
        paymentId: String(payment._id),
        route: {
          // QUAN TRỌNG: Nếu có điểm đón/trả cụ thể thì lấy tên đó, nếu không mới lấy tên TP gốc
          from: (stops && stops.pickupName) ? stops.pickupName : booking.route_snapshot.from,
          to: (stops && stops.dropoffName) ? stops.dropoffName : booking.route_snapshot.to,
          durationMin: booking.route_snapshot.estimated_duration_min
        },
        times: { 
            departureTime: booking.start_time, 
            arrivalTime: calculatedArrivalTime // <-- QUAN TRỌNG: Trả về giờ đến Bến xe Huế
        },
        bus: { 
            busType: booking.bus_snapshot.bus_type, 
            seatCount: booking.bus_snapshot.seat_count, 
            licensePlate: booking.bus_snapshot.license_plate 
        },
        seats: requestedNums,
        passenger: booking.passenger || null,
        pricePerSeat,
        totalAmount: computedTotal,
        paymentMethod: payment.method,
        stops: stops ? {
          pickupName: stops.pickupName,
          dropoffName: stops.dropoffName
        } : null
      };

      // Include selected stops info if present
      if (stops && stops.pickupId && stops.dropoffId) {
        payload.stops = {
          pickupId: String(stops.pickupId),
          dropoffId: String(stops.dropoffId),
          pickupName: stops.pickupName || (booking.pickup_name || null),
          dropoffName: stops.dropoffName || (booking.dropoff_name || null)
        };
      }

      // Gửi email xác nhận (không chặn response)
      // Nếu người dùng đã đăng nhập, ưu tiên gửi đến email đã đăng ký của tài khoản
      const recipientEmail = (req.user && req.user.email) ? req.user.email : (booking?.passenger?.email);
      if (recipientEmail) {
        // Fire-and-forget
        sendBookingConfirmationEmail(recipientEmail, payload)
          .catch((e) => console.error('Send email error:', e));
      }

      return payload;
    };

    // TẮT transaction hoàn toàn để tương thích MongoDB standalone
    const payload = await runFlow(null);
    return res.json(payload);
  } catch (err) {
    console.error('Checkout error:', err);
    res.status(400).json({ error: err.message || 'Checkout failed' });
  } finally {
    session.endSession();
  }
};

// Dùng cho "Vé của tôi" / F5 success
exports.listOfUser = async (req, res) => {
  try {
    const { userId, phone } = req.query;
    // Nếu có user đăng nhập, tự động filter theo user đó
    // Ưu tiên: req.user > userId query > phone query > không filter
    let q = {};
    if (req.user && req.user._id) {
      // User đã đăng nhập - chỉ lấy bookings của user đó
      q = { user: req.user._id };
    } else if (userId) {
      // Admin có thể truyền userId để xem bookings của user khác
      q = { user: userId };
    } else if (phone) {
      // Tìm theo số điện thoại (cho trường hợp chưa đăng nhập)
      q = { 'passenger.phone': phone };
    }
    // Nếu không có gì, q = {} sẽ trả về tất cả (chỉ nên dùng cho admin)
    
    const docs = await Booking.find(q)
      .populate('trip')
      .populate('user', 'name email phone')
      .sort({ createdAt: -1 });
    res.json(docs);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};

exports.detail = async (req, res) => {
  try {
    const doc = await Booking.findById(req.params.id);
    if (!doc) return res.status(404).json({ error: 'Not found' });
    res.json(doc);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};

// API Hủy vé dành cho khách hàng
exports.cancel = async (req, res) => {
  try {
    const bookingId = req.params.id;
    const booking = await Booking.findById(bookingId);

    if (!booking) {
      return res.status(404).json({ error: 'Không tìm thấy vé' });
    }

    // Chỉ cho phép hủy khi đang pending
    if (booking.status !== 'pending') {
      return res.status(400).json({ error: 'Chỉ có thể hủy vé khi đang chờ thanh toán' });
    }

    // 1. Cập nhật trạng thái Booking
    booking.status = 'cancelled';
    await booking.save();

    // 2. Nhả ghế ra (trả về status available)
    await TripSeatStatus.updateMany(
      { booking_id: booking._id },
      { $set: { status: 'available', booking_id: null } }
    );

    res.json({ success: true, message: 'Hủy vé thành công' });
  } catch (e) {
    console.error(e);
    res.status(500).json({ error: e.message });
  }
};
--- END OF FILE: backend\controllers\bookingController.js ---


--- START OF FILE: backend\controllers\feedbackController.js ---
const Feedback = require("../models/Feedback");

// 🟢 Lấy tất cả feedback
exports.getAllFeedbacks = async (req, res) => {
  try {
    const feedbacks = await Feedback.find();
    res.json(feedbacks);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// 🟢 Thêm feedback mới
exports.createFeedback = async (req, res) => {
  try {
    const newFeedback = new Feedback(req.body);
    const saved = await newFeedback.save();
    res.status(201).json(saved);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
};

--- END OF FILE: backend\controllers\feedbackController.js ---


--- START OF FILE: backend\controllers\paymentController.js ---
const Payment = require('../models/Payment');
const Booking = require('../models/Booking');

// GET /api/payments
exports.getAllPayments = async (req, res) => {
  try {
    // ✅ populate 'booking' (không phải 'ticketId')
    const payments = await Payment.find().populate('booking');
    res.json(payments);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// POST /api/payments
// Lưu ý: trong luồng “checkout” bạn đã tạo Payment trong bookingController.
// Hàm này chỉ dùng khi bạn muốn tự tạo payment rời (ít dùng).
exports.createPayment = async (req, res) => {
  try {
    const { booking, user, method = 'banking', amount, transaction_code, status = 'success' } = req.body;

    if (!booking) return res.status(400).json({ error: 'Thiếu booking' });
    if (!amount)  return res.status(400).json({ error: 'Thiếu amount' });

    const existedBooking = await Booking.findById(booking);
    if (!existedBooking) return res.status(404).json({ error: 'Booking không tồn tại' });

    // Tạo paymentId duy nhất để không bị E11000 nếu có unique index
    const paymentId = `PAY${Date.now()}${Math.floor(Math.random() * 1e6)}`;

    const doc = await Payment.create({
      booking,
      user: user || existedBooking.user || null,
      method,
      amount,
      transaction_code: transaction_code || `TX${Date.now()}`,
      status,
      paymentId,               // ✅ luôn set để tránh null
      paid_at: new Date(),
    });

    // (tuỳ chọn) nếu Booking schema có field payment/payment_id, bạn có thể link vào:
    // existedBooking.payment = doc._id;
    // existedBooking.payment_id = doc._id;
    // await existedBooking.save();

    res.status(201).json(doc);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
};

--- END OF FILE: backend\controllers\paymentController.js ---


--- START OF FILE: backend\controllers\routeController.js ---
// controllers/routeController.js
const Route = require('../models/Route');
const RouteStop = require('../models/RouteStop');
const Trip = require('../models/Trip');
const TripSeatStatus = require('../models/TripSeatStatus');
const Review = require('../models/Review');

// GET /api/routes/detailed
exports.getAllRoutesDetailed = async (req, res) => {
  try {
    const { date } = req.query;

    // Get all routes
    const routes = await Route.find().lean();
    
    // Get all trips for all routes
    const routeIds = routes.map(r => r._id);
    
    const tripFilter = { route: { $in: routeIds } };
    if (date) {
      const searchDate = new Date(date);
      const nextDay = new Date(date);
      nextDay.setDate(searchDate.getDate() + 1);

      tripFilter.start_time = {
        $gte: searchDate,
        $lt: nextDay,
      };
    }

    const trips = await Trip.find(tripFilter)
      .populate('bus')
      .lean();

    // Group trips by route
    const tripsByRoute = {};
    trips.forEach(trip => {
      if (!tripsByRoute[trip.route]) {
        tripsByRoute[trip.route] = [];
      }
      tripsByRoute[trip.route].push(trip);
    });

    // Get available seats for all trips
    const tripIds = trips.map(t => t._id);
    const tripSeats = tripIds.length > 0 ? await TripSeatStatus.aggregate([
      { $match: { trip: { $in: tripIds } } },
      { $group: { 
        _id: '$trip',
        availableSeats: { 
          $sum: { $cond: [{ $eq: ['$status', 'available'] }, 1, 0] }
        }
      }}
    ]) : [];

    // Create seats lookup
    const seatsByTrip = {};
    tripSeats.forEach(ts => {
      seatsByTrip[ts._id] = ts.availableSeats;
    });

    // Get average ratings for all routes
    const ratings = tripIds.length > 0 ? await Review.aggregate([
      { $match: { trip: { $in: tripIds } } },
      { $lookup: {
        from: 'trips',
        localField: 'trip',
        foreignField: '_id',
        as: 'trip'
      }},
      { $unwind: '$trip' },
      { $group: {
        _id: '$trip.route',
        avgRating: { $avg: '$rating' }
      }}
    ]) : [];

    // Create ratings lookup
    const ratingsByRoute = {};
    ratings.forEach(r => {
      ratingsByRoute[r._id] = r.avgRating;
    });

    // Combine all data
    const detailedRoutes = routes.map(route => {
      const routeTrips = tripsByRoute[route._id] || [];
      // Sort trips by start time and get the soonest
      routeTrips.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
      const nextTrip = routeTrips[0];

      return {
        _id: route._id,
        from_city: route.from_city,
        to_city: route.to_city,
        estimated_duration_min: route.estimated_duration_min,
        base_price: nextTrip?.base_price,
        start_time: nextTrip?.start_time,
        end_time: nextTrip?.end_time,
        bus_type: nextTrip?.bus?.bus_type,
        availableSeats: nextTrip ? (seatsByTrip[nextTrip._id] || 0) : 0,
        avgRating: ratingsByRoute[route._id] || 0,
        company: route.company,
        features: route.features || []
      };
    }).filter(route => route.start_time); // Only return routes that have trips on the given date

    res.json(detailedRoutes);
  } catch (err) {
    console.error('Error in getAllRoutesDetailed:', err);
    res.status(500).json({ error: err.message });
  }
};

// POST /api/routes
exports.createRoute = async (req, res) => {
  try {
    const route = await Route.create(req.body);
    res.status(201).json(route);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
};

// GET /api/routes
exports.getAllRoutes = async (req, res) => {
  try {
    const routes = await Route.find();
    res.json(routes);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// POST /api/routes/:routeId/stops
exports.createStop = async (req, res) => {
  try {
    const stop = await RouteStop.create({ ...req.body, route: req.params.routeId });
    res.status(201).json(stop);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
};

// GET /api/routes/:routeId/stops
exports.getStops = async (req, res) => {
  try {
    const stops = await RouteStop.find({ route: req.params.routeId }).sort({ order: 1 });
    res.json(stops);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// GET /api/routes/:routeId
// returns route document, stops, and a trips summary (with bus populated and availableSeats)
exports.getRouteDetail = async (req, res) => {
  try {
    const routeId = req.params.routeId;
    const route = await Route.findById(routeId).lean();
    if (!route) return res.status(404).json({ error: 'Route not found' });

    const stops = await RouteStop.find({ route: routeId }).sort({ order: 1 }).lean();

    // find trips for this route (returning scheduled/upcoming and departed)
    const trips = await Trip.find({ route: routeId }).populate('bus').lean();

    // for each trip compute available seats (count in TripSeatStatus)
    const tripsWithSeats = await Promise.all(
      trips.map(async (t) => {
        const availableSeats = await TripSeatStatus.countDocuments({ trip: t._id, status: 'available' });
        return {
          _id: t._id,
          start_time: t.start_time,
          end_time: t.end_time,
          base_price: t.base_price,
          status: t.status,
          direction: t.direction,
          bus: t.bus,
          availableSeats
        };
      })
    );

    // compute average rating from reviews of trips on this route
    let avgRating = null;
    const tripIds = trips.map(t => t._id);
    if (tripIds.length > 0) {
      const agg = await Review.aggregate([
        { $match: { trip: { $in: tripIds } } },
        { $group: { _id: null, avgRating: { $avg: '$rating' } } }
      ]);
      if (agg && agg.length) avgRating = agg[0].avgRating;
    }

    res.json({ route, stops, trips: tripsWithSeats, avgRating });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

--- END OF FILE: backend\controllers\routeController.js ---


--- START OF FILE: backend\controllers\ticketController.js ---
const Ticket = require("../models/Ticket");

// 🟢 Lấy danh sách vé
exports.getAllTickets = async (req, res) => {
  try {
    const tickets = await Ticket.find().populate("tripId");
    res.json(tickets);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// 🟢 Đặt vé (kiểm tra trùng ghế)
exports.createTicket = async (req, res) => {
  try {
    const { tripId, seatNumber, customerName, customerPhone } = req.body;

    // Kiểm tra trùng ghế
    const existing = await Ticket.findOne({ tripId, seatNumber });
    if (existing) {
      return res.status(400).json({ message: "Ghế này đã được đặt rồi!" });
    }

    const newTicket = new Ticket({ tripId, seatNumber, customerName, customerPhone });
    const savedTicket = await newTicket.save();
    res.status(201).json(savedTicket);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
};

--- END OF FILE: backend\controllers\ticketController.js ---


--- START OF FILE: backend\controllers\tripController.js ---
const Trip = require("../models/Trip");
const TripSeatStatus = require("../models/TripSeatStatus");

// 🟢 Lấy danh sách tất cả chuyến xe
exports.getAllTrips = async (req, res) => {
  try {
    const trips = await Trip.find();
    res.json(trips);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// 🟢 Thêm chuyến xe mới
exports.createTrip = async (req, res) => {
  try {
    const newTrip = new Trip(req.body);
    const savedTrip = await newTrip.save();
    res.status(201).json(savedTrip);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
};

// 🟢 Cập nhật chuyến xe
exports.updateTrip = async (req, res) => {
  try {
    const updatedTrip = await Trip.findByIdAndUpdate(req.params.id, req.body, { new: true });
    res.json(updatedTrip);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
};

// 🟢 Xóa chuyến xe
exports.deleteTrip = async (req, res) => {
  try {
    await Trip.findByIdAndDelete(req.params.id);
    res.json({ message: "Trip deleted successfully" });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// Lấy danh sách chuyến của 1 route
exports.getTripsByRoute = async (req, res) => {
  try {
    const { routeId } = req.params;
    const { date } = req.query;

    const filter = { route: routeId };

    if (date) {
      const searchDate = new Date(date);
      const nextDay = new Date(date);
      nextDay.setDate(searchDate.getDate() + 1);

      filter.start_time = {
        $gte: searchDate,
        $lt: nextDay,
      };
    }

    const trips = await Trip.find(filter).sort({ start_time: 1 });
    res.json(trips);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

// Lấy danh sách ghế của 1 chuyến
exports.getSeatsByTrip = async (req, res) => {
  try {
    const seats = await TripSeatStatus.find({ trip: req.params.tripId }).sort({ seat_number: 1 });
    res.json(seats);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

--- END OF FILE: backend\controllers\tripController.js ---


--- START OF FILE: backend\data\assistants.json ---
[
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d0e"
    },
    "name": "Nguyễn Thị Lan",
    "email": "lan.phuxe@gmail.com",
    "phone": "0956789012",
    "employee_id": "PX001",
    "license_number": "PX-LN-2024-001",
    "experience_years": 5,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  },
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d0f"
    },
    "name": "Trần Thị Mai",
    "email": "mai.phuxe@gmail.com",
    "phone": "0967890123",
    "employee_id": "PX002",
    "license_number": "PX-TM-2024-002",
    "experience_years": 3,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  },
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d10"
    },
    "name": "Lê Thị Hoa",
    "email": "hoa.phuxe@gmail.com",
    "phone": "0978901234",
    "employee_id": "PX003",
    "license_number": "PX-LH-2024-003",
    "experience_years": 7,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  },
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d11"
    },
    "name": "Phạm Thị Nga",
    "email": "nga.phuxe@gmail.com",
    "phone": "0989012345",
    "employee_id": "PX004",
    "license_number": "PX-PN-2024-004",
    "experience_years": 4,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  },
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d12"
    },
    "name": "Hoàng Thị Linh",
    "email": "linh.phuxe@gmail.com",
    "phone": "0990123456",
    "employee_id": "PX005",
    "license_number": "PX-HL-2024-005",
    "experience_years": 6,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  },
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d13"
    },
    "name": "Vũ Thị Hương",
    "email": "huong.phuxe@gmail.com",
    "phone": "0901234567",
    "employee_id": "PX006",
    "license_number": "PX-VH-2024-006",
    "experience_years": 2,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  },
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d14"
    },
    "name": "Đỗ Thị Thu",
    "email": "thu.phuxe@gmail.com",
    "phone": "0912345678",
    "employee_id": "PX007",
    "license_number": "PX-DT-2024-007",
    "experience_years": 8,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  },
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d15"
    },
    "name": "Bùi Thị Anh",
    "email": "anh.phuxe@gmail.com",
    "phone": "0923456789",
    "employee_id": "PX008",
    "license_number": "PX-BA-2024-008",
    "experience_years": 3,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  }
]


--- END OF FILE: backend\data\assistants.json ---


--- START OF FILE: backend\data\assistants_simple.json ---
[
  {
    "name": "Nguyễn Thị Lan",
    "email": "lan.phuxe@gmail.com",
    "phone": "0956789012",
    "employee_id": "PX001",
    "license_number": "PX-LN-2024-001",
    "experience_years": 5,
    "status": "active",
    "assigned_trips": []
  },
  {
    "name": "Trần Thị Mai",
    "email": "mai.phuxe@gmail.com",
    "phone": "0967890123",
    "employee_id": "PX002",
    "license_number": "PX-TM-2024-002",
    "experience_years": 3,
    "status": "active",
    "assigned_trips": []
  },
  {
    "name": "Lê Thị Hoa",
    "email": "hoa.phuxe@gmail.com",
    "phone": "0978901234",
    "employee_id": "PX003",
    "license_number": "PX-LH-2024-003",
    "experience_years": 7,
    "status": "active",
    "assigned_trips": []
  },
  {
    "name": "Phạm Thị Nga",
    "email": "nga.phuxe@gmail.com",
    "phone": "0989012345",
    "employee_id": "PX004",
    "license_number": "PX-PN-2024-004",
    "experience_years": 4,
    "status": "active",
    "assigned_trips": []
  },
  {
    "name": "Hoàng Thị Linh",
    "email": "linh.phuxe@gmail.com",
    "phone": "0990123456",
    "employee_id": "PX005",
    "license_number": "PX-HL-2024-005",
    "experience_years": 6,
    "status": "active",
    "assigned_trips": []
  },
  {
    "name": "Vũ Thị Hương",
    "email": "huong.phuxe@gmail.com",
    "phone": "0901234567",
    "employee_id": "PX006",
    "license_number": "PX-VH-2024-006",
    "experience_years": 2,
    "status": "active",
    "assigned_trips": []
  },
  {
    "name": "Đỗ Thị Thu",
    "email": "thu.phuxe@gmail.com",
    "phone": "0912345678",
    "employee_id": "PX007",
    "license_number": "PX-DT-2024-007",
    "experience_years": 8,
    "status": "active",
    "assigned_trips": []
  },
  {
    "name": "Bùi Thị Anh",
    "email": "anh.phuxe@gmail.com",
    "phone": "0923456789",
    "employee_id": "PX008",
    "license_number": "PX-BA-2024-008",
    "experience_years": 3,
    "status": "active",
    "assigned_trips": []
  }
]


--- END OF FILE: backend\data\assistants_simple.json ---


--- START OF FILE: backend\db.js ---
const mongoose = require('mongoose');

const connectDB = async () => {
  try {
    const uri = process.env.MONGO_URI || 'mongodb://127.0.0.1:27017/bus_booking';
    await mongoose.connect(uri, { useNewUrlParser: true, useUnifiedTopology: true });
    console.log('✅ MongoDB connected');
  } catch (err) {
    console.error('❌ MongoDB connection error', err);
    process.exit(1);
  }
};

module.exports = connectDB;

--- END OF FILE: backend\db.js ---


--- START OF FILE: backend\middleware\authMiddleware.js ---
const jwt = require("jsonwebtoken");
const User = require('../models/User');

// Middleware kiểm tra token
const protect = async (req, res, next) => {
  try {
    let token;

    // Check header
    const authHeader = req.header("Authorization");
    if (authHeader && authHeader.startsWith("Bearer")) {
      token = authHeader.replace("Bearer ", "");
    } 
    // Check cookie
    else if (req.cookies.token) {
      token = req.cookies.token;
    }

    if (!token) {
      return res.status(401).json({ message: "Vui lòng đăng nhập để tiếp tục" });
    }

    // Xác thực token
    const decoded = jwt.verify(token, process.env.JWT_SECRET || "secretkey");
    
    // Get user from database
    const user = await User.findById(decoded.id).select('-password');
    if (!user) {
      return res.status(401).json({ message: "Không tìm thấy người dùng" });
    }

    // Gán thông tin user vào request
    req.user = user;
    next();
  } catch (err) {
    res.status(401).json({ message: "Token không hợp lệ hoặc đã hết hạn!" });
  }
};

// Middleware kiểm tra role
const authorize = (...roles) => {
  return (req, res, next) => {
    if (!roles.includes(req.user.role)) {
      return res.status(403).json({ 
        message: `Role ${req.user.role} không có quyền thực hiện thao tác này`
      });
    }
    next();
  };
};

module.exports = { protect, authorize };

--- END OF FILE: backend\middleware\authMiddleware.js ---


--- START OF FILE: backend\models\Assistant.js ---
const mongoose = require('mongoose');

// Merged assistant schema to satisfy both admin views (older fields)
// and assistant API/controllers (userId, busId, currentTrip, checkInList, etc.)
const assistantSchema = new mongoose.Schema({
  // Optional link to User (if assistant is also a user in the system)
  userId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User'
  },

  // Basic personal/contact info (used by admin views)
  name: {
    type: String
  },
  email: {
    type: String,
    match: [/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/, 'Vui lòng nhập email hợp lệ']
  },
  phone: {
    type: String,
    match: [/^(0|84|\+84)[0-9]{9}$/, 'Vui lòng nhập số điện thoại hợp lệ']
  },

  // Admin-related fields
  employee_id: {
    type: String
  },
  license_number: {
    type: String
  },
  experience_years: {
    type: Number,
    min: 0,
    default: 0
  },

  // Assignment fields (kept from older admin UI)
  assigned_trips: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Trip'
  }],
  assigned_routes: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Route'
  }],

  // Operational fields used by assistant controller
  busId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Bus'
  },
  currentTrip: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Trip'
  },
  checkInList: [{
    passengerId: mongoose.Schema.Types.ObjectId,
    ticketId: mongoose.Schema.Types.ObjectId,
    checkedIn: Boolean,
    checkedInTime: Date
  }],

  // status -- include values used in different parts of app
  status: {
    type: String,
    enum: ['active', 'inactive', 'available', 'on_trip', 'off_duty'],
    default: 'available'
  },

  rating: {
    type: Number,
    default: 5,
    min: 1,
    max: 5
  },
  totalTrips: {
    type: Number,
    default: 0
  }
}, {
  timestamps: true,
  collection: 'assistants'
});

module.exports = mongoose.model('Assistant', assistantSchema);

--- END OF FILE: backend\models\Assistant.js ---


--- START OF FILE: backend\models\Booking.js ---
// models/Booking.js
const mongoose = require('mongoose');

const bookingSchema = new mongoose.Schema({
  user: { type: mongoose.Schema.Types.ObjectId, ref: 'User' }, // optional nếu chưa đăng nhập
  trip: { type: mongoose.Schema.Types.ObjectId, ref: 'Trip', required: true },

  // Snapshot để FE hiển thị không cần populate nhiều
  route_snapshot: {
    from: String,
    to: String,
    estimated_duration_min: Number
  },
  // If user selected specific stops for pickup/dropoff
  pickup: { type: String },
  dropoff: { type: String },
  pickup_name: { type: String },
  dropoff_name: { type: String },
  bus_snapshot: {
    bus_type: String,
    license_plate: String,
    seat_count: Number
  },

  start_time: Date,
  end_time: Date,

  seat_numbers: [String],

  // giữ tương thích ngược lẫn tên mới
  total_amount: Number,
  total_price: Number,

  passenger: {
    name: String,
    phone: String,
    email: String,
    note: String
  },

  status: { type: String, enum: ['pending','paid','cancelled','completed'], default: 'pending' },

  payment: { type: mongoose.Schema.Types.ObjectId, ref: 'Payment', default: null },
  payment_id: { type: mongoose.Schema.Types.ObjectId, ref: 'Payment', default: null },
}, { timestamps: true });

module.exports = mongoose.model('Booking', bookingSchema);

--- END OF FILE: backend\models\Booking.js ---


--- START OF FILE: backend\models\Bus.js ---
const mongoose = require('mongoose');

const busSchema = new mongoose.Schema({
  license_plate: { type: String, required: true, unique: true },
  bus_type: String,
  seat_count: Number,
  active: { type: Boolean, default: true }
}, { timestamps: true });

module.exports = mongoose.model('Bus', busSchema);

--- END OF FILE: backend\models\Bus.js ---


--- START OF FILE: backend\models\Checkin.js ---
const mongoose = require('mongoose');

const checkinSchema = new mongoose.Schema({
  booking: { type: mongoose.Schema.Types.ObjectId, ref: 'Booking', required: true },
  assistant: { type: mongoose.Schema.Types.ObjectId, ref: 'Assistant' },
  checkin_time: Date,
  status: { type: String, enum: ['checked_in','no_show'] }
}, { timestamps: true });

module.exports = mongoose.model('Checkin', checkinSchema);

--- END OF FILE: backend\models\Checkin.js ---


--- START OF FILE: backend\models\Contact.js ---
const mongoose = require('mongoose');

const ReplySchema = new mongoose.Schema({
  adminId: { type: mongoose.Schema.Types.ObjectId, ref: 'User' },
  adminName: { type: String },
  message: { type: String },
  messageId: { type: String },
  createdAt: { type: Date, default: Date.now }
}, { _id: false });

const ContactSchema = new mongoose.Schema({
  name: { type: String, required: true },
  email: { type: String, required: true },
  phone: { type: String },
  subject: { type: String },
  message: { type: String },
  // public token so non-authenticated users can view their thread
  publicToken: { type: String },
  tokenExpires: { type: Date },
  sent: { type: Boolean, default: false },
  sentAt: { type: Date },
  sendError: { type: String },
  messageId: { type: String },
  replies: [ReplySchema]
}, { timestamps: true });

module.exports = mongoose.model('Contact', ContactSchema);

--- END OF FILE: backend\models\Contact.js ---


--- START OF FILE: backend\models\Driver.js ---
const mongoose = require('mongoose');

const driverSchema = new mongoose.Schema({
  // Liên kết với bảng User để sau này làm chức năng đăng nhập
  userId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User'
  },

  // Thông tin cá nhân
  name: { type: String, required: true },
  email: { 
    type: String, 
    required: true,
    unique: true, 
    match: [/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/, 'Email không hợp lệ']
  },
  phone: { 
    type: String, 
    required: true,
    match: [/^(0|84|\+84)[0-9]{9}$/, 'Số điện thoại không hợp lệ']
  },

  // Thông tin chuyên môn
  license_number: { type: String, required: true }, // Bắt buộc với tài xế
  experience_years: { type: Number, default: 0 },
  employee_id: { type: String },

  // Danh sách các chuyến được phân công (Để Admin xem lịch trình)
  assigned_trips: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Trip'
  }],

  // Trạng thái tài xế
  status: {
    type: String,
    enum: ['active', 'inactive'],
    default: 'active'
  }
}, { timestamps: true });

module.exports = mongoose.model('Driver', driverSchema);
--- END OF FILE: backend\models\Driver.js ---


--- START OF FILE: backend\models\Feedback.js ---
const mongoose = require("mongoose");

const FeedbackSchema = new mongoose.Schema(
  {
    userId: { type: String, required: true }, // ID của người dùng phản hồi
    tripId: { type: String, required: true }, // ID chuyến xe
    rating: { type: Number, min: 1, max: 5, required: true }, // đánh giá từ 1-5
    comment: { type: String, required: true }, // nội dung phản hồi
    createdAt: { type: Date, default: Date.now }
  },
  { collection: "feedbacks" } // tên collection trong MongoDB
);

module.exports = mongoose.model("Feedback", FeedbackSchema);

--- END OF FILE: backend\models\Feedback.js ---


--- START OF FILE: backend\models\Payment.js ---
const mongoose = require('mongoose');

const paymentSchema = new mongoose.Schema(
  {
    booking: { type: mongoose.Schema.Types.ObjectId, ref: 'Booking', required: true },
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User' },

    // Ví dụ: 'momo' | 'banking' | 'cod'
    method: { type: String, enum: ['momo', 'banking', 'cod'], required: true },

    amount: { type: Number, required: true },              // số tiền đã thanh toán
    transaction_code: { type: String },                    // mã giao dịch từ cổng thanh toán

    // Mã nội bộ của bạn, để đối soát. Đặt unique + sparse để không dính lỗi khi null.
    paymentId: { type: String, unique: true, sparse: true },

    status: { type: String, enum: ['success', 'failed', 'pending'], default: 'success' },
    paid_at: { type: Date, default: Date.now },
  },
  { collection: 'payments', timestamps: true }
);

module.exports = mongoose.model('Payment', paymentSchema);

--- END OF FILE: backend\models\Payment.js ---


--- START OF FILE: backend\models\Review.js ---
const mongoose = require('mongoose');

const reviewSchema = new mongoose.Schema({
  user: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
  trip: { type: mongoose.Schema.Types.ObjectId, ref: 'Trip' },
  rating: { type: Number, min: 1, max: 5 },
  comment: String
}, { timestamps: true });

module.exports = mongoose.model('Review', reviewSchema);

--- END OF FILE: backend\models\Review.js ---


--- START OF FILE: backend\models\Route.js ---
const mongoose = require('mongoose');

const routeSchema = new mongoose.Schema({
  name: { type: String, required: true },
  from_city: String,
  to_city: String,
  total_distance_km: Number,
  estimated_duration_min: Number,
  active: { type: Boolean, default: true }
}, { timestamps: true });

module.exports = mongoose.model('Route', routeSchema);

--- END OF FILE: backend\models\Route.js ---


--- START OF FILE: backend\models\RouteStop.js ---
const mongoose = require('mongoose');

const routeStopSchema = new mongoose.Schema({
  route: { type: mongoose.Schema.Types.ObjectId, ref: 'Route', required: true },
  stop_name: String,
  order: Number,
  type: { type: String, enum: ['pickup','dropoff','both'], default: 'both' }
});

module.exports = mongoose.model('RouteStop', routeStopSchema, 'route_stops');

--- END OF FILE: backend\models\RouteStop.js ---


--- START OF FILE: backend\models\Ticket.js ---
const mongoose = require("mongoose");

const ticketSchema = new mongoose.Schema({
  tripId: { type: mongoose.Schema.Types.ObjectId, ref: "Trip", required: true },
  userId: { type: String }, // hoặc ObjectId nếu bạn có model User
  seatNumber: { type: String, required: true },
  status: { type: String, default: "booked" }
});

module.exports = mongoose.model("Ticket", ticketSchema);

--- END OF FILE: backend\models\Ticket.js ---


--- START OF FILE: backend\models\Trip.js ---
const mongoose = require('mongoose');

const tripSchema = new mongoose.Schema({
  route: { type: mongoose.Schema.Types.ObjectId, ref: 'Route', required: true },
  bus: { type: mongoose.Schema.Types.ObjectId, ref: 'Bus', required: true },
  start_time: { type: Date, required: true },
  end_time: { type: Date },
  base_price: Number,
  direction: { type: String, enum: ['go','return'], default: 'go' },
  status: { type: String, enum: ['scheduled','departed','completed','cancelled'], default: 'scheduled' },
  is_recurring: { type: Boolean, default: false }
}, { timestamps: true });

module.exports = mongoose.model('Trip', tripSchema);

--- END OF FILE: backend\models\Trip.js ---


--- START OF FILE: backend\models\TripSeatStatus.js ---
const mongoose = require('mongoose');

const tripSeatStatusSchema = new mongoose.Schema({
  trip: { type: mongoose.Schema.Types.ObjectId, ref: 'Trip', required: true },
  seat_number: String,
  status: { type: String, enum: ['available','reserved','booked','checked_in'], default: 'available' },
  booking_id: { type: mongoose.Schema.Types.ObjectId, ref: 'Booking', default: null }
}, { timestamps: true, collection: 'trip_seat_status' });

module.exports = mongoose.model('TripSeatStatus', tripSeatStatusSchema);

--- END OF FILE: backend\models\TripSeatStatus.js ---


--- START OF FILE: backend\models\User.js ---
const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');

const userSchema = new mongoose.Schema({
  name: {
    type: String,
    required: [true, 'Vui lòng nhập họ tên']
  },
  email: {
    type: String,
    required: [true, 'Vui lòng nhập email'],
    unique: true,
    match: [
      /^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/,
      'Vui lòng nhập email hợp lệ'
    ]
  },
  phone: {
    type: String,
    required: [true, 'Vui lòng nhập số điện thoại'],
    match: [
      /^(0|84|\+84)[0-9]{9}$/,
      'Vui lòng nhập số điện thoại hợp lệ'
    ]
  },
  password: {
    type: String,
    required: [true, 'Vui lòng nhập mật khẩu'],
    minlength: [6, 'Mật khẩu phải có ít nhất 6 ký tự'],
    select: false
  },
  role: {
    type: String,
    enum: ['user', 'admin', 'driver', 'assistant'],
    default: 'user'
  },
  // Các field riêng cho assistant (optional)
  employee_id: {
    type: String,
    sparse: true
  },
  license_number: {
    type: String,
    sparse: true
  },
  experience_years: {
    type: Number,
    min: 0
  },
  assigned_trips: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Trip'
  }]
}, { timestamps: true });

// Encrypt password using bcrypt
userSchema.pre('save', async function(next) {
  if (!this.isModified('password')) {
    next();
  }

  const salt = await bcrypt.genSalt(10);
  this.password = await bcrypt.hash(this.password, salt);
});

// Match user entered password to hashed password in database
userSchema.methods.matchPassword = async function(enteredPassword) {
  return await bcrypt.compare(enteredPassword, this.password);
};

module.exports = mongoose.model('User', userSchema);
--- END OF FILE: backend\models\User.js ---


--- START OF FILE: backend\package.json ---
{
  "name": "bus-booking-backend",
  "version": "1.0.0",
  "description": "Backend base for Bus Booking (Express + MongoDB).",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "seed": "node seed.js"
  },
  "dependencies": {
    "bcryptjs": "^3.0.3",
    "cookie-parser": "^1.4.7",
    "cors": "^2.8.5",
    "dotenv": "^16.0.0",
    "ejs": "^3.1.10",
    "express": "^4.18.2",
    "jsonwebtoken": "^9.0.2",
    "mongoose": "^7.0.0",
    "nodemailer": "^6.9.15"
  },
  "devDependencies": {
    "nodemon": "^2.0.22"
  },
  "engines": {
    "node": ">=16"
  }
}

--- END OF FILE: backend\package.json ---


--- START OF FILE: backend\routes\adminRoutes.js ---
const express = require('express');
const router = express.Router();
const adminController = require('../controllers/adminController');
const jwt = require('jsonwebtoken');
const User = require('../models/User');

const ensureAuthUI = async (req, res, next) => {
  try {
    let token;
    const authHeader = req.header('Authorization');
    if (authHeader && authHeader.startsWith('Bearer')) {
      token = authHeader.replace('Bearer ', '');
    } else if (req.cookies.token) {
      token = req.cookies.token;
    }
    if (!token) return res.redirect('/admin/login');
    const decoded = jwt.verify(token, process.env.JWT_SECRET || 'secretkey');
    const user = await User.findById(decoded.id).select('-password');
    if (!user) return res.redirect('/admin/login');
    req.user = user;
    next();
  } catch (err) {
    return res.redirect('/admin/login');
  }
};

const requireRolesUI = (...roles) => {
  return (req, res, next) => {
    if (!req.user) return res.redirect('/admin/login');
    if (!roles.includes(req.user.role)) return res.status(403).send('Không có quyền truy cập');
    next();
  };
};

// Trang admin dashboard
router.get('/login', adminController.adminLoginPage);
router.post('/login', adminController.adminLoginPost);
router.get('/logout', adminController.adminLogout);

router.get('/', ensureAuthUI, requireRolesUI('admin'), adminController.dashboard);
router.get('/users', ensureAuthUI, requireRolesUI('admin'), adminController.users);
router.get('/buses', ensureAuthUI, requireRolesUI('admin'), adminController.buses);
// Buses create/edit
router.get('/buses/new', ensureAuthUI, requireRolesUI('admin'), adminController.newBus);
router.post('/buses', ensureAuthUI, requireRolesUI('admin'), adminController.createBus);
router.get('/buses/:id/edit', ensureAuthUI, requireRolesUI('admin'), adminController.editBus);
router.post('/buses/:id', ensureAuthUI, requireRolesUI('admin'), adminController.updateBus);
router.get('/routes', ensureAuthUI, requireRolesUI('admin'), adminController.routes);
// Routes create/edit
router.get('/routes/new', ensureAuthUI, requireRolesUI('admin'), adminController.newRoute);
router.post('/routes', ensureAuthUI, requireRolesUI('admin'), adminController.createRouteAdmin || adminController.createRoute);
router.get('/routes/:id/edit', ensureAuthUI, requireRolesUI('admin'), adminController.editRoute);
router.post('/routes/:id', ensureAuthUI, requireRolesUI('admin'), adminController.updateRoute);
// Trips create/edit (admin)
router.get('/trips/new', ensureAuthUI, requireRolesUI('admin'), adminController.newTrip);
router.post('/trips', ensureAuthUI, requireRolesUI('admin'), adminController.createTrip);
router.post('/trips/recurring', ensureAuthUI, requireRolesUI('admin'), adminController.createRecurringTrips);
router.get('/trips/:id/edit', ensureAuthUI, requireRolesUI('admin'), adminController.editTrip);
router.post('/trips/:id', ensureAuthUI, requireRolesUI('admin'), adminController.updateTrip);
router.get('/trips', ensureAuthUI, requireRolesUI('admin'), adminController.trips);
router.get('/bookings', ensureAuthUI, requireRolesUI('admin'), adminController.bookings);
router.get('/statistics', ensureAuthUI, requireRolesUI('admin'), adminController.statistics);
// Assistants create/edit
router.get('/assistants/new', ensureAuthUI, requireRolesUI('admin'), adminController.newAssistant);
router.get('/assistants/:id/edit', ensureAuthUI, requireRolesUI('admin'), adminController.editAssistant);
router.get('/assistants/:id', ensureAuthUI, requireRolesUI('admin','assistant'), adminController.assistantDetail);
router.get('/assistants', ensureAuthUI, requireRolesUI('admin'), adminController.assistants);
router.post('/assistants', ensureAuthUI, requireRolesUI('admin'), adminController.createAssistant);
router.post('/assistants/:id', ensureAuthUI, requireRolesUI('admin'), adminController.updateAssistant);

// API để xóa booking
router.delete('/bookings/:id', adminController.deleteBooking);

// API để xóa trip
router.delete('/trips/:id', adminController.deleteTrip);

// API để xóa user
router.delete('/users/:id', adminController.deleteUser);

// API để xóa bus
router.delete('/buses/:id', adminController.deleteBus);

// API để xóa route
router.delete('/routes/:id', adminController.deleteRoute);

// API để xóa assistant
router.delete('/assistants/:id', adminController.deleteAssistant);

// API để check-in hành khách
router.post('/assistants/:id/checkin', adminController.checkinPassenger);

// API để cập nhật status booking
router.put('/bookings/:id/status', adminController.updateBookingStatus);

// --- QUẢN LÝ TÀI XẾ (DRIVER) ---
router.get('/drivers', ensureAuthUI, requireRolesUI('admin'), adminController.drivers);
router.get('/drivers/new', ensureAuthUI, requireRolesUI('admin'), adminController.newDriver);
router.post('/drivers', ensureAuthUI, requireRolesUI('admin'), adminController.createDriver);
router.get('/drivers/:id', ensureAuthUI, requireRolesUI('admin','driver'), adminController.driverDetail);
router.get('/drivers/:id/edit', ensureAuthUI, requireRolesUI('admin'), adminController.editDriver);
router.post('/drivers/:id', ensureAuthUI, requireRolesUI('admin'), adminController.updateDriver);
router.delete('/drivers/:id', ensureAuthUI, requireRolesUI('admin'), adminController.deleteDriver);

// Bootstrap sample drivers & assistants

module.exports = router;

module.exports = router;


--- END OF FILE: backend\routes\adminRoutes.js ---


--- START OF FILE: backend\routes\assistantRoutes.js ---
// ...existing code...
const express = require('express');
const router = express.Router();
const assistantController = require('../controllers/assistantController');
const authMiddleware = require('../middleware/authMiddleware');

// đảm bảo authMiddleware là middleware function trước khi dùng
if (typeof authMiddleware === 'function') {
  router.use(authMiddleware);
} else if (authMiddleware && typeof authMiddleware.authenticate === 'function') {
  router.use(authMiddleware.authenticate);
} else if (authMiddleware && typeof authMiddleware.verifyToken === 'function') {
  router.use(authMiddleware.verifyToken);
} // nếu không tìm thấy function thì không đăng ký middleware (hoặc sửa middleware file)

// routes (tất cả yêu cầu xác thực nếu middleware được đăng ký)
router.get('/info', assistantController.getAssistantInfo);
router.get('/passengers', assistantController.getPassengerList);
router.post('/checkin', assistantController.checkInPassenger);
router.post('/report-seat', assistantController.reportSeatIssue);
router.post('/end-trip', assistantController.endTrip);
router.put('/rating', assistantController.updateRating);

module.exports = router;
--- END OF FILE: backend\routes\assistantRoutes.js ---


--- START OF FILE: backend\routes\authRoutes.js ---
const express = require("express");
const router = express.Router();
const authController = require("../controllers/authController");
const { protect } = require("../middleware/authMiddleware");

// Authentication routes
router.post("/register", authController.register);
router.post("/login", authController.login);
router.get("/logout", authController.logout);
router.get("/me", protect, authController.getMe);

module.exports = router;

--- END OF FILE: backend\routes\authRoutes.js ---


--- START OF FILE: backend\routes\bookingRoutes.js ---
// routes/bookingRoutes.js
const express = require('express');
const router = express.Router();

const bookingController = require('../controllers/bookingController');
const jwt = require("jsonwebtoken");
const User = require('../models/User');

// Middleware optional - nếu có token thì authenticate, không thì bỏ qua
const optionalAuth = async (req, res, next) => {
  try {
    let token;
    const authHeader = req.header("Authorization");
    if (authHeader && authHeader.startsWith("Bearer")) {
      token = authHeader.replace("Bearer ", "");
    } else if (req.cookies.token) {
      token = req.cookies.token;
    }

    if (token) {
      const decoded = jwt.verify(token, process.env.JWT_SECRET || "secretkey");
      const user = await User.findById(decoded.id).select('-password');
      if (user) {
        req.user = user;
      }
    }
  } catch (err) {
    // Ignore auth errors - continue without user
  }
  next();
};

// === Booking APIs ===

// FE bấm "Thanh toán" gọi endpoint này -> lưu Booking, Payment, cập nhật ghế
// Middleware optional - nếu có user đăng nhập thì gắn vào booking
router.post('/checkout', optionalAuth, bookingController.checkout);

// Lấy danh sách booking (tuỳ ý dùng cho "Vé của tôi" hoặc admin)
// - Nếu có user đăng nhập: tự động lấy bookings của user đó
// - Có thể truyền ?userId=... hoặc ?phone=... để lọc (cho admin)
router.get('/', optionalAuth, bookingController.listOfUser);

// Lấy chi tiết 1 booking theo id
router.get('/:id', bookingController.detail);

// Huỷ booking
router.put('/:id/cancel', bookingController.cancel);

module.exports = router;

// chưa thêm phần bên admin không được tự tiện xóa phần vé đã thanh toán của khách hàng

--- END OF FILE: backend\routes\bookingRoutes.js ---


--- START OF FILE: backend\routes\feedbackRoutes.js ---
const express = require("express");
const router = express.Router();
const feedbackController = require("../controllers/feedbackController");

router.get("/", feedbackController.getAllFeedbacks);
router.post("/", feedbackController.createFeedback);

module.exports = router;

--- END OF FILE: backend\routes\feedbackRoutes.js ---


--- START OF FILE: backend\routes\paymentRoutes.js ---
const express = require("express");
const router = express.Router();
const paymentController = require("../controllers/paymentController");
const authMiddleware = require("../middleware/authMiddleware");

router.get("/", paymentController.getAllPayments);
router.post("/", paymentController.createPayment);
router.get("/", authMiddleware, paymentController.getAllPayments);
router.post("/", authMiddleware, paymentController.createPayment);

module.exports = router;

--- END OF FILE: backend\routes\paymentRoutes.js ---


--- START OF FILE: backend\routes\routeRoutes.js ---
// routes/routeRoutes.js
const express = require('express');
const router = express.Router();
const routeController = require('../controllers/routeController');

// POST /api/routes  → tạo tuyến
router.post('/', routeController.createRoute);

// GET  /api/routes  → lấy tất cả tuyến (dùng cho "popular routes")
router.get('/', routeController.getAllRoutes);

// GET  /api/routes/detailed  → lấy tất cả tuyến với thông tin chi tiết
router.get('/detailed', routeController.getAllRoutesDetailed);

// POST /api/routes/:routeId/stops → tạo điểm dừng cho tuyến
router.post('/:routeId/stops', routeController.createStop);

// GET  /api/routes/:routeId/stops → lấy điểm dừng theo tuyến (sort by order ASC)
router.get('/:routeId/stops', routeController.getStops);

// GET /api/routes/:routeId → chi tiết tuyến (route + stops + trips summary)
router.get('/:routeId', routeController.getRouteDetail);

module.exports = router;

--- END OF FILE: backend\routes\routeRoutes.js ---


--- START OF FILE: backend\routes\ticketRoutes.js ---
const express = require("express");
const router = express.Router();
const ticketController = require("../controllers/ticketController");
const authMiddleware = require("../middleware/authMiddleware");


router.get("/", authMiddleware, ticketController.getAllTickets);
router.post("/", authMiddleware, ticketController.createTicket);

router.get("/", ticketController.getAllTickets);
router.post("/", ticketController.createTicket);

module.exports = router;

--- END OF FILE: backend\routes\ticketRoutes.js ---


--- START OF FILE: backend\routes\tripRoutes.js ---
const express = require('express');
const router = express.Router();
const Trip = require('../models/Trip');
const Bus = require('../models/Bus');
const TripSeatStatus = require('../models/TripSeatStatus');
const RouteStop = require('../models/RouteStop');
const tripController = require('../controllers/tripController');


router.get('/route/:routeId', tripController.getTripsByRoute);
router.get('/:tripId/seats', tripController.getSeatsByTrip);

router.get('/', async (req, res) => {
  const trips = await Trip.find().populate('route').populate('bus').sort({ createdAt: -1 });
  res.json(trips);
});

router.post('/', async (req, res) => {
  try {
    const trip = await Trip.create(req.body);
    const bus = await Bus.findById(trip.bus);

    const seatCount = bus?.seat_count || 0;
    const seatDocs = [];

    for (let i = 1; i <= seatCount; i++) {
      seatDocs.push({ trip: trip._id, seat_number: String(i), status: 'available' });
    }

    if (seatDocs.length) await TripSeatStatus.insertMany(seatDocs);

    res.status(201).json(trip);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
});

// GET /api/trips/:id  → lấy chi tiết chuyến + trạng thái ghế
router.get('/:id', async (req, res) => {
  try {
    const trip = await Trip.findById(req.params.id)
      .populate('route')
      .populate('bus');

    if (!trip) return res.status(404).json({ error: 'Trip not found' });

    // Lấy danh sách ghế hiện có
    let seats = await TripSeatStatus.find({ trip: trip._id }).sort({ seat_number: 1 });

    // Nếu chưa có ghế nào và trip có bus với seat_count, tự động tạo ghế
    if (seats.length === 0 && trip.bus && trip.bus.seat_count) {
      const seatCount = trip.bus.seat_count;
      const seatDocs = [];
      
      for (let i = 1; i <= seatCount; i++) {
        seatDocs.push({
          trip: trip._id,
          seat_number: String(i),
          status: 'available',
          booking_id: null
        });
      }

      if (seatDocs.length > 0) {
        await TripSeatStatus.insertMany(seatDocs);
        // Lấy lại danh sách ghế sau khi tạo
        seats = await TripSeatStatus.find({ trip: trip._id }).sort({ seat_number: 1 });
      }
    }

    // Lấy danh sách điểm dừng của tuyến
    const stops = trip.route && trip.route._id 
      ? await RouteStop.find({ route: trip.route._id }).sort({ order: 1 }).lean()
      : [];

    res.json({ trip, seats, stops });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});


module.exports = router;

--- END OF FILE: backend\routes\tripRoutes.js ---


--- START OF FILE: backend\routes\userRoutes.js ---
const express = require('express');
const router = express.Router();
const User = require('../models/User'); // ✅ Đường dẫn đúng

// create user
router.post('/', async (req, res) => {
  try {
    const u = await User.create(req.body);
    res.status(201).json(u);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
});

router.get('/', async (req, res) => {
  const users = await User.find();
  res.json(users);
});

module.exports = router;

--- END OF FILE: backend\routes\userRoutes.js ---


--- START OF FILE: backend\scripts\migrate_bookings_total.js ---
const connectDB = require('../db');
const Booking = require('../models/Booking');

(async () => {
  try {
    await connectDB();
    console.log('Starting bookings migration...');

    const res = await Booking.updateMany(
      { $or: [{ total_price: { $exists: false } }, { total_price: null }] },
      [{ $set: { total_price: { $ifNull: ['$total_price', '$total_amount'] } } }]
    );

    console.log('Migration result:', res);
    console.log('Done.');
    process.exit(0);
  } catch (err) {
    console.error('Migration error:', err);
    process.exit(1);
  }
})();

--- END OF FILE: backend\scripts\migrate_bookings_total.js ---


--- START OF FILE: backend\seed.js ---
require('dotenv').config();
const connectDB = require('./db');
const User = require('./models/User');
const Bus = require('./models/Bus');
const Route = require('./models/Route');
const RouteStop = require('./models/RouteStop');
const Trip = require('./models/Trip');
const Booking = require('./models/Booking');

(async () => {
  try {
    await connectDB();
    
    console.log('🗑️  Xóa dữ liệu cũ...');
    await User.deleteMany();
    await Bus.deleteMany();
    await Route.deleteMany();
    await RouteStop.deleteMany();
    await Trip.deleteMany();
    await Booking.deleteMany();

    console.log('👥 Tạo users...');
    // Admin
    const admin = await User.create({ 
      full_name: 'Admin Hệ Thống', 
      phone: '0901111111', 
      email: 'admin@basevex.com', 
      password_hash: '$2b$10$example', 
      role: 'admin' 
    });

    // Customers
    const customer1 = await User.create({ 
      full_name: 'Nguyễn Văn An', 
      phone: '0901234567', 
      email: 'an@gmail.com', 
      role: 'customer' 
    });
    const customer2 = await User.create({ 
      full_name: 'Trần Thị Bình', 
      phone: '0912345678', 
      email: 'binh@gmail.com', 
      role: 'customer' 
    });
    const customer3 = await User.create({ 
      full_name: 'Lê Văn Cường', 
      phone: '0923456789', 
      email: 'cuong@gmail.com', 
      role: 'customer' 
    });

    // Drivers
    const driver1 = await User.create({ 
      full_name: 'Phạm Văn Đức', 
      phone: '0934567890', 
      email: 'duc.tx@gmail.com', 
      role: 'driver' 
    });
    const driver2 = await User.create({ 
      full_name: 'Hoàng Văn Hùng', 
      phone: '0945678901', 
      email: 'hung.tx@gmail.com', 
      role: 'driver' 
    });

    // Assistants
    const assistant1 = await User.create({ 
      full_name: 'Nguyễn Thị Lan', 
      phone: '0956789012', 
      email: 'lan.phuxe@gmail.com', 
      role: 'assistant' 
    });
    const assistant2 = await User.create({ 
      full_name: 'Trần Thị Mai', 
      phone: '0967890123', 
      email: 'mai.phuxe@gmail.com', 
      role: 'assistant' 
    });

    console.log('🚌 Tạo xe buýt...');
    const buses = [];
    buses.push(await Bus.create({ 
      license_plate: '29B-12345', 
      bus_type: 'Ghế ngồi 29 chỗ có điều hòa', 
      seat_count: 29,
      active: true
    }));
    buses.push(await Bus.create({ 
      license_plate: '29B-67890', 
      bus_type: 'Giường nằm 40 chỗ có điều hòa', 
      seat_count: 40,
      active: true
    }));
    buses.push(await Bus.create({ 
      license_plate: '29B-11111', 
      bus_type: 'Ghế ngồi 45 chỗ cao cấp', 
      seat_count: 45,
      active: true
    }));
    buses.push(await Bus.create({ 
      license_plate: '30B-22222', 
      bus_type: 'Giường nằm 32 chỗ VIP', 
      seat_count: 32,
      active: true
    }));

    console.log('📍 Tạo tuyến đường...');
    
    // Route 1: Thái Nguyên - Hà Nội
    const route1 = await Route.create({ 
      name: 'Thái Nguyên - Hà Nội', 
      from_city: 'Thái Nguyên', 
      to_city: 'Hà Nội', 
      total_distance_km: 80, 
      estimated_duration_min: 120,
      active: true
    });

    await RouteStop.create({ route: route1._id, stop_name: 'Bến xe Thái Nguyên', order: 1, type: 'pickup' });
    await RouteStop.create({ route: route1._id, stop_name: 'Cầu Nhật Tân', order: 2, type: 'both' });
    await RouteStop.create({ route: route1._id, stop_name: 'Bến xe Mỹ Đình', order: 3, type: 'dropoff' });

    // Route 2: Hà Nội - Sài Gòn
    const route2 = await Route.create({ 
      name: 'Hà Nội - TP. Hồ Chí Minh', 
      from_city: 'Hà Nội', 
      to_city: 'TP. Hồ Chí Minh', 
      total_distance_km: 1700, 
      estimated_duration_min: 1440,
      active: true
    });

    await RouteStop.create({ route: route2._id, stop_name: 'Bến xe Mỹ Đình', order: 1, type: 'pickup' });
    await RouteStop.create({ route: route2._id, stop_name: 'Bến xe Vinh', order: 2, type: 'both' });
    await RouteStop.create({ route: route2._id, stop_name: 'Bến xe Nước Ngầm', order: 3, type: 'dropoff' });

    // Route 3: Hà Nội - Đà Nẵng
    const route3 = await Route.create({ 
      name: 'Hà Nội - Đà Nẵng', 
      from_city: 'Hà Nội', 
      to_city: 'Đà Nẵng', 
      total_distance_km: 760, 
      estimated_duration_min: 840,
      active: true
    });

    await RouteStop.create({ route: route3._id, stop_name: 'Bến xe Mỹ Đình', order: 1, type: 'pickup' });
    await RouteStop.create({ route: route3._id, stop_name: 'Bến xe Huế', order: 2, type: 'both' });
    await RouteStop.create({ route: route3._id, stop_name: 'Bến xe Đà Nẵng', order: 3, type: 'dropoff' });

    console.log('🕐 Tạo chuyến xe...');
    const trips = [];
    
    // Trips for Route 1
    for (let i = 0; i < 3; i++) {
      const startTime = new Date();
      startTime.setDate(startTime.getDate() + i);
      startTime.setHours(8, 0, 0, 0);
      
      const endTime = new Date(startTime);
      endTime.setHours(10, 0, 0, 0);

      trips.push(await Trip.create({ 
        route: route1._id, 
        bus: buses[0]._id, 
        start_time: startTime, 
        end_time: endTime, 
        base_price: 100000, 
        direction: 'go',
        status: 'scheduled'
      }));

      const returnStartTime = new Date(startTime);
      returnStartTime.setHours(14, 0, 0, 0);
      const returnEndTime = new Date(returnStartTime);
      returnEndTime.setHours(16, 0, 0, 0);

      trips.push(await Trip.create({ 
        route: route1._id, 
        bus: buses[0]._id, 
        start_time: returnStartTime, 
        end_time: returnEndTime, 
        base_price: 100000, 
        direction: 'return',
        status: 'scheduled'
      }));
    }

    // Trips for Route 2
    const trip2Start = new Date();
    trip2Start.setDate(trip2Start.getDate() + 1);
    trip2Start.setHours(18, 0, 0, 0);
    const trip2End = new Date(trip2Start);
    trip2End.setDate(trip2End.getDate() + 2);
    trip2End.setHours(18, 0, 0, 0);

    trips.push(await Trip.create({ 
      route: route2._id, 
      bus: buses[1]._id, 
      start_time: trip2Start, 
      end_time: trip2End, 
      base_price: 500000, 
      direction: 'go',
      status: 'scheduled'
    }));

    // Trips for Route 3
    const trip3Start = new Date();
    trip3Start.setDate(trip3Start.getDate() + 1);
    trip3Start.setHours(20, 0, 0, 0);
    const trip3End = new Date(trip3Start);
    trip3End.setDate(trip3End.getDate() + 1);
    trip3End.setHours(8, 0, 0, 0);

    trips.push(await Trip.create({ 
      route: route3._id, 
      bus: buses[2]._id, 
      start_time: trip3Start, 
      end_time: trip3End, 
      base_price: 450000, 
      direction: 'go',
      status: 'scheduled'
    }));

    console.log('🎫 Tạo đặt chỗ...');
    // Create bookings
    await Booking.create({
      user: customer1._id,
      trip: trips[0]._id,
      seat_numbers: ['A1', 'A2'],
      total_price: 200000,
      status: 'paid'
    });

    await Booking.create({
      user: customer2._id,
      trip: trips[0]._id,
      seat_numbers: ['B3'],
      total_price: 100000,
      status: 'paid'
    });

    await Booking.create({
      user: customer3._id,
      trip: trips[2]._id,
      seat_numbers: ['C5', 'C6'],
      total_price: 200000,
      status: 'completed'
    });

    await Booking.create({
      user: customer1._id,
      trip: trips[5]._id,
      seat_numbers: ['A1', 'A2', 'A3'],
      total_price: 1500000,
      status: 'pending'
    });

    await Booking.create({
      user: customer2._id,
      trip: trips[6]._id,
      seat_numbers: ['D1', 'D2'],
      total_price: 900000,
      status: 'paid'
    });

    console.log('✅ Seed hoàn tất!');
    console.log(`- ${await User.countDocuments()} users`);
    console.log(`- ${await Bus.countDocuments()} buses`);
    console.log(`- ${await Route.countDocuments()} routes`);
    console.log(`- ${await Trip.countDocuments()} trips`);
    console.log(`- ${await Booking.countDocuments()} bookings`);
    
    process.exit(0);
  } catch (err) {
    console.error('❌ Lỗi seed:', err);
    process.exit(1);
  }
})();

--- END OF FILE: backend\seed.js ---


--- START OF FILE: backend\server.js ---
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const cookieParser = require('cookie-parser');
const path = require('path');
const connectDB = require('./db');

// routes
const userRoutes = require('./routes/userRoutes');
const routeRoutes = require('./routes/routeRoutes');
const tripRoutes = require('./routes/tripRoutes');
const bookingRoutes = require('./routes/bookingRoutes');
const adminRoutes = require('./routes/adminRoutes');
const authRoutes = require('./routes/authRoutes');
const assistantRoutes = require('./routes/assistantRoutes');

const app = express();


app.use(cors({
  origin: ['http://localhost:5173', 'http://localhost:3000'],
  credentials: true
}));

app.use(express.json());
app.use(cookieParser());

app.use(express.urlencoded({ extended: true }));


app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));

// connect
connectDB();


require('./models/RouteStop');        
require('./models/TripSeatStatus');   
// Contact model
const Contact = require('./models/Contact');

// API routes
app.use('/api/auth', authRoutes);
app.use('/api/users', userRoutes);
app.use('/api/routes', routeRoutes);
app.use('/api/trips', tripRoutes);
app.use('/api/bookings', bookingRoutes);
app.use('/api/assistant', assistantRoutes);


const crypto = require('crypto');
const { sendContactEmail } = require('./utils/mailer');
app.post('/contact', async (req, res) => {
  try {
    const { name, email, phone, subject, message } = req.body || {};
    if (!name || !email || !subject || !message) {
      return res.status(400).json({ success: false, error: 'Thiếu dữ liệu bắt buộc' });
    }

    // Tạo token công khai để khách có thể xem thread sau khi gửi
    const token = crypto.randomBytes(24).toString('hex');
    const tokenExpires = new Date(Date.now() + 1000 * 60 * 60 * 24 * 7); // 7 days

    // Lưu contact vào DB trước
    const contact = new Contact({ name, email, phone, subject, message, publicToken: token, tokenExpires });
    await contact.save();

    // gửi email tới support (không block nếu lỗi gửi)
    try {
      const info = await sendContactEmail({
        fromName: name,
        fromEmail: email,
        fromPhone: phone,
        subject,
        message,
        to: process.env.SUPPORT_EMAIL || 'vexe7tv@gmail.com',
        contactId: contact._id,
        token
      });
      if (info && info.messageId) {
        contact.sent = true;
        contact.sentAt = new Date();
        contact.messageId = info.messageId;
      }
      await contact.save();
    } catch (sendErr) {
      console.error('Contact saved but mail send failed:', sendErr && sendErr.message ? sendErr.message : sendErr);
      contact.sendError = (sendErr && sendErr.message) ? sendErr.message : String(sendErr);
      await contact.save();
    }

    // trả về contactId và token cho frontend để khách truy cập trang xem
    return res.json({ success: true, message: 'Đã gửi liên hệ thành công', contactId: contact._id, token });
  } catch (err) {
    console.error('Error /contact:', err);
    return res.status(500).json({ success: false, error: 'Lỗi khi gửi liên hệ' });
  }
});

// Public endpoint: lấy contact theo id + token (dùng cho khách không đăng nhập)
app.get('/public/contacts/:id', async (req, res) => {
  try {
    const id = req.params.id;
    const token = req.query.token;
    if (!id || !token) return res.status(400).json({ success: false, error: 'Missing id or token' });
    const contact = await Contact.findById(id).lean();
    if (!contact) return res.status(404).json({ success: false, error: 'Not found' });
    if (!contact.publicToken || contact.publicToken !== token) return res.status(403).json({ success: false, error: 'Invalid token' });
    if (contact.tokenExpires && new Date(contact.tokenExpires) < new Date()) return res.status(403).json({ success: false, error: 'Token expired' });

    // trả về thông tin cần thiết (loại trừ sendError nếu bạn muốn)
    return res.json({ success: true, contact: {
      _id: contact._id,
      name: contact.name,
      email: contact.email,
      phone: contact.phone,
      subject: contact.subject,
      message: contact.message,
      sent: contact.sent,
      sentAt: contact.sentAt,
      messageId: contact.messageId,
      replies: contact.replies || [],
      createdAt: contact.createdAt
    }});
  } catch (e) {
    console.error('Error GET /public/contacts/:id', e);
    return res.status(500).json({ success: false, error: 'Server error' });
  }
});

// Public endpoint: mark contact as replied (clicked from support Gmail link)
app.get('/public/contacts/:id/mark-replied', async (req, res) => {
  try {
    const id = req.params.id;
    const token = req.query.token;
    if (!id || !token) return res.status(400).send('Missing id or token');
    const contact = await Contact.findById(id);
    if (!contact) return res.status(404).send('Not found');
    if (!contact.publicToken || contact.publicToken !== token) return res.status(403).send('Invalid token');
    if (contact.tokenExpires && new Date(contact.tokenExpires) < new Date()) return res.status(403).send('Token expired');

    // Push a generic reply entry indicating admin replied via Gmail
    const reply = {
      adminName: 'Hỗ trợ VeXe7TV',
      message: 'Phản hồi đã được gửi qua Gmail. Vui lòng kiểm tra hộp thư của bạn.',
      createdAt: new Date()
    };
    contact.replies = contact.replies || [];
    contact.replies.push(reply);
    contact.sent = true;
    contact.sentAt = new Date();
    await contact.save();

    // Simple HTML response for admin who clicked the link
    return res.send('<html><body><h3>Ghi nhận phản hồi thành công</h3><p>Phản hồi đã được ghi nhận trên hệ thống. Khách hàng sẽ thấy thông báo trên trang Liên hệ.</p></body></html>');
  } catch (e) {
    console.error('Error mark-replied:', e);
    return res.status(500).send('Server error');
  }
});

// Admin EJS routes
app.use('/admin', adminRoutes);

// static / health
app.get('/', (req, res) => res.send('BaseVeXe backend running'));

// error handler (basic)
app.use((err, req, res, next) => {
  console.error(err);
  res.status(500).json({ error: err.message || 'Server error' });
});

const PORT = process.env.PORT || 5000;
app.listen(PORT, () => console.log(`Server started on port ${PORT}`));
--- END OF FILE: backend\server.js ---


--- START OF FILE: backend\utils\mailer.js ---
const nodemailer = require('nodemailer');


async function createTransporter() {
  const host = process.env.SMTP_HOST;
  const port = Number(process.env.SMTP_PORT || 587);
  const user = (process.env.SMTP_USER || '').trim();
  const pass = (process.env.SMTP_PASS || '').replace(/\s+/g, ''); // Gmail app password: remove spaces

  if (!host || !user || !pass) {
    // Fallback: Ethereal test account (for development/demo)
    if (String(process.env.USE_ETHEREAL || 'false').toLowerCase() === 'true') {
      try {
        const testAccount = await nodemailer.createTestAccount();
        const etherealTransport = nodemailer.createTransport({
          host: 'smtp.ethereal.email',
          port: 587,
          secure: false,
          auth: { user: testAccount.user, pass: testAccount.pass }
        });
        console.log('[mailer] Using Ethereal test SMTP. Emails will NOT deliver to real inbox.');
        return etherealTransport;
      } catch (e) {
        console.warn('[mailer] Failed to init Ethereal transport:', e.message);
        return null;
      }
    }
    return null;
  }

  const transport = nodemailer.createTransport({
    host,
    port,
    secure: port === 465, // true for 465, false for other ports
    auth: { user, pass }
  });
  console.log('[mailer] Using real SMTP host:', host, 'port:', port);
  return transport;
}

let transporterPromise = null;
function getTransporter() {
  if (!transporterPromise) transporterPromise = createTransporter();
  return transporterPromise;
}

async function sendMail({ to, subject, html, text, replyTo }) {
  const transporter = await getTransporter();
  if (!transporter) {
    console.log('[mailer] Transporter not configured. Skip sending to:', to);
    return { skipped: true };
  }
  const from = process.env.MAIL_FROM || process.env.SMTP_USER;
  const mailOptions = { from, to, subject, html, text };
  if (replyTo) mailOptions.replyTo = replyTo;
  const info = await transporter.sendMail(mailOptions);
  // Log messageId and SMTP response for easier delivery verification
  try {
    if (info && info.messageId) console.log('[mailer] Sent messageId:', info.messageId);
    if (info && info.response) console.log('[mailer] SMTP response:', info.response);
  } catch (e) {
    console.warn('[mailer] Warning logging send result:', e && e.message ? e.message : e);
  }
  const preview = nodemailer.getTestMessageUrl(info);
  if (preview) {
    console.log('[mailer] Preview URL:', preview);
  }
  return info;
}

function renderBookingHtml(bookingSummary) {
  const {
    route,
    times,
    seats,
    passenger,
    totalAmount,
    paymentMethod,
    bookingId,
    paymentId,
  } = bookingSummary || {};

  return `
    <div style="font-family: Arial, sans-serif; line-height: 1.6;">
      <h2>Thanh toán thành công</h2>
      <p>Cảm ơn bạn đã đặt vé. Dưới đây là thông tin chi tiết:</p>
      <ul>
        <li><strong>Mã đặt chỗ:</strong> ${bookingId || '-'}</li>
        <li><strong>Mã thanh toán:</strong> ${paymentId || '-'}</li>
        <li><strong>Tuyến:</strong> ${(route?.from || '-') + ' → ' + (route?.to || '-')}</li>
        <li><strong>Thời gian:</strong> Khởi hành ${times?.departureTime ? new Date(times.departureTime).toLocaleString('vi-VN') : '-'}${times?.arrivalTime ? `, Đến ${new Date(times.arrivalTime).toLocaleString('vi-VN')}` : ''}</li>
        <li><strong>Ghế:</strong> ${(seats || []).join(', ') || '-'}</li>
        <li><strong>Hành khách:</strong> ${(passenger?.name || '-')}, ${passenger?.phone || '-'}</li>
        <li><strong>Tổng tiền:</strong> ${(Number(totalAmount || 0)).toLocaleString('vi-VN')}₫</li>
        <li><strong>Phương thức:</strong> ${paymentMethod || '-'}</li>
      </ul>
      <p>Chúc bạn có chuyến đi an toàn và thoải mái!</p>
    </div>
  `;
}

async function sendBookingConfirmationEmail(to, bookingSummary) {
  if (!to) return;
  const subject = 'Xác nhận thanh toán & đặt vé thành công';
  const html = renderBookingHtml(bookingSummary);
  const text = `Thanh toán thành công. Mã đặt chỗ: ${bookingSummary?.bookingId || ''}.`;
  try {
    await sendMail({ to, subject, html, text });
  } catch (e) {
    console.error('[mailer] sendBookingConfirmationEmail error:', e);
  }
}

module.exports = {
  sendBookingConfirmationEmail,
};

// Gửi email từ form liên hệ (contact)
async function sendContactEmail({ fromName, fromEmail, fromPhone, subject, message, to, contactId, token }) {
  if (!to) to = process.env.SUPPORT_EMAIL || 'vexe7tv@gmail.com';
  const fullSubject = `[Liên hệ khách hàng] ${subject || '(Không có chủ đề)'} `;
  const serverUrl = process.env.SERVER_URL || `http://localhost:${process.env.PORT || 5000}`;
  const markLink = contactId && token ? `${serverUrl}/public/contacts/${contactId}/mark-replied?token=${encodeURIComponent(token)}` : null;
  const html = `
    <div style="font-family:Arial,Helvetica,sans-serif;line-height:1.6">
      <h2>Thông báo Liên hệ mới</h2>
      <p><strong>Người gửi:</strong> ${fromName || '-'} &lt;${fromEmail || '-'}&gt;</p>
      <p><strong>Số điện thoại:</strong> ${fromPhone || '-'}</p>
      <p><strong>Chủ đề:</strong> ${subject || '-'}</p>
      <hr />
      <div>${(message || '').replace(/\n/g, '<br/>')}</div>
      ${markLink ? `<hr/><p><a href="${markLink}">Đã trả lời qua Gmail? Nhấn vào đây để ghi nhận trên website</a></p>` : ''}
    </div>
  `;
  const text = `Liên hệ mới từ ${fromName || '-'} <${fromEmail || '-'}>\n\n${message || ''}`;
  try {
    return await sendMail({ to, subject: fullSubject, html, text, replyTo: fromEmail });
  } catch (e) {
    console.error('[mailer] sendContactEmail error:', e.message || e);
    throw e;
  }
}

module.exports.sendContactEmail = sendContactEmail;

// Gửi reply (admin -> khách) với template HTML đẹp hơn
async function sendReplyEmail({ to, subject, replyFromName, replyFromEmail, message, original }) {
  if (!to) throw new Error('Missing recipient');
  const from = process.env.MAIL_FROM || process.env.SMTP_USER;
  const headerName = replyFromName || (from && from.split('<')[0].trim()) || 'VeXe7TV';
  const safeSubject = subject || 'Trả lời từ VeXe7TV';

  const html = `
    <html>
    <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <style>
        body{font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif;background:#f6f8fb;margin:0;padding:20px}
        .container{max-width:680px;margin:0 auto;background:#ffffff;border-radius:8px;overflow:hidden;box-shadow:0 6px 20px rgba(18,38,63,0.08)}
        .header{background:linear-gradient(90deg,#6366f1,#4f46e5);color:#fff;padding:18px}
        .header h1{margin:0;font-size:18px}
        .content{padding:20px;color:#0f172a}
        .greeting{font-size:16px;margin-bottom:12px}
        .reply-box{background:#f8fafc;border:1px solid #eef2ff;padding:16px;border-radius:6px;color:#0f172a;margin-bottom:16px}
        .original{border-left:4px solid #e6edf8;padding:12px 16px;background:#fbfdff;color:#334155;border-radius:6px}
        .meta{font-size:13px;color:#64748b;margin-bottom:6px}
        .footer{padding:16px;background:#fafafa;border-top:1px solid #f1f5f9;font-size:13px;color:#475569}
        a.button{display:inline-block;padding:10px 16px;background:#4f46e5;color:#fff;border-radius:6px;text-decoration:none}
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>${headerName} trả lời bạn</h1>
        </div>
        <div class="content">
          <div class="greeting">Xin chào,</div>
          <div class="meta">Nội dung trả lời từ <strong>${headerName}</strong> — <em>${new Date().toLocaleString('vi-VN')}</em></div>
          <div class="reply-box">${(message || '').replace(/\n/g, '<br/>')}</div>

          ${original ? `<div style="margin-bottom:8px;color:#64748b;font-size:13px">Nội dung gốc:</div>
            <div class="original">${original.replace(/\n/g, '<br/>')}</div>` : ''}

          <div style="margin-top:18px">Trân trọng,<br/><strong>${headerName}</strong></div>
        </div>
        <div class="footer">Bạn đang nhận mail từ VeXe7TV — vui lòng không trả lời vào địa chỉ này nếu bạn không thấy phần trả lời; thay vào đó hãy gửi tới email hỗ trợ: <a href="mailto:${process.env.SUPPORT_EMAIL || process.env.SMTP_USER}">${process.env.SUPPORT_EMAIL || process.env.SMTP_USER}</a></div>
      </div>
    </body>
    </html>
  `;

  const text = (message || '') + (original ? '\n\n----Original message----\n' + original : '');

  // gửi với Reply-To là replyFromEmail nếu có
  return await sendMail({ to, subject: safeSubject, html, text, replyTo: replyFromEmail || process.env.MAIL_FROM });
}

module.exports.sendReplyEmail = sendReplyEmail;



--- END OF FILE: backend\utils\mailer.js ---


--- START OF FILE: backend\utils\send_test_email.js ---
const { sendBookingConfirmationEmail } = require('./mailer');

async function main() {
  const to = process.argv[2];
  if (!to) {
    console.error('Usage: node send_test_email.js recipient@example.com');
    process.exit(1);
  }

  const samplePayload = {
    bookingId: 'TEST123456',
    paymentId: 'PAY123456',
    route: { from: 'Hà Nội', to: 'Hồ Chí Minh', durationMin: 1800 },
    times: { departureTime: new Date(), arrivalTime: new Date(Date.now() + 1000 * 60 * 60 * 12) },
    bus: { busType: 'Sleeper', seatCount: 40 },
    seats: [1, 2],
    passenger: { name: 'Người dùng thử', phone: '0900000000' },
    pricePerSeat: 200000,
    totalAmount: 400000,
    paymentMethod: 'banking'
  };

  try {
    const info = await sendBookingConfirmationEmail(to, samplePayload);
    console.log('Send test email: done', info || 'skipped');
  } catch (e) {
    console.error('Send test email error:', e);
    process.exit(2);
  }
}

main();

--- END OF FILE: backend\utils\send_test_email.js ---


--- START OF FILE: backend\views\admin\assistants.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistants Management - VeXe7TV Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --white: #ffffff;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--dark);
        }
        
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-xl);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .sidebar-header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .sidebar-nav {
            padding: 1.5rem 0;
        }
        
        .nav-item {
            display: block;
            padding: 0.875rem 1.5rem;
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            margin: 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .nav-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-left-color: var(--primary);
            color: var(--primary);
            transform: translateX(4px);
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.15) 0%, transparent 100%);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .page-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .page-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            padding: 1.75rem;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--warning), #fbbf24);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--warning), #fbbf24);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .stat-card h3 {
            color: var(--gray);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
        }
        
        .content-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
        }
        
        .content-card h2 {
            margin: 0 0 1.5rem 0;
            color: var(--dark);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--light);
        }
        
        th {
            padding: 1rem 1.25rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--gray-light);
        }
        
        td {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-light);
            color: var(--dark);
        }
        
        tbody tr {
            transition: all 0.2s ease;
        }
        
        tbody tr:hover {
            background: var(--light);
            transform: scale(1.01);
        }
        
        .badge {
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        .badge-info {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        .empty-state p {
            color: var(--gray);
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>🚌 VeXe7TV</h1>
                <p>Trang quản trị</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin" class="nav-item">
                    <span>📊</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/users" class="nav-item">
                    <span>👥</span>
                    <span>Users</span>
                </a>
                <a href="/admin/assistants" class="nav-item <%= page === 'assistants' ? 'active' : '' %>">
                    <span>👷</span>
                    <span>Lơ xe</span>
                </a>
                <a href="/admin/drivers" class="nav-item <%= page === 'drivers' ? 'active' : '' %>">
                    <span>🚐</span> 
                    <span>Tài xế</span>
                </a>
                <a href="/admin/buses" class="nav-item">
                    <span>🚌</span>
                    <span>Buses</span>
                </a>
                <a href="/admin/routes" class="nav-item">
                    <span>📍</span>
                    <span>Routes</span>
                </a>
                <a href="/admin/trips" class="nav-item">
                    <span>🕐</span>
                    <span>Trips</span>
                </a>
                <a href="/admin/bookings" class="nav-item">
                    <span>🎫</span>
                    <span>Bookings</span>
                </a>
                <a href="/admin/statistics" class="nav-item">
                    <span>📈</span>
                    <span>Statistics</span>
                </a>
                <a href="/" class="nav-item" style="margin-top: 2rem; border-top: 1px solid var(--gray-light); padding-top: 1.5rem;">
                    <span>🏠</span>
                    <span>Về trang chủ</span>
                </a>
            </nav>
        </aside>
        
        <main class="main-content">
            <div class="page-header">
                <div>
                    <h2>Quản lý Phụ xe</h2>
                    <p>Quản lý tất cả phụ xe trong hệ thống</p>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Tổng số phụ xe</h3>
                            <div class="value"><%= stats.total %></div>
                        </div>
                        <div class="stat-card-icon">👷</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Đang hoạt động</h3>
                            <div class="value"><%= stats.active %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--success), #34d399);">✅</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Có tuyến</h3>
                            <div class="value"><%= stats.withRoutes %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--info), #60a5fa);">📍</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Chưa có tuyến</h3>
                            <div class="value"><%= stats.withoutRoutes %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--gray), #94a3b8);">⏸️</div>
                    </div>
                </div>
            </div>
            
            <div class="content-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">Danh sách Phụ xe</h2>
                <div>
                    <a href="/admin/assistants/new" class="btn btn-primary" style="padding: 0.5rem 1rem; text-decoration: none;">
                        ➕ Thêm Phụ xe
                    </a>
                </div>
            </div>
            <% if (assistants.length === 0) { %>
                    <div class="empty-state">
                        <div class="empty-state-icon">👷</div>
                        <h3>Chưa có phụ xe nào</h3>
                        <p>Hãy thêm phụ xe mới vào hệ thống</p>
                    </div>
                <% } else { %>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Họ tên</th>
                                    <th>Email</th>
                                    <th>SĐT</th>
                                    <th>Mã NV</th>
                                    <th>Kinh nghiệm</th>
                                    <th>Số chuyến</th>
                                    <th>Ngày tạo</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% assistants.forEach(function(assistant) { %>
                                    <tr>
                                        <td><strong><%= assistant.name %></strong></td>
                                        <td><%= assistant.email || '-' %></td>
                                        <td><%= assistant.phone || '-' %></td>
                                        <td>
                                            <span class="badge badge-info">
                                                <%= assistant.employee_id || 'N/A' %>
                                            </span>
                                        </td>
                                        <td>
                                            <%= assistant.experience_years || 0 %> năm
                                        </td>
                                        <td>
                                            <% 
                                                const routesCount = assistant.assigned_routes ? assistant.assigned_routes.length : 0;
                                                const tripsCount = assistant.assigned_trips ? assistant.assigned_trips.length : 0;
                                                const totalCount = routesCount + tripsCount;
                                            %>
                                            <span class="badge <%= totalCount > 0 ? 'badge-success' : 'badge-warning' %>">
                                                <%= routesCount > 0 ? routesCount + ' tuyến' : (tripsCount > 0 ? tripsCount + ' chuyến (cũ)' : 'Chưa gán') %>
                                            </span>
                                        </td>
                                        <td><%= new Date(assistant.createdAt).toLocaleString('vi-VN') %></td>
                                        <td>
                                            <a href="/admin/assistants/<%= assistant._id %>" class="btn" style="padding: 0.5rem 1rem; margin-right: 0.5rem; background: var(--info); color: white;">👁️ Chi tiết</a>
                                            <a href="/admin/assistants/<%= assistant._id %>/edit" class="btn btn-warning" style="padding: 0.5rem 1rem; margin-right: 0.5rem;">✏️ Sửa</a>
                                            <button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="deleteAssistant('<%= assistant._id %>')">🗑️ Xóa</button>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } %>
            </div>
        </main>
    </div>
    
    <script>
        async function deleteAssistant(id) {
            if (!confirm('Bạn có chắc muốn xóa phụ xe này?')) return;
            try {
                const response = await fetch(`/admin/assistants/${id}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    alert('Đã xóa phụ xe thành công');
                    location.reload();
                }
            } catch (error) {
                alert('Lỗi: ' + error.message);
            }
        }
    </script>
</body>
</html>


--- END OF FILE: backend\views\admin\assistants.ejs ---


--- START OF FILE: backend\views\admin\assistant_detail.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết Phụ xe - VeXe7TV Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --white: #ffffff;
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--dark);
        }
        
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-lg);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .sidebar-nav {
            padding: 1.5rem 0;
        }
        
        .nav-item {
            display: block;
            padding: 0.875rem 1.5rem;
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            margin: 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .nav-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-left-color: var(--primary);
            color: var(--primary);
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.15) 0%, transparent 100%);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .page-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background: var(--gray-light);
            color: var(--dark);
        }
        
        .info-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
        }
        
        .info-card h3 {
            margin-bottom: 1.5rem;
            color: var(--dark);
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            padding: 1.75rem;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--warning), #fbbf24);
        }
        
        .stat-card h4 {
            color: var(--gray);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--light);
        }
        
        th {
            padding: 1rem 1.25rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.875rem;
            text-transform: uppercase;
            border-bottom: 2px solid var(--gray-light);
        }
        
        td {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-light);
            color: var(--dark);
        }
        
        tbody tr:hover {
            background: var(--light);
        }
        
        .badge {
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        
        .badge-info {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>🚌 VeXe7TV</h1>
                <p>Trang quản trị</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin" class="nav-item">
                    <span>📊</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/users" class="nav-item">
                    <span>👥</span>
                    <span>Users</span>
                </a>
                <a href="/admin/assistants" class="nav-item <%= page === 'assistants' ? 'active' : '' %>">
                    <span>👷</span>
                    <span>Lơ xe</span>
                </a>
                <a href="/admin/drivers" class="nav-item <%= page === 'drivers' ? 'active' : '' %>">
                    <span>🚐</span> 
                    <span>Tài xế</span>
                </a>
                <a href="/admin/buses" class="nav-item">
                    <span>🚌</span>
                    <span>Buses</span>
                </a>
                <a href="/admin/routes" class="nav-item">
                    <span>📍</span>
                    <span>Routes</span>
                </a>
                <a href="/admin/trips" class="nav-item">
                    <span>🕐</span>
                    <span>Trips</span>
                </a>
                <a href="/admin/bookings" class="nav-item">
                    <span>🎫</span>
                    <span>Bookings</span>
                </a>
                <a href="/admin/statistics" class="nav-item">
                    <span>📈</span>
                    <span>Statistics</span>
                </a>
                <a href="/" class="nav-item" style="margin-top: 2rem; border-top: 1px solid var(--gray-light); padding-top: 1.5rem;">
                    <span>🏠</span>
                    <span>Về trang chủ</span>
                </a>
            </nav>
        </aside>
        
        <main class="main-content">
            <div class="page-header">
                <div>
                    <h2>Chi tiết Phụ xe</h2>
                    <p style="color: rgba(255, 255, 255, 0.9);"><%= assistant.name %></p>
                </div>
                <div>
                    <a href="/admin/assistants" class="btn btn-secondary">← Quay lại</a>
                    <a href="/admin/assistants/<%= assistant._id %>/edit" class="btn btn-primary">✏️ Sửa</a>
                </div>
            </div>
            
            <!-- Thông tin cơ bản -->
            <div class="info-card">
                <h3>Thông tin cơ bản</h3>
                <div class="info-grid">
                    <div>
                        <strong>Họ tên:</strong> <%= assistant.name %>
                    </div>
                    <div>
                        <strong>Email:</strong> <%= assistant.email %>
                    </div>
                    <div>
                        <strong>Số điện thoại:</strong> <%= assistant.phone %>
                    </div>
                    <div>
                        <strong>Mã nhân viên:</strong> <%= assistant.employee_id || 'N/A' %>
                    </div>
                    <div>
                        <strong>Số giấy phép:</strong> <%= assistant.license_number || 'N/A' %>
                    </div>
                    <div>
                        <strong>Kinh nghiệm:</strong> <%= assistant.experience_years || 0 %> năm
                    </div>
                    <div>
                        <strong>Trạng thái:</strong>
                        <span class="badge <%= assistant.status === 'active' ? 'badge-success' : 'badge-warning' %>">
                            <%= assistant.status === 'active' ? 'Đang hoạt động' : 'Không hoạt động' %>
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Thống kê -->
            <div class="info-grid">
                <div class="stat-card">
                    <h4>Tổng Check-in</h4>
                    <div class="value"><%= stats.totalCheckins %></div>
                </div>
                <div class="stat-card">
                    <h4>Đã Check-in</h4>
                    <div class="value" style="color: var(--success);"><%= stats.checkedInCount %></div>
                </div>
                <div class="stat-card">
                    <h4>Không đến (No-show)</h4>
                    <div class="value" style="color: var(--danger);"><%= stats.noShowCount %></div>
                </div>
                <div class="stat-card">
                    <h4>Tỷ lệ thành công</h4>
                    <div class="value" style="color: var(--info);"><%= stats.checkinRate %>%</div>
                </div>
                <div class="stat-card">
                    <h4>Tuyến được gán</h4>
                    <div class="value"><%= stats.assignedRoutesCount %></div>
                </div>
                <div class="stat-card">
                    <h4>Chờ Check-in</h4>
                    <div class="value" style="color: var(--warning);"><%= stats.pendingCheckins %></div>
                </div>
            </div>
            
            <!-- Danh sách tuyến được gán -->
            <% if (assistant.assigned_routes && assistant.assigned_routes.length > 0) { %>
                <div class="info-card">
                    <h3>Tuyến được gán (<%= assistant.assigned_routes.length %>)</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tuyến</th>
                                    <th>Khoảng cách</th>
                                    <th>Thời gian ước tính</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% assistant.assigned_routes.forEach(function(route) { %>
                                    <tr>
                                        <td>
                                            <strong><%= (route.origin || route.from_city) + ' → ' + (route.destination || route.to_city) %></strong>
                                        </td>
                                        <td>
                                            <%= route.total_distance_km ? route.total_distance_km + ' km' : 'N/A' %>
                                    </td>
                                        <td>
                                            <%= route.estimated_duration_min ? route.estimated_duration_min + ' phút' : 'N/A' %>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                    <p style="margin-top: 1rem; color: var(--gray); font-size: 0.875rem;">
                        <strong>Lưu ý:</strong> Phụ xe này sẽ check-in hành khách cho tất cả các chuyến thuộc các tuyến trên.
                    </p>
                </div>
            <% } else if (assistant.assigned_trips && assistant.assigned_trips.length > 0) { %>
                <!-- Hiển thị trips nếu chưa có routes (tương thích ngược) -->
                <div class="info-card">
                    <h3>Chuyến được gán (<%= assistant.assigned_trips.length %>) - Cũ</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tuyến</th>
                                    <th>Xe</th>
                                    <th>Thời gian khởi hành</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% assistant.assigned_trips.forEach(function(trip) { %>
                                    <tr>
                                        <td>
                                            <%= trip.route ? (trip.route.origin || trip.route.from_city) + ' → ' + (trip.route.destination || trip.route.to_city) : 'N/A' %>
                                        </td>
                                        <td>
                                            <%= trip.bus ? trip.bus.license_plate : 'N/A' %>
                                        </td>
                                        <td>
                                            <%= new Date(trip.start_time).toLocaleString('vi-VN') %>
                                        </td>
                                        <td>
                                            <span class="badge <%= trip.status === 'completed' ? 'badge-success' : trip.status === 'departed' ? 'badge-info' : trip.status === 'cancelled' ? 'badge-danger' : 'badge-warning' %>">
                                                <%= trip.status === 'scheduled' ? 'Đã lên lịch' : trip.status === 'departed' ? 'Đã khởi hành' : trip.status === 'completed' ? 'Đã hoàn thành' : trip.status === 'cancelled' ? 'Đã hủy' : trip.status %>
                                            </span>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            <% } else { %>
                <div class="info-card">
                    <h3>Tuyến được gán</h3>
                    <p style="color: var(--gray); text-align: center; padding: 2rem;">Chưa được gán tuyến nào. Vui lòng chỉnh sửa để gán tuyến cho phụ xe.</p>
                </div>
            <% } %>
            
            <!-- Danh sách Booking - Quản lý Check-in -->
            <% if (allBookings && allBookings.length > 0) { %>
                <div class="info-card">
                    <h3>Danh sách Hành khách - Quản lý Lên/Xuống xe (<%= allBookings.length %>)</h3>
                    <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Hành khách</th>
                                <th>Ghế</th>
                                <th>Chuyến</th>
                                <th>Thời gian</th>
                                <th>Trạng thái</th>
                                </tr>
                        </thead>
                        <tbody>
                            <% allBookings.forEach(function(item) { %>
                                <tr>
                                    <td>
                                        <strong><%= item.booking.passenger ? item.booking.passenger.name : (item.booking.user ? item.booking.user.name : 'N/A') %></strong><br>
                                        <small style="color: var(--gray);">
                                            <%= item.booking.passenger ? item.booking.passenger.phone : (item.booking.user ? item.booking.user.phone : '') %>
                                        </small>
                                    </td>
                                    <td>
                                        <%= item.booking.seat_numbers ? item.booking.seat_numbers.join(', ') : 'N/A' %>
                                    </td>
                                    <td>
                                        <%= item.trip.route ? (item.trip.route.origin || item.trip.route.from_city) + ' → ' + (item.trip.route.destination || item.trip.route.to_city) : 'N/A' %>
                                    </td>
                                    <td>
                                        <%= new Date(item.booking.start_time).toLocaleString('vi-VN') %>
                                    </td>
                                    <td style="text-align: center;">
                                        <% if (item.checkin && item.checkin.status === 'checked_in') { %>
                                            <span class="badge badge-success">✅ Đã lên xe</span>
                                            <br><small><%= new Date(item.checkin.checkin_time).toLocaleTimeString('vi-VN') %></small>
                                        <% } else if (item.checkin && item.checkin.status === 'no_show') { %>
                                            <span class="badge badge-danger">❌ Vắng mặt</span>
                                        <% } else { %>
                                            <span class="badge badge-warning">⏳ Chưa đón</span>
                                        <% } %>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
                </div>
            <% } else { %>
                <div class="info-card">
                    <h3>Danh sách Hành khách</h3>
                    <p style="color: var(--gray); text-align: center; padding: 2rem;">Chưa có booking nào cho các chuyến được gán</p>
                </div>
            <% } %>
            
            <!-- Lịch sử check-in -->
            <% if (checkins && checkins.length > 0) { %>
                <div class="info-card">
                    <h3>Lịch sử Check-in (50 gần nhất)</h3>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Hành khách</th>
                                    <th>Chuyến</th>
                                    <th>Thời gian check-in</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% checkins.forEach(function(checkin) { %>
                                    <tr>
                                        <td>
                                            <%= checkin.booking && checkin.booking.passenger ? checkin.booking.passenger.name : (checkin.booking && checkin.booking.user ? checkin.booking.user.name : 'N/A') %>
                                        </td>
                                        <td>
                                            <%= checkin.booking && checkin.booking.trip && checkin.booking.trip.route ? (checkin.booking.trip.route.origin || checkin.booking.trip.route.from_city) + ' → ' + (checkin.booking.trip.route.destination || checkin.booking.trip.route.to_city) : 'N/A' %>
                                        </td>
                                        <td>
                                            <%= checkin.checkin_time ? new Date(checkin.checkin_time).toLocaleString('vi-VN') : 'N/A' %>
                                        </td>
                                        <td>
                                            <span class="badge <%= checkin.status === 'checked_in' ? 'badge-success' : 'badge-danger' %>">
                                                <%= checkin.status === 'checked_in' ? 'Đã check-in' : 'Không đến' %>
                                            </span>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            <% } else { %>
                <div class="info-card">
                    <h3>Lịch sử Check-in</h3>
                    <p style="color: var(--gray); text-align: center; padding: 2rem;">Chưa có lịch sử check-in nào</p>
                </div>
            <% } %>
        </main>
    </div>
    
    <script>
        async function checkinPassenger(assistantId, bookingId, status) {
            if (!confirm(status === 'checked_in' ? 'Xác nhận hành khách đã lên xe?' : 'Xác nhận hành khách không đến?')) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/assistants/${assistantId}/checkin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bookingId: bookingId,
                        status: status
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message);
                    location.reload(); // Reload để cập nhật trạng thái
                } else {
                    alert('Lỗi: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi check-in');
            }
        }
    </script>
</body>
</html>


--- END OF FILE: backend\views\admin\assistant_detail.ejs ---


--- START OF FILE: backend\views\admin\assistant_form.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= assistant ? 'Sửa phụ xe' : 'Thêm phụ xe mới' %> - Admin</title>
  <style>
    body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:#f5f7fa;color:#333}
    .container{max-width:800px;margin:3rem auto;background:white;padding:2rem;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
    h2{margin-bottom:1.5rem;color:#1e3a8a}
    label{display:block;margin-top:1rem;font-weight:600;color:#374151}
    
    input[type=text], input[type=email], input[type=tel], input[type=number], select {
      width:100%; padding:0.75rem; border:1px solid #e5e7eb; border-radius:6px; font-size:0.95rem; margin-top: 0.25rem;
    }
    
    input:focus, select:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.1)}
    
    /* Style cho thông báo lỗi */
    .error-msg { color: #dc2626; font-size: 0.85rem; margin-top: 0.25rem; display: none; }
    .input-error { border-color: #dc2626 !important; background-color: #fef2f2; }

    .form-group{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .trips-section{margin-top:2rem;padding-top:2rem;border-top:2px solid #e5e7eb}
    .trips-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));gap:0.75rem;margin-top:1rem;max-height:300px;overflow-y:auto;padding:1rem;background:#f9fafb;border-radius:6px}
    .trip-item{display:flex;align-items:center;gap:0.5rem}
    .trip-item input[type=checkbox]{width:auto}
    .actions{margin-top:2rem;display:flex;gap:0.75rem}
    
    .btn{padding:0.75rem 1.5rem;border-radius:6px;border:none;cursor:pointer;font-weight:600;text-decoration:none;display:inline-block}
    .btn-primary{background:#6366f1;color:white}
    .btn-primary:hover{background:#4f46e5}
    .btn-secondary{background:#e5e7eb;color:#374151}
    .btn-secondary:hover{background:#d1d5db}
    .help-text{font-size:0.875rem;color:#6b7280;margin-top:0.25rem}
  </style>
</head>
<body>
  <div class="container">
    <h2><%= assistant ? 'Sửa thông tin phụ xe' : 'Thêm phụ xe mới' %></h2>
    
    <form id="assistantForm" method="post" action="<%= assistant ? ('/admin/assistants/' + assistant._id) : '/admin/assistants' %>">
      
      <div class="form-group">
        <div>
          <label>Họ tên *</label>
          <input type="text" id="name" name="name" value="<%= assistant ? assistant.name : '' %>" placeholder="Nhập họ tên" />
          <div class="error-msg" id="error-name">Vui lòng nhập họ tên</div>
        </div>
        <div>
          <label>Email *</label>
          <input type="email" id="email" name="email" value="<%= assistant ? assistant.email : '' %>" placeholder="email@example.com" />
          <div class="error-msg" id="error-email">Email không hợp lệ</div>
        </div>
      </div>

      <div class="form-group">
        <div>
          <label>Số điện thoại *</label>
          <input type="tel" id="phone" name="phone" 
                 value="<%= assistant ? assistant.phone : '' %>" 
                 placeholder="09xx..." 
                 maxlength="10"
                 oninput="this.value = this.value.replace(/[^0-9]/g, '')" />
          <div class="error-msg" id="error-phone">Số điện thoại không hợp lệ (Phải có 10 số)</div>
        </div>
        <div>
          <label>Mã nhân viên</label>
          <input type="text" name="employee_id" value="<%= assistant ? assistant.employee_id : '' %>" placeholder="VD: PX001" />
        </div>
      </div>

      <div class="form-group">
        <div>
          <label>Số giấy phép</label>
          <input type="text" name="license_number" value="<%= assistant ? assistant.license_number : '' %>" placeholder="VD: PX-LN-2024-001" />
        </div>
        <div>
          <label>Số năm kinh nghiệm</label>
          <input type="number" name="experience_years" value="<%= assistant ? assistant.experience_years : 0 %>" min="0" />
        </div>
      </div>

      <div>
        <label>Trạng thái</label>
        <select name="status">
          <option value="active" <%= assistant && assistant.status === 'active' ? 'selected' : '' %>>Đang hoạt động</option>
          <option value="inactive" <%= assistant && assistant.status === 'inactive' ? 'selected' : '' %>>Không hoạt động</option>
        </select>
      </div>

      <% if (routes) { %>
        <div class="trips-section">
          <h3 style="margin-bottom:1rem;color:#1e3a8a">Gán tuyến cho phụ xe</h3>
          <div class="help-text">Chọn các tuyến mà phụ xe này sẽ phụ trách.</div>
          <div class="trips-grid">
            <% routes.forEach(function(route) { 
              const isAssigned = assistant && assistant.assigned_routes && assistant.assigned_routes.some(r => {
                const routeId = typeof r === 'object' ? r._id.toString() : r.toString();
                return routeId === route._id.toString();
              });
            %>
              <div class="trip-item">
                <input type="checkbox" name="assigned_routes" value="<%= route._id %>" <%= isAssigned ? 'checked' : '' %> />
                <label style="font-weight:normal;margin:0;cursor:pointer;">
                  <%= (route.origin || route.from_city) + ' → ' + (route.destination || route.to_city) %>
                </label>
              </div>
            <% }); %>
          </div>
        </div>
      <% } %>

      <div class="actions">
        <button type="submit" class="btn btn-primary"><%= assistant ? 'Cập nhật' : 'Tạo mới' %></button>
        <a href="/admin/assistants" class="btn btn-secondary">Hủy</a>
      </div>
    </form>
  </div>

  <script>
    const form = document.getElementById('assistantForm');
    const nameInput = document.getElementById('name');
    const phoneInput = document.getElementById('phone');
    const emailInput = document.getElementById('email');

    // Hàm hiển thị lỗi
    function showError(input, errorId, show) {
        const errorDiv = document.getElementById(errorId);
        if (show) {
            errorDiv.style.display = 'block';
            input.classList.add('input-error');
        } else {
            errorDiv.style.display = 'none';
            input.classList.remove('input-error');
        }
    }

    // Bắt sự kiện khi bấm Lưu
    form.addEventListener('submit', function(e) {
        let isValid = true;

        // 1. Kiểm tra Tên
        if (!nameInput.value.trim()) {
            showError(nameInput, 'error-name', true);
            isValid = false;
        } else {
            showError(nameInput, 'error-name', false);
        }

        // 2. Kiểm tra SĐT (Phải là số, bắt đầu bằng 0, độ dài 10 ký tự)
        const phoneRegex = /^(0)[0-9]{9}$/;
        if (!phoneInput.value.match(phoneRegex)) {
            showError(phoneInput, 'error-phone', true);
            isValid = false;
        } else {
            showError(phoneInput, 'error-phone', false);
        }

        // 3. Kiểm tra Email (Nếu có nhập thì phải đúng định dạng)
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        // Nếu không nhập gì HOẶC nhập sai định dạng đều báo lỗi
        if (!emailInput.value.trim() || !emailInput.value.match(emailRegex)) {
            showError(emailInput, 'error-email', true);
            isValid = false;
        } else {
            showError(emailInput, 'error-email', false);
        }

        // Nếu có lỗi thì chặn gửi form
        if (!isValid) {
            e.preventDefault(); 
        }
    });

    // Tự động xóa lỗi khi người dùng bắt đầu gõ lại
    [nameInput, phoneInput, emailInput].forEach(input => {
        input.addEventListener('input', function() {
            this.classList.remove('input-error');
            // Tìm div lỗi ngay sau input (hoặc dùng ID tương ứng)
            if(this.id === 'name') document.getElementById('error-name').style.display = 'none';
            if(this.id === 'phone') document.getElementById('error-phone').style.display = 'none';
            if(this.id === 'email') document.getElementById('error-email').style.display = 'none';
        });
    });
  </script>
</body>
</html>


--- END OF FILE: backend\views\admin\assistant_form.ejs ---


--- START OF FILE: backend\views\admin\bookings.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookings Management - VeXe7TV Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --white: #ffffff;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--dark);
        }
        
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-xl);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .sidebar-header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .sidebar-nav {
            padding: 1.5rem 0;
        }
        
        .nav-item {
            display: block;
            padding: 0.875rem 1.5rem;
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            margin: 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .nav-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-left-color: var(--primary);
            color: var(--primary);
            transform: translateX(4px);
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.15) 0%, transparent 100%);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .page-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            padding: 1.75rem;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .stat-card h3 {
            color: var(--gray);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
        }
        
        .content-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
        }
        
        .content-card h2 {
            margin: 0 0 1.5rem 0;
            color: var(--dark);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--light);
        }
        
        th {
            padding: 1rem 1.25rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--gray-light);
        }
        
        td {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-light);
            color: var(--dark);
        }
        
        tbody tr {
            transition: all 0.2s ease;
        }
        
        tbody tr:hover {
            background: var(--light);
            transform: scale(1.01);
        }
        
        .badge {
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        
        .badge-primary {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Thêm style cho nút Duyệt */
        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        .empty-state p {
            color: var(--gray);
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>🚌 VeXe7TV</h1>
                <p>Trang quản trị</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin" class="nav-item">
                    <span>📊</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/users" class="nav-item">
                    <span>👥</span>
                    <span>Users</span>
                </a>
                <a href="/admin/assistants" class="nav-item <%= page === 'assistants' ? 'active' : '' %>">
                    <span>👷</span>
                    <span>Lơ xe</span>
                </a>
                <a href="/admin/drivers" class="nav-item <%= page === 'drivers' ? 'active' : '' %>">
                    <span>🚐</span> 
                    <span>Tài xế</span>
                </a>
                <a href="/admin/buses" class="nav-item">
                    <span>🚌</span>
                    <span>Buses</span>
                </a>
                <a href="/admin/routes" class="nav-item">
                    <span>📍</span>
                    <span>Routes</span>
                </a>
                <a href="/admin/trips" class="nav-item">
                    <span>🕐</span>
                    <span>Trips</span>
                </a>
                <a href="/admin/bookings" class="nav-item active">
                    <span>🎫</span>
                    <span>Bookings</span>
                </a>
                <a href="/admin/statistics" class="nav-item">
                    <span>📈</span>
                    <span>Statistics</span>
                </a>
                <a href="/" class="nav-item" style="margin-top: 2rem; border-top: 1px solid var(--gray-light); padding-top: 1.5rem;">
                    <span>🏠</span>
                    <span>Về trang chủ</span>
                </a>
            </nav>
        </aside>
        
        <main class="main-content">
            <div class="page-header">
                <h2>Quản lý Đặt chỗ</h2>
                <p>Quản lý tất cả đặt chỗ trong hệ thống</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Tổng số đặt chỗ</h3>
                            <div class="value"><%= stats.total %></div>
                        </div>
                        <div class="stat-card-icon">🎫</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Đang chờ</h3>
                            <div class="value"><%= stats.pending %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--warning), #fbbf24);">⏳</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Đã thanh toán</h3>
                            <div class="value"><%= stats.paid %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--info), #60a5fa);">💳</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Hoàn thành</h3>
                            <div class="value"><%= stats.completed %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--success), #34d399);">✅</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Doanh thu</h3>
                            <div class="value" style="font-size: 1.75rem;"><%= stats.totalRevenue.toLocaleString('vi-VN') %> ₫</div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--warning), #fbbf24);">💰</div>
                    </div>
                </div>
            </div>
            
            <div class="content-card">
                <h2>Danh sách Đặt chỗ</h2>
                <% if (bookings.length === 0) { %>
                    <div class="empty-state">
                        <div class="empty-state-icon">🎫</div>
                        <h3>Chưa có đặt chỗ nào</h3>
                        <p>Khách hàng chưa đặt chỗ</p>
                    </div>
                <% } else { %>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Khách hàng</th>
                                    <th>Ghế</th>
                                    <th>Tổng tiền</th>
                                    <th>Trạng thái</th>
                                    <th>Ngày đặt</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% bookings.forEach(function(booking) { %>
                                    <tr>
                                        <td><strong><%= booking._id.toString().substring(0, 8) %>...</strong></td>
                                        <td><%= booking.user?.full_name || booking.passenger?.name || 'N/A' %></td>
                                        <td><span class="badge badge-primary"><%= booking.seat_numbers?.join(', ') || 'N/A' %></span></td>
                                        <td><strong><%= ((booking.total_price || booking.total_amount) || 0).toLocaleString('vi-VN') %> ₫</strong></td>
                                        <td>
                                            <span class="badge <%= booking.status === 'completed' ? 'badge-success' : booking.status === 'paid' ? 'badge-primary' : 'badge-warning' %>">
                                                <%= booking.status === 'pending' ? 'Đang chờ' : booking.status === 'paid' ? 'Đã thanh toán' : booking.status === 'completed' ? 'Hoàn thành' : booking.status === 'cancelled' ? 'Đã hủy' : booking.status %>
                                            </span>
                                        </td>
                                        <td><%= new Date(booking.createdAt).toLocaleString('vi-VN') %></td>
                                        <td>
                                            <% if (booking.status === 'pending') { %>
                                                <button 
                                                    class="btn btn-success" 
                                                    onclick="updateStatus('<%= booking._id %>', 'paid')"
                                                    style="margin-right: 0.5rem;"
                                                    title="Xác nhận đã nhận tiền"
                                                >
                                                    ✔ Duyệt
                                                </button>
                                            <% } %>

                                            <% if (booking.status === 'pending' || booking.status === 'cancelled') { %>
                                                <button class="btn btn-danger" onclick="deleteBooking('<%= booking._id %>')">🗑️ Xóa</button>
                                            <% } else { %>
                                                <span class="text-gray-500 text-sm" title="Không thể xóa đơn đã thanh toán hoặc đã hoàn thành">🔒 Đã khóa</span>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } %>
            </div>
        </main>
    </div>
    
    <script>
        // Hàm xóa booking
        async function deleteBooking(id) {
            if (!confirm('Bạn có chắc muốn xóa đặt chỗ này?')) return;
            try {
                const response = await fetch(`/admin/bookings/${id}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    alert('Đã xóa đặt chỗ thành công');
                    location.reload();
                } else {
                    alert('Lỗi: ' + (data.error || 'Không thể xóa đặt chỗ'));
                }
            } catch (error) {
                alert('Lỗi: ' + error.message);
            }
        }

        // --- HÀM DUYỆT ĐƠN MỚI ---
        async function updateStatus(id, status) {
            if (!confirm('Xác nhận đã nhận được tiền cho đơn này?')) return;
            try {
                const response = await fetch(`/admin/bookings/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status }) 
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Đã duyệt đơn thành công!');
                    location.reload(); // Tải lại trang để thấy màu xanh
                } else {
                    alert('Lỗi: ' + (data.error || 'Không thể cập nhật'));
                }
            } catch (error) {
                console.error(error);
                alert('Lỗi kết nối server');
            }
        }
    </script>
</body>
</html>
--- END OF FILE: backend\views\admin\bookings.ejs ---


--- START OF FILE: backend\views\admin\buses.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buses Management - VeXe7TV Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --white: #ffffff;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--dark);
        }
        
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-xl);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .sidebar-header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .sidebar-nav {
            padding: 1.5rem 0;
        }
        
        .nav-item {
            display: block;
            padding: 0.875rem 1.5rem;
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            margin: 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .nav-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-left-color: var(--primary);
            color: var(--primary);
            transform: translateX(4px);
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.15) 0%, transparent 100%);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .page-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            padding: 1.75rem;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .stat-card h3 {
            color: var(--gray);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
        }
        
        .content-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
        }
        
        .content-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .content-card h2 {
            margin: 0;
            color: var(--dark);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--gray);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-secondary:hover {
            background: #475569;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--light);
        }
        
        th {
            padding: 1rem 1.25rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--gray-light);
        }
        
        td {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-light);
            color: var(--dark);
        }
        
        tbody tr {
            transition: all 0.2s ease;
        }
        
        tbody tr:hover {
            background: var(--light);
            transform: scale(1.01);
        }
        
        .badge {
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        .empty-state p {
            color: var(--gray);
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>🚌 VeXe7TV</h1>
                <p>Trang quản trị</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin" class="nav-item">
                    <span>📊</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/users" class="nav-item">
                    <span>👥</span>
                    <span>Users</span>
                </a>
                <a href="/admin/assistants" class="nav-item <%= page === 'assistants' ? 'active' : '' %>">
                    <span>👷</span>
                    <span>Lơ xe</span>
                </a>
                <a href="/admin/drivers" class="nav-item <%= page === 'drivers' ? 'active' : '' %>">
                    <span>🚐</span> 
                    <span>Tài xế</span>
                </a>
                <a href="/admin/buses" class="nav-item active">
                    <span>🚌</span>
                    <span>Buses</span>
                </a>
                <a href="/admin/routes" class="nav-item">
                    <span>📍</span>
                    <span>Routes</span>
                </a>
                <a href="/admin/trips" class="nav-item">
                    <span>🕐</span>
                    <span>Trips</span>
                </a>
                <a href="/admin/bookings" class="nav-item">
                    <span>🎫</span>
                    <span>Bookings</span>
                </a>
                <a href="/admin/statistics" class="nav-item">
                    <span>📈</span>
                    <span>Statistics</span>
                </a>
                <a href="/" class="nav-item" style="margin-top: 2rem; border-top: 1px solid var(--gray-light); padding-top: 1.5rem;">
                    <span>🏠</span>
                    <span>Về trang chủ</span>
                </a>
            </nav>
        </aside>
        
        <main class="main-content">
            <div class="page-header">
                <h2>Quản lý Xe buýt</h2>
                <p>Quản lý tất cả xe buýt trong hệ thống</p>
            </div>
            
        <div class="stats-grid">
            <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                <h3>Tổng số xe</h3>
                <div class="value"><%= stats.total %></div>
                        </div>
                        <div class="stat-card-icon">🚌</div>
                    </div>
            </div>
            <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                <h3>Đang hoạt động</h3>
                <div class="value"><%= stats.active %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--success), #34d399);">✅</div>
                    </div>
            </div>
            <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                <h3>Không hoạt động</h3>
                <div class="value"><%= stats.inactive %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--warning), #fbbf24);">⚠️</div>
                    </div>
            </div>
        </div>
        
            <div class="content-card">
                <div class="content-card-header">
                    <h2>Danh sách Xe buýt</h2>
                    <a href="/admin/buses/new" class="btn btn-success">➕ Thêm xe mới</a>
            </div>
            <% if (buses.length === 0) { %>
                <div class="empty-state">
                        <div class="empty-state-icon">🚌</div>
                    <h3>Chưa có xe buýt nào</h3>
                        <p>Vui lòng thêm xe buýt mới</p>
                </div>
            <% } else { %>
                    <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Biển số</th>
                            <th>Loại xe</th>
                            <th>Số ghế</th>
                            <th>Trạng thái</th>
                            <th>Ngày tạo</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% buses.forEach(function(bus) { %>
                            <tr>
                                        <td><strong><%= bus.license_plate %></strong></td>
                                <td><%= bus.bus_type %></td>
                                <td><%= bus.seat_count %></td>
                                <td>
                                    <span class="badge <%= bus.active ? 'badge-success' : 'badge-warning' %>">
                                        <%= bus.active ? 'Đang hoạt động' : 'Không hoạt động' %>
                                    </span>
                                </td>
                                <td><%= new Date(bus.createdAt).toLocaleString('vi-VN') %></td>
                                <td>
                                            <button class="btn btn-secondary" onclick="location.href='/admin/buses/<%= bus._id %>/edit'" style="margin-right: 0.5rem; padding: 0.5rem 1rem;">✏️ Sửa</button>
                                            <button class="btn btn-danger" onclick="deleteBus('<%= bus._id %>')" style="padding: 0.5rem 1rem;">🗑️ Xóa</button>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
                    </div>
            <% } %>
        </div>
        </main>
    </div>
    
    <script>
        async function deleteBus(id) {
            if (!confirm('Bạn có chắc muốn xóa xe buýt này?')) return;
            try {
                const response = await fetch(`/admin/buses/${id}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    alert('Đã xóa xe buýt thành công');
                    location.reload();
                }
            } catch (error) {
                alert('Lỗi: ' + error.message);
            }
        }
    </script>
</body>
</html>

--- END OF FILE: backend\views\admin\buses.ejs ---


--- START OF FILE: backend\views\admin\bus_form.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= bus ? 'Sửa xe' : 'Thêm xe mới' %> - Admin</title>
  <style>
    body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:#f5f7fa;color:#333}
    .container{max-width:800px;margin:3rem auto;background:white;padding:1.5rem;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
    label{display:block;margin-top:0.75rem;font-weight:600}
    input[type=text], input[type=number]{width:100%;padding:0.6rem;border:1px solid #e5e7eb;border-radius:6px}
    .actions{margin-top:1rem;display:flex;gap:0.5rem}
    .btn{padding:0.6rem 1rem;border-radius:6px;border:none;cursor:pointer}
    .btn-primary{background:#1e3a8a;color:white}
    .btn-secondary{background:#e5e7eb}
  </style>
</head>
<body>
  <div class="container">
    <h2><%= bus ? 'Sửa thông tin xe' : 'Thêm xe mới' %></h2>
    <form method="post" action="<%= bus ? ('/admin/buses/' + bus._id) : '/admin/buses' %>">
      <label>Biển số</label>
      <input type="text" name="license_plate" value="<%= bus ? bus.license_plate : '' %>" required />

      <label>Loại xe</label>
      <input type="text" name="bus_type" value="<%= bus ? bus.bus_type : '' %>" />

      <label>Số ghế</label>
      <input type="number" name="seat_count" value="<%= bus ? bus.seat_count : 0 %>" min="0" />

      <label>
        <input type="checkbox" name="active" <%= bus && bus.active ? 'checked' : '' %> /> Đang hoạt động
      </label>

      <div class="actions">
        <button type="submit" class="btn btn-primary">Lưu</button>
        <a href="/admin/buses" class="btn btn-secondary">Hủy</a>
      </div>
    </form>
  </div>
</body>
</html>
--- END OF FILE: backend\views\admin\bus_form.ejs ---


--- START OF FILE: backend\views\admin\dashboard.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang quản trị - VeXe7TV</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --white: #ffffff;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--dark);
        }
        
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-xl);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .sidebar-header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .sidebar-nav {
            padding: 1.5rem 0;
        }
        
        .nav-item {
            display: block;
            padding: 0.875rem 1.5rem;
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            margin: 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .nav-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-left-color: var(--primary);
            color: var(--primary);
            transform: translateX(4px);
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.15) 0%, transparent 100%);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .nav-item i {
            font-size: 1.25rem;
            width: 24px;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
            position: relative;
            z-index: 2;
            pointer-events: auto;
        }
        
        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .page-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            padding: 1.75rem;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .stat-card h3 {
            color: var(--gray);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
        }
        
        .stat-card .change {
            font-size: 0.875rem;
            color: var(--success);
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .content-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
        }
        
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: var(--light);
            padding: 0.5rem;
            border-radius: 12px;
        }
        
        .tab {
            flex: 1;
            padding: 0.875rem 1.25rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.9375rem;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            color: var(--gray);
            position: relative;
        }
        
        .tab:hover {
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }
        
        .tab.active {
            background: var(--white);
            color: var(--primary);
            box-shadow: var(--shadow);
        }
        
        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .content-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--light);
        }
        
        th {
            padding: 1rem 1.25rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--gray-light);
        }
        
        td {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-light);
            color: var(--dark);
        }
        
        tbody tr {
            transition: all 0.2s ease;
        }
        
        tbody tr:hover {
            background: var(--light);
            transform: scale(1.01);
        }
        
        .badge {
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        
        .badge-primary {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        .empty-state p {
            color: var(--gray);
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>🚌 VeXe7TV</h1>
                <p>Trang quản trị</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin" class="nav-item active">
                    <span>📊</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/users" class="nav-item">
                    <span>👥</span>
                    <span>Users</span>
                </a>
                <a href="/admin/assistants" class="nav-item <%= page === 'assistants' ? 'active' : '' %>">
                    <span>👷</span>
                    <span>Lơ xe</span>
                </a>
                <a href="/admin/drivers" class="nav-item <%= page === 'drivers' ? 'active' : '' %>">
                    <span>🚐</span> 
                    <span>Tài xế</span>
                </a>
                <a href="/admin/buses" class="nav-item">
                    <span>🚌</span>
                    <span>Buses</span>
                </a>
                <a href="/admin/routes" class="nav-item">
                    <span>📍</span>
                    <span>Routes</span>
                </a>
                <a href="/admin/trips" class="nav-item">
                    <span>🕐</span>
                    <span>Trips</span>
                </a>
                <a href="/admin/bookings" class="nav-item">
                    <span>🎫</span>
                    <span>Bookings</span>
                </a>
                <a href="/admin/statistics" class="nav-item">
                    <span>📈</span>
                    <span>Statistics</span>
                </a>
                <a href="/" class="nav-item" style="margin-top: 2rem; border-top: 1px solid var(--gray-light); padding-top: 1.5rem;">
                    <span>🏠</span>
                    <span>Về trang chủ</span>
                </a>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h2>Dashboard</h2>
                <p>Tổng quan hệ thống quản lý vé xe</p>
            </div>
            
            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Tổng chuyến xe</h3>
                            <div class="value"><%= stats.totalTrips %></div>
                        </div>
                        <div class="stat-card-icon">🕐</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Tổng đặt chỗ</h3>
                            <div class="value"><%= stats.totalBookings %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--success), #34d399);">🎫</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Đã hoàn thành</h3>
                            <div class="value"><%= stats.completedBookings %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--success), #34d399);">✅</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Doanh thu</h3>
                            <div class="value"><%= stats.totalRevenue.toLocaleString('vi-VN') %> ₫</div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--warning), #fbbf24);">💰</div>
                    </div>
                </div>
            </div>
            
            <!-- Content Card -->
            <div class="content-card">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="showTab('trips')">🕐 Chuyến xe (<%= trips.length %>)</button>
                    <button class="tab" onclick="showTab('bookings')">🎫 Đặt chỗ (<%= bookings.length %>)</button>
                </div>
                
                <!-- Trips Section -->
                <div id="trips" class="content-section active">
                    <% if (trips.length === 0) { %>
                        <div class="empty-state">
                            <div class="empty-state-icon">🚌</div>
                            <h3>Chưa có chuyến xe nào</h3>
                            <p>Vui lòng thêm chuyến xe mới</p>
                        </div>
                    <% } else { %>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Tuyến</th>
                                        <th>Thời gian bắt đầu</th>
                                        <th>Thời gian kết thúc</th>
                                        <th>Giá cơ bản</th>
                                        <th>Hướng</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% trips.forEach(function(trip) { %>
                                        <tr>
                                            <td><strong><%= trip._id.toString().substring(0, 8) %>...</strong></td>
                                            <td><%= trip.route?.name || 'N/A' %></td>
                                            <td><%= new Date(trip.start_time).toLocaleString('vi-VN') %></td>
                                            <td><%= trip.end_time ? new Date(trip.end_time).toLocaleString('vi-VN') : 'N/A' %></td>
                                            <td><strong><%= trip.base_price?.toLocaleString('vi-VN') || '0' %> ₫</strong></td>
                                            <td>
                                                <span class="badge <%= trip.direction === 'go' ? 'badge-success' : 'badge-warning' %>">
                                                    <%= trip.direction === 'go' ? 'Đi' : 'Về' %>
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge badge-primary"><%= trip.status || 'scheduled' %></span>
                                            </td>
                                            <td>
                                                <button class="btn btn-danger" onclick="deleteTrip('<%= trip._id %>')">🗑️ Xóa</button>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } %>
                </div>
                
                <!-- Bookings Section -->
                <div id="bookings" class="content-section">
                    <% if (bookings.length === 0) { %>
                        <div class="empty-state">
                            <div class="empty-state-icon">🎫</div>
                            <h3>Chưa có đặt chỗ nào</h3>
                            <p>Khách hàng chưa đặt chỗ</p>
                        </div>
                    <% } else { %>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Khách hàng</th>
                                        <th>Ghế</th>
                                        <th>Tổng tiền</th>
                                        <th>Trạng thái</th>
                                        <th>Ngày đặt</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% bookings.forEach(function(booking) { %>
                                        <tr>
                                            <td><strong><%= booking._id.toString().substring(0, 8) %>...</strong></td>
                                            <td><%= booking.user?.full_name || booking.passenger?.name || 'N/A' %></td>
                                            <td><span class="badge badge-primary"><%= booking.seat_numbers?.join(', ') || 'N/A' %></span></td>
                                            <td><strong><%= ((booking.total_price || booking.total_amount) || 0).toLocaleString('vi-VN') %> ₫</strong></td>
                                            <td>
                                                <span class="badge <%= booking.status === 'completed' ? 'badge-success' : booking.status === 'paid' ? 'badge-primary' : 'badge-warning' %>">
                                                    <%= booking.status === 'pending' ? 'Đang chờ' : booking.status === 'paid' ? 'Đã thanh toán' : booking.status === 'completed' ? 'Hoàn thành' : booking.status %>
                                                </span>
                                            </td>
                                            <td><%= new Date(booking.createdAt).toLocaleString('vi-VN') %></td>
                                            <td>
                                                <% if (booking.status === 'pending' || booking.status === 'cancelled') { %>
                                                    <button class="btn btn-danger" onclick="deleteBooking('<%= booking._id %>')">🗑️ Xóa</button>
                                                <% } else { %>
                                                    <span class="text-gray-500 text-sm" title="Không thể xóa đơn đã thanh toán hoặc đã hoàn thành">🔒 Đã khóa</span>
                                                <% } %>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } %>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        function showTab(tabName) {
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(tabName).classList.add('active');
            
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        async function deleteTrip(id) {
            if (!confirm('Bạn có chắc muốn xóa chuyến xe này?')) return;
            
            try {
                const response = await fetch(`/admin/trips/${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.success) {
                    alert('Đã xóa chuyến xe thành công');
                    location.reload();
                }
            } catch (error) {
                alert('Lỗi khi xóa: ' + error.message);
            }
        }
        
        async function deleteBooking(id) {
            if (!confirm('Bạn có chắc muốn xóa đặt chỗ này?')) return;
            
            try {
                const response = await fetch(`/admin/bookings/${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.success) {
                    alert('Đã xóa đặt chỗ thành công');
                    location.reload();
                } else {
                    alert('Lỗi: ' + (data.error || 'Không thể xóa đặt chỗ'));
                }
            } catch (error) {
                alert('Lỗi khi xóa: ' + error.message);
            }
        }
    </script>
</body>
</html>


--- END OF FILE: backend\views\admin\dashboard.ejs ---


--- START OF FILE: backend\views\admin\drivers.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Tài xế - VeXe7TV Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --white: #ffffff;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--dark);
        }
        
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-xl);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .sidebar-header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .sidebar-nav {
            padding: 1.5rem 0;
        }
        
        .nav-item {
            display: block;
            padding: 0.875rem 1.5rem;
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            margin: 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .nav-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-left-color: var(--primary);
            color: var(--primary);
            transform: translateX(4px);
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.15) 0%, transparent 100%);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .page-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .page-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            padding: 1.75rem;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--warning), #fbbf24);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--warning), #fbbf24);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .stat-card h3 {
            color: var(--gray);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
        }
        
        .content-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
        }
        
        .content-card h2 {
            margin: 0 0 1.5rem 0;
            color: var(--dark);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--light);
        }
        
        th {
            padding: 1rem 1.25rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--gray-light);
        }
        
        td {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-light);
            color: var(--dark);
        }
        
        tbody tr {
            transition: all 0.2s ease;
        }
        
        tbody tr:hover {
            background: var(--light);
            transform: scale(1.01);
        }
        
        .badge {
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        .badge-info {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        .empty-state p {
            color: var(--gray);
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>🚌 VeXe7TV</h1>
                <p>Trang quản trị</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin" class="nav-item">
                    <span>📊</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/users" class="nav-item">
                    <span>👥</span>
                    <span>Users</span>
                </a>
                <a href="/admin/assistants" class="nav-item <%= page === 'assistants' ? 'active' : '' %>">
                    <span>👷</span>
                    <span>Lơ xe</span>
                </a>
                <a href="/admin/drivers" class="nav-item <%= page === 'drivers' ? 'active' : '' %>">
                    <span>🚐</span> 
                    <span>Tài xế</span>
                </a>
                <a href="/admin/buses" class="nav-item">
                    <span>🚌</span>
                    <span>Buses</span>
                </a>
                <a href="/admin/routes" class="nav-item">
                    <span>📍</span>
                    <span>Routes</span>
                </a>
                <a href="/admin/trips" class="nav-item">
                    <span>🕐</span>
                    <span>Trips</span>
                </a>
                <a href="/admin/bookings" class="nav-item">
                    <span>🎫</span>
                    <span>Bookings</span>
                </a>
                <a href="/admin/statistics" class="nav-item">
                    <span>📈</span>
                    <span>Statistics</span>
                </a>
                <a href="/" class="nav-item" style="margin-top: 2rem; border-top: 1px solid var(--gray-light); padding-top: 1.5rem;">
                    <span>🏠</span>
                    <span>Về trang chủ</span>
                </a>
            </nav>
        </aside>
        <main class="main-content">
            <div class="page-header">
                <div>
                    <h2>Quản lý Tài xế</h2>
                    <p>Danh sách tài xế trong hệ thống</p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Tổng số tài xế</h3>
                    <div class="value"><%= stats.total %></div>
                </div>
                <div class="stat-card" style="border-left-color: var(--success);">
                    <h3>Đang hoạt động</h3>
                    <div class="value"><%= stats.active %></div>
                </div>
            </div>

            <div class="content-card">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 1.5rem;">
                    <a href="/admin/drivers/new" class="btn btn-primary">➕ Thêm Tài xế</a>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Họ tên</th>
                                <th>SĐT / Email</th>
                                <th>Bằng lái</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (drivers.length === 0) { %>
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #999;">Chưa có tài xế nào.</td>
                                </tr>
                            <% } %>
                            
                            <% drivers.forEach(d => { %>
                                <tr>
                                    <td>
                                        <strong><%= d.name %></strong><br>
                                        <small style="color: #64748b;"><%= d.employee_id || 'Mã: N/A' %></small>
                                    </td>
                                    <td>
                                        <%= d.phone %><br>
                                        <small style="color: #64748b;"><%= d.email %></small>
                                    </td>
                                    <td><span class="badge badge-info"><%= d.license_number %></span></td>
                                    <td>
                                        <span class="badge <%= d.status==='active'?'badge-success':'badge-danger' %>">
                                            <%= d.status==='active'?'Đang làm':'Đã nghỉ' %>
                                        </span>
                                    </td>
                                    <td>
                                        <a href="/admin/drivers/<%= d._id %>" class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">Chi tiết</a>
                                        <a href="/admin/drivers/<%= d._id %>/edit" class="btn btn-warning" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">Sửa</a>
                                        <button onclick="deleteDriver('<%= d._id %>')" class="btn btn-danger" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">Xóa</button>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        async function deleteDriver(id) {
            if(!confirm('Xóa tài xế này sẽ xóa luôn tài khoản đăng nhập tương ứng. Tiếp tục?')) return;
            try {
                const res = await fetch('/admin/drivers/' + id, {method:'DELETE'});
                const data = await res.json();
                if(data.success) {
                    alert('Đã xóa thành công!');
                    location.reload();
                } else {
                    alert('Lỗi: ' + data.error);
                }
            } catch(e) {
                alert('Lỗi kết nối server');
            }
        }
    </script>
</body>
</html>

--- END OF FILE: backend\views\admin\drivers.ejs ---


--- START OF FILE: backend\views\admin\driver_detail.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Chi tiết Tài xế - VeXe7TV Admin</title>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
	<style>
		body{font-family:Inter,Segoe UI,Arial;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#1e293b;margin:0}
		.admin-wrapper{display:flex;min-height:100vh}
		.sidebar{width:260px;background:rgba(255,255,255,0.95);position:fixed;height:100vh;padding-bottom:2rem;overflow:auto}
		.main-content{flex:1;margin-left:260px;padding:2rem}
		.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
		.info-card{background:#fff;padding:1.5rem;border-radius:12px;box-shadow:0 8px 20px rgba(2,6,23,0.08);margin-bottom:1rem}
		.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem}
		table{width:100%;border-collapse:collapse}
		th,td{padding:0.75rem;text-align:left;border-bottom:1px solid #eef2f7}
		thead{background:#f8fafc}
		.badge{padding:0.35rem 0.7rem;border-radius:999px;font-weight:600;font-size:0.85rem}
		.badge-success{background:rgba(16,185,129,0.1);color:#059669}
		.badge-info{background:rgba(59,130,246,0.08);color:#2563eb}
		.badge-warning{background:rgba(245,158,11,0.08);color:#b45309}
		.actions a{margin-left:0.5rem;text-decoration:none}
	</style>
</head>
<body>
	<div class="admin-wrapper">
		<aside class="sidebar">
			<div style="padding:1.5rem;background:linear-gradient(90deg,#6366f1,#4f46e5);color:white">
				<h2 style="margin:0">🚌 VeXe7TV</h2>
				<div style="opacity:0.9;font-size:0.9rem">Trang quản trị</div>
			</div>
			<nav style="padding:1rem">
				<a href="/admin" style="display:block;padding:0.6rem 0;color:#0f172a;text-decoration:none">Dashboard</a>
				<a href="/admin/drivers" style="display:block;padding:0.6rem 0;color:#0f172a;text-decoration:none;font-weight:600">🚐 Tài xế</a>
			</nav>
		</aside>

		<main class="main-content">
			<div class="page-header">
				<div>
					<h1 style="color:white;margin:0 0 6px 0">Chi tiết tài xế</h1>
					<div style="color:rgba(255,255,255,0.9)"><%= driver.name %></div>
				</div>
				<div class="actions">
					<a href="/admin/drivers" class="btn" style="background:#fff;padding:0.6rem 1rem;border-radius:8px;text-decoration:none">← Quay lại</a>
					<a href="/admin/drivers/<%= driver._id %>/edit" class="btn" style="background:#6366f1;color:#fff;padding:0.6rem 1rem;border-radius:8px;text-decoration:none">✏️ Sửa</a>
				</div>
			</div>

			<div class="info-card">
				<h3>Thông tin cơ bản</h3>
				<div class="info-grid" style="margin-top:0.75rem">
					<div><strong>Họ tên:</strong> <div><%= driver.name %></div></div>
					<div><strong>Email:</strong> <div><%= driver.email %></div></div>
					<div><strong>Số điện thoại:</strong> <div><%= driver.phone %></div></div>
					<div><strong>Mã nhân viên:</strong> <div><%= driver.employee_id || 'N/A' %></div></div>
					<div><strong>Bằng lái:</strong> <div><%= driver.license_number || 'N/A' %></div></div>
					<div><strong>Kinh nghiệm:</strong> <div><%= driver.experience_years || 0 %> năm</div></div>
				</div>
			</div>

			<div class="info-card">
				<h3>Chuyến được gán (<%= trips ? trips.length : 0 %>)</h3>
				<% if (trips && trips.length > 0) { %>
					<div style="margin-top:1rem">
						<table>
							<thead>
								<tr>
									<th>Tuyến</th>
									<th>Xe</th>
									<th>Khởi hành</th>
									<th>Trạng thái</th>
								</tr>
							</thead>
							<tbody>
								<% trips.forEach(function(trip){ %>
									<tr>
										<td>
											<strong>
												<%= trip.route ? ((trip.route.origin || trip.route.from_city) + ' → ' + (trip.route.destination || trip.route.to_city)) : 'N/A' %>
											</strong>
										</td>
										<td><%= trip.bus ? trip.bus.license_plate : 'N/A' %></td>
										<td><%= trip.start_time ? new Date(trip.start_time).toLocaleString('vi-VN') : 'N/A' %></td>
										<td>
											<span class="badge <%= trip.status === 'completed' ? 'badge-success' : trip.status === 'departed' ? 'badge-info' : 'badge-warning' %>">
												<%= trip.status === 'scheduled' ? 'Đã lên lịch' : trip.status === 'departed' ? 'Đang chạy' : trip.status === 'completed' ? 'Đã hoàn thành' : trip.status %>
											</span>
										</td>
									</tr>
								<% }); %>
							</tbody>
						</table>
					</div>
				<% } else { %>
					<p style="color:#475569;margin:1rem 0">Chưa có chuyến nào được gán cho tài xế này.</p>
				<% } %>
			</div>

		</main>
	</div>
</body>
</html>

--- END OF FILE: backend\views\admin\driver_detail.ejs ---


--- START OF FILE: backend\views\admin\driver_form.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title><%= driver ? 'Sửa tài xế' : 'Thêm tài xế mới' %> - Admin</title>
	<style>
		body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:#f5f7fa;color:#333}
		.container{max-width:900px;margin:3rem auto;background:white;padding:2rem;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
		h2{margin-bottom:1.5rem;color:#1e3a8a}
		label{display:block;margin-top:1rem;font-weight:600;color:#374151}
		input[type=text], input[type=email], input[type=tel], input[type=number], select {
			width:100%; padding:0.75rem; border:1px solid #e5e7eb; border-radius:6px; font-size:0.95rem; margin-top: 0.25rem;
		}
		input:focus, select:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.1)}
		.form-group{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
		.trips-section{margin-top:2rem;padding-top:2rem;border-top:2px solid #e5e7eb}
		.trips-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(240px, 1fr));gap:0.75rem;margin-top:1rem;max-height:320px;overflow-y:auto;padding:1rem;background:#f9fafb;border-radius:6px}
		.trip-item{display:flex;align-items:center;gap:0.5rem}
		.trip-item input[type=checkbox]{width:auto}
		.actions{margin-top:2rem;display:flex;gap:0.75rem}
		.btn{padding:0.75rem 1.5rem;border-radius:6px;border:none;cursor:pointer;font-weight:600;text-decoration:none;display:inline-block}
		.btn-primary{background:#6366f1;color:white}
		.btn-primary:hover{background:#4f46e5}
		.btn-secondary{background:#e5e7eb;color:#374151}
		.btn-secondary:hover{background:#d1d5db}
		.help-text{font-size:0.875rem;color:#6b7280;margin-top:0.25rem}
		.error-msg { color: #dc2626; font-size: 0.85rem; margin-top: 0.25rem; display: none; }
		.input-error { border-color: #dc2626 !important; background-color: #fef2f2; }
	</style>
</head>
<body>
	<div class="container">
		<h2><%= driver ? 'Sửa thông tin tài xế' : 'Thêm tài xế mới' %></h2>

		<form id="driverForm" method="post" action="<%= driver ? ('/admin/drivers/' + driver._id) : '/admin/drivers' %>">

			<div class="form-group">
				<div>
					<label>Họ tên *</label>
					<input type="text" id="name" name="name" value="<%= driver ? driver.name : '' %>" placeholder="Nhập họ tên" />
					<div class="error-msg" id="error-name">Vui lòng nhập họ tên</div>
				</div>
				<div>
					<label>Email *</label>
					<input type="email" id="email" name="email" value="<%= driver ? driver.email : '' %>" placeholder="email@example.com" />
					<div class="error-msg" id="error-email">Email không hợp lệ</div>
				</div>
			</div>

			<div class="form-group">
				<div>
					<label>Số điện thoại *</label>
					<input type="tel" id="phone" name="phone" value="<%= driver ? driver.phone : '' %>" placeholder="09xx..." maxlength="11" oninput="this.value = this.value.replace(/[^0-9\+]/g, '')" />
					<div class="error-msg" id="error-phone">Số điện thoại không hợp lệ</div>
				</div>
				<div>
					<label>Mã nhân viên</label>
					<input type="text" name="employee_id" value="<%= driver ? driver.employee_id : '' %>" placeholder="VD: TX001" />
				</div>
			</div>

			<div class="form-group">
				<div>
					<label>Số giấy phép lái xe</label>
					<input type="text" name="license_number" value="<%= driver ? driver.license_number : '' %>" placeholder="VD: BKS-12345" />
				</div>
				<div>
					<label>Số năm kinh nghiệm</label>
					<input type="number" name="experience_years" value="<%= driver ? driver.experience_years : 0 %>" min="0" />
				</div>
			</div>

			<div>
				<label>Trạng thái</label>
				<select name="status">
					<option value="active" <%= driver && driver.status === 'active' ? 'selected' : '' %>>Đang hoạt động</option>
					<option value="inactive" <%= driver && driver.status === 'inactive' ? 'selected' : '' %>>Không hoạt động</option>
				</select>
			</div>

			<% if (trips) { %>
				<div class="trips-section">
					<h3 style="margin-bottom:1rem;color:#1e3a8a">Gán chuyến cho tài xế</h3>
					<div class="help-text">Chọn các chuyến mà tài xế này sẽ phụ trách (tuỳ chọn).</div>
					<div class="trips-grid">
						<% trips.forEach(function(trip) { 
							const isAssigned = driver && driver.assigned_trips && driver.assigned_trips.some(t => {
								const tid = typeof t === 'object' ? (t._id ? t._id.toString() : '') : t.toString();
								return tid === trip._id.toString();
							});
						%>
							<div class="trip-item">
								<input type="checkbox" name="assigned_trips" value="<%= trip._id %>" <%= isAssigned ? 'checked' : '' %> />
								<label style="font-weight:normal;margin:0;cursor:pointer;">
									<%= (trip.route && (trip.route.from_city || trip.route.origin) ? (trip.route.from_city || trip.route.origin) : '---') %> → 
									<%= (trip.route && (trip.route.to_city || trip.route.destination) ? (trip.route.to_city || trip.route.destination) : '---') %>
									<span style="color:#6b7280;font-size:0.85rem;display:block;margin-top:0.25rem;">
										<%= trip.start_time ? (new Date(trip.start_time)).toLocaleString() : 'Thời gian chưa đặt' %>
										<% if (trip.bus && trip.bus.license_plate) { %> · <%= trip.bus.license_plate %> <% } %>
									</span>
								</label>
							</div>
						<% }); %>
					</div>
				</div>
			<% } %>

			<div class="actions">
				<button type="submit" class="btn btn-primary"><%= driver ? 'Cập nhật' : 'Tạo mới' %></button>
				<a href="/admin/drivers" class="btn btn-secondary">Hủy</a>
			</div>
		</form>
	</div>

	<script>
		const form = document.getElementById('driverForm');
		const nameInput = document.getElementById('name');
		const phoneInput = document.getElementById('phone');
		const emailInput = document.getElementById('email');

		function showError(input, errorId, show) {
				const errorDiv = document.getElementById(errorId);
				if (show) {
						errorDiv.style.display = 'block';
						input.classList.add('input-error');
				} else {
						errorDiv.style.display = 'none';
						input.classList.remove('input-error');
				}
		}

		form.addEventListener('submit', function(e) {
				let isValid = true;

				if (!nameInput.value.trim()) {
						showError(nameInput, 'error-name', true);
						isValid = false;
				} else {
						showError(nameInput, 'error-name', false);
				}

				const phoneRegex = /^(0|\+84)[0-9]{9,10}$/;
				if (!phoneInput.value.match(phoneRegex)) {
						showError(phoneInput, 'error-phone', true);
						isValid = false;
				} else {
						showError(phoneInput, 'error-phone', false);
				}

				const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
				if (!emailInput.value.trim() || !emailInput.value.match(emailRegex)) {
						showError(emailInput, 'error-email', true);
						isValid = false;
				} else {
						showError(emailInput, 'error-email', false);
				}

				if (!isValid) e.preventDefault();
		});

		[nameInput, phoneInput, emailInput].forEach(input => {
				input.addEventListener('input', function() {
						this.classList.remove('input-error');
						if(this.id === 'name') document.getElementById('error-name').style.display = 'none';
						if(this.id === 'phone') document.getElementById('error-phone').style.display = 'none';
						if(this.id === 'email') document.getElementById('error-email').style.display = 'none';
				});
		});
	</script>
</body>
</html>

--- END OF FILE: backend\views\admin\driver_form.ejs ---


--- START OF FILE: backend\views\admin\layout.ejs ---
<!-- ...existing code... -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= typeof pageTitle !== 'undefined' ? pageTitle : 'Admin' %> - BaseVeXe</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 { font-size: 1.8rem; }
        
        nav {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: background 0.3s;
            background: rgba(255,255,255,0.1);
        }
        
        nav a:hover, nav a.active {
            background: rgba(255,255,255,0.2);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #3b82f6;
        }
        
        .stat-card h3 {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #1e3a8a;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        th {
            background: #f9fafb;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }
        
        td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        tr:hover { background: #f9fafb; }
        
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fed7aa; color: #c2410c; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-primary { background: #dbeafe; color: #1e40af; }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 0.5rem;
        }
        
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
    </style>
    <%- typeof additionalStyles !== 'undefined' ? additionalStyles : '' %>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>🚌 Admin Panel - BaseVeXe</h1>
        </div>
        <nav>
            <a href="/admin" class="<%= page === 'dashboard' ? 'active' : '' %>">📊 Dashboard</a>
            <a href="/admin/users" class="<%= page === 'users' && !roleFilter ? 'active' : '' %>">👥 Users</a>
            <a href="/admin/assistants" class="nav-item <%= page === 'assistants' ? 'active' : '' %>"><span>🧑‍✈️</span> <span>Phụ xe</span></a>
            <a href="/admin/drivers" class="<%= page === 'drivers' ? 'active' : '' %>">🚐 Tài xế</a>
            <a href="/admin/buses" class="<%= page === 'buses' ? 'active' : '' %>">🚌 Buses</a>
            <a href="/admin/routes" class="<%= page === 'routes' ? 'active' : '' %>">📍 Routes</a>
            <a href="/admin/trips" class="<%= page === 'trips' ? 'active' : '' %>">🕐 Trips</a>
            <a href="/admin/bookings" class="<%= page === 'bookings' ? 'active' : '' %>">🎫 Bookings</a>
            <a href="/admin/statistics" class="<%= page === 'statistics' ? 'active' : '' %>">📈 Statistics</a>
            <a href="/" style="background: rgba(239,68,68,0.2);">← Về trang chủ</a>
        </nav>
    </header>
    
    <div class="container">
        <%- body %>
    </div>
    
    <%- typeof additionalScripts !== 'undefined' ? additionalScripts : '' %>
</body>
</html>
// ...existing code...
--- END OF FILE: backend\views\admin\layout.ejs ---


--- START OF FILE: backend\views\admin\login.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Đăng nhập Admin</title>
  <style>
    body{font-family:Inter,Segoe UI,Tahoma,Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;margin:0;display:flex;align-items:center;justify-content:center}
    .card{background:#fff;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,0.15);width:100%;max-width:420px;padding:2rem}
    h1{margin:0 0 1rem 0;font-size:1.5rem;color:#1e293b;text-align:center}
    .field{margin-bottom:1rem}
    label{display:block;margin-bottom:0.5rem;font-weight:600;color:#334155}
    input{width:100%;padding:0.75rem;border:1px solid #e5e7eb;border-radius:8px;font-size:0.95rem}
    .btn{width:100%;padding:0.75rem;border:none;border-radius:8px;background:#1e3a8a;color:#fff;font-weight:600;cursor:pointer}
    .btn:hover{background:#172f6b}
    .error{background:#fee2e2;color:#991b1b;padding:0.75rem;border-radius:8px;margin-bottom:1rem;text-align:center}
    .note{margin-top:1rem;color:#64748b;font-size:0.9rem;text-align:center}
    .links{margin-top:1rem;text-align:center}
    .links a{color:#1e3a8a;text-decoration:none;font-weight:600}
  </style>
  </head>
<body>
  <div class="card">
    <h1>Đăng nhập hệ thống</h1>
    <% if (error) { %>
      <div class="error"><%= error %></div>
    <% } %>
    <form method="post" action="/admin/login">
      <div class="field">
        <label>Email</label>
        <input type="email" name="email" placeholder="you@example.com" required />
      </div>
      <div class="field">
        <label>Mật khẩu</label>
        <input type="password" name="password" placeholder="••••••••" required />
      </div>
      <button type="submit" class="btn">Đăng nhập</button>
    </form>
    <div class="note">Admin → vào trang quản trị. Tài xế/Lơ xe → vào trang riêng.</div>
    <div class="links"><a href="/">Về trang chủ</a></div>
  </div>
</body>
</html>

--- END OF FILE: backend\views\admin\login.ejs ---


--- START OF FILE: backend\views\admin\routes.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Routes Management - VeXe7TV Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --white: #ffffff;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--dark);
        }
        
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-xl);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .sidebar-header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .sidebar-nav {
            padding: 1.5rem 0;
        }
        
        .nav-item {
            display: block;
            padding: 0.875rem 1.5rem;
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            margin: 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .nav-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-left-color: var(--primary);
            color: var(--primary);
            transform: translateX(4px);
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.15) 0%, transparent 100%);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .page-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            padding: 1.75rem;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .stat-card h3 {
            color: var(--gray);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
        }
        
        .content-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
        }
        
        .content-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .content-card h2 {
            margin: 0;
            color: var(--dark);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--gray);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-secondary:hover {
            background: #475569;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--light);
        }
        
        th {
            padding: 1rem 1.25rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--gray-light);
        }
        
        td {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-light);
            color: var(--dark);
        }
        
        tbody tr {
            transition: all 0.2s ease;
        }
        
        tbody tr:hover {
            background: var(--light);
            transform: scale(1.01);
        }
        
        .badge {
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        .empty-state p {
            color: var(--gray);
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>🚌 VeXe7TV</h1>
                <p>Trang quản trị</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin" class="nav-item">
                    <span>📊</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/users" class="nav-item">
                    <span>👥</span>
                    <span>Users</span>
                </a>
                <a href="/admin/assistants" class="nav-item <%= page === 'assistants' ? 'active' : '' %>">
                    <span>👷</span>
                    <span>Lơ xe</span>
                </a>
                <a href="/admin/drivers" class="nav-item <%= page === 'drivers' ? 'active' : '' %>">
                    <span>🚐</span> 
                    <span>Tài xế</span>
                </a>
                <a href="/admin/buses" class="nav-item">
                    <span>🚌</span>
                    <span>Buses</span>
                </a>
                <a href="/admin/routes" class="nav-item active">
                    <span>📍</span>
                    <span>Routes</span>
                </a>
                <a href="/admin/trips" class="nav-item">
                    <span>🕐</span>
                    <span>Trips</span>
                </a>
                <a href="/admin/bookings" class="nav-item">
                    <span>🎫</span>
                    <span>Bookings</span>
                </a>
                <a href="/admin/statistics" class="nav-item">
                    <span>📈</span>
                    <span>Statistics</span>
                </a>
                <a href="/" class="nav-item" style="margin-top: 2rem; border-top: 1px solid var(--gray-light); padding-top: 1.5rem;">
                    <span>🏠</span>
                    <span>Về trang chủ</span>
                </a>
            </nav>
        </aside>
        
        <main class="main-content">
            <div class="page-header">
                <h2>Quản lý Tuyến đường</h2>
                <p>Quản lý tất cả tuyến đường trong hệ thống</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Tổng số tuyến</h3>
                            <div class="value"><%= stats.total %></div>
                        </div>
                        <div class="stat-card-icon">📍</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Đang hoạt động</h3>
                            <div class="value"><%= stats.active %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--success), #34d399);">✅</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Không hoạt động</h3>
                            <div class="value"><%= stats.inactive %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--warning), #fbbf24);">⚠️</div>
                    </div>
                </div>
            </div>
            
            <div class="content-card">
                <div class="content-card-header">
                    <h2>Danh sách Tuyến đường</h2>
                    <a href="/admin/routes/new" class="btn btn-success">➕ Thêm tuyến mới</a>
                </div>
                <% if (routes.length === 0) { %>
                    <div class="empty-state">
                        <div class="empty-state-icon">📍</div>
                        <h3>Chưa có tuyến đường nào</h3>
                        <p>Vui lòng thêm tuyến đường mới</p>
                    </div>
                <% } else { %>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tuyến</th>
                                    <th>Thành phố</th>
                                    <th>Khoảng cách</th>
                                    <th>Thời gian</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% routes.forEach(function(route) { %>
                                    <tr>
                                        <td><strong><%= route.name %></strong></td>
                                        <td><%= route.from_city %> → <%= route.to_city %></td>
                                        <td><%= route.total_distance_km %> km</td>
                                        <td><%= route.estimated_duration_min %> phút</td>
                                        <td>
                                            <span class="badge <%= route.active ? 'badge-success' : 'badge-warning' %>">
                                                <%= route.active ? 'Đang hoạt động' : 'Không hoạt động' %>
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-secondary" onclick="location.href='/admin/routes/<%= route._id %>/edit'" style="margin-right: 0.5rem; padding: 0.5rem 1rem;">✏️ Sửa</button>
                                            <button class="btn btn-danger" onclick="deleteRoute('<%= route._id %>')" style="padding: 0.5rem 1rem;">🗑️ Xóa</button>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } %>
            </div>
        </main>
    </div>
    
    <script>
        async function deleteRoute(id) {
            if (!confirm('Bạn có chắc muốn xóa tuyến đường này?')) return;
            try {
                const response = await fetch(`/admin/routes/${id}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    alert('Đã xóa tuyến đường thành công');
                    location.reload();
                }
            } catch (error) {
                alert('Lỗi: ' + error.message);
            }
        }
    </script>
</body>
</html>

--- END OF FILE: backend\views\admin\routes.ejs ---


--- START OF FILE: backend\views\admin\route_form.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= route ? 'Sửa tuyến' : 'Thêm tuyến mới' %> - Admin</title>
  <style>
    body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:#f5f7fa;color:#333}
    .container{max-width:900px;margin:3rem auto;background:white;padding:1.5rem;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
    label{display:block;margin-top:0.75rem;font-weight:600}
    input[type=text], input[type=number]{width:100%;padding:0.6rem;border:1px solid #e5e7eb;border-radius:6px}
    .actions{margin-top:1rem;display:flex;gap:0.5rem}
    .btn{padding:0.6rem 1rem;border-radius:6px;border:none;cursor:pointer}
    .btn-primary{background:#1e3a8a;color:white}
    .btn-secondary{background:#e5e7eb}
  </style>
</head>
<body>
  <div class="container">
    <h2><%= route ? 'Sửa thông tin tuyến' : 'Thêm tuyến mới' %></h2>
    <form method="post" action="<%= route ? ('/admin/routes/' + route._id) : '/admin/routes' %>">
      <label>Tên tuyến</label>
      <input type="text" name="name" value="<%= route ? route.name : '' %>" required />

      <label>Thành phố đi</label>
      <input type="text" name="from_city" value="<%= route ? route.from_city : '' %>" />

      <label>Thành phố đến</label>
      <input type="text" name="to_city" value="<%= route ? route.to_city : '' %>" />

      <label>Tổng khoảng cách (km)</label>
      <input type="number" name="total_distance_km" value="<%= route ? route.total_distance_km : 0 %>" min="0" />

      <label>Thời gian ước tính (phút)</label>
      <input type="number" name="estimated_duration_min" value="<%= route ? route.estimated_duration_min : 0 %>" min="0" />

      <label>
        <input type="checkbox" name="active" <%= route && route.active ? 'checked' : '' %> /> Đang hoạt động
      </label>

      <div class="actions">
        <button type="submit" class="btn btn-primary">Lưu</button>
        <a href="/admin/routes" class="btn btn-secondary">Hủy</a>
      </div>
    </form>
  </div>
</body>
</html>
--- END OF FILE: backend\views\admin\route_form.ejs ---


--- START OF FILE: backend\views\admin\statistics.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistics - VeXe7TV Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --white: #ffffff;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--dark);
        }
        
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-xl);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .sidebar-header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .sidebar-nav {
            padding: 1.5rem 0;
        }
        
        .nav-item {
            display: block;
            padding: 0.875rem 1.5rem;
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            margin: 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .nav-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-left-color: var(--primary);
            color: var(--primary);
            transform: translateX(4px);
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.15) 0%, transparent 100%);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .page-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }
        
        .revenue-card {
            background: linear-gradient(135deg, var(--success) 0%, #34d399 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .revenue-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .revenue-card-content {
            position: relative;
            z-index: 1;
        }
        
        .revenue-card h3 {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        
        .revenue-card .value {
            font-size: 3rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 0.5rem;
        }
        
        .revenue-card .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .section {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light);
        }
        
        .section-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            margin: 0;
        }
        
        .section-icon {
            font-size: 1.75rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
        }
        
        .stat-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
            background: var(--white);
        }
        
        .stat-card:hover::before {
            transform: scaleX(1);
        }
        
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .stat-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .stat-card h3 {
            color: var(--gray);
            font-size: 0.8125rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
        }
        
        .icon-users { background: linear-gradient(135deg, var(--info), #60a5fa) !important; }
        .icon-customer { background: linear-gradient(135deg, var(--success), #34d399) !important; }
        .icon-driver { background: linear-gradient(135deg, var(--info), #60a5fa) !important; }
        .icon-assistant { background: linear-gradient(135deg, var(--warning), #fbbf24) !important; }
        .icon-admin { background: linear-gradient(135deg, var(--danger), #f87171) !important; }
        .icon-bus { background: linear-gradient(135deg, var(--primary), var(--primary-light)) !important; }
        .icon-route { background: linear-gradient(135deg, var(--success), #34d399) !important; }
        .icon-trip { background: linear-gradient(135deg, var(--info), #60a5fa) !important; }
        .icon-booking { background: linear-gradient(135deg, var(--primary), var(--primary-light)) !important; }
        .icon-pending { background: linear-gradient(135deg, var(--warning), #fbbf24) !important; }
        .icon-paid { background: linear-gradient(135deg, var(--info), #60a5fa) !important; }
        .icon-completed { background: linear-gradient(135deg, var(--success), #34d399) !important; }
        .icon-cancelled { background: linear-gradient(135deg, var(--danger), #f87171) !important; }
        .icon-scheduled { background: linear-gradient(135deg, var(--info), #60a5fa) !important; }
        .icon-departed { background: linear-gradient(135deg, var(--warning), #fbbf24) !important; }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .revenue-card .value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>🚌 VeXe7TV</h1>
                <p>Trang quản trị</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin" class="nav-item">
                    <span>📊</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/users" class="nav-item">
                    <span>👥</span>
                    <span>Users</span>
                </a>
                <a href="/admin/assistants" class="nav-item <%= page === 'assistants' ? 'active' : '' %>">
                    <span>👷</span>
                    <span>Lơ xe</span>
                </a>
                <a href="/admin/drivers" class="nav-item <%= page === 'drivers' ? 'active' : '' %>">
                    <span>🚐</span> 
                    <span>Tài xế</span>
                </a>
                <a href="/admin/buses" class="nav-item">
                    <span>🚌</span>
                    <span>Buses</span>
                </a>
                <a href="/admin/routes" class="nav-item">
                    <span>📍</span>
                    <span>Routes</span>
                </a>
                <a href="/admin/trips" class="nav-item">
                    <span>🕐</span>
                    <span>Trips</span>
                </a>
                <a href="/admin/bookings" class="nav-item">
                    <span>🎫</span>
                    <span>Bookings</span>
                </a>
                <a href="/admin/statistics" class="nav-item active">
                    <span>📈</span>
                    <span>Statistics</span>
                </a>
                <a href="/" class="nav-item" style="margin-top: 2rem; border-top: 1px solid var(--gray-light); padding-top: 1.5rem;">
                    <span>🏠</span>
                    <span>Về trang chủ</span>
                </a>
            </nav>
        </aside>
        
        <main class="main-content">
            <div class="page-header">
                <h2>Thống kê & Báo cáo</h2>
                <p>Tổng quan toàn diện về hệ thống</p>
            </div>
            
            <!-- Revenue Card -->
            <div class="revenue-card">
                <div class="revenue-card-content">
                    <h3>Tổng doanh thu</h3>
                    <div class="value"><%= stats.bookings.revenue.toLocaleString('vi-VN') %> ₫</div>
                    <div class="subtitle">Từ tất cả các đặt chỗ đã thanh toán</div>
                </div>
            </div>
            
            <!-- Users Statistics -->
            <div class="section">
                <div class="section-header">
                    <span class="section-icon">👥</span>
                    <h2>Thống kê Người dùng</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Tổng số</h3>
                                <div class="value"><%= stats.users.total %></div>
                            </div>
                            <div class="stat-card-icon icon-users">👥</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Khách hàng</h3>
                                <div class="value"><%= stats.users.byRole.customer %></div>
                            </div>
                            <div class="stat-card-icon icon-customer">🛒</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Tài xế</h3>
                                <div class="value"><%= stats.users.byRole.driver %></div>
                            </div>
                            <div class="stat-card-icon icon-driver">🚗</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Phụ xe</h3>
                                <div class="value"><%= stats.users.byRole.assistant %></div>
                            </div>
                            <div class="stat-card-icon icon-assistant">👷</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Quản trị viên</h3>
                                <div class="value"><%= stats.users.byRole.admin %></div>
                            </div>
                            <div class="stat-card-icon icon-admin">👨‍💼</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Buses & Routes Statistics -->
            <div class="section">
                <div class="section-header">
                    <span class="section-icon">🚌</span>
                    <h2>Thống kê Xe buýt & Tuyến đường</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Tổng số xe</h3>
                                <div class="value"><%= stats.buses.total %></div>
                            </div>
                            <div class="stat-card-icon icon-bus">🚌</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Xe đang hoạt động</h3>
                                <div class="value"><%= stats.buses.active %></div>
                            </div>
                            <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--success), #34d399);">✅</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Tổng số tuyến</h3>
                                <div class="value"><%= stats.routes.total %></div>
                            </div>
                            <div class="stat-card-icon icon-route">📍</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Tuyến đang hoạt động</h3>
                                <div class="value"><%= stats.routes.active %></div>
                            </div>
                            <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--success), #34d399);">✅</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Trips Statistics -->
            <div class="section">
                <div class="section-header">
                    <span class="section-icon">🕐</span>
                    <h2>Thống kê Chuyến xe</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Tổng số</h3>
                                <div class="value"><%= stats.trips.total %></div>
                            </div>
                            <div class="stat-card-icon icon-trip">🕐</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Đã lên lịch</h3>
                                <div class="value"><%= stats.trips.byStatus.scheduled %></div>
                            </div>
                            <div class="stat-card-icon icon-scheduled">📅</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Đã khởi hành</h3>
                                <div class="value"><%= stats.trips.byStatus.departed %></div>
                            </div>
                            <div class="stat-card-icon icon-departed">🚀</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Đã hoàn thành</h3>
                                <div class="value"><%= stats.trips.byStatus.completed %></div>
                            </div>
                            <div class="stat-card-icon icon-completed">✅</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Đã hủy</h3>
                                <div class="value"><%= stats.trips.byStatus.cancelled %></div>
                            </div>
                            <div class="stat-card-icon icon-cancelled">❌</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bookings Statistics -->
            <div class="section">
                <div class="section-header">
                    <span class="section-icon">🎫</span>
                    <h2>Thống kê Đặt chỗ</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Tổng số</h3>
                                <div class="value"><%= stats.bookings.total %></div>
                            </div>
                            <div class="stat-card-icon icon-booking">🎫</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Đang chờ</h3>
                                <div class="value"><%= stats.bookings.byStatus.pending %></div>
                            </div>
                            <div class="stat-card-icon icon-pending">⏳</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Đã thanh toán</h3>
                                <div class="value"><%= stats.bookings.byStatus.paid %></div>
                            </div>
                            <div class="stat-card-icon icon-paid">💳</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Hoàn thành</h3>
                                <div class="value"><%= stats.bookings.byStatus.completed %></div>
                            </div>
                            <div class="stat-card-icon icon-completed">✅</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div>
                                <h3>Đã hủy</h3>
                                <div class="value"><%= stats.bookings.byStatus.cancelled %></div>
                            </div>
                            <div class="stat-card-icon icon-cancelled">❌</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</body>
</html>

--- END OF FILE: backend\views\admin\statistics.ejs ---


--- START OF FILE: backend\views\admin\trips.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trips Management - VeXe7TV Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --white: #ffffff;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--dark);
        }
        
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-xl);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .sidebar-header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .sidebar-nav {
            padding: 1.5rem 0;
        }
        
        .nav-item {
            display: block;
            padding: 0.875rem 1.5rem;
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            margin: 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .nav-item:hover {
            background: rgba(99, 102, 241, 0.1);
            border-left-color: var(--primary);
            color: var(--primary);
            transform: translateX(4px);
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.15) 0%, transparent 100%);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .page-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            padding: 1.75rem;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .stat-card h3 {
            color: var(--gray);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
        }
        
        .content-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
        }
        
        .content-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .content-card h2 {
            margin: 0;
            color: var(--dark);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--gray);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-secondary:hover {
            background: #475569;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--light);
        }
        
        th {
            padding: 1rem 1.25rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--gray-light);
        }
        
        td {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-light);
            color: var(--dark);
        }
        
        tbody tr {
            transition: all 0.2s ease;
        }
        
        tbody tr:hover {
            background: var(--light);
            transform: scale(1.01);
        }
        
        .badge {
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        .badge-primary {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        .empty-state p {
            color: var(--gray);
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>🚌 VeXe7TV</h1>
                <p>Trang quản trị</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin" class="nav-item">
                    <span>📊</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/users" class="nav-item">
                    <span>👥</span>
                    <span>Users</span>
                </a>
                <a href="/admin/assistants" class="nav-item <%= page === 'assistants' ? 'active' : '' %>">
                    <span>👷</span>
                    <span>Lơ xe</span>
                </a>
                <a href="/admin/drivers" class="nav-item <%= page === 'drivers' ? 'active' : '' %>">
                    <span>🚐</span> 
                    <span>Tài xế</span>
                </a>
                <a href="/admin/buses" class="nav-item">
                    <span>🚌</span>
                    <span>Buses</span>
                </a>
                <a href="/admin/routes" class="nav-item">
                    <span>📍</span>
                    <span>Routes</span>
                </a>
                <a href="/admin/trips" class="nav-item active">
                    <span>🕐</span>
                    <span>Trips</span>
                </a>
                <a href="/admin/bookings" class="nav-item">
                    <span>🎫</span>
                    <span>Bookings</span>
                </a>
                <a href="/admin/statistics" class="nav-item">
                    <span>📈</span>
                    <span>Statistics</span>
                </a>
                <a href="/" class="nav-item" style="margin-top: 2rem; border-top: 1px solid var(--gray-light); padding-top: 1.5rem;">
                    <span>🏠</span>
                    <span>Về trang chủ</span>
                </a>
            </nav>
        </aside>
        
        <main class="main-content">
            <div class="page-header">
                <h2>Quản lý Chuyến xe</h2>
                <p>Quản lý tất cả chuyến xe trong hệ thống</p>
            </div>
            
        <div class="stats-grid">
            <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                <h3>Tổng số chuyến</h3>
                <div class="value"><%= stats.total %></div>
                        </div>
                        <div class="stat-card-icon">🕐</div>
                    </div>
            </div>
            <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                <h3>Đã lên lịch</h3>
                <div class="value"><%= stats.scheduled %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--info), #60a5fa);">📅</div>
                    </div>
            </div>
            <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                <h3>Đã khởi hành</h3>
                <div class="value"><%= stats.departed %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--warning), #fbbf24);">🚀</div>
                    </div>
            </div>
            <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                <h3>Đã hoàn thành</h3>
                <div class="value"><%= stats.completed %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--success), #34d399);">✅</div>
            </div>
        </div>
            </div>
            
            <div class="content-card">
                <div class="content-card-header">
                    <h2>Chuyến cố định</h2>
                    <a href="/admin/trips/new" class="btn btn-success">➕ Thêm chuyến mới</a>
                </div>
                <% if (!recurringTrips || recurringTrips.length === 0) { %>
                    <div class="empty-state">
                        <div class="empty-state-icon">📅</div>
                        <h3>Chưa có chuyến cố định</h3>
                        <p>Hãy dùng mục "Tạo chuyến cố định theo lịch" trong form Thêm chuyến mới</p>
                    </div>
                <% } else { %>
                    <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tuyến</th>
                        <th>Xe</th>
                        <th>Thời gian bắt đầu</th>
                        <th>Thời gian kết thúc</th>
                        <th>Giá</th>
                        <th>Hướng</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    <% recurringTrips.forEach(function(trip) { %>
                        <tr>
                                        <td><strong><%= trip._id.toString().substring(0, 8) %>...</strong></td>
                            <td><%= trip.route?.name || 'N/A' %></td>
                            <td><%= trip.bus?.license_plate || 'N/A' %></td>
                            <td><%= new Date(trip.start_time).toLocaleString('vi-VN') %></td>
                            <td><%= trip.end_time ? new Date(trip.end_time).toLocaleString('vi-VN') : 'N/A' %></td>
                                        <td><strong><%= (trip.base_price || 0).toLocaleString('vi-VN') %> ₫</strong></td>
                            <td>
                                <span class="badge <%= trip.direction === 'go' ? 'badge-success' : 'badge-warning' %>">
                                    <%= trip.direction === 'go' ? 'Đi' : 'Về' %>
                                </span>
                            </td>
                            <td>
                                <span class="badge badge-primary"><%= trip.status === 'scheduled' ? 'Đã lên lịch' : trip.status === 'departed' ? 'Đã khởi hành' : trip.status === 'completed' ? 'Hoàn thành' : trip.status === 'cancelled' ? 'Đã hủy' : trip.status || 'Đã lên lịch' %></span>
                            </td>
                            <td>
                                            <button class="btn btn-secondary" onclick="location.href='/admin/trips/<%= trip._id %>/edit'" style="margin-right: 0.5rem; padding: 0.5rem 1rem;">✏️ Sửa</button>
                                            <button class="btn btn-danger" onclick="deleteTrip('<%= trip._id %>')" style="padding: 0.5rem 1rem;">🗑️ Xóa</button>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
                <% } %>
            </div>

            <div class="content-card">
                <div class="content-card-header">
                    <h2>Chuyến không cố định</h2>
                </div>
                <% if (!singleTrips || singleTrips.length === 0) { %>
                    <div class="empty-state">
                        <div class="empty-state-icon">🕐</div>
                        <h3>Chưa có chuyến không cố định</h3>
                        <p>Vui lòng thêm chuyến lẻ bằng form Thêm chuyến mới</p>
                    </div>
                <% } else { %>
                    <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tuyến</th>
                        <th>Xe</th>
                        <th>Thời gian bắt đầu</th>
                        <th>Thời gian kết thúc</th>
                        <th>Giá</th>
                        <th>Hướng</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    <% singleTrips.forEach(function(trip) { %>
                        <tr>
                                        <td><strong><%= trip._id.toString().substring(0, 8) %>...</strong></td>
                            <td><%= trip.route?.name || 'N/A' %></td>
                            <td><%= trip.bus?.license_plate || 'N/A' %></td>
                            <td><%= new Date(trip.start_time).toLocaleString('vi-VN') %></td>
                            <td><%= trip.end_time ? new Date(trip.end_time).toLocaleString('vi-VN') : 'N/A' %></td>
                                        <td><strong><%= (trip.base_price || 0).toLocaleString('vi-VN') %> ₫</strong></td>
                            <td>
                                <span class="badge <%= trip.direction === 'go' ? 'badge-success' : 'badge-warning' %>">
                                    <%= trip.direction === 'go' ? 'Đi' : 'Về' %>
                                </span>
                            </td>
                            <td>
                                <span class="badge badge-primary"><%= trip.status === 'scheduled' ? 'Đã lên lịch' : trip.status === 'departed' ? 'Đã khởi hành' : trip.status === 'completed' ? 'Hoàn thành' : trip.status === 'cancelled' ? 'Đã hủy' : trip.status || 'Đã lên lịch' %></span>
                            </td>
                            <td>
                                            <button class="btn btn-secondary" onclick="location.href='/admin/trips/<%= trip._id %>/edit'" style="margin-right: 0.5rem; padding: 0.5rem 1rem;">✏️ Sửa</button>
                                            <button class="btn btn-danger" onclick="deleteTrip('<%= trip._id %>')" style="padding: 0.5rem 1rem;">🗑️ Xóa</button>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
                <% } %>
            </div>
        </main>
    </div>
    
    <script>
        async function deleteTrip(id) {
            if (!confirm('Bạn có chắc muốn xóa chuyến xe này?')) return;
            try {
                const response = await fetch(`/admin/trips/${id}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    alert('Đã xóa chuyến xe thành công');
                    location.reload();
                }
            } catch (error) {
                alert('Lỗi: ' + error.message);
            }
        }
    </script>
</body>
</html>

--- END OF FILE: backend\views\admin\trips.ejs ---


--- START OF FILE: backend\views\admin\trip_form.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= trip ? 'Sửa chuyến' : 'Thêm chuyến mới' %> - Admin</title>
  <style>
    body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:#f5f7fa;color:#333}
    .container{max-width:900px;margin:3rem auto;background:white;padding:1.5rem;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
    label{display:block;margin-top:0.75rem;font-weight:600}
    input[type=text], input[type=datetime-local], input[type=number], select{width:100%;padding:0.6rem;border:1px solid #e5e7eb;border-radius:6px}
    .actions{margin-top:1rem;display:flex;gap:0.5rem}
    .btn{padding:0.6rem 1rem;border-radius:6px;border:none;cursor:pointer}
    .btn-primary{background:#1e3a8a;color:white}
    .btn-secondary{background:#e5e7eb}
  </style>
</head>
<body>
  <div class="container">
    <h2><%= trip ? 'Sửa thông tin chuyến' : 'Thêm chuyến mới' %></h2>
    <form method="post" action="<%= trip ? ('/admin/trips/' + trip._id) : '/admin/trips' %>">
      <label>Tuyến</label>
      <select name="route" required>
        <% routes.forEach(function(r){ %>
          <option value="<%= r._id %>" <%= trip && trip.route && trip.route.toString()===r._id.toString() ? 'selected' : '' %>><%= r.name %> — <%= r.from_city %> → <%= r.to_city %></option>
        <% }) %>
      </select>

      <label>Xe</label>
      <select name="bus" required>
        <% buses.forEach(function(b){ %>
          <option value="<%= b._id %>" <%= trip && trip.bus && trip.bus.toString()===b._id.toString() ? 'selected' : '' %>><%= b.license_plate %> — <%= b.bus_type %></option>
        <% }) %>
      </select>

      <label>Thời gian bắt đầu</label>
      <input type="datetime-local" name="start_time" value="<%= trip && trip.start_time ? new Date(trip.start_time).toISOString().slice(0,16) : '' %>" />

      <label>Thời gian kết thúc</label>
      <input type="datetime-local" name="end_time" value="<%= trip && trip.end_time ? new Date(trip.end_time).toISOString().slice(0,16) : '' %>" />

      <label>Giá cơ bản (VND)</label>
      <input type="number" name="base_price" value="<%= trip ? trip.base_price : 0 %>" min="0" />

      <label>Hướng</label>
      <select name="direction">
        <option value="go" <%= trip && trip.direction==='go' ? 'selected' : '' %>>Đi</option>
        <option value="return" <%= trip && trip.direction==='return' ? 'selected' : '' %>>Về</option>
      </select>

      <label>Trạng thái</label>
      <select name="status">
        <option value="scheduled" <%= trip && trip.status==='scheduled' ? 'selected' : '' %>>Đã lên lịch</option>
        <option value="departed" <%= trip && trip.status==='departed' ? 'selected' : '' %>>Đã khởi hành</option>
        <option value="completed" <%= trip && trip.status==='completed' ? 'selected' : '' %>>Hoàn thành</option>
        <option value="cancelled" <%= trip && trip.status==='cancelled' ? 'selected' : '' %>>Đã hủy</option>
      </select>

      <div class="actions">
        <button type="submit" class="btn btn-primary">Lưu</button>
        <a href="/admin/trips" class="btn btn-secondary">Hủy</a>
      </div>
    </form>

    <hr style="margin:2rem 0;border:none;border-top:1px solid #e5e7eb" />
    <h2>Tạo chuyến cố định theo lịch</h2>
    <form method="post" action="/admin/trips/recurring">
      <label>Tuyến</label>
      <select name="route" required>
        <% routes.forEach(function(r){ %>
          <option value="<%= r._id %>"><%= r.name %> — <%= r.from_city %> → <%= r.to_city %></option>
        <% }) %>
      </select>

      <label>Xe</label>
      <select name="bus" required>
        <% buses.forEach(function(b){ %>
          <option value="<%= b._id %>"><%= b.license_plate %> — <%= b.bus_type %></option>
        <% }) %>
      </select>

      <label>Giá cơ bản (VND)</label>
      <input type="number" name="base_price" value="0" min="0" />

      <label>Hướng</label>
      <select name="direction">
        <option value="go">Đi</option>
        <option value="return">Về</option>
      </select>

      <label>Loại lặp</label>
      <select name="frequency">
        <option value="daily">Hằng ngày</option>
        <option value="weekly">Theo tuần</option>
      </select>

      <label>Ngày bắt đầu</label>
      <input type="date" name="start_date" />

      <label>Ngày kết thúc (mặc định 6 tháng)</label>
      <input type="date" name="end_date" />

      <label>Giờ khởi hành cố định</label>
      <input type="time" name="time_of_day" value="08:00" />

      <label>Thứ trong tuần (khi chọn theo tuần)</label>
      <div style="display:flex;flex-wrap:wrap;gap:0.5rem">
        <label><input type="checkbox" name="days_of_week" value="1" /> Thứ 2</label>
        <label><input type="checkbox" name="days_of_week" value="2" /> Thứ 3</label>
        <label><input type="checkbox" name="days_of_week" value="3" /> Thứ 4</label>
        <label><input type="checkbox" name="days_of_week" value="4" /> Thứ 5</label>
        <label><input type="checkbox" name="days_of_week" value="5" /> Thứ 6</label>
        <label><input type="checkbox" name="days_of_week" value="6" /> Thứ 7</label>
        <label><input type="checkbox" name="days_of_week" value="0" /> Chủ nhật</label>
      </div>

      <div class="actions">
        <button type="submit" class="btn btn-primary">Tạo chuyến cố định</button>
        <a href="/admin/trips" class="btn btn-secondary">Hủy</a>
      </div>
    </form>
  </div>
</body>
</html>

--- END OF FILE: backend\views\admin\trip_form.ejs ---


--- START OF FILE: backend\views\admin\users.ejs ---
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users Management - VeXe7TV Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-light: #e2e8f0;
            --white: #ffffff;
            --sidebar-bg: #ffffff;
            --sidebar-hover: rgba(99, 102, 241, 0.1);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--dark);
        }
        
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            box-shadow: var(--shadow-xl);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .sidebar-header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .sidebar-nav {
            padding: 1.5rem 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            margin: 0.25rem 0;
        }
        
        .nav-item:hover {
            background: var(--sidebar-hover);
            border-left-color: var(--primary);
            color: var(--primary);
            transform: translateX(4px);
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.15) 0%, transparent 100%);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        
        .nav-item span:first-child {
            font-size: 1.25rem;
        }
        
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-header h2 {
            font-size: 2.25rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .page-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.125rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            padding: 1.75rem;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .stat-card h3 {
            color: var(--gray);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1;
        }
        
        .content-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 2rem;
        }
        
        .content-card h2 {
            margin: 0 0 1.5rem 0;
            color: var(--dark);
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--light);
        }
        
        th {
            padding: 1rem 1.25rem;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--gray-light);
        }
        
        td {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-light);
            color: var(--dark);
        }
        
        tbody tr {
            transition: all 0.2s ease;
        }
        
        tbody tr:hover {
            background: var(--light);
        }
        
        .badge {
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        
        .badge-primary {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        .empty-state p {
            color: var(--gray);
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="admin-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>🚌 VeXe7TV</h1>
                <p>Trang quản trị</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin" class="nav-item <%= page === 'dashboard' ? 'active' : '' %>">
                    <span>📊</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/users" class="nav-item <%= page === 'users' && !roleFilter ? 'active' : '' %>">
                    <span>👥</span>
                    <span>Users</span>
                </a>
                <a href="/admin/assistants" class="nav-item <%= page === 'assistants' ? 'active' : '' %>">
                    <span>👷</span>
                    <span>Lơ xe</span>
                </a>
                <a href="/admin/drivers" class="nav-item <%= page === 'drivers' ? 'active' : '' %>">
                    <span>🚐</span> 
                    <span>Tài xế</span>
                </a>
                <a href="/admin/buses" class="nav-item <%= page === 'buses' ? 'active' : '' %>">
                    <span>🚌</span>
                    <span>Buses</span>
                </a>
                <a href="/admin/routes" class="nav-item <%= page === 'routes' ? 'active' : '' %>">
                    <span>📍</span>
                    <span>Routes</span>
                </a>
                <a href="/admin/trips" class="nav-item <%= page === 'trips' ? 'active' : '' %>">
                    <span>🕐</span>
                    <span>Trips</span>
                </a>
                <a href="/admin/bookings" class="nav-item <%= page === 'bookings' ? 'active' : '' %>">
                    <span>🎫</span>
                    <span>Bookings</span>
                </a>
                <a href="/admin/statistics" class="nav-item <%= page === 'statistics' ? 'active' : '' %>">
                    <span>📈</span>
                    <span>Statistics</span>
                </a>
                <a href="/" class="nav-item" style="margin-top: 2rem; border-top: 1px solid var(--gray-light); padding-top: 1.5rem;">
                    <span>🏠</span>
                    <span>Về trang chủ</span>
                </a>
            </nav>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h2>Quản lý Người dùng</h2>
                <p>Quản lý tất cả người dùng trong hệ thống</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Tổng số người dùng</h3>
                            <div class="value"><%= stats.total %></div>
                        </div>
                        <div class="stat-card-icon">👥</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Khách hàng</h3>
                            <div class="value"><%= stats.customers %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--success), #34d399);">🛒</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Tài xế</h3>
                            <div class="value"><%= stats.drivers %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--info), #60a5fa);">🚗</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Phụ xe</h3>
                            <div class="value"><%= stats.assistants %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--warning), #fbbf24);">👷</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <h3>Quản trị viên</h3>
                            <div class="value"><%= stats.admins %></div>
                        </div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, var(--danger), #f87171);">👨‍💼</div>
                    </div>
                </div>
            </div>

            <div class="content-card">
                <h2>Danh sách Người dùng</h2>
                <% if (users.length === 0) { %>
                    <div class="empty-state">
                        <div class="empty-state-icon">👥</div>
                        <h3>Chưa có người dùng nào</h3>
                        <p>Hệ thống chưa có người dùng</p>
                    </div>
                <% } else { %>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Họ tên</th>
                                    <th>Email</th>
                                    <th>SĐT</th>
                                    <th>Vai trò</th>
                                    <th>Ngày tạo</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% users.forEach(function(user) { %>
                                    <tr>
                                        <td><strong><%= user.name %></strong></td>
                                        <td><%= user.email || '-' %></td>
                                        <td><%= user.phone || '-' %></td>
                                        <td>
                                            <span class="badge <%= user.role === 'admin' ? 'badge-danger' : user.role === 'driver' ? 'badge-primary' : user.role === 'assistant' ? 'badge-warning' : 'badge-success' %>">
                                                <%= user.role === 'admin' ? 'Quản trị viên' : user.role === 'driver' ? 'Tài xế' : user.role === 'assistant' ? 'Phụ xe' : user.role === 'customer' ? 'Khách hàng' : user.role %>
                                            </span>
                                        </td>
                                        <td><%= new Date(user.createdAt).toLocaleString('vi-VN') %></td>
                                        <td>
                                            <button class="btn btn-danger" onclick="deleteUser('<%= user._id %>')">🗑️ Xóa</button>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } %>
            </div>
        </main>
    </div>

    <script>
        async function deleteUser(id) {
            if (!confirm('Bạn có chắc muốn xóa người dùng này?')) return;
            try {
                const response = await fetch(`/admin/users/${id}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    alert('Đã xóa người dùng thành công');
                    location.reload();
                } else {
                    alert('Lỗi: ' + (data.error || 'Không thể xóa người dùng'));
                }
            } catch (error) {
                alert('Lỗi: ' + error.message);
            }
        }
    </script>
</body>
</html>

--- END OF FILE: backend\views\admin\users.ejs ---


--- START OF FILE: frontend\index.html ---
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VeXe7TV - Đặt vé xe buýt trực tuyến</title>
    <meta name="description" content="Đặt vé xe buýt trực tuyến nhanh chóng, tiện lợi và giá cả hợp lý. BaseVeXe - dịch vụ đặt vé xe buýt hàng đầu Việt Nam." />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

--- END OF FILE: frontend\index.html ---


--- START OF FILE: frontend\package.json ---
{
  "name": "basevexe-frontend",
  "version": "1.0.0",
  "description": "Frontend for BaseVeXe bus booking application",
  "main": "index.js",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.8.1",
    "lucide-react": "^0.263.1"
  },
  "devDependencies": {
    "@types/react": "^18.2.15",
    "@types/react-dom": "^18.2.7",
    "@typescript-eslint/eslint-plugin": "^6.0.0",
    "@typescript-eslint/parser": "^6.0.0",
    "@vitejs/plugin-react": "^4.0.3",
    "eslint": "^8.45.0",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.3",
    "typescript": "^5.0.2",
    "vite": "^4.4.5"
  }
}

--- END OF FILE: frontend\package.json ---


--- START OF FILE: frontend\src\App.css ---
/* Reset và base styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  line-height: 1.6;
  color: #333;
}

.App {
  min-height: 100vh;
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Responsive utilities */
@media (max-width: 768px) {
  .hidden-mobile {
    display: none !important;
  }
}

@media (min-width: 769px) {
  .hidden-desktop {
    display: none !important;
  }
}

/* Print styles: tối ưu cho in / lưu PDF trên desktop và mobile */
@media print {
  body {
    background: #fff !important;
    color: #000 !important;
  }

  /* Ẩn các phần không cần in (navigation, nút, footer) */
  .no-print {
    display: none !important;
  }

  /* Làm vé chiếm toàn trang in, bỏ shadow/border */
  .printable-ticket {
    width: 100% !important;
    box-shadow: none !important;
    border: none !important;
    background: transparent !important;
    color: #000 !important;
    break-inside: avoid;
    page-break-inside: avoid;
  }

  /* Ảnh / biểu tượng co vừa trang */
  img {
    max-width: 100% !important;
    height: auto !important;
  }

  svg {
    color: #000 !important;
    fill: currentColor !important;
  }

  /* Giảm kích thước font trên in để vừa khổ */
  body, .printable-ticket, .printable-ticket * {
    font-size: 12px !important;
  }
}

/* Kích thước trang in mặc định (desktop) */
@page {
  size: A4 portrait;
  margin: 10mm;
}

--- END OF FILE: frontend\src\App.css ---


--- START OF FILE: frontend\src\App.tsx ---
import React, { createContext, useContext, useState, useEffect } from 'react';
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import HomePage from './components/HomePage';
import BookingDetail from './components/BookingDetail';
import PaymentPage from './components/PaymentPage';
import PaymentSuccess from './components/PaymentSuccess';
import RoutesPage from './components/RoutesPage';
import MyTicketsPage from './components/MyTicketsPage';
import TicketDetailPage from './components/TicketDetailPage';
import ContactPage from './components/ContactPage';
import AdminPage from './components/AdminPage';
import LoginPage from './components/LoginPage';
import RegisterPage from './components/RegisterPage';
import './App.css';

// 1. Thêm isLoading vào Context Type
interface AuthContextType {
  user: any;
  isLoading: boolean; 
  login: (userData: any) => void;
  logout: () => void;
}

const AuthContext = createContext<AuthContextType>({
  user: null,
  isLoading: true, // Mặc định là đang load
  login: () => {},
  logout: () => {},
});

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [user, setUser] = useState<any>(null);
  const [isLoading, setIsLoading] = useState(true); // State để theo dõi quá trình check login

  useEffect(() => {
    const validateAuth = async () => {
      setIsLoading(true); // Bắt đầu check
      const userData = localStorage.getItem('user');
      
      if (userData) {
        try {
          // Lấy URL Backend từ biến môi trường hoặc fallback về localhost
          const API_BASE = ((import.meta as any)?.env?.VITE_BACKEND_URL as string) || 'http://localhost:5000';
          
          const response = await fetch(`${API_BASE}/api/auth/me`, {
            credentials: 'include' // Quan trọng để gửi cookie token
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.data) {
              setUser(data.data);
              localStorage.setItem('user', JSON.stringify(data.data));
            } else {
              setUser(JSON.parse(userData));
            }
          } else {
            // Token hết hạn hoặc không hợp lệ
            logout();
          }
        } catch (error) {
          logout();
        }
      } else {
        // Không có data trong storage
        setIsLoading(false);
      }
      setIsLoading(false); // Kết thúc check
    };

    validateAuth();
  }, []);

  const login = (userData: any) => {
    setUser(userData);
    localStorage.setItem('user', JSON.stringify(userData));
  };

  const logout = () => {
    setUser(null);
    localStorage.removeItem('user');
    setIsLoading(false);
  };

  return (
    <AuthContext.Provider value={{ user, isLoading, login, logout }}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => useContext(AuthContext);

// Protected route component đã được nâng cấp
const ProtectedRoute: React.FC<{ children: React.ReactNode; allowedRoles?: string[] }> = ({ 
  children, 
  allowedRoles = [] 
}) => {
  const { user, isLoading } = useAuth();

  // 2. Nếu đang check login thì hiện màn hình chờ, ĐỪNG redirect vội
  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center">
          <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
          <p className="text-gray-500 text-sm">Đang tải...</p>
        </div>
      </div>
    );
  }

  // Check xong rồi mà không có user thì mới đá về login
  if (!user) {
    return <Navigate to="/login" replace />;
  }

  if (allowedRoles.length > 0 && !allowedRoles.includes(user.role)) {
    return <Navigate to="/" replace />;
  }

  return <>{children}</>;
};

const App: React.FC = () => {
  return (
    <AuthProvider>
      <Router>
        <div className="App">
          <Routes>
            <Route path="/" element={<HomePage />} />
            <Route path="/routes" element={<RoutesPage />} />
            <Route path="/login" element={<LoginPage />} />
            <Route path="/register" element={<RegisterPage />} />
            <Route path="/contact" element={<ContactPage />} />
            
            {/* Các route cần bảo vệ */}
            <Route
              path="/my-tickets"
              element={
                <ProtectedRoute>
                  <MyTicketsPage />
                </ProtectedRoute>
              }
            />
            <Route
              path="/ticket-detail"
              element={
                <ProtectedRoute>
                  <TicketDetailPage />
                </ProtectedRoute>
              }
            />
            <Route
              path="/booking/:routeId"
              element={
                <ProtectedRoute>
                  <BookingDetail />
                </ProtectedRoute>
              }
            />
            <Route
              path="/payment"
              element={
                <ProtectedRoute>
                  <PaymentPage />
                </ProtectedRoute>
              }
            />
            <Route
              path="/payment-success"
              element={
                <ProtectedRoute>
                  <PaymentSuccess />
                </ProtectedRoute>
              }
            />
            <Route
              path="/admin"
              element={
                <ProtectedRoute allowedRoles={['admin']}>
                  <AdminPage />
                </ProtectedRoute>
              }
            />
          </Routes>
        </div>
      </Router>
    </AuthProvider>
  );
};

export default App;
--- END OF FILE: frontend\src\App.tsx ---


--- START OF FILE: frontend\src\components\AdminPage.tsx ---
// frontend/src/components/AdminPage.tsxxx
import React, { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';

interface Trip {
  _id: string;
  route: any;
  bus: any;
  start_time: string;
  end_time: string;
  base_price: number;
  direction: string;
}

interface Booking {
  _id: string;
  trip: any;
  user: any;
  seats: string[];
  total_price: number;
  status: string;
  createdAt: string;
}

const AdminPage: React.FC = () => {
  const [trips, setTrips] = useState<Trip[]>([]);
  const [bookings, setBookings] = useState<Booking[]>([]);
  const [activeTab, setActiveTab] = useState<'trips' | 'bookings'>('trips');

  // URL Backend
  const API_BASE = 'http://localhost:5000';

  useEffect(() => {
    fetchTrips();
    fetchBookings();
  }, []);

  const fetchTrips = async () => {
    try {
      const response = await fetch(`${API_BASE}/api/trips`);
      const data = await response.json();
      setTrips(data);
    } catch (error) {
      console.error('Error fetching trips:', error);
    }
  };

  const fetchBookings = async () => {
    try {
      // Dùng endpoint admin để lấy tất cả booking
      const response = await fetch(`${API_BASE}/api/bookings`);
      const data = await response.json();
      setBookings(data);
    } catch (error) {
      console.error('Error fetching bookings:', error);
    }
  };

  const handleDeleteBooking = async (bookingId: string) => {
    if (!window.confirm('Bạn có chắc chắn muốn xóa đặt chỗ này?')) {
      return;
    }

    try {
      // Gọi API xóa trong admin routes
      const response = await fetch(`${API_BASE}/admin/bookings/${bookingId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        throw new Error('Error deleting booking');
      }

      // Refresh the bookings list
      fetchBookings();
    } catch (error) {
      console.error('Error:', error);
      alert('Có lỗi khi xóa đặt chỗ. Vui lòng thử lại.');
    }
  };

  // --- HÀM DUYỆT THANH TOÁN (MỚI) ---
  const handleApprovePayment = async (bookingId: string) => {
    if (!window.confirm('Xác nhận đã nhận được tiền cho đơn này?')) return;
    
    try {
      // Gọi API update status (Lưu ý: dùng /admin/bookings/... theo đúng file adminRoutes.js)
      const response = await fetch(`${API_BASE}/admin/bookings/${bookingId}/status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'paid' }) // Chuyển sang trạng thái đã thanh toán
      });

      if (response.ok) {
        alert('Đã duyệt đơn thành công!');
        fetchBookings(); // Load lại danh sách để cập nhật trạng thái
      } else {
        const err = await response.json();
        alert('Lỗi khi duyệt đơn: ' + (err.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Error approving:', error);
      alert('Lỗi kết nối đến server');
    }
  };

  return (
    <div style={{ minHeight: '100vh', backgroundColor: '#f5f5f5' }}>
      {/* Header */}
      <header style={{
        backgroundColor: '#1e3a8a',
        color: 'white',
        padding: '1.5rem',
        boxShadow: '0 2px 10px rgba(0,0,0,0.1)'
      }}>
        <div style={{ maxWidth: '1200px', margin: '0 auto', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <h1 style={{ margin: 0 }}>Admin Dashboard</h1>
          <Link to="/" style={{ color: 'white', textDecoration: 'none' }}>← Về trang chủ</Link>
        </div>
      </header>

      {/* Main Content */}
      <div style={{ maxWidth: '1200px', margin: '2rem auto', padding: '0 1rem' }}>
        {/* Tabs */}
        <div style={{ 
          display: 'flex', 
          gap: '1rem', 
          marginBottom: '2rem',
          backgroundColor: 'white',
          padding: '0.5rem',
          borderRadius: '8px',
          boxShadow: '0 2px 5px rgba(0,0,0,0.1)'
        }}>
          <button
            onClick={() => setActiveTab('trips')}
            style={{
              flex: 1,
              padding: '1rem',
              border: 'none',
              borderRadius: '6px',
              backgroundColor: activeTab === 'trips' ? '#1e3a8a' : 'transparent',
              color: activeTab === 'trips' ? 'white' : '#333',
              cursor: 'pointer',
              fontSize: '1rem',
              fontWeight: '600',
              transition: 'all 0.3s'
            }}
          >
            Quản lý Chuyến xe ({trips.length})
          </button>
          <button
            onClick={() => setActiveTab('bookings')}
            style={{
              flex: 1,
              padding: '1rem',
              border: 'none',
              borderRadius: '6px',
              backgroundColor: activeTab === 'bookings' ? '#1e3a8a' : 'transparent',
              color: activeTab === 'bookings' ? 'white' : '#333',
              cursor: 'pointer',
              fontSize: '1rem',
              fontWeight: '600',
              transition: 'all 0.3s'
            }}
          >
            Quản lý Đặt chỗ ({bookings.length})
          </button>
        </div>

        {/* Trips Tab */}
        {activeTab === 'trips' && (
          <div style={{
            backgroundColor: 'white',
            borderRadius: '8px',
            padding: '1.5rem',
            boxShadow: '0 2px 10px rgba(0,0,0,0.1)'
          }}>
            <h2 style={{ marginTop: 0, color: '#1e3a8a' }}>Danh sách Chuyến xe</h2>
            <div style={{ overflowX: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                <thead>
                  <tr style={{ backgroundColor: '#f3f4f6' }}>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>ID</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Tuyến</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Thời gian</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Giá cơ bản</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Hướng</th>
                  </tr>
                </thead>
                <tbody>
                  {trips.map((trip) => (
                    <tr key={trip._id} style={{ borderBottom: '1px solid #e5e7eb' }}>
                      <td style={{ padding: '1rem' }}>{trip._id.substring(0, 8)}...</td>
                      <td style={{ padding: '1rem' }}>{trip.route?.name || 'N/A'}</td>
                      <td style={{ padding: '1rem' }}>
                        {new Date(trip.start_time).toLocaleString('vi-VN')}
                      </td>
                      <td style={{ padding: '1rem' }}>
                        {trip.base_price?.toLocaleString('vi-VN')} ₫
                      </td>
                      <td style={{ padding: '1rem' }}>
                        <span style={{
                          padding: '0.25rem 0.75rem',
                          borderRadius: '4px',
                          backgroundColor: trip.direction === 'go' ? '#dbeafe' : '#fed7aa',
                          color: trip.direction === 'go' ? '#1e40af' : '#c2410c'
                        }}>
                          {trip.direction === 'go' ? 'Đi' : 'Về'}
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              {trips.length === 0 && (
                <p style={{ textAlign: 'center', padding: '2rem', color: '#6b7280' }}>
                  Chưa có chuyến xe nào
                </p>
              )}
            </div>
          </div>
        )}

        {/* Bookings Tab */}
        {activeTab === 'bookings' && (
          <div style={{
            backgroundColor: 'white',
            borderRadius: '8px',
            padding: '1.5rem',
            boxShadow: '0 2px 10px rgba(0,0,0,0.1)'
          }}>
            <h2 style={{ marginTop: 0, color: '#1e3a8a' }}>Danh sách Đặt chỗ</h2>
            <div style={{ overflowX: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                <thead>
                  <tr style={{ backgroundColor: '#f3f4f6' }}>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>ID</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Khách hàng</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Ghế</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Tổng tiền</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Trạng thái</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Ngày đặt</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Thao tác</th>
                  </tr>
                </thead>
                <tbody>
                  {bookings.map((booking) => (
                    <tr key={booking._id} style={{ borderBottom: '1px solid #e5e7eb' }}>
                      <td style={{ padding: '1rem' }}>{booking._id.substring(0, 8)}...</td>
                      <td style={{ padding: '1rem' }}>{booking.user?.name || 'N/A'}</td>
                      <td style={{ padding: '1rem' }}>{booking.seats?.join(', ') || 'N/A'}</td>
                      <td style={{ padding: '1rem' }}>
                        {booking.total_price?.toLocaleString('vi-VN')} ₫
                      </td>
                      <td style={{ padding: '1rem' }}>
                        <span style={{
                          padding: '0.25rem 0.75rem',
                          borderRadius: '4px',
                          backgroundColor: 
                            booking.status === 'paid' || booking.status === 'confirmed' || booking.status === 'completed' 
                              ? '#d1fae5' 
                              : booking.status === 'pending' 
                                ? '#fef3c7' 
                                : '#fee2e2',
                          color: 
                            booking.status === 'paid' || booking.status === 'confirmed' || booking.status === 'completed'
                              ? '#065f46' 
                              : booking.status === 'pending' 
                                ? '#d97706' 
                                : '#991b1b'
                        }}>
                          {booking.status === 'paid' ? 'Đã thanh toán' : booking.status === 'pending' ? 'Chờ thanh toán' : booking.status}
                        </span>
                      </td>
                      <td style={{ padding: '1rem' }}>
                        {new Date(booking.createdAt).toLocaleString('vi-VN')}
                      </td>
                      <td style={{ padding: '1rem' }}>
                        {/* NÚT DUYỆT: Chỉ hiện khi trạng thái là pending */}
                        {booking.status === 'pending' && (
                          <button
                            onClick={() => handleApprovePayment(booking._id)}
                            style={{
                              padding: '0.5rem 1rem',
                              backgroundColor: '#10b981', // Màu xanh lá
                              color: 'white',
                              border: 'none',
                              borderRadius: '4px',
                              cursor: 'pointer',
                              marginRight: '8px',
                              transition: 'all 0.2s'
                            }}
                            title="Xác nhận đã nhận tiền"
                          >
                            ✔ Duyệt
                          </button>
                        )}

                        <button 
                          onClick={() => handleDeleteBooking(booking._id)}
                          style={{
                            padding: '0.5rem 1rem',
                            backgroundColor: '#ef4444',
                            color: 'white',
                            border: 'none',
                            borderRadius: '4px',
                            cursor: 'pointer',
                            transition: 'all 0.2s'
                          }}
                          onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#dc2626'}
                          onMouseOut={(e) => e.currentTarget.style.backgroundColor = '#ef4444'}
                        >
                          Xóa
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              {bookings.length === 0 && (
                <p style={{ textAlign: 'center', padding: '2rem', color: '#6b7280' }}>
                  Chưa có đặt chỗ nào
                </p>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default AdminPage;
--- END OF FILE: frontend\src\components\AdminPage.tsx ---


--- START OF FILE: frontend\src\components\BookingDetail.tsx ---
// src/components/BookingDetail.tsx
import React, { useEffect, useMemo, useState } from 'react';
import { useAuth } from '../App';
import { useParams, useNavigate } from 'react-router-dom';
import { ArrowLeft, Bus, MapPin, Clock, Users, Calendar } from 'lucide-react';

/** Types matching backend responses */
type TripDoc = {
  _id: string;
  route: {
    _id: string;
    name?: string;
    from_city?: string;
    to_city?: string;
    estimated_duration_min?: number;
  };
  bus: {
    _id: string;
    license_plate?: string;
    bus_type?: string;
    seat_count?: number;
  };
  start_time: string; // ISO
  end_time?: string | null;
  base_price?: number;
  direction?: 'go' | 'return';
  status?: 'scheduled' | 'departed' | 'completed' | 'cancelled';
};

type SeatDoc = {
  _id: string;
  trip: string;
  seat_number: string; // "1", "2", ...
  status: 'available' | 'reserved' | 'booked' | 'checked_in';
  booking_id?: string | null;
};

type RouteStopDoc = {
  _id: string;
  route: string;
  stop_name: string;
  order: number;
  type: 'pickup' | 'dropoff' | 'both';
};

type TripDetailResponse = {
  trip: TripDoc;
  seats: SeatDoc[];
  stops?: RouteStopDoc[];
};

// Use relative path to leverage Vite proxy, or fallback to env variable
const API_BASE = ((import.meta as any)?.env?.VITE_BACKEND_URL as string) || '';

// Function to compare seats arrays - moved outside component to prevent re-render loops
const seatsEqual = (a?: SeatDoc[], b?: SeatDoc[]) => {
  if (!a && !b) return true;
  if (!a || !b) return false;
  if (a.length !== b.length) return false;
  return a.every((seat, i) => 
    seat.seat_number === b[i].seat_number && 
    seat.status === b[i].status
  );
};

const BookingDetail: React.FC = () => {
  const { routeId } = useParams<{ routeId: string }>();
  const navigate = useNavigate();

  const [searchDate, setSearchDate] = useState(new Date().toISOString().split('T')[0]);
  const [allTrips, setAllTrips] = useState<TripDoc[]>([]);
  const [loadingTrips, setLoadingTrips] = useState(true);
  const [errTrips, setErrTrips] = useState<string | null>(null);

  const [selectedTrip, setSelectedTrip] = useState<TripDoc | null>(null);

  const [tripDetail, setTripDetail] = useState<TripDetailResponse | null>(null);
  const [loadingDetail, setLoadingDetail] = useState(false);
  const [errDetail, setErrDetail] = useState<string | null>(null);

  const [selectedSeats, setSelectedSeats] = useState<number[]>([]);
  const [passengerInfo, setPassengerInfo] = useState({ name: '', phone: '', email: '', note: '' });
  const [phoneError, setPhoneError] = useState<string | null>(null);
  const { user } = useAuth();

  useEffect(() => {
    // If the visitor is logged in and passenger email not filled yet, prefill it
    if (user && user.email && !passengerInfo.email) {
      setPassengerInfo(prev => ({ ...prev, email: user.email }));
    }
  }, [user]);

  const isValidPhone = (phone: string) => {
    if (!phone) return false;
    const p = phone.trim();
    // Accept Vietnamese mobile numbers starting with 0 or +84 followed by valid operator and 8 digits
    // Examples: 0912345678 or +84912345678
    const re = /^(?:\+84|0)(?:3|5|7|8|9)\d{8}$/;
    return re.test(p);
  };
  const [selectedPickupId, setSelectedPickupId] = useState<string | null>(null);
  const [selectedDropoffId, setSelectedDropoffId] = useState<string | null>(null);

  // Reset selections when user chooses a different trip
  useEffect(() => {
    setSelectedPickupId(null);
    setSelectedDropoffId(null);
    setSelectedSeats([]);
  }, [selectedTrip?._id]);

  // Validate selected stops when tripDetail/stops change
  useEffect(() => {
    if (!tripDetail?.stops) return;
    const hasPickup = selectedPickupId ? tripDetail.stops.some(s => s._id === selectedPickupId) : true;
    const hasDropoff = selectedDropoffId ? tripDetail.stops.some(s => s._id === selectedDropoffId) : true;
    if (!hasPickup) setSelectedPickupId(null);
    if (!hasDropoff) setSelectedDropoffId(null);
    // if both present, ensure order validity
    if (selectedPickupId && selectedDropoffId) {
      const pu = tripDetail.stops.find(s => s._id === selectedPickupId);
      const dr = tripDetail.stops.find(s => s._id === selectedDropoffId);
      if (pu && dr && pu.order >= dr.order) {
        // dropoff invalid after stops changed; clear dropoff
        setSelectedDropoffId(null);
      }
    }
  }, [tripDetail?.stops, selectedPickupId, selectedDropoffId]);

  useEffect(() => {
    let mounted = true;
    const fetchTrips = async () => {
      try {
        setLoadingTrips(true);
        setErrTrips(null);
        const url = API_BASE ? `${API_BASE}/api/trips` : '/api/trips';
        console.log('[BookingDetail] Fetching trips from:', url, 'routeId:', routeId);
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data: TripDoc[] = await res.json();
        console.log('[BookingDetail] Received trips:', data.length, 'trips');
        if (!mounted) return;

        // Lấy thời gian hiện tại
        const now = new Date();
        
        // Filter and sort trips
        const filtered = data
            .filter(t => {
              // 1. Kiểm tra dữ liệu Route hợp lệ
              if (!t?.route) return false;

              // 2. Lấy ID tuyến đường (xử lý cả trường hợp populate object hoặc string ID)
              const routeIdValue = typeof t.route === 'object' && t.route !== null 
                ? String(t.route._id || t.route) 
                : String(t.route);
              
              // 3. Điều kiện lọc:
              // - Đúng tuyến đường (routeId)
              // - KHÔNG bị hủy (status != cancelled)
              // - Thời gian khởi hành phải lớn hơn hiện tại (tripStartTime > now)
              const isCorrectRoute = routeIdValue === routeId;
              const isActive = t.status !== 'cancelled';
              const tripStartTime = new Date(t.start_time);
              const isFutureTrip = tripStartTime > now; 

              return isCorrectRoute && isActive && isFutureTrip;
            })
            .sort((a, b) => new Date(a.start_time).getTime() - new Date(b.start_time).getTime());
            
        console.log('[BookingDetail] Valid future trips:', filtered.length);

        // Only update state if data has actually changed
        setAllTrips(prev => {
          if (prev.length === filtered.length && 
              prev.every((trip, i) => trip._id === filtered[i]._id)) {
            return prev;
          }
          return filtered;
        });

        // Only update selectedTrip if necessary
        setSelectedTrip(prev => {
          if (prev && filtered.find(f => f._id === prev._id)) return prev;
          if (!prev && filtered.length > 0) return filtered[0];
          return prev;
        });
      } catch (e: any) {
        if (!mounted) return;
        setErrTrips(e?.message || 'Lỗi tải danh sách chuyến');
      } finally {
        if (mounted) setLoadingTrips(false);
      }
    };

    fetchTrips();
    return () => { mounted = false; };
  }, [routeId]);

  // Effect for handling trip details and polling
  useEffect(() => {
    if (!selectedTrip?._id) {
      setTripDetail(null);
      return;
    }

    let mounted = true;
    let timeoutId: ReturnType<typeof setTimeout>;

    const fetchTripDetails = async () => {
      if (!mounted) return;

      try {
        if (!tripDetail) setLoadingDetail(true);
        setErrDetail(null);

        const res = await fetch(API_BASE ? `${API_BASE}/api/trips/${selectedTrip._id}` : `/api/trips/${selectedTrip._id}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data: TripDetailResponse = await res.json();

        if (!mounted) return;

        // Check if any selected seats are no longer available
        const unavailableSelected = selectedSeats.some(sn => {
          const seat = data.seats.find(s => s.seat_number === String(sn));
          return !seat || seat.status !== 'available';
        });

        // Only update states if there are actual changes
        if (unavailableSelected) {
          setSelectedSeats(prev => 
            prev.filter(sn => {
              const seat = data.seats.find(s => s.seat_number === String(sn));
              return seat && seat.status === 'available';
            })
          );
        }

        // Only update trip detail if seats have changed
        if (!tripDetail || !seatsEqual(tripDetail.seats, data.seats)) {
          setTripDetail(data);
        }
      } catch (e: any) {
        if (!mounted) return;
        setErrDetail(e?.message || 'Lỗi tải chi tiết chuyến');
      } finally {
        if (mounted) {
          setLoadingDetail(false);
          // Schedule next poll
          timeoutId = setTimeout(fetchTripDetails, 5000); // Increased poll interval to 5s
        }
      }
    };

    fetchTripDetails();

    return () => {
      mounted = false;
      if (timeoutId) clearTimeout(timeoutId);
    };
  }, [selectedTrip?._id]);

  // Debug: detect mounts/unmounts and page unloads to help diagnose unexpected reloads
  // Commented out to prevent console spam - uncomment if needed for debugging
  // useEffect(() => {
  //   console.info('[BookingDetail] mounted');
  //   const onBeforeUnload = (e: BeforeUnloadEvent) => {
  //     console.warn('[BookingDetail] beforeunload', e);
  //   };
  //   const onVisibility = () => {
  //     console.info('[BookingDetail] visibilitychange', document.visibilityState);
  //   };
  //   window.addEventListener('beforeunload', onBeforeUnload);
  //   document.addEventListener('visibilitychange', onVisibility);
  //   return () => {
  //     console.info('[BookingDetail] unmounted');
  //     window.removeEventListener('beforeunload', onBeforeUnload);
  //     document.removeEventListener('visibilitychange', onVisibility);
  //   };
  // }, []);

  const fmtTime = (iso?: string | null) => {
    if (!iso) return '-';
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return '-';
    return d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
  };

  const fmtDuration = (mins?: number) => {
    if (typeof mins !== 'number' || Number.isNaN(mins)) return '-';
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    if (h && m) return `${h}h ${m}m`;
    if (h) return `${h}h`;
    return `${m}m`;
  };

  // Đếm số ghế trống thực tế (không trừ ghế đã chọn)
  const availableSeatsCount = useMemo(() => {
    return (tripDetail?.seats || []).filter(s => s.status === 'available').length;
  }, [tripDetail?.seats]);

  // Số ghế đã chọn (chỉ tính những ghế available)
  const selectedAvailableCount = useMemo(() => {
    const availableSeats = tripDetail?.seats?.filter(s => s.status === 'available') || [];
    return selectedSeats.filter(sn => availableSeats.some(s => s.seat_number === String(sn))).length;
  }, [tripDetail?.seats, selectedSeats]);

  const handleSeatSelect = (seatNumber: number) => {
    const status = tripDetail?.seats?.find(s => s.seat_number === String(seatNumber))?.status;
    if (status && status !== 'available') return;
    setSelectedSeats(prev => prev.includes(seatNumber) ? prev.filter(s => s !== seatNumber) : [...prev, seatNumber]);
  };

  // Component implementation inline since we only use it in one place
  const handleSeatClick = (seatNumber: number, status: SeatDoc['status']) => {
    if (status !== 'available') return;
    handleSeatSelect(seatNumber);
  };

  const handleBooking = () => {
    if (!tripDetail?.trip?._id) { alert('Chưa chọn chuyến.'); return; }
    if (selectedSeats.length === 0) { alert('Vui lòng chọn ít nhất một ghế'); return; }
    if (!selectedPickupId || !selectedDropoffId) { alert('Vui lòng chọn điểm đón và điểm trả'); return; }

    // Ensure pickup is before dropoff by order
    const pickup = tripDetail?.stops?.find(s => s._id === selectedPickupId);
    const dropoff = tripDetail?.stops?.find(s => s._id === selectedDropoffId);
    if (!pickup || !dropoff) { alert('Điểm dừng không hợp lệ'); return; }
    if (pickup.order >= dropoff.order) { alert('Vui lòng chọn điểm đón trước điểm trả'); return; }
    if (!passengerInfo.name || !passengerInfo.phone) { alert('Vui lòng điền đầy đủ thông tin hành khách'); return; }
    if (!isValidPhone(passengerInfo.phone)) { setPhoneError('Số điện thoại không hợp lệ. Vui lòng nhập số bắt đầu bằng 0 hoặc +84, ví dụ 0912345678.'); return; }
    navigate('/payment', { state: {
      tripId: tripDetail.trip._id,
      seats: selectedSeats,
      passenger: passengerInfo,
      stops: { pickupId: selectedPickupId, dropoffId: selectedDropoffId, pickupName: pickup.stop_name, dropoffName: dropoff.stop_name },
      route: { from: tripDetail.trip.route?.from_city || '', to: tripDetail.trip.route?.to_city || '', durationMin: tripDetail.trip.route?.estimated_duration_min || null },
      bus: { busType: tripDetail.trip.bus?.bus_type || '', licensePlate: tripDetail.trip.bus?.license_plate || '', seatCount: tripDetail.trip.bus?.seat_count || 0 },
      times: { departureTime: tripDetail.trip.start_time, arrivalTime: computedArrivalIso || tripDetail.trip.end_time || null },
      pricePerSeat: computedPricePerSeat
    } });
  };

  // Compute price per seat based on selected stops (same logic as server-side)
  const computedPricePerSeat = React.useMemo(() => {
    const base = tripDetail?.trip?.base_price || selectedTrip?.base_price || 0;
    if (!tripDetail?.stops || !selectedPickupId || !selectedDropoffId) return base;
    const pickup = tripDetail.stops.find(s => s._id === selectedPickupId);
    const dropoff = tripDetail.stops.find(s => s._id === selectedDropoffId);
    if (!pickup || !dropoff) return base;
    const orders = tripDetail.stops.map(s => (typeof s.order === 'number' ? s.order : 0));
    const minOrder = Math.min(...orders);
    const maxOrder = Math.max(...orders);
    const totalSegments = (maxOrder - minOrder) || 1;
    const segmentsBetween = Math.max(0, dropoff.order - pickup.order);
    const fraction = Math.min(1, segmentsBetween / totalSegments);
    let price = Math.round(base * fraction);
    if (price <= 0) price = Math.max(1, Math.floor(base * 0.2));
    return price;
  }, [tripDetail?.stops, tripDetail?.trip?.base_price, selectedPickupId, selectedDropoffId, selectedTrip?.base_price]);

  // Tính thời gian đến dự kiến cho điểm trả đã chọn (nếu có)
  const computedArrivalIso = React.useMemo(() => {
    if (!selectedTrip) return selectedTrip?.end_time || null;
    if (selectedDropoffId && tripDetail?.stops && tripDetail.stops.length > 0) {
      const stops = tripDetail.stops;
      const orders = stops.map(s => (typeof s.order === 'number' ? s.order : 0));
      const minOrder = Math.min(...orders);
      const maxOrder = Math.max(...orders);
      const totalSegments = (maxOrder - minOrder) || 1;
      const dropoff = stops.find(s => s._id === selectedDropoffId);
      const estMin = (selectedTrip.route && (selectedTrip.route as any).estimated_duration_min) || (tripDetail.trip.route && (tripDetail.trip.route as any).estimated_duration_min) || 0;
      if (dropoff && typeof dropoff.order === 'number' && estMin) {
        const segmentsBetween = Math.max(0, dropoff.order - minOrder);
        const frac = Math.min(1, segmentsBetween / totalSegments);
        const mins = Math.round(estMin * frac);
        const d = new Date(selectedTrip.start_time);
        d.setMinutes(d.getMinutes() + mins);
        return d.toISOString();
      }
    }
    return selectedTrip.end_time || null;
  }, [selectedTrip, tripDetail?.stops, selectedDropoffId]);

  const computedTotalAmount = React.useMemo(() => {
    return (computedPricePerSeat || 0) * (selectedSeats.length || 0);
  }, [computedPricePerSeat, selectedSeats.length]);

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button
              onClick={() => navigate('/')}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay lại
            </button>
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Chọn chuyến */}
        <div className="mb-6">
          {loadingTrips ? (
            <div className="text-gray-500">Đang tải danh sách chuyến…</div>
          ) : errTrips ? (
            <div className="text-red-600">Lỗi: {errTrips}</div>
          ) : allTrips.length === 0 ? (
            <div className="text-gray-600">Không tìm thấy chuyến nào cho tuyến này.</div>
          ) : (
            <div className="flex items-center gap-3">
              <span className="text-sm text-gray-600">Chọn chuyến:</span>
              <select
                className="border border-gray-300 rounded-lg px-3 py-2 bg-white w-full max-w-xl" // Thêm w-full để rộng ra xíu
                value={selectedTrip?._id || ''}
                onChange={(e) => {
                  const t = allTrips.find(x => x._id === e.target.value) || null;
                  setSelectedTrip(t);
                }}
              >
                {allTrips.map(t => {
                  // Tạo hàm format hiển thị cả Ngày và Giờ
                  const d = new Date(t.start_time);
                  const dateStr = d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
                  const timeStr = d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                  
                  // Tính giờ đến dự kiến
                  const dEnd = t.end_time ? new Date(t.end_time) : null;
                  const timeEndStr = dEnd ? dEnd.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : '...';

                  return (
                    <option key={t._id} value={t._id}>
                      {/* Hiển thị: 24/11 | 08:00 - 10:00 | Thái Nguyên -> Hà Nội */}
                      {dateStr} | {timeStr} - {timeEndStr} | {t.route?.from_city || '-'} → {t.route?.to_city || '-'}
                    </option>
                  );
                })}
              </select>
            </div>
          )}
        </div>

        {selectedTrip && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Thông tin tuyến/chuyến */}
            <div className="lg:col-span-2">
              <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                <h2 className="text-2xl font-bold text-gray-900 mb-6">Chi tiết tuyến đường</h2>

                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center">
                    <MapPin className="h-6 w-6 text-blue-600 mr-3" />
                    <div>
                      <p className="text-lg font-semibold text-gray-900">
                        {selectedTrip.route?.from_city || '-'}
                      </p>
                      <p className="text-sm text-gray-600">Điểm đi</p>
                    </div>
                  </div>

                  <div className="flex-1 mx-6">
                    <div className="border-t-2 border-dashed border-gray-300"></div>
                    <div className="text-center mt-2">
                      <Clock className="h-4 w-4 inline mr-1" />
                      <span className="text-sm text-gray-600">
                        {fmtDuration(selectedTrip.route?.estimated_duration_min)}
                      </span>
                    </div>
                  </div>

                  <div className="flex items-center">
                    <MapPin className="h-6 w-6 text-green-600 mr-3" />
                    <div>
                      <p className="text-lg font-semibold text-gray-900">
                        {selectedTrip.route?.to_city || '-'}
                      </p>
                      <p className="text-sm text-gray-600">Điểm đến</p>
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                  {/* Ô 1: Giờ khởi hành */}
                  <div className="text-center p-4 bg-gray-50 rounded-lg">
                    <Calendar className="h-6 w-6 text-blue-600 mx-auto mb-2" />
                    <p className="font-semibold text-gray-900">Giờ khởi hành</p>
                    <p className="text-gray-600">{fmtTime(selectedTrip.start_time)}</p>
                  </div>
                  
                  {/* Ô 2: Giờ dự kiến đến */}
                  <div className="text-center p-4 bg-gray-50 rounded-lg">
                    <Calendar className="h-6 w-6 text-green-600 mx-auto mb-2" />
                    <p className="font-semibold text-gray-900">Giờ dự kiến đến</p>
                    <p className="text-gray-600">{fmtTime(computedArrivalIso || undefined)}</p>
                  </div>

                  {/* Ô 3: BIỂN SỐ XE  */}
                  <div className="text-center p-4 bg-gray-50 rounded-lg">
                    {/* Icon BS đơn giản */}
                    <div className="h-6 w-8 mx-auto mb-2 flex items-center justify-center bg-blue-600 text-white rounded text-xs font-bold">
                      BS
                    </div>
                    <p className="font-semibold text-gray-900">Biển số</p>
                    <p className="text-blue-700 font-bold text-lg">
                      {selectedTrip.bus?.license_plate || '---'}
                    </p>
                  </div>

                  {/* Ô 4: Loại xe */}
                  <div className="text-center p-4 bg-gray-50 rounded-lg">
                    <Bus className="h-6 w-6 text-purple-600 mx-auto mb-2" />
                    <p className="font-semibold text-gray-900">Loại xe</p>
                    <p className="text-gray-600">{selectedTrip.bus?.bus_type || '-'}</p>
                  </div>

                  {/* Ô 5: Số ghế */}
                  <div className="text-center p-4 bg-gray-50 rounded-lg">
                    <Users className="h-6 w-6 text-orange-600 mx-auto mb-2" />
                    <p className="font-semibold text-gray-900">Số ghế</p>
                    <p className="text-gray-600">
                      {loadingDetail ? '…' : `${availableSeatsCount - selectedAvailableCount} ghế trống`}
                    </p>
                  </div>
                </div>

                {/* Hiển thị điểm dừng */}
                {tripDetail?.stops && tripDetail.stops.length > 0 && (
                  <div className="mt-6 pt-6 border-t border-gray-200">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                      <MapPin className="h-5 w-5 text-blue-600 mr-2" />
                      Các điểm dừng trên tuyến
                    </h3>
                    <div className="relative">
                      {/* Đường thẳng nối các điểm */}
                      <div className="absolute left-4 top-0 bottom-0 w-0.5 bg-blue-200"></div>
                      
                      <div className="space-y-4 relative">
                        {(() => {
                          const stops = tripDetail?.stops || [];
                          return stops.map((stop, index) => {
                          const isFirst = index === 0;
                          const isLast = index === stops.length - 1;
                          const getTypeColor = () => {
                            if (stop.type === 'pickup') return 'bg-green-100 text-green-700 border-green-300';
                            if (stop.type === 'dropoff') return 'bg-red-100 text-red-700 border-red-300';
                            return 'bg-blue-100 text-blue-700 border-blue-300';
                          };
                          const getTypeLabel = () => {
                            if (stop.type === 'pickup') return 'Điểm đón';
                            if (stop.type === 'dropoff') return 'Điểm trả';
                            return 'Điểm đón/trả';
                          };

                          const isSelectedPickup = selectedPickupId === stop._id;
                          const isSelectedDropoff = selectedDropoffId === stop._id;

                          const handleStopClick = () => {
                            if (isSelectedPickup) { setSelectedPickupId(null); return; }
                            if (isSelectedDropoff) { setSelectedDropoffId(null); return; }

                            if (!selectedPickupId) {
                              if (stop.type === 'dropoff') {
                                alert('Không thể chọn điểm trả làm điểm đón. Vui lòng chọn điểm đón hợp lệ.');
                                return;
                              }
                              setSelectedPickupId(stop._id);
                              return;
                            }

                            if (selectedPickupId && !selectedDropoffId) {
                                  const pickup = stops.find(s => s._id === selectedPickupId);
                              if (pickup && stop.order <= pickup.order) {
                                alert('Vui lòng chọn điểm trả nằm sau điểm đón.');
                                return;
                              }
                              if (stop.type === 'pickup') {
                                alert('Vui lòng chọn điểm trả hợp lệ.');
                                return;
                              }
                              setSelectedDropoffId(stop._id);
                              return;
                            }

                            setSelectedPickupId(stop._id);
                            setSelectedDropoffId(null);
                          };

                          return (
                            <div key={stop._id} className="relative flex items-start pl-10">
                              <div className={`absolute left-0 w-8 h-8 rounded-full flex items-center justify-center font-semibold text-sm border-2 ${
                                isFirst 
                                  ? 'bg-blue-600 text-white border-blue-600' 
                                  : isLast
                                  ? 'bg-green-600 text-white border-green-600'
                                  : 'bg-white text-blue-600 border-blue-400'
                              }`}>
                                {stop.order}
                              </div>

                              <div
                                onClick={handleStopClick}
                                role="button"
                                tabIndex={0}
                                className={[
                                  'flex-1 rounded-lg p-3 border transition-colors cursor-pointer',
                                  isSelectedPickup ? 'bg-blue-50 border-blue-400' : 'bg-gray-50 border-gray-200',
                                  isSelectedDropoff ? 'bg-indigo-50 border-indigo-400' : ''
                                ].join(' ')}
                                onKeyDown={(e: React.KeyboardEvent) => { if (e.key === 'Enter') handleStopClick(); }}
                              >
                                <div className="flex items-center justify-between">
                                  <p className="font-medium text-gray-900">{stop.stop_name}</p>
                                  <div className="ml-4 text-right">
                                    <span className={`inline-block mt-2 px-2 py-1 rounded text-xs font-medium border ${getTypeColor()}`}>
                                      {getTypeLabel()}
                                    </span>
                                  </div>
                                </div>

                                <div className="mt-2 flex items-center gap-2">
                                  {isSelectedPickup && (
                                    <span className="text-xs font-semibold text-blue-700">Bạn chọn điểm đón</span>
                                  )}
                                  {isSelectedDropoff && (
                                    <span className="text-xs font-semibold text-indigo-700">Bạn chọn điểm trả</span>
                                  )}
                                </div>
                              </div>
                            </div>
                          );
                          });
                        })()}
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {/* Chọn ghế */}
              <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                <h3 className="text-xl font-bold text-gray-900 mb-4">Chọn ghế</h3>

                {loadingDetail ? (
                  <div className="text-gray-500">Đang tải sơ đồ ghế…</div>
                ) : errDetail ? (
                  <div className="text-red-600">Lỗi: {errDetail}</div>
                ) : (
                  <>
                    <div className="grid grid-cols-4 gap-3">
                    {(tripDetail?.seats || [])
                      .sort((a, b) => parseInt(a.seat_number) - parseInt(b.seat_number))
                      .map((seat) => {
                        const seatNumber = parseInt(seat.seat_number, 10);
                        
                        // Find the current status of this seat
                        const seatStatus = tripDetail?.seats?.find(
                          s => s.seat_number === String(seatNumber)
                        );
                        const status = seatStatus?.status || 'available';
                        const isSelected = selectedSeats.includes(seatNumber);

                        return (
                          <button
                            key={seatNumber}
                            onClick={() => handleSeatClick(seatNumber, status)}
                            disabled={status !== 'available'}
                            className={[
                              'p-3 rounded-lg border-2 text-center font-medium transition-colors',
                              status !== 'available'
                                ? 'bg-red-100 text-gray-500 border-red-300 cursor-not-allowed'
                                : isSelected
                                  ? 'bg-blue-600 text-white border-blue-600'
                                  : 'bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200'
                            ].join(' ')}
                            title={status !== 'available' ? `Ghế ${seatNumber} đã bán/giữ` : `Ghế ${seatNumber}`}
                          >
                            {seatNumber}
                          </button>
                        );
                    })}
                  </div>

                    <div className="mt-4 flex flex-wrap items-center gap-4">
                      <div className="flex items-center">
                        <div className="w-4 h-4 bg-gray-100 border-2 border-gray-300 rounded mr-2"></div>
                        <span className="text-sm text-gray-600">Ghế trống ({availableSeatsCount - selectedAvailableCount})</span>
                      </div>
                      <div className="flex items-center">
                        <div className="w-4 h-4 bg-red-100 border-2 border-red-300 rounded mr-2"></div>
                        <span className="text-sm text-gray-600">Ghế đã bán/giữ ({(tripDetail?.seats?.length || 0) - availableSeatsCount})</span>
                      </div>
                      <div className="flex items-center">
                        <div className="w-4 h-4 bg-blue-600 border-2 border-blue-600 rounded mr-2"></div>
                        <span className="text-sm text-gray-600">Đã chọn ({selectedAvailableCount})</span>
                      </div>
                    </div>
                  </>
                )}
              </div>

              {/* Thông tin hành khách */}
              <div className="bg-white rounded-xl shadow-md p-6">
                <h3 className="text-xl font-bold text-gray-900 mb-4">Thông tin hành khách</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Họ và tên *</label>
                    <input
                      type="text"
                      value={passengerInfo.name}
                      onChange={(e) => setPassengerInfo({ ...passengerInfo, name: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Nhập họ và tên"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Số điện thoại *</label>
                    <input
                      type="tel"
                      value={passengerInfo.phone}
                      onChange={(e) => { setPassengerInfo({ ...passengerInfo, phone: e.target.value }); if (phoneError) setPhoneError(null); }}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Nhập số điện thoại"
                    />
                    {phoneError && (
                      <p className="text-sm text-red-600 mt-1">{phoneError}</p>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input
                      type="email"
                      value={passengerInfo.email}
                      onChange={(e) => setPassengerInfo({ ...passengerInfo, email: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Nhập email"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Ghi chú</label>
                    <input
                      type="text"
                      value={passengerInfo.note}
                      onChange={(e) => setPassengerInfo({ ...passengerInfo, note: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Ghi chú thêm"
                    />
                  </div>
                </div>
              </div>
            </div>

            {/* Tóm tắt đặt vé */}
            <div className="lg:col-span-1">
              <div className="bg-white rounded-xl shadow-md p-6 sticky top-8">
                <h3 className="text-xl font-bold text-gray-900 mb-4">Tóm tắt đặt vé</h3>

                <div className="space-y-4 mb-6">
                  <div className="flex justify-between">
                    <span className="text-gray-600">Tuyến đường:</span>
                    <span className="font-medium">
                      {(selectedTrip.route?.from_city || '-')} - {(selectedTrip.route?.to_city || '-')}
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Số ghế:</span>
                    <span className="font-medium">{selectedSeats.length} ghế</span>
                  </div>
                  {tripDetail?.stops && (
                    <div className="flex justify-between">
                      <span className="text-gray-600">Điểm đón / trả:</span>
                      <span className="font-medium text-right">
                        {selectedPickupId ? (tripDetail.stops.find(s => s._id === selectedPickupId)?.stop_name || '-') : '-'}
                        {' '} / {' '}
                        {selectedDropoffId ? (tripDetail.stops.find(s => s._id === selectedDropoffId)?.stop_name || '-') : '-'}
                      </span>
                    </div>
                  )}
                  <div className="flex justify-between">
                    <span className="text-gray-600">Giá/ghế:</span>
                    <span className="font-medium">{(computedPricePerSeat || 0).toLocaleString()}₫</span>
                  </div>
                  <div className="border-t pt-4">
                    <div className="flex justify-between text-lg font-bold">
                      <span>Tổng cộng:</span>
                      <span className="text-blue-600">{(computedTotalAmount || 0).toLocaleString()}₫</span>
                    </div>
                  </div>
                </div>

                <button
                  onClick={handleBooking}
                  className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium text-lg"
                >
                  Tiếp tục thanh toán
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default BookingDetail;

--- END OF FILE: frontend\src\components\BookingDetail.tsx ---


--- START OF FILE: frontend\src\components\ContactPage.tsx ---
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { ArrowLeft, Bus, Phone, Mail, MapPin, Clock, MessageCircle, Send, CheckCircle } from 'lucide-react';

const ContactPage: React.FC = () => {
  const navigate = useNavigate();
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    subject: '',
    message: ''
  });
  const [isSubmitted, setIsSubmitted] = useState(false);
  const [publicView, setPublicView] = useState<{ contactId: string; token: string } | null>(null);
  const [contactDetails, setContactDetails] = useState<any>(null);
  const [pollingId, setPollingId] = useState<number | null>(null);

  // Khi component mount, nếu có lastContactId trong localStorage thì tự load và bắt polling
  useEffect(() => {
    try {
      const lastId = localStorage.getItem('lastContactId');
      if (lastId) {
        const token = localStorage.getItem(`contactToken:${lastId}`);
        if (token) {
          const pv = { contactId: lastId, token };
          setPublicView(pv);
          fetchPublicContact(pv.contactId, pv.token);
          const id = window.setInterval(() => fetchPublicContact(pv.contactId, pv.token), 10000);
          setPollingId(id);
        }
      }
    } catch (e) {
      console.warn('ContactPage mount load token error', e);
    }

    // cleanup when unmount
    return () => {
      if (pollingId) { window.clearInterval(pollingId); }
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // clear interval if pollingId changes (ensure no duplicate timers)
  useEffect(() => {
    return () => { if (pollingId) { window.clearInterval(pollingId); } };
  }, [pollingId]);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
  
    (async () => {
      try {
        const apiUrl = 'http://localhost:5000';
        const res = await fetch(`${apiUrl}/contact`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        const data = await res.json();
        if (res.ok && data.success) {
          setIsSubmitted(true);
          // store token so user can view replies on site
          if (data.contactId && data.token) {
            const pv = { contactId: data.contactId, token: data.token };
            setPublicView(pv);
            try { 
              localStorage.setItem(`contactToken:${data.contactId}`, data.token);
              localStorage.setItem('lastContactId', data.contactId);
            } catch(e){}
            // start polling for replies
            fetchPublicContact(pv.contactId, pv.token);
            const id = window.setInterval(() => fetchPublicContact(pv.contactId, pv.token), 10000);
            setPollingId(id);
          }

          setTimeout(() => setIsSubmitted(false), 3000);
          setFormData({ name: '', email: '', phone: '', subject: '', message: '' });
        } else {
          alert(data.error || 'Có lỗi khi gửi liên hệ');
        }
      } catch (err) {
        console.error('Contact submit error', err);
        alert('Lỗi khi gửi liên hệ. Vui lòng thử lại sau.');
      }
    })();
  };

  async function fetchPublicContact(contactId: string, token: string) {
    try {
      const apiUrl = 'http://localhost:5000';
      const res = await fetch(`${apiUrl}/public/contacts/${contactId}?token=${encodeURIComponent(token)}`);
      const data = await res.json();
      if (res.ok && data.success) {
        setContactDetails(data.contact);
      } else {
        // if token invalid or expired, stop polling
        if (res.status === 403 || res.status === 404) {
          if (pollingId) { window.clearInterval(pollingId); setPollingId(null); }
        }
      }
    } catch (e) {
      console.error('fetchPublicContact error', e);
    }
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button 
              onClick={() => navigate('/')}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay lại
            </button>
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Page Header */}
        <div className="text-center mb-12">
          <h2 className="text-3xl font-bold text-gray-900 mb-2">Liên hệ với chúng tôi</h2>
          <p className="text-gray-600">Chúng tôi luôn sẵn sàng hỗ trợ bạn 24/7</p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
          {/* Contact Information */}
          <div className="space-y-8">
            {/* Contact Cards */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-6">Thông tin liên hệ</h3>
              
              <div className="space-y-6">
                <div className="flex items-start">
                  <div className="bg-blue-100 p-3 rounded-lg mr-4">
                    <Phone className="h-6 w-6 text-blue-600" />
                  </div>
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-1">Hotline</h4>
                    <p className="text-gray-600 mb-1">1900 6886</p>
                    <p className="text-sm text-gray-500">Hỗ trợ 24/7</p>
                  </div>
                </div>

                <div className="flex items-start">
                  <div className="bg-green-100 p-3 rounded-lg mr-4">
                    <Mail className="h-6 w-6 text-green-600" />
                  </div>
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-1">Email</h4>
                    <p className="text-gray-600 mb-1">vexe7tv@gmail.com</p>
                    <p className="text-sm text-gray-500">Phản hồi trong 24h</p>
                  </div>
                </div>

                <div className="flex items-start">
                  <div className="bg-purple-100 p-3 rounded-lg mr-4">
                    <MapPin className="h-6 w-6 text-purple-600" />
                  </div>
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-1">Địa chỉ</h4>
                    <p className="text-gray-600 mb-1">123 Đường Trịnh Văn Bô, Quận Nam Từ Liêm</p>
                    <p className="text-gray-600 mb-1">TP.Hà Nội, Việt Nam</p>
                    <p className="text-sm text-gray-500">Trụ sở chính</p>
                  </div>
                </div>

                <div className="flex items-start">
                  <div className="bg-orange-100 p-3 rounded-lg mr-4">
                    <Clock className="h-6 w-6 text-orange-600" />
                  </div>
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-1">Giờ làm việc</h4>
                    <p className="text-gray-600 mb-1">Thứ 2 - Thứ 6: 8:00 - 18:00</p>
                    <p className="text-gray-600 mb-1">Thứ 7: 8:00 - 12:00</p>
                    <p className="text-sm text-gray-500">Hotline hoạt động 24/7</p>
                  </div>
                </div>
              </div>
            </div>

            {/* FAQ */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-6">Câu hỏi thường gặp</h3>
              
              <div className="space-y-4">
                <div className="border-l-4 border-blue-500 pl-4">
                  <h4 className="font-semibold text-gray-900 mb-1">Làm thế nào để đặt vé?</h4>
                  <p className="text-gray-600 text-sm">Chọn tuyến đường, chọn ghế, nhập thông tin và thanh toán.</p>
                </div>
                
                <div className="border-l-4 border-green-500 pl-4">
                  <h4 className="font-semibold text-gray-900 mb-1">Có thể hủy vé không?</h4>
                  <p className="text-gray-600 text-sm">Có thể hủy vé trước giờ khởi hành 2 tiếng.</p>
                </div>
                
                <div className="border-l-4 border-purple-500 pl-4">
                  <h4 className="font-semibold text-gray-900 mb-1">Thanh toán như thế nào?</h4>
                  <p className="text-gray-600 text-sm">Hỗ trợ MoMo, chuyển khoản ngân hàng và thanh toán tại xe.</p>
                </div>
                
                <div className="border-l-4 border-orange-500 pl-4">
                  <h4 className="font-semibold text-gray-900 mb-1">Có hỗ trợ hoàn tiền không?</h4>
                  <p className="text-gray-600 text-sm">Có chính sách hoàn tiền theo điều khoản dịch vụ.</p>
                </div>
              </div>
            </div>
          </div>

          {/* Contact Form */}
          <div className="bg-white rounded-xl shadow-md p-6">
            <h3 className="text-xl font-bold text-gray-900 mb-6">Gửi tin nhắn</h3>
            
            {isSubmitted ? (
              <div className="text-center py-8">
                <div className="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                  <CheckCircle className="h-8 w-8 text-green-600" />
                </div>
                <h4 className="text-lg font-semibold text-gray-900 mb-2">Tin nhắn đã được gửi!</h4>
                <p className="text-gray-600">Chúng tôi sẽ phản hồi trong thời gian sớm nhất.</p>
              </div>
            ) : (
              <form onSubmit={handleSubmit} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Họ và tên *
                    </label>
                    <input
                      type="text"
                      name="name"
                      value={formData.name}
                      onChange={handleInputChange}
                      required
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Nhập họ và tên"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Email *
                    </label>
                    <input
                      type="email"
                      name="email"
                      value={formData.email}
                      onChange={handleInputChange}
                      required
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Nhập email"
                    />
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Số điện thoại
                    </label>
                    <input
                      type="tel"
                      name="phone"
                      value={formData.phone}
                      onChange={handleInputChange}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Nhập số điện thoại"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Chủ đề *
                    </label>
                    <select
                      name="subject"
                      value={formData.subject}
                      onChange={handleInputChange}
                      required
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="">Chọn chủ đề</option>
                      <option value="booking">Đặt vé</option>
                      <option value="cancel">Hủy vé</option>
                      <option value="refund">Hoàn tiền</option>
                      <option value="complaint">Khiếu nại</option>
                      <option value="suggestion">Góp ý</option>
                      <option value="other">Khác</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Nội dung tin nhắn *
                  </label>
                  <textarea
                    name="message"
                    value={formData.message}
                    onChange={handleInputChange}
                    required
                    rows={6}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Nhập nội dung tin nhắn..."
                  />
                </div>

                <button
                  type="submit"
                  className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center justify-center"
                >
                  <Send className="h-5 w-5 mr-2" />
                  Gửi tin nhắn
                </button>
              </form>
            )}
            {/* Public view: nếu có publicView hiển thị thread và replies */}
            {publicView && contactDetails && (
              <div className="mt-6 border-t pt-6">
                <h4 className="text-lg font-semibold mb-2">Lịch sử liên hệ</h4>
                <div className="bg-gray-50 p-4 rounded">
                  <div className="text-sm text-gray-600 mb-2"><strong>Chủ đề:</strong> {contactDetails.subject}</div>
                  <div className="mb-3"><strong>Nội dung bạn gửi:</strong>
                    <div className="mt-2 p-3 bg-white rounded border">{contactDetails.message}</div>
                  </div>
                  <div className="mb-2"><strong>Phản hồi:</strong></div>
                  {contactDetails.replies && contactDetails.replies.length > 0 ? (
                    contactDetails.replies.map((r: any, idx: number) => (
                      <div key={idx} className="mb-3 p-3 bg-white rounded border">
                        <div className="text-sm text-gray-500 mb-1">{new Date(r.createdAt).toLocaleString()}</div>
                        <div className="text-gray-800">{r.message}</div>
                      </div>
                    ))
                  ) : (
                    <div className="text-sm text-gray-500">Hiện chưa có phản hồi. Vui lòng kiểm tra lại sau hoặc kiểm tra email.</div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Additional Info */}
        <div className="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="bg-blue-50 rounded-xl p-6 text-center">
            <div className="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
              <MessageCircle className="h-6 w-6 text-blue-600" />
            </div>
            <h4 className="font-semibold text-gray-900 mb-2">Chat trực tuyến</h4>
            <p className="text-gray-600 text-sm">Hỗ trợ trực tuyến 24/7 qua chat</p>
          </div>
          
          <div className="bg-green-50 rounded-xl p-6 text-center">
            <div className="bg-green-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
              <Phone className="h-6 w-6 text-green-600" />
            </div>
            <h4 className="font-semibold text-gray-900 mb-2">Hotline</h4>
            <p className="text-gray-600 text-sm">Gọi ngay 1900 1234 để được hỗ trợ</p>
          </div>
          
          <div className="bg-purple-50 rounded-xl p-6 text-center">
            <div className="bg-purple-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
              <Mail className="h-6 w-6 text-purple-600" />
            </div>
            <h4 className="font-semibold text-gray-900 mb-2">Email</h4>
            <p className="text-gray-600 text-sm">Gửi email đến support@vexe7tv.com</p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ContactPage;

--- END OF FILE: frontend\src\components\ContactPage.tsx ---


--- START OF FILE: frontend\src\components\HomePage.tsx ---
import React, { useEffect, useState } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { Bus, MapPin, Clock, Users, Star, Search, Calendar, LogOut, User } from 'lucide-react';
import { useAuth } from '../App';

type RouteDoc = {
  _id: string;
  name?: string;
  from_city?: string;
  to_city?: string;
  total_distance_km?: number;
  estimated_duration_min?: number;
  active?: boolean;
};

const API_BASE =
  (typeof import.meta !== 'undefined' && (import.meta as any)?.env?.VITE_BACKEND_URL) || '';

const HomePage: React.FC = () => {
  const navigate = useNavigate();
  const auth = useAuth();

  const [routes, setRoutes] = useState<RouteDoc[]>([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);

  // Search form state
  const [fromCity, setFromCity] = useState('');
  const [toCity, setToCity] = useState('');
  const [searchDate, setSearchDate] = useState('');

  const handleBookingClick = (routeId: string) => {
    navigate(`/booking/${routeId}`);
  };

  const handleSearch = (e: React.FormEvent) => {
    e.preventDefault();
    // Navigate to routes page with search params
    const params = new URLSearchParams();
    if (fromCity.trim()) {
      params.append('from', fromCity.trim());
    }
    if (toCity.trim()) {
      params.append('to', toCity.trim());
    }
    if (searchDate) {
      params.append('date', searchDate);
    }
    
    // Navigate to routes page with search query
    const queryString = params.toString();
    navigate(`/routes${queryString ? `?${queryString}` : ''}`);
  };

  useEffect(() => {
    let mounted = true;
    (async () => {
      try {
        setLoading(true);
        setErr(null);
        const res = await fetch(`${API_BASE}/api/routes`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data: RouteDoc[] = await res.json();
        if (!mounted) return;

        // lấy 6 tuyến đang active làm "popular"
        const popular = (Array.isArray(data) ? data : [])
          .filter(r => r?.active !== false)
          .slice(0, 6);
        setRoutes(popular);
      } catch (e: any) {
        if (!mounted) return;
        setErr(e?.message || 'Lỗi tải dữ liệu');
      } finally {
        if (mounted) setLoading(false);
      }
    })();
    return () => { mounted = false; };
  }, []);

  const fmtDuration = (mins?: number) => {
    if (typeof mins !== 'number' || Number.isNaN(mins)) return '-';
    const h = Math.floor(mins / 60);
    const m = Math.floor(mins % 60);
    if (h && m) return `${h}h ${m}m`;
    if (h) return `${h}h`;
    return `${m}m`;
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-6">
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
            <nav className="hidden md:flex space-x-8">
              <button className="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">
                Trang chủ
              </button>
              <Link to="/routes" className="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">
                Tuyến đường
              </Link>
              <button onClick={() => navigate('/my-tickets')}
                className="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">
                Vé của tôi
              </button>
              <button onClick={() => navigate('/contact')}
                className="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">
                Liên hệ
              </button>
            </nav>
            <div className="flex items-center space-x-4">
              {auth.user ? (
                <div className="flex items-center space-x-4">
                  <div className="flex items-center text-gray-700">
                    <User className="h-5 w-5 mr-2" />
                    <span className="font-medium">{auth.user.name}</span>
                  </div>
                  <button
                    onClick={() => {
                      auth.logout();
                      navigate('/');
                    }}
                    className="flex items-center text-gray-700 hover:text-red-600"
                  >
                    <LogOut className="h-5 w-5 mr-2" />
                    Đăng xuất
                  </button>
                </div>
              ) : (
                <>
                  <button 
                    onClick={() => navigate('/login')}
                    className="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
                  >
                    Đăng nhập
                  </button>
                  <button 
                    onClick={() => navigate('/register')}
                    className="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700"
                  >
                    Đăng ký
                  </button>
                </>
              )}
            </div>
          </div>
        </div>
      </header>

      {/* Hero */}
      <section className="relative py-20">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="text-center">
            <h2 className="text-4xl md:text-6xl font-bold text-gray-900 mb-6">
              Đặt vé xe khách <span className="text-blue-600">dễ dàng</span>
            </h2>
            <p className="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">
              Tìm kiếm và đặt vé xe khách nhanh chóng với giá cả hợp lý. Hành trình thuận tiện, an toàn và tiết kiệm.
            </p>
          </div>

          {/* Search Form */}
          <div className="max-w-4xl mx-auto">
            <form onSubmit={handleSearch} className="bg-white rounded-2xl shadow-xl p-8">
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div className="relative">
                  <MapPin className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
                  <input 
                    type="text" 
                    placeholder="Điểm đi (ví dụ: Hà Nội)"
                    value={fromCity}
                    onChange={(e) => setFromCity(e.target.value)}
                    className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                  />
                </div>
                <div className="relative">
                  <MapPin className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
                  <input 
                    type="text" 
                    placeholder="Điểm đến (ví dụ: TP. Hồ Chí Minh)"
                    value={toCity}
                    onChange={(e) => setToCity(e.target.value)}
                    className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                  />
                </div>
                <div className="relative">
                  <Calendar className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
                  <input 
                    type="date"
                    value={searchDate}
                    onChange={(e) => setSearchDate(e.target.value)}
                    min={new Date().toISOString().split('T')[0]}
                    className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                  />
                </div>
                <button 
                  type="submit"
                  className="bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 flex items-center justify-center font-medium transition-colors"
                >
                  <Search className="h-5 w-5 mr-2" /> Tìm kiếm
                </button>
              </div>
            </form>
          </div>
        </div>
      </section>

      {/* Features */}
      <section className="py-20 bg-white">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="text-center mb-16">
            <h3 className="text-3xl font-bold text-gray-900 mb-4">Tại sao chọn VeXe7TV?</h3>
            <p className="text-xl text-gray-600">Dịch vụ đặt vé xe khách hàng đầu với nhiều ưu điểm vượt trội</p>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div className="text-center p-6">
              <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <Clock className="h-8 w-8 text-blue-600" />
              </div>
              <h4 className="text-xl font-semibold text-gray-900 mb-2">Đặt vé nhanh chóng</h4>
              <p className="text-gray-600">Chỉ với vài cú click, bạn có thể đặt vé một cách dễ dàng.</p>
            </div>
            <div className="text-center p-6">
              <div className="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <Users className="h-8 w-8 text-green-600" />
              </div>
              <h4 className="text-xl font-semibold text-gray-900 mb-2">Hỗ trợ 24/7</h4>
              <p className="text-gray-600">CSKH luôn sẵn sàng mọi lúc, mọi nơi.</p>
            </div>
            <div className="text-center p-6">
              <div className="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <Star className="h-8 w-8 text-yellow-600" />
              </div>
              <h4 className="text-xl font-semibold text-gray-900 mb-2">Chất lượng cao</h4>
              <p className="text-gray-600">Dịch vụ uy tín, giá hợp lý.</p>
            </div>
          </div>
        </div>
      </section>

      {/* Popular Routes: đọc từ /api/routes */}
      <section className="py-20 bg-gray-50">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="text-center mb-16">
            <h3 className="text-3xl font-bold text-gray-900 mb-4">Tuyến đường phổ biến</h3>
            <p className="text-xl text-gray-600">Khám phá các tuyến đường được yêu thích nhất</p>
          </div>

          {loading ? (
            <div className="text-center text-gray-500">Đang tải tuyến đường…</div>
          ) : err ? (
            <div className="text-center text-red-600">Lỗi: {err}</div>
          ) : routes.length === 0 ? (
            <div className="text-center text-gray-500">Chưa có dữ liệu tuyến đường.</div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {routes.map(route => (
                <div key={route._id} className="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition-shadow">
                  <div className="flex items-center justify-between mb-4">
                    <div className="flex items-center">
                      <MapPin className="h-5 w-5 text-blue-600 mr-2" />
                      <span className="font-medium text-gray-900">{route.from_city || '-'}</span>
                    </div>
                    <div className="flex-1 mx-4"><div className="border-t border-dashed border-gray-300"></div></div>
                    <div className="flex items-center">
                      <MapPin className="h-5 w-5 text-green-600 mr-2" />
                      <span className="font-medium text-gray-900">{route.to_city || '-'}</span>
                    </div>
                  </div>

                  <div className="flex justify-between items-center text-sm text-gray-600">
                    <div className="flex items-center">
                      <Clock className="h-4 w-4 inline mr-1" />
                      {fmtDuration(route.estimated_duration_min)}
                    </div>
                    <div className="font-medium">
                      {typeof route.total_distance_km === 'number' ? `${route.total_distance_km} km` : '-'}
                    </div>
                  </div>

                  <button
                    onClick={() => handleBookingClick(route._id)}
                    className="w-full mt-4 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    Đặt vé ngay
                  </button>
                </div>
              ))}
            </div>
          )}
        </div>
      </section>

      {/* Footer */}
      <footer className="bg-gray-900 text-white py-12">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
            <div>
              <div className="flex items-center mb-4">
                <Bus className="h-8 w-8 text-blue-400" />
                <h4 className="ml-2 text-xl font-bold">VeXe7TV</h4>
              </div>
              <p className="text-gray-400">Dịch vụ đặt vé xe khách trực tuyến hàng đầu Việt Nam.</p>
            </div>
            <div>
              <h5 className="text-lg font-semibold mb-4">Dịch vụ</h5>
              <ul className="space-y-2 text-gray-400">
                <li><a href="#" className="hover:text-white">Đặt vé xe khách</a></li>
                <li><a href="#" className="hover:text-white">Tra cứu tuyến đường</a></li>
                <li><a href="#" className="hover:text-white">Hỗ trợ khách hàng</a></li>
                <li><a href="#" className="hover:text-white">Chính sách hoàn vé</a></li>
              </ul>
            </div>
            <div>
              <h5 className="text-lg font-semibold mb-4">Hỗ trợ</h5>
              <ul className="space-y-2 text-gray-400">
                <li><a href="#" className="hover:text-white">Câu hỏi thường gặp</a></li>
                <li><a href="#" className="hover:text-white">Hướng dẫn đặt vé</a></li>
                <li><a href="#" className="hover:text-white">Liên hệ</a></li>
                <li><a href="#" className="hover:text-white">Báo cáo sự cố</a></li>
              </ul>
            </div>
            <div>
              <h5 className="text-lg font-semibold mb-4">Liên hệ</h5>
              <div className="space-y-2 text-gray-400">
                <p>📞 Hotline: 1900 1234</p>
                <p>📧 Email: support@vexe7tv.com</p>
                <p>📍 123 Trịnh Văn Bô, Nam Từ Liêm, Hà Nội</p>
              </div>
            </div>
          </div>
          <div className="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
            <p>&copy; 2025 VeXe7TV. Tất cả quyền được bảo lưu.</p>
          </div>
        </div>
      </footer>
    </div>
  );
};

export default HomePage;

--- END OF FILE: frontend\src\components\HomePage.tsx ---


--- START OF FILE: frontend\src\components\LoginPage.tsx ---
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { ArrowLeft, Lock, Mail } from 'lucide-react';
import { useAuth } from '../App';

const API_BASE = ((import.meta as any)?.env?.VITE_BACKEND_URL as string) || 'http://localhost:5000';

const LoginPage: React.FC = () => {
  const navigate = useNavigate();
  const { login: authLogin } = useAuth();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setLoading(true);

    try {
      const response = await fetch(`${API_BASE}/api/auth/login`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email, password }),
        credentials: 'include', // Important for cookies
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || 'Đăng nhập thất bại');
      }

      // Use auth context to manage user state
      authLogin(data.user);
      
      // Redirect based on role
      if (data.user.role === 'admin') {
        navigate('/admin');
      } else {
        navigate('/');
      }
    } catch (err: any) {
      setError(err.message || 'Đã xảy ra lỗi khi đăng nhập');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button
              onClick={() => navigate('/')}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay lại
            </button>
          </div>
        </div>
      </header>

      <div className="flex-grow flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div className="max-w-md w-full space-y-8">
          <div>
            <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
              Đăng nhập vào tài khoản
            </h2>
            <p className="mt-2 text-center text-sm text-gray-600">
              Hoặc{' '}
              <button
                onClick={() => navigate('/register')}
                className="font-medium text-blue-600 hover:text-blue-500"
              >
                đăng ký tài khoản mới
              </button>
            </p>
          </div>

          <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
            {error && (
              <div className="rounded-md bg-red-50 p-4">
                <div className="text-sm text-red-700">{error}</div>
              </div>
            )}

            <div className="rounded-md shadow-sm -space-y-px">
              <div>
                <label htmlFor="email" className="sr-only">
                  Email
                </label>
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Mail className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="email"
                    name="email"
                    type="email"
                    autoComplete="email"
                    required
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    className="appearance-none rounded-none relative block w-full px-3 py-2 pl-10 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                    placeholder="Email"
                  />
                </div>
              </div>
              <div>
                <label htmlFor="password" className="sr-only">
                  Mật khẩu
                </label>
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Lock className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="password"
                    name="password"
                    type="password"
                    autoComplete="current-password"
                    required
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="appearance-none rounded-none relative block w-full px-3 py-2 pl-10 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                    placeholder="Mật khẩu"
                  />
                </div>
              </div>
            </div>

            <div className="flex items-center justify-between">
              <div className="text-sm">
                <button
                  type="button"
                  onClick={() => navigate('/forgot-password')}
                  className="font-medium text-blue-600 hover:text-blue-500"
                >
                  Quên mật khẩu?
                </button>
              </div>
            </div>

            <div>
              <button
                type="submit"
                disabled={loading}
                className={`group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white ${
                  loading
                    ? 'bg-blue-400 cursor-not-allowed'
                    : 'bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500'
                }`}
              >
                {loading ? 'Đang xử lý...' : 'Đăng nhập'}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
};

export default LoginPage;
--- END OF FILE: frontend\src\components\LoginPage.tsx ---


--- START OF FILE: frontend\src\components\MyTicketsPage.tsx ---
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { ArrowLeft, Bus, MapPin, Clock, Calendar, Download, Eye, Trash2, XCircle, Phone } from 'lucide-react';
import { useAuth } from '../App';

interface Ticket {
  id: string;
  bookingId: string;
  route: {
    from: string;
    to: string;
    price: string;
    duration: string;
    departureTime: string;
    arrivalTime: string;
    busType: string;
  };
  seats: number[];
  passenger: {
    name: string;
    phone: string;
    email: string;
    note: string;
  };
  totalAmount: number;
  paymentMethod: string;
  bookingDate: string;
  status: 'confirmed' | 'cancelled' | 'used' | 'pending';
}

type BookingDoc = {
  _id: string;
  user?: any;
  trip?: any;
  pickup_name?: string;
  dropoff_name?: string;
  route_snapshot?: {
    from: string;
    to: string;
    estimated_duration_min?: number;
  };
  bus_snapshot?: {
    bus_type: string;
    license_plate: string;
    seat_count: number;
  };
  start_time: string;
  end_time?: string | null;
  seat_numbers: string[];
  total_amount?: number;
  total_price?: number;
  passenger?: {
    name: string;
    phone: string;
    email: string;
    note: string;
  };
  status: 'pending' | 'paid' | 'cancelled' | 'completed';
  createdAt: string;
};

const API_BASE = ((import.meta as any)?.env?.VITE_BACKEND_URL as string) || 'http://localhost:5000';

const MyTicketsPage: React.FC = () => {
  const navigate = useNavigate();
  const { user } = useAuth();
  const [tickets, setTickets] = useState<Ticket[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [filterStatus, setFilterStatus] = useState<'all' | 'confirmed' | 'cancelled' | 'used' | 'pending'>('all');

  useEffect(() => {
    const fetchBookings = async () => {
      try {
        setLoading(true);
        setError(null);
        
        // Fetch từ API với credentials để gửi cookie token
        const res = await fetch(`${API_BASE}/api/bookings`, {
          credentials: 'include', // Quan trọng để gửi cookie
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        
        const bookings: BookingDoc[] = await res.json();
        
        // Chuyển đổi Booking format sang Ticket format
        const convertedTickets: Ticket[] = bookings.map((booking) => {
          const fmtTime = (iso?: string | null) => {
            if (!iso) return '-';
            const d = new Date(iso);
            if (Number.isNaN(d.getTime())) return '-';
            return d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
          };

          const fmtDate = (iso?: string | null) => {
            if (!iso) return new Date().toISOString();
            return iso;
          };

          const durationMin = booking.route_snapshot?.estimated_duration_min || 0;
          const duration = durationMin 
            ? `${Math.floor(durationMin / 60)}h ${durationMin % 60}m`
            : '-';

          // Map status từ booking sang ticket
          const mapStatus = (status: string): 'confirmed' | 'cancelled' | 'used' | 'pending' => {
            if (status === 'cancelled') return 'cancelled';
            if (status === 'completed') return 'used';
            if (status === 'pending') return 'pending';
            return 'confirmed'; // pending, paid -> confirmed
          };

          return {
            id: booking._id,
            bookingId: booking._id.substring(0, 8).toUpperCase(),
            route: {
              from: booking.route_snapshot?.from || booking.route_snapshot?.from || '-',
              to: booking.route_snapshot?.to || booking.route_snapshot?.to || '-',
              price: String(booking.total_amount || booking.total_price || 0),
              duration,
              departureTime: fmtTime(booking.start_time),
              arrivalTime: fmtTime(booking.end_time),
              busType: booking.bus_snapshot?.bus_type || '-',
            },
            seats: booking.seat_numbers.map(s => parseInt(s, 10)).filter(n => !Number.isNaN(n)),
            passenger: booking.passenger || {
              name: '',
              phone: '',
              email: '',
              note: '',
            },
            totalAmount: booking.total_amount || booking.total_price || 0,
            paymentMethod: 'banking', // Có thể lấy từ payment nếu cần
            bookingDate: fmtDate(booking.createdAt),
            status: mapStatus(booking.status),
          };
        });

        setTickets(convertedTickets);
      } catch (err: any) {
        setError(err.message || 'Lỗi khi tải danh sách vé');
        console.error('Error fetching bookings:', err);
      } finally {
        setLoading(false);
      }
    };

    fetchBookings();
  }, [user]); // Re-fetch khi user thay đổi

  const filteredTickets = tickets.filter(ticket => {
    if (filterStatus === 'all') return true;
    return ticket.status === filterStatus;
  });

  const handleViewTicket = (ticket: Ticket) => {
    // Chuyển đến trang chi tiết vé
    navigate('/ticket-detail', { state: { ticket } });
  };

  const handleDownloadTicket = (ticket: Ticket) => {
    // Mở trang chi tiết và tự động in (hoặc lưu PDF) từ đó
    navigate('/ticket-detail', { state: { ticket, autoPrint: true } });
  };

  const handleCancelTicket = async (ticketId: string) => {
    if (!window.confirm('Bạn có chắc chắn muốn hủy vé này? Hành động này sẽ trả lại ghế trống.')) {
      return;
    }

    try {
      setLoading(true);
      // Gọi API hủy vé xuống Backend
      const res = await fetch(`${API_BASE}/api/bookings/${ticketId}/cancel`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      const data = await res.json();

      if (res.ok) {
        alert('Hủy vé thành công!');
        // Reload lại trang để cập nhật danh sách mới nhất từ server
        window.location.reload(); 
      } else {
        alert(data.error || 'Có lỗi xảy ra khi hủy vé');
      }
    } catch (err) {
      console.error(err);
      alert('Lỗi kết nối server');
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteTicket = (ticketId: string) => {
    if (window.confirm('Bạn có chắc chắn muốn xóa vé này?')) {
      const updatedTickets = tickets.filter(ticket => ticket.id !== ticketId);
      setTickets(updatedTickets);
      localStorage.setItem('vexe7tv_tickets', JSON.stringify(updatedTickets));
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'confirmed': return 'bg-green-100 text-green-800';
      case 'pending': return 'bg-yellow-100 text-yellow-800';
      case 'cancelled': return 'bg-red-100 text-red-800';
      case 'used': return 'bg-gray-100 text-gray-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const getStatusText = (status: string) => {
    switch (status) {
      case 'confirmed': return 'Đã xác nhận';
      case 'pending': return 'Chờ thanh toán';
      case 'cancelled': return 'Đã hủy';
      case 'used': return 'Đã sử dụng';
      default: return 'Không xác định';
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button 
              onClick={() => navigate('/')}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay lại
            </button>
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Page Header */}
        <div className="text-center mb-8">
          <h2 className="text-3xl font-bold text-gray-900 mb-2">Vé của tôi</h2>
          <p className="text-gray-600">Quản lý và theo dõi các vé đã đặt</p>
        </div>

        {/* Filter */}
        <div className="bg-white rounded-xl shadow-md p-6 mb-8">
          <div className="flex flex-wrap gap-4">
            <button
              onClick={() => setFilterStatus('all')}
              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                filterStatus === 'all'
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Tất cả ({tickets.length})
            </button>
            <button
              onClick={() => setFilterStatus('confirmed')}
              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                filterStatus === 'confirmed'
                  ? 'bg-green-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Đã xác nhận ({tickets.filter(t => t.status === 'confirmed').length})
            </button>
            <button
              onClick={() => setFilterStatus('cancelled')}
              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                filterStatus === 'cancelled'
                  ? 'bg-red-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Đã hủy ({tickets.filter(t => t.status === 'cancelled').length})
            </button>
            <button
              onClick={() => setFilterStatus('used')}
              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                filterStatus === 'used'
                  ? 'bg-gray-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Đã sử dụng ({tickets.filter(t => t.status === 'used').length})
            </button>
          </div>
        </div>

        {/* Loading State */}
        {loading && (
          <div className="text-center py-12">
            <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p className="text-gray-600">Đang tải danh sách vé...</p>
          </div>
        )}

        {/* Error State */}
        {error && !loading && (
          <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <p className="text-red-700">{error}</p>
            {!user && (
              <p className="text-sm text-red-600 mt-2">
                Vui lòng <button onClick={() => navigate('/login')} className="underline font-medium">đăng nhập</button> để xem vé của bạn.
              </p>
            )}
          </div>
        )}

        {/* Tickets List */}
        {!loading && !error && filteredTickets.length > 0 ? (
          <div className="space-y-6">
            {filteredTickets.map((ticket) => (
              <div key={ticket.id} className="bg-white rounded-xl shadow-md p-6">
                <div className="flex items-start justify-between mb-4">
                  <div className="flex items-center">
                    <div className="bg-blue-100 p-3 rounded-lg mr-4">
                      <Bus className="h-6 w-6 text-blue-600" />
                    </div>
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900">
                        {ticket.route.from} → {ticket.route.to}
                      </h3>
                      <p className="text-sm text-gray-600">Mã đặt vé: {ticket.bookingId}</p>
                    </div>
                  </div>
                  <div className="flex items-center space-x-2">
                    <span className={`px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(ticket.status)}`}>
                      {getStatusText(ticket.status)}
                    </span>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                  <div className="flex items-center">
                    <Calendar className="h-5 w-5 text-blue-600 mr-2" />
                    <div>
                      <p className="text-sm text-gray-600">Ngày đặt</p>
                      <p className="font-medium">{new Date(ticket.bookingDate).toLocaleDateString('vi-VN')}</p>
                    </div>
                  </div>
                  <div className="flex items-center">
                    <Clock className="h-5 w-5 text-green-600 mr-2" />
                    <div>
                      <p className="text-sm text-gray-600">Giờ khởi hành</p>
                      <p className="font-medium">{ticket.route.departureTime}</p>
                    </div>
                  </div>
                  <div className="flex items-center">
                    <MapPin className="h-5 w-5 text-purple-600 mr-2" />
                    <div>
                      <p className="text-sm text-gray-600">Ghế</p>
                      <p className="font-medium">{ticket.seats.join(', ')}</p>
                    </div>
                  </div>
                  <div className="flex items-center">
                    <Bus className="h-5 w-5 text-orange-600 mr-2" />
                    <div>
                      <p className="text-sm text-gray-600">Loại xe</p>
                      <p className="font-medium">{ticket.route.busType}</p>
                    </div>
                  </div>
                </div>

                <div className="flex items-center justify-between">
                  <div className="text-lg font-bold text-blue-600">
                    {ticket.totalAmount.toLocaleString()}₫
                  </div>
                  <div className="flex space-x-2">
                    <button
                      onClick={() => handleViewTicket(ticket)}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center"
                    >
                      <Eye className="h-4 w-4 mr-2" />
                      Chi tiết
                    </button>

                    {ticket.status === 'confirmed' ? (
                      /* ĐÃ THANH TOÁN: Tải vé + Hỗ trợ */
                      <>
                        <button
                          onClick={() => handleDownloadTicket(ticket)}
                          className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center"
                        >
                          <Download className="h-4 w-4 mr-2" />
                          Tải vé
                        </button>
                        <a
                          href="tel:19001234"
                          className="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors flex items-center decoration-0"
                          title="Liên hệ tổng đài"
                        >
                          <Phone className="h-4 w-4 mr-2" />
                          Hỗ trợ
                        </a>
                      </>
                    ) : ticket.status === 'pending' ? (
                      /* CHỜ THANH TOÁN: Thanh toán + Hủy */
                      <>
                        <button
                           onClick={() => alert("Vui lòng chuyển khoản theo mã QR")}
                           className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center"
                        >
                          <Clock className="h-4 w-4 mr-2" />
                          Thanh toán
                        </button>
                        <button
                          onClick={() => handleCancelTicket(ticket.id)}
                          className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center"
                        >
                          <XCircle className="h-4 w-4 mr-2" />
                          Hủy vé
                        </button>
                      </>
                    ) : (
                      /* ĐÃ HỦY/ĐI: Xóa lịch sử */
                      <button
                        onClick={() => handleDeleteTicket(ticket.id)}
                        className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center"
                      >
                        <Trash2 className="h-4 w-4 mr-2" />
                        Xóa lịch sử
                      </button>
                    )}
                  </div>
                </div>
              </div>
            ))}
          </div>
        ) : !loading && !error ? (
          <div className="text-center py-12">
            <Bus className="h-16 w-16 text-gray-400 mx-auto mb-4" />
            <h3 className="text-xl font-semibold text-gray-900 mb-2">Chưa có vé nào</h3>
            <p className="text-gray-600 mb-6">
              {user 
                ? 'Bạn chưa đặt vé nào. Hãy đặt vé để bắt đầu hành trình!'
                : 'Vui lòng đăng nhập để xem vé của bạn hoặc đặt vé mới.'}
            </p>
            <div className="flex gap-4 justify-center">
              {!user && (
                <button
                  onClick={() => navigate('/login')}
                  className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                  Đăng nhập
                </button>
              )}
              <button
                onClick={() => navigate('/')}
                className="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium"
              >
                Đặt vé ngay
              </button>
            </div>
          </div>
        ) : null}

        {/* Stats */}
        {tickets.length > 0 && (
          <div className="mt-12 bg-white rounded-xl shadow-md p-6">
            <h3 className="text-xl font-bold text-gray-900 mb-4">Thống kê</h3>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div className="text-center p-4 bg-blue-50 rounded-lg">
                <div className="text-2xl font-bold text-blue-600">{tickets.length}</div>
                <div className="text-sm text-gray-600">Tổng vé</div>
              </div>
              <div className="text-center p-4 bg-green-50 rounded-lg">
                <div className="text-2xl font-bold text-green-600">
                  {tickets.filter(t => t.status === 'confirmed').length}
                </div>
                <div className="text-sm text-gray-600">Đã xác nhận</div>
              </div>
              <div className="text-center p-4 bg-red-50 rounded-lg">
                <div className="text-2xl font-bold text-red-600">
                  {tickets.filter(t => t.status === 'cancelled').length}
                </div>
                <div className="text-sm text-gray-600">Đã hủy</div>
              </div>
              <div className="text-center p-4 bg-purple-50 rounded-lg">
                <div className="text-2xl font-bold text-purple-600">
                  {tickets.reduce((sum, ticket) => sum + ticket.totalAmount, 0).toLocaleString()}₫
                </div>
                <div className="text-sm text-gray-600">Tổng chi phí</div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default MyTicketsPage;

--- END OF FILE: frontend\src\components\MyTicketsPage.tsx ---


--- START OF FILE: frontend\src\components\PaymentPage.tsx ---
// components/PaymentPage.tsx
import React, { useMemo, useState } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { ArrowLeft, Bus, MapPin, Clock, CreditCard, Shield, Lock } from 'lucide-react';
const API_BASE = 'http://localhost:5000';

type PaymentState = {
  tripId: string;
  seats: number[];
  passenger: { name: string; phone: string; email?: string; note?: string; };
  stops?: { pickupId?: string; dropoffId?: string; pickupName?: string; dropoffName?: string };
  route?: { from?: string; to?: string; durationMin?: number | null };
  bus?: { busType?: string; licensePlate?: string; seatCount?: number };
  times?: { departureTime?: string; arrivalTime?: string | null };
  pricePerSeat?: number;
};

const PaymentPage: React.FC = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const st = (location.state || {}) as PaymentState;

  // Mặc định chọn Banking
  const [paymentMethod, setPaymentMethod] = useState<'momo' | 'banking'>('banking');
  const [isProcessing, setIsProcessing] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  const totalAmount = useMemo(() => {
    const price = Number(st.pricePerSeat || 0);
    return price * (st.seats?.length || 0);
  }, [st.pricePerSeat, st.seats]);

  if (!st?.tripId || !Array.isArray(st?.seats)) {
    navigate('/');
    return null;
  }

  const handlePayment = async () => {
    try {
      setIsProcessing(true);
      setErr(null);

      const res = await fetch(`${API_BASE}/api/bookings/checkout`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include', 
        body: JSON.stringify({
          tripId: st.tripId,
          seatNumbers: st.seats,
          passenger: st.passenger,
          paymentMethod,
          amount: totalAmount,
          stops: st.stops
        })
      });

      if (!res.ok) {
        const e = await res.json().catch(() => ({}));
        throw new Error(e?.error || `HTTP ${res.status}`);
      }
      const payload = await res.json();
      navigate('/payment-success', { state: payload });
    } catch (e: any) {
      setErr(e?.message || 'Có lỗi khi thanh toán');
    } finally {
      setIsProcessing(false);
    }
  };

  const fmtTime = (iso?: string | null) => {
    if (!iso) return '-';
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return '-';
    return d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button
              onClick={() => navigate(-1)}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay lại
            </button>
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="text-center mb-8">
          <h2 className="text-3xl font-bold text-gray-900 mb-2">Thanh toán</h2>
          <p className="text-gray-600">Hoàn tất đặt vé của bạn</p>
          {err && <div className="text-red-600 mt-2">{err}</div>}
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {/* Thông tin đặt vé */}
          <div className="space-y-6">
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Thông tin chuyến đi</h3>

              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center">
                  <MapPin className="h-5 w-5 text-blue-600 mr-2" />
                  <div>
                    <p className="font-semibold text-gray-900">{st.stops?.pickupName || st.route?.from || '-'}</p>
                    <p className="text-sm text-gray-600">Điểm đi</p>
                  </div>
                </div>

                <div className="flex-1 mx-4">
                  <div className="border-t border-dashed border-gray-300"></div>
                  <div className="text-center mt-1">
                    <Clock className="h-4 w-4 inline mr-1" />
                    <span className="text-sm text-gray-600">
                      {st.route?.durationMin ? `${Math.floor((st.route.durationMin||0)/60)}h ${(st.route.durationMin||0)%60}m` : '-'}
                    </span>
                  </div>
                </div>

                <div className="flex items-center">
                  <MapPin className="h-5 w-5 text-green-600 mr-2" />
                  <div>
                    <p className="font-semibold text-gray-900">{st.stops?.dropoffName || st.route?.to || '-'}</p>
                    <p className="text-sm text-gray-600">Điểm đến</p>
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span className="text-gray-600">Giờ khởi hành:</span>
                  <span className="ml-2 font-medium">{fmtTime(st.times?.departureTime)}</span>
                </div>
                <div>
                  <span className="text-gray-600">Giờ dự kiến đến:</span>
                  <span className="ml-2 font-medium">{fmtTime(st.times?.arrivalTime || null)}</span>
                </div>
                <div>
                  <span className="text-gray-600">Loại xe:</span>
                  <span className="ml-2 font-medium">{st.bus?.busType || '-'}</span>
                </div>
                <div className="col-span-2 border-t border-dashed pt-2 mt-1">
                   <span className="text-gray-600">Ghế đã chọn:</span>
                   <span className="ml-2 font-bold text-blue-600 text-base">
                     {st.seats.join(', ')}
                   </span>
                </div>
                <div>
                  <span className="text-gray-600">Biển số:</span>
                  <span className="ml-2 font-medium font-mono text-blue-700">
                    {st.bus?.licensePlate || '---'}
                  </span>
              </div>
              </div>
            </div>

            {/* Hành khách */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Thông tin hành khách</h3>
              <div className="space-y-3 text-sm">
                <div className="flex justify-between">
                  <span className="text-gray-600">Họ và tên:</span>
                  <span className="font-medium">{st.passenger?.name || '-'}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Số điện thoại:</span>
                  <span className="font-medium">{st.passenger?.phone || '-'}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Email:</span>
                  <span className="font-medium">{st.passenger?.email || 'Không có'}</span>
                </div>
                {st.passenger?.note && (
                  <div className="flex justify-between">
                    <span className="text-gray-600">Ghi chú:</span>
                    <span className="font-medium">{st.passenger?.note}</span>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Thanh toán */}
          <div className="space-y-6">
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Phương thức thanh toán</h3>

              {/* MoMo */}
              <div
                className={`border-2 rounded-lg p-4 cursor-pointer transition-colors mb-3 ${paymentMethod==='momo' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300'}`}
                onClick={() => setPaymentMethod('momo')}
              >
                <div className="flex items-center">
                  <div className="w-6 h-6 rounded-full border-2 mr-3 flex items-center justify-center">
                    {paymentMethod === 'momo' && <div className="w-3 h-3 bg-pink-500 rounded-full"></div>}
                  </div>
                  <div className="flex items-center">
                    <div className="w-8 h-8 bg-pink-500 rounded mr-3 flex items-center justify-center">
                      <span className="text-white font-bold text-sm">M</span>
                    </div>
                    <div>
                      <p className="font-semibold text-gray-900">Ví MoMo</p>
                      <p className="text-sm text-gray-600">Thanh toán qua ví điện tử MoMo</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Banking */}
              <div
                className={`border-2 rounded-lg p-4 cursor-pointer transition-colors ${paymentMethod==='banking' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
                onClick={() => setPaymentMethod('banking')}
              >
                <div className="flex items-center">
                  <div className="w-6 h-6 rounded-full border-2 mr-3 flex items-center justify-center">
                    {paymentMethod === 'banking' && <div className="w-3 h-3 bg-blue-500 rounded-full"></div>}
                  </div>
                  <div className="flex items-center">
                    <CreditCard className="h-8 w-8 text-blue-600 mr-3" />
                    <div>
                      <p className="font-semibold text-gray-900">Chuyển khoản ngân hàng</p>
                      <p className="text-sm text-gray-600">Thanh toán qua Internet Banking</p>
                    </div>
                  </div>
                </div>
              </div>

            </div>

            {/* Tóm tắt */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Tóm tắt thanh toán</h3>
              <div className="space-y-3 mb-6">
                <div className="flex justify-between">
                  <span className="text-gray-600">Ghế đã chọn:</span>
                  <span className="font-medium text-right">
                    {st.seats.length} ghế <br/>
                    <span className="text-blue-600 text-sm">({st.seats.join(', ')})</span>
                  </span>
                </div>

                <div className="flex justify-between">
                  <span className="text-gray-600">Giá vé/ghế:</span>
                  <span className="font-medium">{(st.pricePerSeat || 0).toLocaleString()}₫</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Phí dịch vụ:</span>
                  <span className="font-medium">0₫</span>
                </div>
                <div className="border-t pt-3">
                  <div className="flex justify-between text-lg font-bold">
                    <span>Tổng cộng:</span>
                    <span className="text-blue-600">{totalAmount.toLocaleString()}₫</span>
                  </div>
                </div>
              </div>

              <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                <div className="flex items-center">
                  <Shield className="h-5 w-5 text-green-600 mr-2" />
                  <span className="text-sm text-green-800">Giao dịch được bảo mật và mã hóa SSL</span>
                </div>
              </div>

              <button
                onClick={handlePayment}
                disabled={isProcessing}
                className={`w-full py-3 px-4 rounded-lg font-medium text-lg transition-colors flex items-center justify-center ${isProcessing ? 'bg-gray-400 text-gray-200 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`}
              >
                {isProcessing ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                    Đang xử lý...
                  </>
                ) : (
                  <>
                    <Lock className="h-5 w-5 mr-2" />
                    Thanh toán {totalAmount.toLocaleString()}₫
                  </>
                )}
              </button>

              <p className="text-xs text-gray-500 text-center mt-3">
                Bằng cách thanh toán, bạn đồng ý với
                <a href="#" className="text-blue-600 hover:underline"> Điều khoản sử dụng</a> và
                <a href="#" className="text-blue-600 hover:underline"> Chính sách bảo mật</a>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default PaymentPage;
--- END OF FILE: frontend\src\components\PaymentPage.tsx ---


--- START OF FILE: frontend\src\components\PaymentSuccess.tsx ---
// components/PaymentSuccess.tsx
import React, { useEffect } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { CheckCircle, Bus, MapPin, Clock, Calendar } from 'lucide-react';

type SuccessPayload = {
  bookingId: string;
  paymentId: string;
  route: { from: string; to: string; durationMin: number | null };
  times: { departureTime: string; arrivalTime: string | null };
  bus: { busType: string; seatCount: number; licensePlate?: string };
  seats: (number|string)[];
  passenger: { name?: string; phone?: string; email?: string; note?: string } | null;
  pricePerSeat: number;
  totalAmount: number;
  paymentMethod: 'momo'|'banking'|'cod';
};

const PaymentSuccess: React.FC = () => {
  const { state } = useLocation();
  const navigate = useNavigate();
  const s = (state || null) as SuccessPayload | null;

  if (!s) {
    // nếu F5 mất state thì quay về trang chủ (hoặc bạn có thể gọi GET /api/bookings/:id nếu truyền id qua query)
    navigate('/');
    return null;
  }

  const fmtTime = (iso?: string | null) => {
    if (!iso) return '-';
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return '-';
    return d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
  };

  

  // Save the ticket into localStorage so MyTicketsPage (which reads localStorage) shows it
  useEffect(() => {
    if (!s) return;

    try {
      const key = 'vexe7tv_tickets';
      const existing = JSON.parse(localStorage.getItem(key) || '[]');

      // Build ticket shape compatible with MyTicketsPage
      const ticket = {
        id: s.bookingId,
        bookingId: s.bookingId,
        route: {
          from: s.route.from,
          to: s.route.to,
          price: (s.pricePerSeat || 0).toString(),
          duration: s.route.durationMin?.toString() || '',
          departureTime: s.times.departureTime,
          arrivalTime: s.times.arrivalTime || '',
          busType: s.bus.busType || ''
        },
        seats: (s.seats || []).map((x: any) => Number(x)),
        passenger: s.passenger || { name: '', phone: '', email: '', note: '' },
        totalAmount: s.totalAmount || 0,
        paymentMethod: s.paymentMethod,
        bookingDate: new Date().toISOString(),
        status: 'confirmed'
      };

      // avoid duplicates
      const exists = existing.some((t: any) => t.bookingId === ticket.bookingId);
      if (!exists) {
        const updated = [ticket, ...existing];
        localStorage.setItem(key, JSON.stringify(updated));
      }
    } catch (err) {
      console.error('Failed to save ticket to localStorage', err);
    }
  }, [s]);

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
       {/* LOGIC HIỂN THỊ: Chấp nhận cả Banking và MoMo là pending để hiện QR */}
        {(s.paymentMethod === 'banking' || s.paymentMethod === 'momo') && s.totalAmount > 0 ? (
          <div className="bg-yellow-50 border-2 border-yellow-400 rounded-xl p-6 mb-8 text-center max-w-md mx-auto">
            <h3 className="text-xl font-bold text-yellow-800 mb-4 animate-pulse">
              ⏳ Đơn hàng đang chờ thanh toán!
            </h3>
            
            <div className="bg-white p-2 inline-block rounded-lg shadow-sm border">
              {/* QR Code VietQR tự động */}
              <img 
                src={`https://img.vietqr.io/image/MB-0945555555-compact.jpg?amount=${s.totalAmount}&addInfo=VEXE ${s.bookingId}`} 
                alt="QR Code thanh toán" 
                className="h-48 w-48 mx-auto"
              />
            </div>
            
            <div className="mt-4 text-sm text-gray-800 space-y-1">
              <p>Ngân hàng: <strong>MB Bank</strong></p>
              <p>Số tài khoản: <strong className="text-lg">0945555555</strong></p>
              <p>Chủ tài khoản: <strong>NGUYEN VAN A</strong></p>
              <p className="pt-2">Nội dung chuyển khoản (Bắt buộc):</p>
              <p className="font-mono font-bold text-red-600 text-lg bg-white inline-block px-2 py-1 rounded border border-red-200">
                VEXE {s.bookingId}
              </p>
            </div>
            
            <p className="mt-4 text-red-600 text-xs italic">
              * Vui lòng chuyển khoản đúng nội dung để hệ thống tự động xử lý.
            </p>
          </div>
        ) : (
          /* TRƯỜNG HỢP CŨ: Đã thanh toán (COD hoặc logic khác) */
          <div className="text-center mb-8">
            <div className="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4">
              <CheckCircle className="h-12 w-12 text-green-600" />
            </div>
            <h2 className="text-3xl font-bold text-gray-900 mb-2">Đặt vé thành công!</h2>
            <p className="text-gray-600">Mã đặt vé: {s.bookingId}</p>
          </div>
        )}

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {/* Vé điện tử */}
          <div className="space-y-6">
            <div className="bg-white rounded-xl shadow-lg p-6 border-2 border-green-200">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-bold text-gray-900">Vé điện tử</h3>
                
                {/* Logic kiểm tra: Nếu là Banking/Momo -> Hiện Chờ thanh toán (Vàng), Ngược lại -> Đã thanh toán (Xanh) */}
                {(s.paymentMethod === 'banking' || s.paymentMethod === 'momo') ? (
                   <span className="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium">
                     ⏳ Chờ thanh toán
                   </span>
                ) : (
                   <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                     ✅ Đã thanh toán
                   </span>
                )}
              </div>

              <div className="bg-gray-50 rounded-lg p-4 mb-4">
                <div className="text-center mb-4">
                  <div className="text-2xl font-bold text-gray-900 mb-1">VeXe7TV</div>
                  <div className="text-sm text-gray-600">Mã đặt vé: {s.bookingId}</div>
                </div>

                <div className="flex items-center justify-between mb-4">
                  <div className="text-center">
                    <MapPin className="h-6 w-6 text-blue-600 mx-auto mb-1" />
                    <div className="font-semibold text-gray-900">{s.route.from}</div>
                    <div className="text-sm text-gray-600">{fmtTime(s.times.departureTime)}</div>
                  </div>

                  <div className="flex-1 mx-4">
                    <div className="border-t border-dashed border-gray-300"></div>
                    <div className="text-center mt-1">
                      <Clock className="h-4 w-4 inline mr-1" />
                      <span className="text-sm text-gray-600">
                        {s.route.durationMin ? `${Math.floor((s.route.durationMin||0)/60)}h ${(s.route.durationMin||0)%60}m` : '-'}
                      </span>
                    </div>
                  </div>

                  <div className="text-center">
                    <MapPin className="h-6 w-6 text-green-600 mx-auto mb-1" />
                    <div className="font-semibold text-gray-900">{s.route.to}</div>
                    <div className="text-sm text-gray-600">{fmtTime(s.times.arrivalTime)}</div>
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div><span className="text-gray-600">Ghế:</span><span className="ml-2 font-medium">{s.seats.join(', ')}</span></div>
                  <div><span className="text-gray-600">Xe:</span><span className="ml-2 font-medium">{s.bus.busType} {s.bus.licensePlate ? `(${s.bus.licensePlate})` : ''}</span></div>
                  <div><span className="text-gray-600">Loại xe:</span><span className="ml-2 font-medium">{s.bus.busType}</span></div>
                  <div><span className="text-gray-600">Hành khách:</span><span className="ml-2 font-medium">{s.passenger?.name || '-'}</span></div>
                  <div><span className="text-gray-600">SĐT:</span><span className="ml-2 font-medium">{s.passenger?.phone || '-'}</span></div>
                </div>
              </div>

              <button
                onClick={() => window.print()}
                className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
              >
                In / Tải vé điện tử
              </button>
            </div>

            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Thông tin chuyến đi</h3>
              <div className="space-y-4">
                <div className="flex items-center">
                  <Calendar className="h-5 w-5 text-blue-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">Ngày khởi hành</p>
                    <p className="text-gray-600">{new Date(s.times.departureTime).toLocaleDateString('vi-VN')}</p>
                  </div>
                </div>
                <div className="flex items-center">
                  <Clock className="h-5 w-5 text-green-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">Giờ khởi hành</p>
                    <p className="text-gray-600">{fmtTime(s.times.departureTime)}</p>
                  </div>
                </div>
                <div className="flex items-center">
                  <Bus className="h-5 w-5 text-purple-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">Loại xe</p>
                    <p className="text-gray-600">{s.bus.busType}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Thanh toán */}
          <div className="space-y-6">
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Chi tiết thanh toán</h3>
              <div className="space-y-3 mb-4">
                <div className="flex justify-between"><span className="text-gray-600">Mã đặt vé:</span><span className="font-medium">{s.bookingId}</span></div>
                <div className="flex justify-between"><span className="text-gray-600">Mã thanh toán:</span><span className="font-medium">{s.paymentId}</span></div>
                <div className="flex justify-between"><span className="text-gray-600">Phương thức:</span><span className="font-medium">{s.paymentMethod === 'momo' ? 'Ví MoMo' : s.paymentMethod === 'cod' ? 'Thanh toán tại xe' : 'Chuyển khoản ngân hàng'}</span></div>
                <div className="flex justify-between"><span className="text-gray-600">Số ghế:</span><span className="font-medium">{s.seats.length} ghế</span></div>
                <div className="flex justify-between"><span className="text-gray-600">Giá vé/ghế:</span><span className="font-medium">{(s.pricePerSeat || 0).toLocaleString()}₫</span></div>
                <div className="border-t pt-3">
                  <div className="flex justify-between text-lg font-bold">
                    <span>Tổng thanh toán:</span>
                    <span className="text-green-600">{(s.totalAmount || 0).toLocaleString()}₫</span>
                  </div>
                </div>
              </div>
              <button
                onClick={() => navigate('/')}
                className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium"
              >
                Về trang chủ
              </button>
            </div>
          </div>
        </div>

        {/* footer nhỏ */}
        <div className="mt-12 text-center text-sm text-gray-500">
          Cần hỗ trợ? Hotline 1900 1234 • support@vexe7tv.com
        </div>
      </div>
    </div>
  );
};

export default PaymentSuccess;

--- END OF FILE: frontend\src\components\PaymentSuccess.tsx ---


--- START OF FILE: frontend\src\components\RegisterPage.tsx ---
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { ArrowLeft, Lock, Mail, User, Phone } from 'lucide-react';

const API_BASE = ((import.meta as any)?.env?.VITE_BACKEND_URL as string) || 'http://localhost:5000';

const RegisterPage: React.FC = () => {
  const navigate = useNavigate();
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    password: '',
    confirmPassword: ''
  });
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);

    // Validate password match
    if (formData.password !== formData.confirmPassword) {
      setError('Mật khẩu xác nhận không khớp');
      return;
    }

    setLoading(true);

    try {
      const response = await fetch(`${API_BASE}/api/auth/register`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify({
          name: formData.name,
          email: formData.email,
          phone: formData.phone,
          password: formData.password
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || 'Đăng ký thất bại');
      }

      // Redirect to login page with success message
      navigate('/login', { state: { message: 'Đăng ký thành công! Vui lòng đăng nhập.' } });
    } catch (err: any) {
      setError(err.message || 'Đã xảy ra lỗi khi đăng ký');
    } finally {
      setLoading(false);
    }
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button
              onClick={() => navigate('/')}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay lại
            </button>
          </div>
        </div>
      </header>

      <div className="flex-grow flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div className="max-w-md w-full space-y-8">
          <div>
            <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
              Đăng ký tài khoản mới
            </h2>
            <p className="mt-2 text-center text-sm text-gray-600">
              Hoặc{' '}
              <button
                onClick={() => navigate('/login')}
                className="font-medium text-blue-600 hover:text-blue-500"
              >
                đăng nhập với tài khoản hiện có
              </button>
            </p>
          </div>

          <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
            {error && (
              <div className="rounded-md bg-red-50 p-4">
                <div className="text-sm text-red-700">{error}</div>
              </div>
            )}

            <div className="rounded-md shadow-sm -space-y-px">
              <div>
                <label htmlFor="name" className="sr-only">
                  Họ và tên
                </label>
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <User className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="name"
                    name="name"
                    type="text"
                    required
                    value={formData.name}
                    onChange={handleChange}
                    className="appearance-none rounded-none relative block w-full px-3 py-2 pl-10 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                    placeholder="Họ và tên"
                  />
                </div>
              </div>
              <div>
                <label htmlFor="email" className="sr-only">
                  Email
                </label>
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Mail className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="email"
                    name="email"
                    type="email"
                    autoComplete="email"
                    required
                    value={formData.email}
                    onChange={handleChange}
                    className="appearance-none rounded-none relative block w-full px-3 py-2 pl-10 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                    placeholder="Email"
                  />
                </div>
              </div>
              <div>
                <label htmlFor="phone" className="sr-only">
                  Số điện thoại
                </label>
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Phone className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="phone"
                    name="phone"
                    type="tel"
                    required
                    value={formData.phone}
                    onChange={handleChange}
                    className="appearance-none rounded-none relative block w-full px-3 py-2 pl-10 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                    placeholder="Số điện thoại"
                  />
                </div>
              </div>
              <div>
                <label htmlFor="password" className="sr-only">
                  Mật khẩu
                </label>
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Lock className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="password"
                    name="password"
                    type="password"
                    required
                    value={formData.password}
                    onChange={handleChange}
                    className="appearance-none rounded-none relative block w-full px-3 py-2 pl-10 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                    placeholder="Mật khẩu"
                  />
                </div>
              </div>
              <div>
                <label htmlFor="confirmPassword" className="sr-only">
                  Xác nhận mật khẩu
                </label>
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Lock className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="confirmPassword"
                    name="confirmPassword"
                    type="password"
                    required
                    value={formData.confirmPassword}
                    onChange={handleChange}
                    className="appearance-none rounded-none relative block w-full px-3 py-2 pl-10 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                    placeholder="Xác nhận mật khẩu"
                  />
                </div>
              </div>
            </div>

            <div>
              <button
                type="submit"
                disabled={loading}
                className={`group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white ${
                  loading
                    ? 'bg-blue-400 cursor-not-allowed'
                    : 'bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500'
                }`}
              >
                {loading ? 'Đang xử lý...' : 'Đăng ký'}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
};

export default RegisterPage;
--- END OF FILE: frontend\src\components\RegisterPage.tsx ---


--- START OF FILE: frontend\src\components\RoutesPage.tsx ---
import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { ArrowLeft, Bus, MapPin, Clock, Star, Search, Calendar, Filter } from 'lucide-react';

interface Route {
  id: string;
  from: string;
  to: string;
  price: string;
  duration: string;
  departureTime: string;
  arrivalTime: string;
  busType: string;
  availableSeats: number;
  rating: number;
  company: string;
  features: string[];
}

const API_BASE = ((import.meta as any)?.env?.VITE_BACKEND_URL as string) || '';

const RoutesPage: React.FC = () => {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  
  // Get initial search values from URL params
  const fromParam = searchParams.get('from') || '';
  const toParam = searchParams.get('to') || '';
  const dateParam = searchParams.get('date') || '';
  
  // Build search term from from/to params
  const initialSearchTerm = [fromParam, toParam].filter(Boolean).join(' ');
  
  const [searchTerm, setSearchTerm] = useState(initialSearchTerm);
  const [selectedDate, setSelectedDate] = useState(dateParam);
  const [sortBy, setSortBy] = useState<'price' | 'duration' | 'rating'>('price');
  const [filterBusType, setFilterBusType] = useState<string>('all');
  const [routes, setRoutes] = useState<Route[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  // Debounced search term to prevent frequent re-renders
  const [debouncedSearchTerm, setDebouncedSearchTerm] = useState(searchTerm);
  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedSearchTerm(searchTerm);
    }, 300);
    return () => clearTimeout(timer);
  }, [searchTerm]);

  // Update search term when URL params change
  useEffect(() => {
    const newSearchTerm = [fromParam, toParam].filter(Boolean).join(' ');
    if (newSearchTerm && newSearchTerm !== searchTerm) {
      setSearchTerm(newSearchTerm);
    }
  }, [fromParam, toParam]);

  const handleDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const newDate = e.target.value;
    setSelectedDate(newDate);
    
    // Update URL to trigger data refetch
    const params = new URLSearchParams(window.location.search);
    if (newDate) {
      params.set('date', newDate);
    } else {
      params.delete('date');
    }
    navigate(`?${params.toString()}`, { replace: true });
  };

  useEffect(() => {
    let mounted = true;
    const fetchRoutes = async () => {
      try {
        setLoading(true);
        // Build the URL with date query param if available
        let url = `${API_BASE}/api/routes/detailed`;
        if (dateParam) {
          url += `?date=${dateParam}`;
        }
        
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (mounted) {
          setRoutes(data.map((r: any) => ({
            id: r._id || r.id,
            from: r.from_city || r.from || r.name || '—',
            to: r.to_city || r.to || '—',
            price: r.base_price ? String(r.base_price) : '',
            duration: r.estimated_duration_min ? `${Math.round(r.estimated_duration_min/60)}h` : (r.duration || ''),
            departureTime: r.start_time ? new Date(r.start_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '',
            arrivalTime: r.end_time ? new Date(r.end_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '',
            busType: r.bus_type || '',
            availableSeats: typeof r.availableSeats === 'number' ? r.availableSeats : 0,
            rating: r.avgRating ? Math.round(r.avgRating * 10) / 10 : 0,
            company: r.company || '',
            features: r.features || []
          })));
          setLoading(false);
        }
      } catch (err: any) {
        if (mounted) {
          setError(err.message || 'Lỗi khi tải tuyến');
          setLoading(false);
        }
      }
    };

    fetchRoutes();
    return () => { mounted = false; };
  }, [dateParam]);

  // Memoize filtered and sorted routes
  const filteredRoutes = useMemo(() => {
    return routes
      .filter(route => {
        // If we have specific from/to params, match them exactly
        let matchesSearch = true;
        if (fromParam || toParam) {
          const fromMatch = !fromParam || route.from.toLowerCase().includes(fromParam.toLowerCase());
          const toMatch = !toParam || route.to.toLowerCase().includes(toParam.toLowerCase());
          matchesSearch = fromMatch && toMatch;
        } else if (debouncedSearchTerm) {
          // Otherwise use general search
          matchesSearch = route.from.toLowerCase().includes(debouncedSearchTerm.toLowerCase()) ||
                         route.to.toLowerCase().includes(debouncedSearchTerm.toLowerCase());
        }
        const matchesBusType = filterBusType === 'all' || route.busType.includes(filterBusType);
        return matchesSearch && matchesBusType;
      })
      .sort((a, b) => {
        switch (sortBy) {
          case 'price':
            return parseInt(a.price.replace(',', '')) - parseInt(b.price.replace(',', ''));
          case 'duration':
            return parseInt(a.duration.replace('h', '')) - parseInt(b.duration.replace('h', ''));
          case 'rating':
            return b.rating - a.rating;
          default:
            return 0;
        }
      });
  }, [routes, debouncedSearchTerm, filterBusType, sortBy]);

  const handleBookingClick = useCallback((routeId: string) => {
    navigate(`/booking/${routeId}`);
  }, [navigate]);

  // Memoize stats calculations
  const stats = useMemo(() => ({
    totalRoutes: routes.length,
    totalSeats: routes.reduce((sum, route) => sum + route.availableSeats, 0),
    averageRating: routes.length ? Math.round((routes.reduce((sum, route) => sum + route.rating, 0) / routes.length) * 10) / 10 : 0,
    uniqueCompanies: new Set(routes.map(route => route.company)).size
  }), [routes]);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <Bus className="h-16 w-16 text-gray-400 mx-auto mb-4" />
          <div className="text-lg font-medium">Đang tải danh sách tuyến...</div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center text-red-600">Lỗi: {error}</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button 
              onClick={() => navigate('/')}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay lại
            </button>
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Page Header */}
        <div className="text-center mb-8">
          <h2 className="text-3xl font-bold text-gray-900 mb-2">Tất cả tuyến đường</h2>
          <p className="text-gray-600">Khám phá các tuyến đường xe khách có sẵn</p>
        </div>

        {/* Search and Filter */}
        <div className="bg-white rounded-xl shadow-md p-6 mb-8">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div className="relative">
              <Search className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
              <input
                type="text"
                placeholder="Tìm kiếm tuyến đường..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div className="relative">
              <Calendar className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
              <input
                type="date"
                value={selectedDate}
                onChange={handleDateChange}
                className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            
            <div className="relative">
              <Filter className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
              <select
                value={filterBusType}
                onChange={(e) => setFilterBusType(e.target.value)}
                className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none"
              >
                <option value="all">Tất cả loại xe</option>
                <option value="Xe ngồi">Xe ngồi</option>
                <option value="Xe giường nằm">Xe giường nằm</option>
                <option value="VIP">Xe VIP</option>
              </select>
            </div>
            
            <div className="relative">
              <Calendar className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
              <select
                value={sortBy}
                onChange={(e) => setSortBy(e.target.value as 'price' | 'duration' | 'rating')}
                className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none"
              >
                <option value="price">Sắp xếp theo giá</option>
                <option value="duration">Sắp xếp theo thời gian</option>
                <option value="rating">Sắp xếp theo đánh giá</option>
              </select>
            </div>
          </div>
        </div>

        {/* Routes Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredRoutes.map((route) => (
            <div key={route.id} className="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition-shadow">
              {/* Route Header */}
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center">
                  <MapPin className="h-5 w-5 text-blue-600 mr-2" />
                  <span className="font-medium text-gray-900">{route.from}</span>
                </div>
                <div className="flex-1 mx-4">
                  <div className="border-t border-dashed border-gray-300"></div>
                </div>
                <div className="flex items-center">
                  <MapPin className="h-5 w-5 text-green-600 mr-2" />
                  <span className="font-medium text-gray-900">{route.to}</span>
                </div>
              </div>

              {/* Route Info */}
              <div className="space-y-3 mb-4">
                <div className="flex justify-between items-center">
                  <div className="flex items-center text-sm text-gray-600">
                    <Clock className="h-4 w-4 mr-1" />
                    {route.duration}
                  </div>
                  <div className="text-lg font-bold text-blue-600">
                    {route.price}₫
                  </div>
                </div>
                
                <div className="flex justify-between items-center text-sm">
                  <span className="text-gray-600">Giờ khởi hành:</span>
                  <span className="font-medium">{route.departureTime}</span>
                </div>
                
                <div className="flex justify-between items-center text-sm">
                  <span className="text-gray-600">Loại xe:</span>
                  <span className="font-medium">{route.busType}</span>
                </div>
                
                <div className="flex justify-between items-center text-sm">
                  <span className="text-gray-600">Nhà xe:</span>
                  <span className="font-medium">{route.company}</span>
                </div>
                
                <div className="flex justify-between items-center text-sm">
                  <span className="text-gray-600">Ghế trống:</span>
                  <span className="font-medium text-green-600">{route.availableSeats} ghế</span>
                </div>
              </div>

              {/* Rating */}
              <div className="flex items-center mb-4">
                <div className="flex items-center">
                  {[...Array(5)].map((_, i) => (
                    <Star
                      key={i}
                      className={`h-4 w-4 ${
                        i < Math.floor(route.rating)
                          ? 'text-yellow-400 fill-current'
                          : 'text-gray-300'
                      }`}
                    />
                  ))}
                </div>
                <span className="ml-2 text-sm text-gray-600">{route.rating}/5</span>
              </div>

              {/* Features */}
              <div className="mb-4">
                <div className="flex flex-wrap gap-2">
                  {route.features.map((feature, index) => (
                    <span
                      key={index}
                      className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full"
                    >
                      {feature}
                    </span>
                  ))}
                </div>
              </div>

              {/* Book Button */}
              <button
                onClick={() => handleBookingClick(route.id)}
                className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium"
              >
                Đặt vé ngay
              </button>
            </div>
          ))}
        </div>

        {/* No Results */}
        {filteredRoutes.length === 0 && (
          <div className="text-center py-12">
            <Bus className="h-16 w-16 text-gray-400 mx-auto mb-4" />
            <h3 className="text-xl font-semibold text-gray-900 mb-2">Không tìm thấy tuyến đường</h3>
            <p className="text-gray-600">Vui lòng thử lại với từ khóa khác hoặc bộ lọc khác</p>
          </div>
        )}

        {/* Stats */}
        <div className="mt-12 bg-white rounded-xl shadow-md p-6">
          <h3 className="text-xl font-bold text-gray-900 mb-4">Thống kê</h3>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div className="text-center p-4 bg-blue-50 rounded-lg">
              <div className="text-2xl font-bold text-blue-600">{stats.totalRoutes}</div>
                <div className="text-sm text-gray-600">Tổng tuyến đường</div>
            </div>
            <div className="text-center p-4 bg-green-50 rounded-lg">
                <div className="text-2xl font-bold text-green-600">
                  {stats.totalSeats}
                </div>
              <div className="text-sm text-gray-600">Ghế có sẵn</div>
            </div>
            <div className="text-center p-4 bg-yellow-50 rounded-lg">
              <div className="text-2xl font-bold text-yellow-600">
                  {stats.averageRating}
              </div>
              <div className="text-sm text-gray-600">Đánh giá trung bình</div>
            </div>
            <div className="text-center p-4 bg-purple-50 rounded-lg">
              <div className="text-2xl font-bold text-purple-600">
                  {stats.uniqueCompanies}
              </div>
              <div className="text-sm text-gray-600">Nhà xe</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default RoutesPage;

--- END OF FILE: frontend\src\components\RoutesPage.tsx ---


--- START OF FILE: frontend\src\components\TicketDetailPage.tsx ---
import React, { useEffect } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { ArrowLeft, Bus, MapPin, Clock, Calendar, Download, Home, User, Phone, Mail, FileText, AlertCircle } from 'lucide-react';

interface Ticket {
  id: string;
  bookingId: string;
  route: {
    from: string;
    to: string;
    price: string;
    duration: string;
    departureTime: string;
    arrivalTime: string;
    busType: string;
  };
  seats: number[];
  passenger: {
    name: string;
    phone: string;
    email: string;
    note: string;
  };
  totalAmount: number;
  paymentMethod: string;
  bookingDate: string;
  status: 'confirmed' | 'cancelled' | 'used' | 'pending'; // Thêm pending vào đây
}

const TicketDetailPage: React.FC = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const ticket = location.state?.ticket as Ticket;
  const autoPrint = location.state?.autoPrint;

  if (!ticket) {
    navigate('/my-tickets');
    return null;
  }

  const handleDownloadTicket = () => {
    window.print();
  };

  useEffect(() => {
    if (autoPrint) {
      // Delay một chút để DOM render xong trước khi in
      setTimeout(() => window.print(), 300);
    }
  }, [autoPrint]);

  const handleBackToTickets = () => {
    navigate('/my-tickets');
  };

  const handleBackToHome = () => {
    navigate('/');
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'confirmed': return 'bg-green-100 text-green-800';
      case 'pending': return 'bg-yellow-100 text-yellow-800'; // Màu vàng cho Pending
      case 'cancelled': return 'bg-red-100 text-red-800';
      case 'used': return 'bg-gray-100 text-gray-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const getStatusText = (status: string) => {
    switch (status) {
      case 'confirmed': return 'Đã xác nhận';
      case 'pending': return 'Chờ thanh toán'; // Hiển thị chữ đúng
      case 'cancelled': return 'Đã hủy';
      case 'used': return 'Đã sử dụng';
      default: return 'Không xác định';
    }
  };

  const getPaymentMethodText = (method: string) => {
    switch (method) {
      case 'momo': return 'Ví MoMo';
      case 'banking': return 'Chuyển khoản ngân hàng';
      case 'cod': return 'Thanh toán tại xe';
      default: return 'Không xác định';
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm no-print">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button 
              onClick={handleBackToTickets}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay lại
            </button>
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Page Header */}
        <div className="text-center mb-8">
          <h2 className="text-3xl font-bold text-gray-900 mb-2">Chi tiết vé</h2>
          <p className="text-gray-600">Thông tin đầy đủ về vé đã đặt</p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {/* Vé điện tử */}
          <div className="space-y-6">
              <div className="bg-white rounded-xl shadow-lg p-6 border-2 border-green-200 printable-ticket">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-bold text-gray-900">Vé điện tử</h3>
                <span className={`px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(ticket.status)}`}>
                  {getStatusText(ticket.status)}
                </span>
              </div>
              
              <div className="bg-gray-50 rounded-lg p-4 mb-4">
                <div className="text-center mb-4">
                  <div className="text-2xl font-bold text-gray-900 mb-1">VeXe7TV</div>
                  <div className="text-sm text-gray-600">Mã đặt vé: {ticket.bookingId}</div>
                </div>
                
                <div className="flex items-center justify-between mb-4">
                  <div className="text-center">
                    <MapPin className="h-6 w-6 text-blue-600 mx-auto mb-1" />
                    <div className="font-semibold text-gray-900">{ticket.route.from}</div>
                    <div className="text-sm text-gray-600">{ticket.route.departureTime}</div>
                  </div>
                  
                  <div className="flex-1 mx-4">
                    <div className="border-t border-dashed border-gray-300"></div>
                    <div className="text-center mt-1">
                      <Clock className="h-4 w-4 inline mr-1" />
                      <span className="text-sm text-gray-600">{ticket.route.duration}</span>
                    </div>
                  </div>
                  
                  <div className="text-center">
                    <MapPin className="h-6 w-6 text-green-600 mx-auto mb-1" />
                    <div className="font-semibold text-gray-900">{ticket.route.to}</div>
                    <div className="text-sm text-gray-600">{ticket.route.arrivalTime}</div>
                  </div>
                </div>
                
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span className="text-gray-600">Ghế:</span>
                    <span className="ml-2 font-medium">{ticket.seats.join(', ')}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">Loại xe:</span>
                    <span className="ml-2 font-medium">{ticket.route.busType}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">Hành khách:</span>
                    <span className="ml-2 font-medium">{ticket.passenger.name}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">SĐT:</span>
                    <span className="ml-2 font-medium">{ticket.passenger.phone}</span>
                  </div>
                </div>
              </div>
              
              {/* LOGIC NÚT TẢI VÉ: Chỉ hiện khi Đã xác nhận */}
              {ticket.status === 'confirmed' ? (
                <button
                  onClick={handleDownloadTicket}
                  className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center no-print"
                >
                  <Download className="h-5 w-5 mr-2" />
                  Tải vé điện tử
                </button>
              ) : ticket.status === 'pending' ? (
                <div className="w-full bg-yellow-100 text-yellow-800 py-3 px-4 rounded-lg border border-yellow-200 text-center font-medium flex items-center justify-center no-print">
                  <AlertCircle className="h-5 w-5 mr-2" />
                  Vui lòng thanh toán để tải vé
                </div>
              ) : (
                <button disabled className="w-full bg-gray-300 text-gray-500 py-2 px-4 rounded-lg cursor-not-allowed flex items-center justify-center no-print">
                  Vé không khả dụng
                </button>
              )}
            </div>

            {/* Thông tin chuyến đi */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Thông tin chuyến đi</h3>
              
              <div className="space-y-4">
                <div className="flex items-center">
                  <Calendar className="h-5 w-5 text-blue-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">Ngày đặt vé</p>
                    <p className="text-gray-600">{new Date(ticket.bookingDate).toLocaleDateString('vi-VN')}</p>
                  </div>
                </div>
                
                <div className="flex items-center">
                  <Clock className="h-5 w-5 text-green-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">Giờ khởi hành</p>
                    <p className="text-gray-600">{ticket.route.departureTime}</p>
                  </div>
                </div>
                
                <div className="flex items-center">
                  <Bus className="h-5 w-5 text-purple-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">Loại xe</p>
                    <p className="text-gray-600">{ticket.route.busType}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Thông tin chi tiết bên phải */}
          <div className="space-y-6">
            {/* Thông tin hành khách */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Thông tin hành khách</h3>
              
              <div className="space-y-4">
                <div className="flex items-center">
                  <User className="h-5 w-5 text-blue-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">Họ và tên</p>
                    <p className="text-gray-600">{ticket.passenger.name}</p>
                  </div>
                </div>
                
                <div className="flex items-center">
                  <Phone className="h-5 w-5 text-green-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">Số điện thoại</p>
                    <p className="text-gray-600">{ticket.passenger.phone}</p>
                  </div>
                </div>
                
                {ticket.passenger.email && (
                  <div className="flex items-center">
                    <Mail className="h-5 w-5 text-purple-600 mr-3" />
                    <div>
                      <p className="font-semibold text-gray-900">Email</p>
                      <p className="text-gray-600">{ticket.passenger.email}</p>
                    </div>
                  </div>
                )}
                
                {ticket.passenger.note && (
                  <div className="flex items-center">
                    <FileText className="h-5 w-5 text-orange-600 mr-3" />
                    <div>
                      <p className="font-semibold text-gray-900">Ghi chú</p>
                      <p className="text-gray-600">{ticket.passenger.note}</p>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Chi tiết thanh toán */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Chi tiết thanh toán</h3>
              
              <div className="space-y-3 mb-4">
                <div className="flex justify-between">
                  <span className="text-gray-600">Mã đặt vé:</span>
                  <span className="font-medium">{ticket.bookingId}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Phương thức thanh toán:</span>
                  <span className="font-medium">{getPaymentMethodText(ticket.paymentMethod)}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Số ghế:</span>
                  <span className="font-medium">{ticket.seats.length} ghế</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Giá vé/ghế:</span>
                  <span className="font-medium">{ticket.route.price}₫</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Phí dịch vụ:</span>
                  <span className="font-medium">0₫</span>
                </div>
                <div className="border-t pt-3">
                  <div className="flex justify-between text-lg font-bold">
                    <span>Tổng thanh toán:</span>
                    <span className="text-green-600">{ticket.totalAmount.toLocaleString()}₫</span>
                  </div>
                </div>
              </div>
            </div>

            {/* Lưu ý quan trọng */}
            <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-6">
              <h3 className="text-lg font-bold text-yellow-800 mb-3">Lưu ý quan trọng</h3>
              <ul className="space-y-2 text-sm text-yellow-700">
                <li>• Vui lòng có mặt tại bến xe trước giờ khởi hành 30 phút</li>
                <li>• Mang theo CMND/CCCD để đối chiếu khi lên xe</li>
                <li>• Vé điện tử đã được gửi về email của bạn</li>
                <li>• Liên hệ hotline 1900 1234 nếu cần hỗ trợ</li>
              </ul>
            </div>

            {/* Hành động */}
            <div className="space-y-3 no-print">
              <button
                onClick={handleBackToTickets}
                className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center font-medium"
              >
                <ArrowLeft className="h-5 w-5 mr-2" />
                Về danh sách vé
              </button>
              
              <button
                onClick={handleBackToHome}
                className="w-full bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center font-medium"
              >
                <Home className="h-5 w-5 mr-2" />
                Về trang chủ
              </button>
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="mt-12 text-center">
          <div className="bg-white rounded-xl shadow-md p-6">
            <h3 className="text-lg font-bold text-gray-900 mb-2">Cần hỗ trợ?</h3>
            <p className="text-gray-600 mb-4">
              Nếu bạn có bất kỳ thắc mắc nào về chuyến đi, vui lòng liên hệ với chúng tôi
            </p>
            <div className="flex justify-center space-x-6 text-sm">
              <div className="flex items-center">
                <span className="font-medium">Hotline:</span>
                <span className="ml-2 text-blue-600">1900 1234</span>
              </div>
              <div className="flex items-center">
                <span className="font-medium">Email:</span>
                <span className="ml-2 text-blue-600">support@vexe7tv.com</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default TicketDetailPage;
--- END OF FILE: frontend\src\components\TicketDetailPage.tsx ---


--- START OF FILE: frontend\src\main.tsx ---
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const root = ReactDOM.createRoot(
  document.getElementById('root') as HTMLElement
);

root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);

--- END OF FILE: frontend\src\main.tsx ---


--- START OF FILE: frontend\tsconfig.json ---
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}

--- END OF FILE: frontend\tsconfig.json ---


--- START OF FILE: frontend\tsconfig.node.json ---
{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}

--- END OF FILE: frontend\tsconfig.node.json ---


--- START OF FILE: frontend\vite.config.ts ---
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://127.0.0.1:5000',
        changeOrigin: true,
        secure: false,
        ws: true,
        configure: (proxy, _options) => {
          proxy.on('error', (err, _req, _res) => {
            console.log('proxy error', err);
          });
          proxy.on('proxyReq', (proxyReq, req, _res) => {
            console.log('Sending Request to the Target:', req.method, req.url);
          });
          proxy.on('proxyRes', (proxyRes, req, _res) => {
            console.log('Received Response from the Target:', proxyRes.statusCode, req.url);
          });
        },
      }
    }
  }
})

--- END OF FILE: frontend\vite.config.ts ---
