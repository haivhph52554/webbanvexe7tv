=== PROJECT STRUCTURE ===
backend\controllers\adminController.js
backend\controllers\assistantController.js
backend\controllers\authController.js
backend\controllers\bookingController.js
backend\controllers\feedbackController.js
backend\controllers\paymentController.js
backend\controllers\routeController.js
backend\controllers\ticketController.js
backend\controllers\tripController.js
backend\data\assistants.json
backend\data\assistants_simple.json
backend\db.js
backend\middleware\authMiddleware.js
backend\models\Assistant.js
backend\models\Booking.js
backend\models\Bus.js
backend\models\Checkin.js
backend\models\Feedback.js
backend\models\Payment.js
backend\models\Review.js
backend\models\Route.js
backend\models\RouteStop.js
backend\models\Ticket.js
backend\models\Trip.js
backend\models\TripSeatStatus.js
backend\models\User.js
backend\package.json
backend\routes\adminRoutes.js
backend\routes\assistantRoutes.js
backend\routes\authRoutes.js
backend\routes\bookingRoutes.js
backend\routes\feedbackRoutes.js
backend\routes\paymentRoutes.js
backend\routes\routeRoutes.js
backend\routes\ticketRoutes.js
backend\routes\tripRoutes.js
backend\routes\userRoutes.js
backend\scripts\migrate_bookings_total.js
backend\seed.js
backend\server.js
backend\utils\mailer.js
backend\utils\send_test_email.js
frontend\index.html
frontend\package.json
frontend\src\App.css
frontend\src\App.tsx
frontend\src\components\AdminPage.tsx
frontend\src\components\BookingDetail.tsx
frontend\src\components\ContactPage.tsx
frontend\src\components\HomePage.tsx
frontend\src\components\LoginPage.tsx
frontend\src\components\MyTicketsPage.tsx
frontend\src\components\PaymentPage.tsx
frontend\src\components\PaymentSuccess.tsx
frontend\src\components\RegisterPage.tsx
frontend\src\components\RoutesPage.tsx
frontend\src\components\TicketDetailPage.tsx
frontend\src\main.tsx
frontend\tsconfig.json
frontend\tsconfig.node.json
frontend\vite.config.ts
scan_project.js

=========================



--- START OF FILE: backend\controllers\adminController.js ---
// ...existing code...
const Trip = require('../models/Trip');
const Booking = require('../models/Booking');
const Route = require('../models/Route');
const Bus = require('../models/Bus');
const User = require('../models/User');
const Assistant = require('../models/Assistant');
const TripSeatStatus = require('../models/TripSeatStatus');

// --- Buses CRUD helpers for admin UI --- 12345
exports.newBus = async (req, res) => {
  try {
    res.render('admin/bus_form', { bus: null, page: 'buses', errors: null });
  } catch (err) {
    console.error('Error rendering new bus form:', err);
    res.status(500).send('L·ªói khi t·∫£i form t·∫°o xe: ' + err.message);
  }
};

exports.createBus = async (req, res) => {
  try {
    const payload = {
      license_plate: req.body.license_plate,
      bus_type: req.body.bus_type,
      seat_count: Number(req.body.seat_count) || 0,
      active: req.body.active === 'on'
    };
    await Bus.create(payload);
    res.redirect('/admin/buses');
  } catch (err) {
    console.error('Error creating bus:', err);
    res.status(500).send('L·ªói khi t·∫°o xe: ' + err.message);
  }
};

exports.editBus = async (req, res) => {
  try {
    const bus = await Bus.findById(req.params.id);
    if (!bus) return res.status(404).send('Xe kh√¥ng t·ªìn t·∫°i');
    res.render('admin/bus_form', { bus, page: 'buses', errors: null });
  } catch (err) {
    console.error('Error rendering edit bus form:', err);
    res.status(500).send('L·ªói khi t·∫£i form s·ª≠a xe: ' + err.message);
  }
};

exports.updateBus = async (req, res) => {
  try {
    const payload = {
      license_plate: req.body.license_plate,
      bus_type: req.body.bus_type,
      seat_count: Number(req.body.seat_count) || 0,
      active: req.body.active === 'on'
    };
    await Bus.findByIdAndUpdate(req.params.id, payload);
    res.redirect('/admin/buses');
  } catch (err) {
    console.error('Error updating bus:', err);
    res.status(500).send('L·ªói khi c·∫≠p nh·∫≠t xe: ' + err.message);
  }
};

// --- Routes CRUD helpers for admin UI ---
exports.newRoute = async (req, res) => {
  try {
    res.render('admin/route_form', { route: null, page: 'routes', errors: null });
  } catch (err) {
    console.error('Error rendering new route form:', err);
    res.status(500).send('L·ªói khi t·∫£i form t·∫°o tuy·∫øn: ' + err.message);
  }
};

exports.createRouteAdmin = async (req, res) => {
  try {
    const payload = {
      name: req.body.name,
      from_city: req.body.from_city,
      to_city: req.body.to_city,
      total_distance_km: Number(req.body.total_distance_km) || 0,
      estimated_duration_min: Number(req.body.estimated_duration_min) || 0,
      active: req.body.active === 'on'
    };
    await Route.create(payload);
    res.redirect('/admin/routes');
  } catch (err) {
    console.error('Error creating route:', err);
    res.status(500).send('L·ªói khi t·∫°o tuy·∫øn: ' + err.message);
  }
};

exports.editRoute = async (req, res) => {
  try {
    const route = await Route.findById(req.params.id);
    if (!route) return res.status(404).send('Tuy·∫øn kh√¥ng t·ªìn t·∫°i');
    res.render('admin/route_form', { route, page: 'routes', errors: null });
  } catch (err) {
    console.error('Error rendering edit route form:', err);
    res.status(500).send('L·ªói khi t·∫£i form s·ª≠a tuy·∫øn: ' + err.message);
  }
};

exports.updateRoute = async (req, res) => {
  try {
    const payload = {
      name: req.body.name,
      from_city: req.body.from_city,
      to_city: req.body.to_city,
      total_distance_km: Number(req.body.total_distance_km) || 0,
      estimated_duration_min: Number(req.body.estimated_duration_min) || 0,
      active: req.body.active === 'on'
    };
    await Route.findByIdAndUpdate(req.params.id, payload);
    res.redirect('/admin/routes');
  } catch (err) {
    console.error('Error updating route:', err);
    res.status(500).send('L·ªói khi c·∫≠p nh·∫≠t tuy·∫øn: ' + err.message);
  }
};


// Hi·ªÉn th·ªã admin dashboard
exports.dashboard = async (req, res) => {
  try {
    const trips = await Trip.find()
      .populate('route')
      .populate('bus')
      .sort({ start_time: -1 });

    const bookings = await Booking.find()
      .populate('user')
      .populate('trip')
      .sort({ createdAt: -1 });

    const stats = {
      totalTrips: trips.length,
      totalBookings: bookings.length,
      completedBookings: bookings.filter(b => b.status === 'completed').length,
      pendingBookings: bookings.filter(b => b.status === 'pending').length,
      totalRevenue: bookings
        .filter(b => b.status === 'paid' || b.status === 'completed')
        .reduce((sum, b) => sum + (b.total_price || 0), 0)
    };

    res.render('admin/dashboard', {
      trips,
      bookings,
      stats,
      page: 'dashboard'
    });
  } catch (err) {
    console.error('Admin dashboard error:', err);
    res.status(500).send('L·ªói khi t·∫£i trang admin: ' + err.message);
  }
};

// API endpoint ƒë·ªÉ x√≥a booking
exports.deleteBooking = async (req, res) => {
  try {
    const booking = await Booking.findById(req.params.id);
    if (!booking) {
      return res.status(404).json({ error: 'Kh√¥ng t√¨m th·∫•y ƒë∆°n ƒë·∫∑t ch·ªó' });
    }

    if (booking.trip && booking.seat_numbers && booking.seat_numbers.length > 0) {
      const seatStatuses = await TripSeatStatus.find({
        trip: booking.trip,
        seat_number: { $in: booking.seat_numbers }
      });

      await TripSeatStatus.updateMany(
        {
          trip: booking.trip,
          seat_number: { $in: booking.seat_numbers }
        },
        {
          $set: {
            status: 'available',
            booking_id: null
          }
        }
      );

      console.log(`Reset ${seatStatuses.length} seats to available for booking ${booking._id}`);
    }

    await Booking.findByIdAndDelete(req.params.id);

    res.json({ success: true, message: 'ƒê√£ x√≥a ƒë·∫∑t ch·ªó v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i gh·∫ø th√†nh c√¥ng' });
  } catch (err) {
    console.error('Error deleting booking:', err);
    res.status(500).json({ error: 'L·ªói khi x√≥a ƒë·∫∑t ch·ªó: ' + err.message });
  }
};

// API endpoint ƒë·ªÉ x√≥a trip
exports.deleteTrip = async (req, res) => {
  try {
    await Trip.findByIdAndDelete(req.params.id);
    res.json({ success: true, message: 'ƒê√£ x√≥a chuy·∫øn xe th√†nh c√¥ng' });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// API endpoint ƒë·ªÉ thay ƒë·ªïi status c·ªßa booking
exports.updateBookingStatus = async (req, res) => {
  try {
    const { status } = req.body;
    const booking = await Booking.findByIdAndUpdate(
      req.params.id,
      { status },
      { new: true }
    );
    res.json({ success: true, booking });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// Trang Users Management (h·ªó tr·ª£ l·ªçc ?role=assistant v√† ph√¢n trang)
exports.users = async (req, res) => {
  try {
    const roleFilter = req.query.role; // ?role=assistant
    const pageNum = req.query.page ? Math.max(1, parseInt(req.query.page, 10) || 1) : 1;
    const limit = 50;
    const query = roleFilter ? { role: roleFilter } : {};

    const [users, total] = await Promise.all([
      User.find(query).sort({ createdAt: -1 }).skip((pageNum - 1) * limit).limit(limit).lean(),
      User.countDocuments(query)
    ]);

    const statsAll = await User.find().lean();
    const stats = {
      total: statsAll.length,
      customers: statsAll.filter(u => u.role === 'customer').length,
      drivers: statsAll.filter(u => u.role === 'driver').length,
      assistants: statsAll.filter(u => u.role === 'assistant').length,
      admins: statsAll.filter(u => u.role === 'admin').length
    };

    const totalPages = Math.ceil(total / limit);

    res.render('admin/users', {
      users,
      stats,
      page: 'users',
      roleFilter,
      pagination: {
        page: pageNum,
        totalPages,
        total
      }
    });
  } catch (err) {
    console.error('Error loading users:', err);
    res.status(500).send('L·ªói khi t·∫£i trang users: ' + err.message);
  }
};

// --- Assistants Management ---
// Trang Assistants Management
exports.assistants = async (req, res) => {
  try {
    const assistants = await Assistant.find()
      .populate('assigned_routes')
      .populate('assigned_trips')
      .sort({ createdAt: -1 });
    
    const stats = {
      total: assistants.length,
      active: assistants.filter(a => !a.status || a.status === 'active').length,
      withRoutes: assistants.filter(a => a.assigned_routes && a.assigned_routes.length > 0).length,
      withoutRoutes: assistants.filter(a => (!a.assigned_routes || a.assigned_routes.length === 0) && (!a.assigned_trips || a.assigned_trips.length === 0)).length
    };
    
    res.render('admin/assistants', { assistants, stats, page: 'assistants' });
  } catch (err) {
    console.error('Error loading assistants:', err);
    res.status(500).send('L·ªói khi t·∫£i trang assistants: ' + err.message);
  }
};

// Form t·∫°o assistant m·ªõi
exports.newAssistant = async (req, res) => {
  try {
    const Route = require('../models/Route');
    const routes = await Route.find().sort({ origin: 1 });
    res.render('admin/assistant_form', { assistant: null, routes, page: 'assistants', errors: null });
  } catch (err) {
    console.error('Error rendering new assistant form:', err);
    res.status(500).send('L·ªói khi t·∫£i form t·∫°o ph·ª• xe: ' + err.message);
  }
};

// T·∫°o assistant m·ªõi
exports.createAssistant = async (req, res) => {
  try {
    const payload = {
      name: req.body.name,
      email: req.body.email,
      phone: req.body.phone,
      employee_id: req.body.employee_id,
      license_number: req.body.license_number,
      experience_years: Number(req.body.experience_years) || 0,
      status: 'active',
      assigned_trips: [],
      assigned_routes: []
    };
    
    // X·ª≠ l√Ω assigned_routes n·∫øu c√≥
    if (req.body.assigned_routes) {
      const routeIds = Array.isArray(req.body.assigned_routes) 
        ? req.body.assigned_routes 
        : [req.body.assigned_routes];
      payload.assigned_routes = routeIds.filter(id => id);
    }
    
    await Assistant.create(payload);
    res.redirect('/admin/assistants');
  } catch (err) {
    console.error('Error creating assistant:', err);
    res.status(500).send('L·ªói khi t·∫°o ph·ª• xe: ' + err.message);
  }
};

// Form s·ª≠a assistant
exports.editAssistant = async (req, res) => {
  try {
    const Route = require('../models/Route');
    const assistant = await Assistant.findById(req.params.id);
    if (!assistant) return res.status(404).send('Ph·ª• xe kh√¥ng t·ªìn t·∫°i');
    
    const routes = await Route.find().sort({ origin: 1 });
    res.render('admin/assistant_form', { assistant, routes, page: 'assistants', errors: null });
  } catch (err) {
    console.error('Error rendering edit assistant form:', err);
    res.status(500).send('L·ªói khi t·∫£i form s·ª≠a ph·ª• xe: ' + err.message);
  }
};

// C·∫≠p nh·∫≠t assistant
exports.updateAssistant = async (req, res) => {
  try {
    const payload = {
      name: req.body.name,
      email: req.body.email,
      phone: req.body.phone,
      employee_id: req.body.employee_id,
      license_number: req.body.license_number,
      experience_years: Number(req.body.experience_years) || 0,
      status: req.body.status || 'active'
    };
    
    // C·∫≠p nh·∫≠t assigned_routes n·∫øu c√≥
    if (req.body.assigned_routes) {
      const routeIds = Array.isArray(req.body.assigned_routes) 
        ? req.body.assigned_routes 
        : [req.body.assigned_routes];
      payload.assigned_routes = routeIds.filter(id => id);
    } else {
      payload.assigned_routes = [];
    }
    
    await Assistant.findByIdAndUpdate(req.params.id, payload);
    res.redirect('/admin/assistants');
  } catch (err) {
    console.error('Error updating assistant:', err);
    res.status(500).send('L·ªói khi c·∫≠p nh·∫≠t ph·ª• xe: ' + err.message);
  }
};

// X√≥a assistant
exports.deleteAssistant = async (req, res) => {
  try {
    await Assistant.findByIdAndDelete(req.params.id);
    res.json({ success: true, message: 'ƒê√£ x√≥a ph·ª• xe th√†nh c√¥ng' });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// Xem chi ti·∫øt assistant
exports.assistantDetail = async (req, res) => {
  try {
    const Checkin = require('../models/Checkin');
    const Route = require('../models/Route');
    const assistant = await Assistant.findById(req.params.id)
      .populate('assigned_routes')
      .populate({
        path: 'assigned_trips',
        populate: [
          { path: 'route' },
          { path: 'bus' }
        ]
      });
    
    if (!assistant) {
      return res.status(404).send('Ph·ª• xe kh√¥ng t·ªìn t·∫°i');
    }
    
    // L·∫•y l·ªãch s·ª≠ check-in c·ªßa assistant n√†y
    const checkins = await Checkin.find({ assistant: assistant._id })
      .populate({
        path: 'booking',
        populate: {
          path: 'trip',
          populate: [
            { path: 'route' },
            { path: 'bus' }
          ]
        }
      })
      .sort({ checkin_time: -1 })
      .limit(50);
    
    // Th·ªëng k√™
    const totalCheckins = await Checkin.countDocuments({ assistant: assistant._id });
    const checkedInCount = await Checkin.countDocuments({ 
      assistant: assistant._id, 
      status: 'checked_in' 
    });
    const noShowCount = await Checkin.countDocuments({ 
      assistant: assistant._id, 
      status: 'no_show' 
    });
    
    // L·∫•y danh s√°ch booking t·ª´ c√°c route ƒë∆∞·ª£c g√°n
    const upcomingBookings = [];
    const allBookings = [];
    
    // L·∫•y t·∫•t c·∫£ trips t·ª´ c√°c routes ƒë∆∞·ª£c g√°n
    const routeIds = assistant.assigned_routes ? assistant.assigned_routes.map(r => r._id || r) : [];
    
    if (routeIds.length > 0) {
      // T√¨m t·∫•t c·∫£ trips thu·ªôc c√°c routes n√†y
      const trips = await Trip.find({ route: { $in: routeIds } })
        .populate('route')
        .populate('bus');
      
      // L·∫•y booking t·ª´ c√°c trips n√†y
      for (const trip of trips) {
        const bookings = await Booking.find({ 
          trip: trip._id,
          status: { $in: ['paid', 'completed'] }
        })
        .populate('user')
        .populate({
          path: 'trip',
          populate: [
            { path: 'route' },
            { path: 'bus' }
          ]
        })
        .sort({ createdAt: -1 });
        
        // Ki·ªÉm tra xem booking ƒë√£ ƒë∆∞·ª£c check-in ch∆∞a
        for (const booking of bookings) {
          const checkin = await Checkin.findOne({ booking: booking._id });
          const bookingInfo = {
            booking,
            trip,
            checkin: checkin || null,
            needsCheckin: !checkin
          };
          
          allBookings.push(bookingInfo);
          
          if (!checkin) {
            upcomingBookings.push(bookingInfo);
          }
        }
      }
    }
    
    // N·∫øu v·∫´n c√≤n assigned_trips (t∆∞∆°ng th√≠ch ng∆∞·ª£c), l·∫•y booking t·ª´ ƒë√≥
    if (assistant.assigned_trips && assistant.assigned_trips.length > 0) {
      for (const trip of assistant.assigned_trips) {
        // Ki·ªÉm tra xem trip n√†y ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ch∆∞a (n·∫øu route ƒë√£ ƒë∆∞·ª£c g√°n)
        const tripRouteId = trip.route ? (trip.route._id || trip.route) : null;
        const alreadyProcessed = tripRouteId && routeIds.some(rid => rid.toString() === tripRouteId.toString());
        
        if (!alreadyProcessed) {
          const bookings = await Booking.find({ 
            trip: trip._id,
            status: { $in: ['paid', 'completed'] }
          })
          .populate('user')
          .populate({
            path: 'trip',
            populate: [
              { path: 'route' },
              { path: 'bus' }
            ]
          })
          .sort({ createdAt: -1 });
          
          for (const booking of bookings) {
            const checkin = await Checkin.findOne({ booking: booking._id });
            const bookingInfo = {
              booking,
              trip,
              checkin: checkin || null,
              needsCheckin: !checkin
            };
            
            allBookings.push(bookingInfo);
            
            if (!checkin) {
              upcomingBookings.push(bookingInfo);
            }
          }
        }
      }
    }
    
    const stats = {
      totalCheckins,
      checkedInCount,
      noShowCount,
      checkinRate: totalCheckins > 0 ? ((checkedInCount / totalCheckins) * 100).toFixed(1) : 0,
      assignedRoutesCount: assistant.assigned_routes ? assistant.assigned_routes.length : 0,
      assignedTripsCount: assistant.assigned_trips ? assistant.assigned_trips.length : 0,
      pendingCheckins: upcomingBookings.length,
      totalBookings: allBookings.length
    };
    
    res.render('admin/assistant_detail', { 
      assistant, 
      checkins, 
      stats, 
      upcomingBookings: upcomingBookings.slice(0, 50),
      allBookings: allBookings.slice(0, 100),
      page: 'assistants' 
    });
  } catch (err) {
    console.error('Error loading assistant detail:', err);
    res.status(500).send('L·ªói khi t·∫£i chi ti·∫øt ph·ª• xe: ' + err.message);
  }
};

// API: Check-in h√†nh kh√°ch
exports.checkinPassenger = async (req, res) => {
  try {
    const Checkin = require('../models/Checkin');
    const { bookingId, status } = req.body; // status: 'checked_in' ho·∫∑c 'no_show'
    const assistantId = req.params.id;
    
    if (!bookingId || !status) {
      return res.status(400).json({ 
        success: false,
        message: 'Thi·∫øu bookingId ho·∫∑c status' 
      });
    }
    
    if (!['checked_in', 'no_show'].includes(status)) {
      return res.status(400).json({ 
        success: false,
        message: 'Status kh√¥ng h·ª£p l·ªá' 
      });
    }
    
    // Ki·ªÉm tra assistant t·ªìn t·∫°i
    const assistant = await Assistant.findById(assistantId);
    if (!assistant) {
      return res.status(404).json({ 
        success: false,
        message: 'Ph·ª• xe kh√¥ng t·ªìn t·∫°i' 
      });
    }
    
    // Ki·ªÉm tra booking t·ªìn t·∫°i
    const booking = await Booking.findById(bookingId);
    if (!booking) {
      return res.status(404).json({ 
        success: false,
        message: 'Booking kh√¥ng t·ªìn t·∫°i' 
      });
    }
    
    // Ki·ªÉm tra xem ƒë√£ check-in ch∆∞a
    const existingCheckin = await Checkin.findOne({ booking: bookingId });
    
    if (existingCheckin) {
      // C·∫≠p nh·∫≠t check-in hi·ªán c√≥
      existingCheckin.status = status;
      existingCheckin.checkin_time = new Date();
      existingCheckin.assistant = assistantId;
      await existingCheckin.save();
    } else {
      // T·∫°o check-in m·ªõi
      await Checkin.create({
        booking: bookingId,
        assistant: assistantId,
        checkin_time: new Date(),
        status: status
      });
    }
    
    res.json({ 
      success: true, 
      message: status === 'checked_in' ? 'ƒê√£ ƒë√°nh d·∫•u h√†nh kh√°ch ƒë√£ l√™n xe' : 'ƒê√£ ƒë√°nh d·∫•u h√†nh kh√°ch kh√¥ng ƒë·∫øn'
    });
  } catch (err) {
    console.error('Error checking in passenger:', err);
    res.status(500).json({ 
      success: false,
      message: 'L·ªói khi check-in: ' + err.message 
    });
  }
};

// Trang Buses Management
exports.buses = async (req, res) => {
  try {
    const buses = await Bus.find().sort({ createdAt: -1 });
    const stats = {
      total: buses.length,
      active: buses.filter(b => b.active).length,
      inactive: buses.filter(b => !b.active).length
    };
    res.render('admin/buses', { buses, stats, page: 'buses' });
  } catch (err) {
    console.error('Error loading buses:', err);
    res.status(500).send('L·ªói khi t·∫£i trang buses: ' + err.message);
  }
};

// Trang Routes Management
exports.routes = async (req, res) => {
  try {
    const RouteStop = require('../models/RouteStop');
    const routes = await Route.find().sort({ createdAt: -1 });
    
    for (let route of routes) {
      route.stops = await RouteStop.find({ route: route._id }).sort({ order: 1 });
    }
    
    const stats = {
      total: routes.length,
      active: routes.filter(r => r.active).length,
      inactive: routes.filter(r => !r.active).length
    };
    
    res.render('admin/routes', { routes, stats, page: 'routes' });
  } catch (err) {
    console.error('Error loading routes:', err);
    res.status(500).send('L·ªói khi t·∫£i trang routes: ' + err.message);
  }
};

// Trang Trips Management
exports.trips = async (req, res) => {
  try {
    const trips = await Trip.find()
      .populate('route')
      .populate('bus')
      .sort({ start_time: -1 });
    
    const stats = {
      total: trips.length,
      scheduled: trips.filter(t => t.status === 'scheduled').length,
      departed: trips.filter(t => t.status === 'departed').length,
      completed: trips.filter(t => t.status === 'completed').length
    };
    
    res.render('admin/trips', { trips, stats, page: 'trips' });
  } catch (err) {
    console.error('Error loading trips:', err);
    res.status(500).send('L·ªói khi t·∫£i trang trips: ' + err.message);
  }
};

// Trang Bookings Management
exports.bookings = async (req, res) => {
  try {
    const bookings = await Booking.find()
      .populate('user')
      .populate('trip')
      .sort({ createdAt: -1 });
    
    const stats = {
      total: bookings.length,
      pending: bookings.filter(b => b.status === 'pending').length,
      paid: bookings.filter(b => b.status === 'paid').length,
      completed: bookings.filter(b => b.status === 'completed').length,
      cancelled: bookings.filter(b => b.status === 'cancelled').length,
      totalRevenue: bookings
        .filter(b => b.status === 'paid' || b.status === 'completed')
        .reduce((sum, b) => sum + (b.total_price || 0), 0)
    };
    
    res.render('admin/bookings', { bookings, stats, page: 'bookings' });
  } catch (err) {
    console.error('Error loading bookings:', err);
    res.status(500).send('L·ªói khi t·∫£i trang bookings: ' + err.message);
  }
};

// Trang Statistics
exports.statistics = async (req, res) => {
  try {
    const users = await User.find();
    const trips = await Trip.find().populate('route').populate('bus');
    const bookings = await Booking.find().populate('user').populate('trip');
    const buses = await Bus.find();
    const routes = await Route.find();
    
    const stats = {
      users: {
        total: users.length,
        byRole: {
          customer: users.filter(u => u.role === 'customer').length,
          driver: users.filter(u => u.role === 'driver').length,
          assistant: users.filter(u => u.role === 'assistant').length,
          admin: users.filter(u => u.role === 'admin').length
        }
      },
      buses: {
        total: buses.length,
        active: buses.filter(b => b.active).length
      },
      routes: {
        total: routes.length,
        active: routes.filter(r => r.active).length
      },
      trips: {
        total: trips.length,
        byStatus: {
          scheduled: trips.filter(t => t.status === 'scheduled').length,
          departed: trips.filter(t => t.status === 'departed').length,
          completed: trips.filter(t => t.status === 'completed').length,
          cancelled: trips.filter(t => t.status === 'cancelled').length
        }
      },
      bookings: {
        total: bookings.length,
        byStatus: {
          pending: bookings.filter(b => b.status === 'pending').length,
          paid: bookings.filter(b => b.status === 'paid').length,
          completed: bookings.filter(b => b.status === 'completed').length,
          cancelled: bookings.filter(b => b.status === 'cancelled').length
        },
        revenue: bookings
          .filter(b => b.status === 'paid' || b.status === 'completed')
          .reduce((sum, b) => sum + (b.total_price || 0), 0)
      }
    };
    
    res.render('admin/statistics', { stats, page: 'statistics' });
  } catch (err) {
    console.error('Error loading statistics:', err);
    res.status(500).send('L·ªói khi t·∫£i trang statistics: ' + err.message);
  }
};

// API endpoints ƒë·ªÉ x√≥a
exports.deleteUser = async (req, res) => {
  try {
    await User.findByIdAndDelete(req.params.id);
    res.json({ success: true, message: 'ƒê√£ x√≥a user th√†nh c√¥ng' });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

exports.deleteBus = async (req, res) => {
  try {
    await Bus.findByIdAndDelete(req.params.id);
    res.json({ success: true, message: 'ƒê√£ x√≥a xe bu√Ωt th√†nh c√¥ng' });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

exports.deleteRoute = async (req, res) => {
  try {
    await Route.findByIdAndDelete(req.params.id);
    res.json({ success: true, message: 'ƒê√£ x√≥a tuy·∫øn ƒë∆∞·ªùng th√†nh c√¥ng' });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// --- Trips CRUD helpers for admin UI ---
exports.newTrip = async (req, res) => {
  try {
    const routes = await Route.find().sort({ createdAt: -1 });
    const buses = await Bus.find().sort({ createdAt: -1 });
    res.render('admin/trip_form', { trip: null, routes, buses, page: 'trips', errors: null });
  } catch (err) {
    console.error('Error rendering new trip form:', err);
    res.status(500).send('L·ªói khi t·∫£i form t·∫°o chuy·∫øn: ' + err.message);
  }
};

exports.createTrip = async (req, res) => {
  try {
    const payload = {
      route: req.body.route,
      bus: req.body.bus,
      start_time: req.body.start_time ? new Date(req.body.start_time) : null,
      end_time: req.body.end_time ? new Date(req.body.end_time) : null,
      base_price: Number(req.body.base_price) || 0,
      direction: req.body.direction || 'go',
      status: req.body.status || 'scheduled'
    };

    const trip = await Trip.create(payload);

    const bus = await Bus.findById(trip.bus);
    const seatCount = bus?.seat_count || 0;
    const seatDocs = [];
    for (let i = 1; i <= seatCount; i++) {
      seatDocs.push({ trip: trip._id, seat_number: String(i), status: 'available' });
    }
    if (seatDocs.length) await TripSeatStatus.insertMany(seatDocs);

    res.redirect('/admin/trips');
  } catch (err) {
    console.error('Error creating trip:', err);
    res.status(500).send('L·ªói khi t·∫°o chuy·∫øn: ' + err.message);
  }
};

exports.editTrip = async (req, res) => {
  try {
    const trip = await Trip.findById(req.params.id);
    if (!trip) return res.status(404).send('Chuy·∫øn kh√¥ng t·ªìn t·∫°i');
    const routes = await Route.find().sort({ createdAt: -1 });
    const buses = await Bus.find().sort({ createdAt: -1 });
    res.render('admin/trip_form', { trip, routes, buses, page: 'trips', errors: null });
  } catch (err) {
    console.error('Error rendering edit trip form:', err);
    res.status(500).send('L·ªói khi t·∫£i form s·ª≠a chuy·∫øn: ' + err.message);
  }
};

exports.updateTrip = async (req, res) => {
  try {
    const payload = {
      route: req.body.route,
      bus: req.body.bus,
      start_time: req.body.start_time ? new Date(req.body.start_time) : null,
      end_time: req.body.end_time ? new Date(req.body.end_time) : null,
      base_price: Number(req.body.base_price) || 0,
      direction: req.body.direction || 'go',
      status: req.body.status || 'scheduled'
    };

    await Trip.findByIdAndUpdate(req.params.id, payload);
    res.redirect('/admin/trips');
  } catch (err) {
    console.error('Error updating trip:', err);
    res.status(500).send('L·ªói khi c·∫≠p nh·∫≠t chuy·∫øn: ' + err.message);
  }
};
// ...existing code...
--- END OF FILE: backend\controllers\adminController.js ---


--- START OF FILE: backend\controllers\assistantController.js ---
const Assistant = require('../models/Assistant');
const Ticket = require('../models/Ticket');
const Checkin = require('../models/Checkin');
const Trip = require('../models/Trip');
const TripSeatStatus = require('../models/TripSeatStatus');

exports.getAssistantInfo = async (req, res) => {
  try {
    const assistant = await Assistant.findOne({ userId: req.user.id })
      .populate('userId', 'name phone email role')
      .populate('busId')
      .populate('currentTrip');

    if (!assistant) return res.status(404).json({ message: 'Kh√¥ng t√¨m th·∫•y l∆° xe' });
    res.json(assistant);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

exports.getPassengerList = async (req, res) => {
  try {
    const assistant = await Assistant.findOne({ userId: req.user.id });
    if (!assistant || !assistant.currentTrip) {
      return res.status(400).json({ message: 'Kh√¥ng c√≥ chuy·∫øn hi·ªán t·∫°i' });
    }

    const tickets = await Ticket.find({ tripId: assistant.currentTrip })
      .populate('userId', 'name phone email')
      .populate('seatId');

    res.json(tickets);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

exports.checkInPassenger = async (req, res) => {
  try {
    const { ticketId } = req.body;
    if (!ticketId) return res.status(400).json({ message: 'ticketId l√† b·∫Øt bu·ªôc' });

    const assistant = await Assistant.findOne({ userId: req.user.id });
    if (!assistant) return res.status(404).json({ message: 'Kh√¥ng t√¨m th·∫•y l∆° xe' });

    const ticket = await Ticket.findById(ticketId);
    if (!ticket) return res.status(404).json({ message: 'Kh√¥ng t√¨m th·∫•y v√©' });

    // Ki·ªÉm tra v√© thu·ªôc chuy·∫øn hi·ªán t·∫°i
    if (assistant.currentTrip && ticket.tripId.toString() !== assistant.currentTrip.toString()) {
      return res.status(400).json({ message: 'V√© kh√¥ng thu·ªôc chuy·∫øn hi·ªán t·∫°i' });
    }

    // T·∫°o b·∫£n ghi checkin
    const checkin = new Checkin({
      ticketId: ticket._id,
      assistantId: assistant._id,
      checkedInTime: new Date(),
      status: 'checked_in'
    });
    await checkin.save();

    // C·∫≠p nh·∫≠t v√© v√† danh s√°ch checkIn c·ªßa assistant
    ticket.status = 'checked_in';
    await ticket.save();

    assistant.checkInList.push({
      passengerId: ticket.userId,
      ticketId: ticket._id,
      checkedIn: true,
      checkedInTime: new Date()
    });
    await assistant.save();

    res.json({ message: 'Check-in th√†nh c√¥ng', checkin });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

exports.reportSeatIssue = async (req, res) => {
  try {
    const { seatStatusId, issue } = req.body;
    if (!seatStatusId || !issue) return res.status(400).json({ message: 'seatStatusId v√† issue l√† b·∫Øt bu·ªôc' });

    const assistant = await Assistant.findOne({ userId: req.user.id });
    if (!assistant) return res.status(404).json({ message: 'Kh√¥ng t√¨m th·∫•y l∆° xe' });

    const updated = await TripSeatStatus.findByIdAndUpdate(
      seatStatusId,
      { status: 'broken', issue },
      { new: true }
    );

    if (!updated) return res.status(404).json({ message: 'Kh√¥ng t√¨m th·∫•y tr·∫°ng th√°i gh·∫ø' });
    res.json({ message: 'B√°o c√°o s·ª± c·ªë th√†nh c√¥ng', seat: updated });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

exports.endTrip = async (req, res) => {
  try {
    const { tripId, notes } = req.body;
    if (!tripId) return res.status(400).json({ message: 'tripId l√† b·∫Øt bu·ªôc' });

    const assistant = await Assistant.findOne({ userId: req.user.id });
    if (!assistant) return res.status(404).json({ message: 'Kh√¥ng t√¨m th·∫•y l∆° xe' });

    const trip = await Trip.findByIdAndUpdate(tripId, { status: 'completed', assistantNotes: notes }, { new: true });
    if (!trip) return res.status(404).json({ message: 'Kh√¥ng t√¨m th·∫•y chuy·∫øn' });

    assistant.currentTrip = null;
    assistant.status = 'available';
    assistant.totalTrips = (assistant.totalTrips || 0) + 1;
    await assistant.save();

    res.json({ message: 'K·∫øt th√∫c chuy·∫øn th√†nh c√¥ng', trip });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

exports.updateRating = async (req, res) => {
  try {
    const { rating } = req.body;
    if (typeof rating !== 'number') return res.status(400).json({ message: 'rating ph·∫£i l√† s·ªë' });

    const assistant = await Assistant.findOne({ userId: req.user.id });
    if (!assistant) return res.status(404).json({ message: 'Kh√¥ng t√¨m th·∫•y l∆° xe' });

    // C·∫≠p nh·∫≠t trung b√¨nh ƒë∆°n gi·∫£n
    assistant.rating = (assistant.rating + rating) / 2;
    await assistant.save();

    res.json({ message: 'C·∫≠p nh·∫≠t ƒë√°nh gi√° th√†nh c√¥ng', assistant });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};
--- END OF FILE: backend\controllers\assistantController.js ---


--- START OF FILE: backend\controllers\authController.js ---
const User = require("../models/User");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");

// Generate JWT Token
const generateToken = (id) => {
  return jwt.sign({ id }, process.env.JWT_SECRET || "secretkey", {
    expiresIn: '30d',
  });
};

// Set token cookie
const sendTokenResponse = (user, statusCode, res) => {
  const token = generateToken(user._id);

  const options = {
    expires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
  };

  // Remove password from response
  const userResponse = { ...user._doc };
  delete userResponse.password;

  res
    .status(statusCode)
    .cookie('token', token, options)
    .json({
      success: true,
      token,
      user: userResponse,
    });
};

// @desc    Register user
// @route   POST /api/auth/register
exports.register = async (req, res) => {
  try {
    const { name, email, phone, password } = req.body;

    // Check if email exists
    const existingUser = await User.findOne({ email });
    if (existingUser) {
      return res.status(400).json({ message: "Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng" });
    }

    // Create user
    const user = await User.create({
      name,
      email,
      phone,
      password,  // Password will be hashed via mongoose pre-save middleware
      role: 'user'
    });

    sendTokenResponse(user, 201, res);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

// @desc    Login user
// @route   POST /api/auth/login
exports.login = async (req, res) => {
  try {
    const { email, password } = req.body;

    // Validate email & password
    if (!email || !password) {
      return res.status(400).json({ message: 'Vui l√≤ng nh·∫≠p email v√† m·∫≠t kh·∫©u' });
    }

    // Check for user
    const user = await User.findOne({ email }).select('+password');
    if (!user) {
      return res.status(401).json({ message: 'Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng' });
    }

    // Check password
    const isMatch = await bcrypt.compare(password, user.password);
    if (!isMatch) {
      return res.status(401).json({ message: 'Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng' });
    }

    sendTokenResponse(user, 200, res);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

// @desc    Logout user / clear cookie
// @route   GET /api/auth/logout
exports.logout = async (req, res) => {
  res.cookie('token', 'none', {
    expires: new Date(Date.now() + 10 * 1000),
    httpOnly: true,
  });

  res.status(200).json({
    success: true,
    message: 'ƒê√£ ƒëƒÉng xu·∫•t'
  });
};

// @desc    Get current logged in user
// @route   GET /api/auth/me
exports.getMe = async (req, res) => {
  try {
    const user = await User.findById(req.user.id);
    res.status(200).json({
      success: true,
      data: user,
    });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

--- END OF FILE: backend\controllers\authController.js ---


--- START OF FILE: backend\controllers\bookingController.js ---
// controllers/bookingController.js
const mongoose = require('mongoose');
const Booking = require('../models/Booking');
const Payment = require('../models/Payment');
const Trip = require('../models/Trip');
const TripSeatStatus = require('../models/TripSeatStatus');
const RouteStop = require('../models/RouteStop');
const { sendBookingConfirmationEmail } = require('../utils/mailer');

const normalizeToNumber = (v) => {
  const num = parseInt(String(v).replace(/\D/g, ''), 10);
  return Number.isNaN(num) ? null : num;
};

exports.checkout = async (req, res) => {
  const session = await mongoose.startSession();
  try {
    const { tripId, seatNumbers, passenger, paymentMethod, amount, stops } = req.body;

    if (!tripId || !Array.isArray(seatNumbers) || seatNumbers.length === 0) {
      return res.status(400).json({ error: 'Thi·∫øu tripId ho·∫∑c seatNumbers' });
    }

    const runFlow = async (maybeSession) => {
      const s = (query) => (maybeSession ? query.session(maybeSession) : query);
      const wopt = maybeSession ? { session: maybeSession } : {};

      // 1) L·∫•y trip + tham chi·∫øu bus/route
      const trip = await s(
        Trip.findById(tripId)
          .populate('route')
          .populate('bus')
      );
      if (!trip) throw new Error('Trip kh√¥ng t·ªìn t·∫°i');

      const seatCount = trip.bus?.seat_count || 0;
      if (!seatCount) throw new Error('Chuy·∫øn ch∆∞a c√≥ seat_count c·ªßa bus');

      // 2) Chu·∫©n ho√° danh s√°ch gh·∫ø ng∆∞·ªùi d√πng ch·ªçn (d∆∞·ªõi d·∫°ng s·ªë)
      const requestedNums = (seatNumbers || [])
        .map(normalizeToNumber)
        .filter((n) => n != null);

      if (!requestedNums.length) throw new Error('Thi·∫øu seatNumbers');

      // 3) L·∫•y gh·∫ø hi·ªán c√≥ c·ªßa trip
      let allSeatDocs = await s(TripSeatStatus.find({ trip: trip._id }));

      // 3a) N·∫øu CH∆ØA c√≥ gh·∫ø n√†o => seed to√†n b·ªô 1..seat_count
      if (allSeatDocs.length === 0) {
        const seedDocs = [];
        for (let i = 1; i <= seatCount; i++) {
          seedDocs.push({
            trip: trip._id,
            seat_number: String(i), // "1","2",...
            status: 'available',
            booking_id: null
          });
        }
        await TripSeatStatus.insertMany(seedDocs, wopt);
        allSeatDocs = await s(TripSeatStatus.find({ trip: trip._id }));
      }

      // 3b) Map s·ªë gh·∫ø -> doc
      const seatByNum = new Map(); // num -> doc
      for (const s of allSeatDocs) {
        const n = normalizeToNumber(s.seat_number);
        if (n != null && !seatByNum.has(n)) seatByNum.set(n, s);
      }

      // 3c) N·∫øu thi·∫øu doc cho c√°c gh·∫ø ng∆∞·ªùi d√πng ch·ªçn => seed b·ªï sung (mi·ªÖn l√† trong 1..seat_count)
      const missingNums = requestedNums.filter((n) => !seatByNum.has(n));
      if (missingNums.length) {
        const invalid = missingNums.filter((n) => n < 1 || n > seatCount);
        if (invalid.length) throw new Error('S·ªë gh·∫ø v∆∞·ª£t qu√° seat_count c·ªßa xe');

        const addDocs = missingNums.map((n) => ({
          trip: trip._id,
          seat_number: String(n),
          status: 'available',
          booking_id: null
        }));
        await TripSeatStatus.insertMany(addDocs, wopt);

        // n·∫°p b·ªï sung v√†o map
        const fresh = await s(TripSeatStatus.find({
          trip: trip._id,
          seat_number: { $in: missingNums.map(String) }
        }));
        for (const s of fresh) {
          const n = normalizeToNumber(s.seat_number);
          if (n != null) seatByNum.set(n, s);
        }
      }

      // 4) L·∫•y doc th·∫≠t ƒë·ªÉ ƒë·∫∑t
      const willBookDocs = requestedNums.map((n) => seatByNum.get(n));
      if (willBookDocs.some((d) => !d)) throw new Error('M·ªôt s·ªë gh·∫ø kh√¥ng t·ªìn t·∫°i trong chuy·∫øn');

      // 5) Ki·ªÉm tra tr·∫°ng th√°i available
      if (willBookDocs.some((d) => d.status !== 'available')) {
        throw new Error('C√≥ gh·∫ø ƒë√£ ƒë∆∞·ª£c gi·ªØ/ƒë·∫∑t');
      }

      // 6) T√≠nh ti·ªÅn ·ªü server ‚Äî n·∫øu client truy·ªÅn th√¥ng tin ƒëi·ªÉm d·ª´ng, t√≠nh theo ƒëo·∫°n gi·ªØa pickup/dropoff
      let pricePerSeat = trip.base_price || 0;
      let computedTotal = pricePerSeat * requestedNums.length;

      if (stops && stops.pickupId && stops.dropoffId) {
        // Load stops for route to compute relative fraction by order
        const pickupStop = await RouteStop.findById(stops.pickupId);
        const dropoffStop = await RouteStop.findById(stops.dropoffId);
        if (pickupStop && dropoffStop && String(pickupStop.route) === String(dropoffStop.route)) {
          const routeStops = await RouteStop.find({ route: pickupStop.route }).sort({ order: 1 });
          if (routeStops && routeStops.length > 0) {
            const orders = routeStops.map(s => (typeof s.order === 'number' ? s.order : 0));
            const minOrder = Math.min(...orders);
            const maxOrder = Math.max(...orders);
            const totalSegments = (maxOrder - minOrder) || 1;
            const segmentsBetween = Math.max(0, dropoffStop.order - pickupStop.order);
            const fraction = Math.min(1, segmentsBetween / totalSegments);
            // Compute prorated price per seat based on fraction of route length
            pricePerSeat = Math.round((trip.base_price || 0) * fraction);
            if (pricePerSeat <= 0) pricePerSeat = Math.max(1, Math.floor((trip.base_price || 0) * 0.2));
            computedTotal = pricePerSeat * requestedNums.length;
          }
        }
      }
      // if (Number(amount) !== computedTotal) throw new Error('Sai t·ªïng ti·ªÅn');

      // 7) T·∫°o booking ‚Äî l∆∞u label gh·∫ø y nh∆∞ DB (c√≥ th·ªÉ l√† "1", "A1", ...)
      const seatLabels = willBookDocs.map((d) => d.seat_number);
      const [booking] = await Booking.create(
        [
          {
            // G·∫Øn user n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p
            user: req.user ? req.user._id : undefined,
            trip: trip._id,
            start_time: trip.start_time,
            end_time: trip.end_time || null,
            seat_numbers: seatLabels,
            passenger: passenger || null,
            total_amount: computedTotal,
            total_price: computedTotal,
            status: 'paid',
            route_snapshot: {
              from: trip.route?.from_city || '',
              to: trip.route?.to_city || '',
              estimated_duration_min: trip.route?.estimated_duration_min || null
            },
            pickup: stops && stops.pickupId ? String(stops.pickupId) : undefined,
            dropoff: stops && stops.dropoffId ? String(stops.dropoffId) : undefined,
            pickup_name: (stops && stops.pickupId && typeof stops.pickupName === 'string') ? stops.pickupName : undefined,
            dropoff_name: (stops && stops.dropoffId && typeof stops.dropoffName === 'string') ? stops.dropoffName : undefined,
            bus_snapshot: {
              bus_type: trip.bus?.bus_type || '',
              license_plate: trip.bus?.license_plate || '',
              seat_count: trip.bus?.seat_count || 0
            }
          }
        ],
        wopt
      );

      // 8) T·∫°o payment
      const [payment] = await Payment.create(
        [
          {
            booking: booking._id,
            method: paymentMethod || 'banking',
            amount: computedTotal,
            transaction_code: `TX${Date.now()}`,
            status: 'success',
            paid_at: new Date()
          }
        ],
        wopt
      );

      // Link payment v√†o booking (n·∫øu schema c√≥ field)
      booking.payment = payment._id;
      booking.payment_id = payment._id;
  // Ensure user is saved on booking (if middleware set req.user)
  if (req.user && !booking.user) booking.user = req.user._id;
  await booking.save(wopt);

      // 9) C·∫≠p nh·∫≠t tr·∫°ng th√°i gh·∫ø theo _id (an to√†n nh·∫•t)
      const idsToUpdate = willBookDocs.map((d) => d._id);
      await TripSeatStatus.updateMany(
        { _id: { $in: idsToUpdate } },
        { $set: { status: 'booked', booking_id: booking._id, updated_at: new Date() } },
        wopt
      );

      // 10) Chu·∫©n b·ªã payload tr·∫£ v·ªÅ FE (seats tr·∫£ v·ªÅ d·∫°ng S·ªê cho UI)
      const payload = {
        bookingId: String(booking._id),
        paymentId: String(payment._id),
        route: {
          from: booking.route_snapshot.from,
          to: booking.route_snapshot.to,
          durationMin: booking.route_snapshot.estimated_duration_min
        },
        times: { departureTime: booking.start_time, arrivalTime: booking.end_time },
        bus: { busType: booking.bus_snapshot.bus_type, seatCount: booking.bus_snapshot.seat_count },
        seats: requestedNums,
        passenger: booking.passenger || null,
        pricePerSeat,
        totalAmount: computedTotal,
        paymentMethod: payment.method
      };
      // Include selected stops info if present
      if (stops && stops.pickupId && stops.dropoffId) {
        payload.stops = {
          pickupId: String(stops.pickupId),
          dropoffId: String(stops.dropoffId),
          pickupName: stops.pickupName || (booking.pickup_name || null),
          dropoffName: stops.dropoffName || (booking.dropoff_name || null)
        };
      }

      // G·ª≠i email x√°c nh·∫≠n (kh√¥ng ch·∫∑n response)
      // N·∫øu ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p, ∆∞u ti√™n g·ª≠i ƒë·∫øn email ƒë√£ ƒëƒÉng k√Ω c·ªßa t√†i kho·∫£n
      const recipientEmail = (req.user && req.user.email) ? req.user.email : (booking?.passenger?.email);
      if (recipientEmail) {
        // Fire-and-forget
        sendBookingConfirmationEmail(recipientEmail, payload)
          .catch((e) => console.error('Send email error:', e));
      }

      return payload;
    };

    // T·∫ÆT transaction ho√†n to√†n ƒë·ªÉ t∆∞∆°ng th√≠ch MongoDB standalone
    const payload = await runFlow(null);
    return res.json(payload);
  } catch (err) {
    console.error('Checkout error:', err);
    res.status(400).json({ error: err.message || 'Checkout failed' });
  } finally {
    session.endSession();
  }
};

// D√πng cho "V√© c·ªßa t√¥i" / F5 success
exports.listOfUser = async (req, res) => {
  try {
    const { userId, phone } = req.query;
    
    // N·∫øu c√≥ user ƒëƒÉng nh·∫≠p, t·ª± ƒë·ªông filter theo user ƒë√≥
    // ∆Øu ti√™n: req.user > userId query > phone query > kh√¥ng filter
    let q = {};
    
    if (req.user && req.user._id) {
      // User ƒë√£ ƒëƒÉng nh·∫≠p - ch·ªâ l·∫•y bookings c·ªßa user ƒë√≥
      q = { user: req.user._id };
    } else if (userId) {
      // Admin c√≥ th·ªÉ truy·ªÅn userId ƒë·ªÉ xem bookings c·ªßa user kh√°c
      q = { user: userId };
    } else if (phone) {
      // T√¨m theo s·ªë ƒëi·ªán tho·∫°i (cho tr∆∞·ªùng h·ª£p ch∆∞a ƒëƒÉng nh·∫≠p)
      q = { 'passenger.phone': phone };
    }
    // N·∫øu kh√¥ng c√≥ g√¨, q = {} s·∫Ω tr·∫£ v·ªÅ t·∫•t c·∫£ (ch·ªâ n√™n d√πng cho admin)
    
    const docs = await Booking.find(q)
      .populate('trip')
      .populate('user', 'name email phone')
      .sort({ createdAt: -1 });
    
    res.json(docs);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};

exports.detail = async (req, res) => {
  try {
    const doc = await Booking.findById(req.params.id);
    if (!doc) return res.status(404).json({ error: 'Not found' });
    res.json(doc);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
};

--- END OF FILE: backend\controllers\bookingController.js ---


--- START OF FILE: backend\controllers\feedbackController.js ---
const Feedback = require("../models/Feedback");

// üü¢ L·∫•y t·∫•t c·∫£ feedback
exports.getAllFeedbacks = async (req, res) => {
  try {
    const feedbacks = await Feedback.find();
    res.json(feedbacks);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// üü¢ Th√™m feedback m·ªõi
exports.createFeedback = async (req, res) => {
  try {
    const newFeedback = new Feedback(req.body);
    const saved = await newFeedback.save();
    res.status(201).json(saved);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
};

--- END OF FILE: backend\controllers\feedbackController.js ---


--- START OF FILE: backend\controllers\paymentController.js ---
const Payment = require('../models/Payment');
const Booking = require('../models/Booking');

// GET /api/payments
exports.getAllPayments = async (req, res) => {
  try {
    // ‚úÖ populate 'booking' (kh√¥ng ph·∫£i 'ticketId')
    const payments = await Payment.find().populate('booking');
    res.json(payments);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// POST /api/payments
// L∆∞u √Ω: trong lu·ªìng ‚Äúcheckout‚Äù b·∫°n ƒë√£ t·∫°o Payment trong bookingController.
// H√†m n√†y ch·ªâ d√πng khi b·∫°n mu·ªën t·ª± t·∫°o payment r·ªùi (√≠t d√πng).
exports.createPayment = async (req, res) => {
  try {
    const { booking, user, method = 'banking', amount, transaction_code, status = 'success' } = req.body;

    if (!booking) return res.status(400).json({ error: 'Thi·∫øu booking' });
    if (!amount)  return res.status(400).json({ error: 'Thi·∫øu amount' });

    const existedBooking = await Booking.findById(booking);
    if (!existedBooking) return res.status(404).json({ error: 'Booking kh√¥ng t·ªìn t·∫°i' });

    // T·∫°o paymentId duy nh·∫•t ƒë·ªÉ kh√¥ng b·ªã E11000 n·∫øu c√≥ unique index
    const paymentId = `PAY${Date.now()}${Math.floor(Math.random() * 1e6)}`;

    const doc = await Payment.create({
      booking,
      user: user || existedBooking.user || null,
      method,
      amount,
      transaction_code: transaction_code || `TX${Date.now()}`,
      status,
      paymentId,               // ‚úÖ lu√¥n set ƒë·ªÉ tr√°nh null
      paid_at: new Date(),
    });

    // (tu·ª≥ ch·ªçn) n·∫øu Booking schema c√≥ field payment/payment_id, b·∫°n c√≥ th·ªÉ link v√†o:
    // existedBooking.payment = doc._id;
    // existedBooking.payment_id = doc._id;
    // await existedBooking.save();

    res.status(201).json(doc);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
};

--- END OF FILE: backend\controllers\paymentController.js ---


--- START OF FILE: backend\controllers\routeController.js ---
// controllers/routeController.js
const Route = require('../models/Route');
const RouteStop = require('../models/RouteStop');
const Trip = require('../models/Trip');
const TripSeatStatus = require('../models/TripSeatStatus');
const Review = require('../models/Review');

// GET /api/routes/detailed
exports.getAllRoutesDetailed = async (req, res) => {
  try {
    const { date } = req.query;

    // Get all routes
    const routes = await Route.find().lean();
    
    // Get all trips for all routes
    const routeIds = routes.map(r => r._id);
    
    const tripFilter = { route: { $in: routeIds } };
    if (date) {
      const searchDate = new Date(date);
      const nextDay = new Date(date);
      nextDay.setDate(searchDate.getDate() + 1);

      tripFilter.start_time = {
        $gte: searchDate,
        $lt: nextDay,
      };
    }

    const trips = await Trip.find(tripFilter)
      .populate('bus')
      .lean();

    // Group trips by route
    const tripsByRoute = {};
    trips.forEach(trip => {
      if (!tripsByRoute[trip.route]) {
        tripsByRoute[trip.route] = [];
      }
      tripsByRoute[trip.route].push(trip);
    });

    // Get available seats for all trips
    const tripIds = trips.map(t => t._id);
    const tripSeats = tripIds.length > 0 ? await TripSeatStatus.aggregate([
      { $match: { trip: { $in: tripIds } } },
      { $group: { 
        _id: '$trip',
        availableSeats: { 
          $sum: { $cond: [{ $eq: ['$status', 'available'] }, 1, 0] }
        }
      }}
    ]) : [];

    // Create seats lookup
    const seatsByTrip = {};
    tripSeats.forEach(ts => {
      seatsByTrip[ts._id] = ts.availableSeats;
    });

    // Get average ratings for all routes
    const ratings = tripIds.length > 0 ? await Review.aggregate([
      { $match: { trip: { $in: tripIds } } },
      { $lookup: {
        from: 'trips',
        localField: 'trip',
        foreignField: '_id',
        as: 'trip'
      }},
      { $unwind: '$trip' },
      { $group: {
        _id: '$trip.route',
        avgRating: { $avg: '$rating' }
      }}
    ]) : [];

    // Create ratings lookup
    const ratingsByRoute = {};
    ratings.forEach(r => {
      ratingsByRoute[r._id] = r.avgRating;
    });

    // Combine all data
    const detailedRoutes = routes.map(route => {
      const routeTrips = tripsByRoute[route._id] || [];
      // Sort trips by start time and get the soonest
      routeTrips.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
      const nextTrip = routeTrips[0];

      return {
        _id: route._id,
        from_city: route.from_city,
        to_city: route.to_city,
        estimated_duration_min: route.estimated_duration_min,
        base_price: nextTrip?.base_price,
        start_time: nextTrip?.start_time,
        end_time: nextTrip?.end_time,
        bus_type: nextTrip?.bus?.bus_type,
        availableSeats: nextTrip ? (seatsByTrip[nextTrip._id] || 0) : 0,
        avgRating: ratingsByRoute[route._id] || 0,
        company: route.company,
        features: route.features || []
      };
    }).filter(route => route.start_time); // Only return routes that have trips on the given date

    res.json(detailedRoutes);
  } catch (err) {
    console.error('Error in getAllRoutesDetailed:', err);
    res.status(500).json({ error: err.message });
  }
};

// POST /api/routes
exports.createRoute = async (req, res) => {
  try {
    const route = await Route.create(req.body);
    res.status(201).json(route);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
};

// GET /api/routes
exports.getAllRoutes = async (req, res) => {
  try {
    const routes = await Route.find();
    res.json(routes);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// POST /api/routes/:routeId/stops
exports.createStop = async (req, res) => {
  try {
    const stop = await RouteStop.create({ ...req.body, route: req.params.routeId });
    res.status(201).json(stop);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
};

// GET /api/routes/:routeId/stops
exports.getStops = async (req, res) => {
  try {
    const stops = await RouteStop.find({ route: req.params.routeId }).sort({ order: 1 });
    res.json(stops);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// GET /api/routes/:routeId
// returns route document, stops, and a trips summary (with bus populated and availableSeats)
exports.getRouteDetail = async (req, res) => {
  try {
    const routeId = req.params.routeId;
    const route = await Route.findById(routeId).lean();
    if (!route) return res.status(404).json({ error: 'Route not found' });

    const stops = await RouteStop.find({ route: routeId }).sort({ order: 1 }).lean();

    // find trips for this route (returning scheduled/upcoming and departed)
    const trips = await Trip.find({ route: routeId }).populate('bus').lean();

    // for each trip compute available seats (count in TripSeatStatus)
    const tripsWithSeats = await Promise.all(
      trips.map(async (t) => {
        const availableSeats = await TripSeatStatus.countDocuments({ trip: t._id, status: 'available' });
        return {
          _id: t._id,
          start_time: t.start_time,
          end_time: t.end_time,
          base_price: t.base_price,
          status: t.status,
          direction: t.direction,
          bus: t.bus,
          availableSeats
        };
      })
    );

    // compute average rating from reviews of trips on this route
    let avgRating = null;
    const tripIds = trips.map(t => t._id);
    if (tripIds.length > 0) {
      const agg = await Review.aggregate([
        { $match: { trip: { $in: tripIds } } },
        { $group: { _id: null, avgRating: { $avg: '$rating' } } }
      ]);
      if (agg && agg.length) avgRating = agg[0].avgRating;
    }

    res.json({ route, stops, trips: tripsWithSeats, avgRating });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

--- END OF FILE: backend\controllers\routeController.js ---


--- START OF FILE: backend\controllers\ticketController.js ---
const Ticket = require("../models/Ticket");

// üü¢ L·∫•y danh s√°ch v√©
exports.getAllTickets = async (req, res) => {
  try {
    const tickets = await Ticket.find().populate("tripId");
    res.json(tickets);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// üü¢ ƒê·∫∑t v√© (ki·ªÉm tra tr√πng gh·∫ø)
exports.createTicket = async (req, res) => {
  try {
    const { tripId, seatNumber, customerName, customerPhone } = req.body;

    // Ki·ªÉm tra tr√πng gh·∫ø
    const existing = await Ticket.findOne({ tripId, seatNumber });
    if (existing) {
      return res.status(400).json({ message: "Gh·∫ø n√†y ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t r·ªìi!" });
    }

    const newTicket = new Ticket({ tripId, seatNumber, customerName, customerPhone });
    const savedTicket = await newTicket.save();
    res.status(201).json(savedTicket);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
};

--- END OF FILE: backend\controllers\ticketController.js ---


--- START OF FILE: backend\controllers\tripController.js ---
const Trip = require("../models/Trip");
const TripSeatStatus = require("../models/TripSeatStatus");

// üü¢ L·∫•y danh s√°ch t·∫•t c·∫£ chuy·∫øn xe
exports.getAllTrips = async (req, res) => {
  try {
    const trips = await Trip.find();
    res.json(trips);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// üü¢ Th√™m chuy·∫øn xe m·ªõi
exports.createTrip = async (req, res) => {
  try {
    const newTrip = new Trip(req.body);
    const savedTrip = await newTrip.save();
    res.status(201).json(savedTrip);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
};

// üü¢ C·∫≠p nh·∫≠t chuy·∫øn xe
exports.updateTrip = async (req, res) => {
  try {
    const updatedTrip = await Trip.findByIdAndUpdate(req.params.id, req.body, { new: true });
    res.json(updatedTrip);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
};

// üü¢ X√≥a chuy·∫øn xe
exports.deleteTrip = async (req, res) => {
  try {
    await Trip.findByIdAndDelete(req.params.id);
    res.json({ message: "Trip deleted successfully" });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
};

// L·∫•y danh s√°ch chuy·∫øn c·ªßa 1 route
exports.getTripsByRoute = async (req, res) => {
  try {
    const { routeId } = req.params;
    const { date } = req.query;

    const filter = { route: routeId };

    if (date) {
      const searchDate = new Date(date);
      const nextDay = new Date(date);
      nextDay.setDate(searchDate.getDate() + 1);

      filter.start_time = {
        $gte: searchDate,
        $lt: nextDay,
      };
    }

    const trips = await Trip.find(filter).sort({ start_time: 1 });
    res.json(trips);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

// L·∫•y danh s√°ch gh·∫ø c·ªßa 1 chuy·∫øn
exports.getSeatsByTrip = async (req, res) => {
  try {
    const seats = await TripSeatStatus.find({ trip: req.params.tripId }).sort({ seat_number: 1 });
    res.json(seats);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

--- END OF FILE: backend\controllers\tripController.js ---


--- START OF FILE: backend\data\assistants.json ---
[
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d0e"
    },
    "name": "Nguy·ªÖn Th·ªã Lan",
    "email": "lan.phuxe@gmail.com",
    "phone": "0956789012",
    "employee_id": "PX001",
    "license_number": "PX-LN-2024-001",
    "experience_years": 5,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  },
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d0f"
    },
    "name": "Tr·∫ßn Th·ªã Mai",
    "email": "mai.phuxe@gmail.com",
    "phone": "0967890123",
    "employee_id": "PX002",
    "license_number": "PX-TM-2024-002",
    "experience_years": 3,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  },
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d10"
    },
    "name": "L√™ Th·ªã Hoa",
    "email": "hoa.phuxe@gmail.com",
    "phone": "0978901234",
    "employee_id": "PX003",
    "license_number": "PX-LH-2024-003",
    "experience_years": 7,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  },
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d11"
    },
    "name": "Ph·∫°m Th·ªã Nga",
    "email": "nga.phuxe@gmail.com",
    "phone": "0989012345",
    "employee_id": "PX004",
    "license_number": "PX-PN-2024-004",
    "experience_years": 4,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  },
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d12"
    },
    "name": "Ho√†ng Th·ªã Linh",
    "email": "linh.phuxe@gmail.com",
    "phone": "0990123456",
    "employee_id": "PX005",
    "license_number": "PX-HL-2024-005",
    "experience_years": 6,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  },
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d13"
    },
    "name": "V≈© Th·ªã H∆∞∆°ng",
    "email": "huong.phuxe@gmail.com",
    "phone": "0901234567",
    "employee_id": "PX006",
    "license_number": "PX-VH-2024-006",
    "experience_years": 2,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  },
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d14"
    },
    "name": "ƒê·ªó Th·ªã Thu",
    "email": "thu.phuxe@gmail.com",
    "phone": "0912345678",
    "employee_id": "PX007",
    "license_number": "PX-DT-2024-007",
    "experience_years": 8,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  },
  {
    "_id": {
      "$oid": "670a1b2c3d4e5f6a7b8c9d15"
    },
    "name": "B√πi Th·ªã Anh",
    "email": "anh.phuxe@gmail.com",
    "phone": "0923456789",
    "employee_id": "PX008",
    "license_number": "PX-BA-2024-008",
    "experience_years": 3,
    "status": "active",
    "assigned_trips": [],
    "createdAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    },
    "updatedAt": {
      "$date": "2024-01-15T08:00:00.000Z"
    }
  }
]


--- END OF FILE: backend\data\assistants.json ---


--- START OF FILE: backend\data\assistants_simple.json ---
[
  {
    "name": "Nguy·ªÖn Th·ªã Lan",
    "email": "lan.phuxe@gmail.com",
    "phone": "0956789012",
    "employee_id": "PX001",
    "license_number": "PX-LN-2024-001",
    "experience_years": 5,
    "status": "active",
    "assigned_trips": []
  },
  {
    "name": "Tr·∫ßn Th·ªã Mai",
    "email": "mai.phuxe@gmail.com",
    "phone": "0967890123",
    "employee_id": "PX002",
    "license_number": "PX-TM-2024-002",
    "experience_years": 3,
    "status": "active",
    "assigned_trips": []
  },
  {
    "name": "L√™ Th·ªã Hoa",
    "email": "hoa.phuxe@gmail.com",
    "phone": "0978901234",
    "employee_id": "PX003",
    "license_number": "PX-LH-2024-003",
    "experience_years": 7,
    "status": "active",
    "assigned_trips": []
  },
  {
    "name": "Ph·∫°m Th·ªã Nga",
    "email": "nga.phuxe@gmail.com",
    "phone": "0989012345",
    "employee_id": "PX004",
    "license_number": "PX-PN-2024-004",
    "experience_years": 4,
    "status": "active",
    "assigned_trips": []
  },
  {
    "name": "Ho√†ng Th·ªã Linh",
    "email": "linh.phuxe@gmail.com",
    "phone": "0990123456",
    "employee_id": "PX005",
    "license_number": "PX-HL-2024-005",
    "experience_years": 6,
    "status": "active",
    "assigned_trips": []
  },
  {
    "name": "V≈© Th·ªã H∆∞∆°ng",
    "email": "huong.phuxe@gmail.com",
    "phone": "0901234567",
    "employee_id": "PX006",
    "license_number": "PX-VH-2024-006",
    "experience_years": 2,
    "status": "active",
    "assigned_trips": []
  },
  {
    "name": "ƒê·ªó Th·ªã Thu",
    "email": "thu.phuxe@gmail.com",
    "phone": "0912345678",
    "employee_id": "PX007",
    "license_number": "PX-DT-2024-007",
    "experience_years": 8,
    "status": "active",
    "assigned_trips": []
  },
  {
    "name": "B√πi Th·ªã Anh",
    "email": "anh.phuxe@gmail.com",
    "phone": "0923456789",
    "employee_id": "PX008",
    "license_number": "PX-BA-2024-008",
    "experience_years": 3,
    "status": "active",
    "assigned_trips": []
  }
]


--- END OF FILE: backend\data\assistants_simple.json ---


--- START OF FILE: backend\db.js ---
const mongoose = require('mongoose');

const connectDB = async () => {
  try {
    const uri = process.env.MONGO_URI || 'mongodb://127.0.0.1:27017/bus_booking';
    await mongoose.connect(uri, { useNewUrlParser: true, useUnifiedTopology: true });
    console.log('‚úÖ MongoDB connected');
  } catch (err) {
    console.error('‚ùå MongoDB connection error', err);
    process.exit(1);
  }
};

module.exports = connectDB;

--- END OF FILE: backend\db.js ---


--- START OF FILE: backend\middleware\authMiddleware.js ---
const jwt = require("jsonwebtoken");
const User = require('../models/User');

// Middleware ki·ªÉm tra token
const protect = async (req, res, next) => {
  try {
    let token;

    // Check header
    const authHeader = req.header("Authorization");
    if (authHeader && authHeader.startsWith("Bearer")) {
      token = authHeader.replace("Bearer ", "");
    } 
    // Check cookie
    else if (req.cookies.token) {
      token = req.cookies.token;
    }

    if (!token) {
      return res.status(401).json({ message: "Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c" });
    }

    // X√°c th·ª±c token
    const decoded = jwt.verify(token, process.env.JWT_SECRET || "secretkey");
    
    // Get user from database
    const user = await User.findById(decoded.id).select('-password');
    if (!user) {
      return res.status(401).json({ message: "Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng" });
    }

    // G√°n th√¥ng tin user v√†o request
    req.user = user;
    next();
  } catch (err) {
    res.status(401).json({ message: "Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n!" });
  }
};

// Middleware ki·ªÉm tra role
const authorize = (...roles) => {
  return (req, res, next) => {
    if (!roles.includes(req.user.role)) {
      return res.status(403).json({ 
        message: `Role ${req.user.role} kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y`
      });
    }
    next();
  };
};

module.exports = { protect, authorize };

--- END OF FILE: backend\middleware\authMiddleware.js ---


--- START OF FILE: backend\models\Assistant.js ---
const mongoose = require('mongoose');

// Merged assistant schema to satisfy both admin views (older fields)
// and assistant API/controllers (userId, busId, currentTrip, checkInList, etc.)
const assistantSchema = new mongoose.Schema({
  // Optional link to User (if assistant is also a user in the system)
  userId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User'
  },

  // Basic personal/contact info (used by admin views)
  name: {
    type: String
  },
  email: {
    type: String,
    match: [/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/, 'Vui l√≤ng nh·∫≠p email h·ª£p l·ªá']
  },
  phone: {
    type: String,
    match: [/^(0|84|\+84)[0-9]{9}$/, 'Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá']
  },

  // Admin-related fields
  employee_id: {
    type: String
  },
  license_number: {
    type: String
  },
  experience_years: {
    type: Number,
    min: 0,
    default: 0
  },

  // Assignment fields (kept from older admin UI)
  assigned_trips: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Trip'
  }],
  assigned_routes: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Route'
  }],

  // Operational fields used by assistant controller
  busId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Bus'
  },
  currentTrip: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Trip'
  },
  checkInList: [{
    passengerId: mongoose.Schema.Types.ObjectId,
    ticketId: mongoose.Schema.Types.ObjectId,
    checkedIn: Boolean,
    checkedInTime: Date
  }],

  // status -- include values used in different parts of app
  status: {
    type: String,
    enum: ['active', 'inactive', 'available', 'on_trip', 'off_duty'],
    default: 'available'
  },

  rating: {
    type: Number,
    default: 5,
    min: 1,
    max: 5
  },
  totalTrips: {
    type: Number,
    default: 0
  }
}, {
  timestamps: true,
  collection: 'assistants'
});

module.exports = mongoose.model('Assistant', assistantSchema);

--- END OF FILE: backend\models\Assistant.js ---


--- START OF FILE: backend\models\Booking.js ---
// models/Booking.js
const mongoose = require('mongoose');

const bookingSchema = new mongoose.Schema({
  user: { type: mongoose.Schema.Types.ObjectId, ref: 'User' }, // optional n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
  trip: { type: mongoose.Schema.Types.ObjectId, ref: 'Trip', required: true },

  // Snapshot ƒë·ªÉ FE hi·ªÉn th·ªã kh√¥ng c·∫ßn populate nhi·ªÅu
  route_snapshot: {
    from: String,
    to: String,
    estimated_duration_min: Number
  },
  // If user selected specific stops for pickup/dropoff
  pickup: { type: String },
  dropoff: { type: String },
  pickup_name: { type: String },
  dropoff_name: { type: String },
  bus_snapshot: {
    bus_type: String,
    license_plate: String,
    seat_count: Number
  },

  start_time: Date,
  end_time: Date,

  seat_numbers: [String],

  // gi·ªØ t∆∞∆°ng th√≠ch ng∆∞·ª£c l·∫´n t√™n m·ªõi
  total_amount: Number,
  total_price: Number,

  passenger: {
    name: String,
    phone: String,
    email: String,
    note: String
  },

  status: { type: String, enum: ['pending','paid','cancelled','completed'], default: 'pending' },

  payment: { type: mongoose.Schema.Types.ObjectId, ref: 'Payment', default: null },
  payment_id: { type: mongoose.Schema.Types.ObjectId, ref: 'Payment', default: null },
}, { timestamps: true });

module.exports = mongoose.model('Booking', bookingSchema);

--- END OF FILE: backend\models\Booking.js ---


--- START OF FILE: backend\models\Bus.js ---
const mongoose = require('mongoose');

const busSchema = new mongoose.Schema({
  license_plate: { type: String, required: true, unique: true },
  bus_type: String,
  seat_count: Number,
  active: { type: Boolean, default: true }
}, { timestamps: true });

module.exports = mongoose.model('Bus', busSchema);

--- END OF FILE: backend\models\Bus.js ---


--- START OF FILE: backend\models\Checkin.js ---
const mongoose = require('mongoose');

const checkinSchema = new mongoose.Schema({
  booking: { type: mongoose.Schema.Types.ObjectId, ref: 'Booking', required: true },
  assistant: { type: mongoose.Schema.Types.ObjectId, ref: 'Assistant' },
  checkin_time: Date,
  status: { type: String, enum: ['checked_in','no_show'] }
}, { timestamps: true });

module.exports = mongoose.model('Checkin', checkinSchema);

--- END OF FILE: backend\models\Checkin.js ---


--- START OF FILE: backend\models\Feedback.js ---
const mongoose = require("mongoose");

const FeedbackSchema = new mongoose.Schema(
  {
    userId: { type: String, required: true }, // ID c·ªßa ng∆∞·ªùi d√πng ph·∫£n h·ªìi
    tripId: { type: String, required: true }, // ID chuy·∫øn xe
    rating: { type: Number, min: 1, max: 5, required: true }, // ƒë√°nh gi√° t·ª´ 1-5
    comment: { type: String, required: true }, // n·ªôi dung ph·∫£n h·ªìi
    createdAt: { type: Date, default: Date.now }
  },
  { collection: "feedbacks" } // t√™n collection trong MongoDB
);

module.exports = mongoose.model("Feedback", FeedbackSchema);

--- END OF FILE: backend\models\Feedback.js ---


--- START OF FILE: backend\models\Payment.js ---
const mongoose = require('mongoose');

const paymentSchema = new mongoose.Schema(
  {
    booking: { type: mongoose.Schema.Types.ObjectId, ref: 'Booking', required: true },
    user: { type: mongoose.Schema.Types.ObjectId, ref: 'User' },

    // V√≠ d·ª•: 'momo' | 'banking' | 'cod'
    method: { type: String, enum: ['momo', 'banking', 'cod'], required: true },

    amount: { type: Number, required: true },              // s·ªë ti·ªÅn ƒë√£ thanh to√°n
    transaction_code: { type: String },                    // m√£ giao d·ªãch t·ª´ c·ªïng thanh to√°n

    // M√£ n·ªôi b·ªô c·ªßa b·∫°n, ƒë·ªÉ ƒë·ªëi so√°t. ƒê·∫∑t unique + sparse ƒë·ªÉ kh√¥ng d√≠nh l·ªói khi null.
    paymentId: { type: String, unique: true, sparse: true },

    status: { type: String, enum: ['success', 'failed', 'pending'], default: 'success' },
    paid_at: { type: Date, default: Date.now },
  },
  { collection: 'payments', timestamps: true }
);

module.exports = mongoose.model('Payment', paymentSchema);

--- END OF FILE: backend\models\Payment.js ---


--- START OF FILE: backend\models\Review.js ---
const mongoose = require('mongoose');

const reviewSchema = new mongoose.Schema({
  user: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },
  trip: { type: mongoose.Schema.Types.ObjectId, ref: 'Trip' },
  rating: { type: Number, min: 1, max: 5 },
  comment: String
}, { timestamps: true });

module.exports = mongoose.model('Review', reviewSchema);

--- END OF FILE: backend\models\Review.js ---


--- START OF FILE: backend\models\Route.js ---
const mongoose = require('mongoose');

const routeSchema = new mongoose.Schema({
  name: { type: String, required: true },
  from_city: String,
  to_city: String,
  total_distance_km: Number,
  estimated_duration_min: Number,
  active: { type: Boolean, default: true }
}, { timestamps: true });

module.exports = mongoose.model('Route', routeSchema);

--- END OF FILE: backend\models\Route.js ---


--- START OF FILE: backend\models\RouteStop.js ---
const mongoose = require('mongoose');

const routeStopSchema = new mongoose.Schema({
  route: { type: mongoose.Schema.Types.ObjectId, ref: 'Route', required: true },
  stop_name: String,
  order: Number,
  type: { type: String, enum: ['pickup','dropoff','both'], default: 'both' }
});

module.exports = mongoose.model('RouteStop', routeStopSchema, 'route_stops');

--- END OF FILE: backend\models\RouteStop.js ---


--- START OF FILE: backend\models\Ticket.js ---
const mongoose = require("mongoose");

const ticketSchema = new mongoose.Schema({
  tripId: { type: mongoose.Schema.Types.ObjectId, ref: "Trip", required: true },
  userId: { type: String }, // ho·∫∑c ObjectId n·∫øu b·∫°n c√≥ model User
  seatNumber: { type: String, required: true },
  status: { type: String, default: "booked" }
});

module.exports = mongoose.model("Ticket", ticketSchema);

--- END OF FILE: backend\models\Ticket.js ---


--- START OF FILE: backend\models\Trip.js ---
const mongoose = require('mongoose');

const tripSchema = new mongoose.Schema({
  route: { type: mongoose.Schema.Types.ObjectId, ref: 'Route', required: true },
  bus: { type: mongoose.Schema.Types.ObjectId, ref: 'Bus', required: true },
  start_time: { type: Date, required: true },
  end_time: { type: Date },
  base_price: Number,
  direction: { type: String, enum: ['go','return'], default: 'go' },
  status: { type: String, enum: ['scheduled','departed','completed','cancelled'], default: 'scheduled' }
}, { timestamps: true });

module.exports = mongoose.model('Trip', tripSchema);

--- END OF FILE: backend\models\Trip.js ---


--- START OF FILE: backend\models\TripSeatStatus.js ---
const mongoose = require('mongoose');

const tripSeatStatusSchema = new mongoose.Schema({
  trip: { type: mongoose.Schema.Types.ObjectId, ref: 'Trip', required: true },
  seat_number: String,
  status: { type: String, enum: ['available','reserved','booked','checked_in'], default: 'available' },
  booking_id: { type: mongoose.Schema.Types.ObjectId, ref: 'Booking', default: null }
}, { timestamps: true, collection: 'trip_seat_status' });

module.exports = mongoose.model('TripSeatStatus', tripSeatStatusSchema);

--- END OF FILE: backend\models\TripSeatStatus.js ---


--- START OF FILE: backend\models\User.js ---
const mongoose = require('mongoose');
const bcrypt = require('bcryptjs');

const userSchema = new mongoose.Schema({
  name: {
    type: String,
    required: [true, 'Vui l√≤ng nh·∫≠p h·ªç t√™n']
  },
  email: {
    type: String,
    required: [true, 'Vui l√≤ng nh·∫≠p email'],
    unique: true,
    match: [
      /^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/,
      'Vui l√≤ng nh·∫≠p email h·ª£p l·ªá'
    ]
  },
  phone: {
    type: String,
    required: [true, 'Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i'],
    match: [
      /^(0|84|\+84)[0-9]{9}$/,
      'Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá'
    ]
  },
  password: {
    type: String,
    required: [true, 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u'],
    minlength: [6, 'M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±'],
    select: false
  },
  role: {
    type: String,
    enum: ['user', 'admin', 'driver', 'assistant'],
    default: 'user'
  },
  // C√°c field ri√™ng cho assistant (optional)
  employee_id: {
    type: String,
    sparse: true
  },
  license_number: {
    type: String,
    sparse: true
  },
  experience_years: {
    type: Number,
    min: 0
  },
  assigned_trips: [{
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Trip'
  }]
}, { timestamps: true });

// Encrypt password using bcrypt
userSchema.pre('save', async function(next) {
  if (!this.isModified('password')) {
    next();
  }

  const salt = await bcrypt.genSalt(10);
  this.password = await bcrypt.hash(this.password, salt);
});

// Match user entered password to hashed password in database
userSchema.methods.matchPassword = async function(enteredPassword) {
  return await bcrypt.compare(enteredPassword, this.password);
};

module.exports = mongoose.model('User', userSchema);
--- END OF FILE: backend\models\User.js ---


--- START OF FILE: backend\package.json ---
{
  "name": "bus-booking-backend",
  "version": "1.0.0",
  "description": "Backend base for Bus Booking (Express + MongoDB).",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "seed": "node seed.js"
  },
  "dependencies": {
    "bcryptjs": "^3.0.3",
    "cookie-parser": "^1.4.7",
    "cors": "^2.8.5",
    "dotenv": "^16.0.0",
    "ejs": "^3.1.10",
    "express": "^4.18.2",
    "jsonwebtoken": "^9.0.2",
    "mongoose": "^7.0.0",
    "nodemailer": "^6.9.15"
  },
  "devDependencies": {
    "nodemon": "^2.0.22"
  },
  "engines": {
    "node": ">=16"
  }
}

--- END OF FILE: backend\package.json ---


--- START OF FILE: backend\routes\adminRoutes.js ---
const express = require('express');
const router = express.Router();
const adminController = require('../controllers/adminController');

// Trang admin dashboard
router.get('/', adminController.dashboard);
router.get('/users', adminController.users);
router.get('/buses', adminController.buses);
// Buses create/edit
router.get('/buses/new', adminController.newBus);
router.post('/buses', adminController.createBus);
router.get('/buses/:id/edit', adminController.editBus);
router.post('/buses/:id', adminController.updateBus);
router.get('/routes', adminController.routes);
// Routes create/edit
router.get('/routes/new', adminController.newRoute);
router.post('/routes', adminController.createRouteAdmin || adminController.createRoute);
router.get('/routes/:id/edit', adminController.editRoute);
router.post('/routes/:id', adminController.updateRoute);
// Trips create/edit (admin)
router.get('/trips/new', adminController.newTrip);
router.post('/trips', adminController.createTrip);
router.get('/trips/:id/edit', adminController.editTrip);
router.post('/trips/:id', adminController.updateTrip);
router.get('/trips', adminController.trips);
router.get('/bookings', adminController.bookings);
router.get('/statistics', adminController.statistics);
// Assistants create/edit
router.get('/assistants/new', adminController.newAssistant);
router.get('/assistants/:id/edit', adminController.editAssistant);
router.get('/assistants/:id', adminController.assistantDetail);
router.get('/assistants', adminController.assistants);
router.post('/assistants', adminController.createAssistant);
router.post('/assistants/:id', adminController.updateAssistant);

// API ƒë·ªÉ x√≥a booking
router.delete('/bookings/:id', adminController.deleteBooking);

// API ƒë·ªÉ x√≥a trip
router.delete('/trips/:id', adminController.deleteTrip);

// API ƒë·ªÉ x√≥a user
router.delete('/users/:id', adminController.deleteUser);

// API ƒë·ªÉ x√≥a bus
router.delete('/buses/:id', adminController.deleteBus);

// API ƒë·ªÉ x√≥a route
router.delete('/routes/:id', adminController.deleteRoute);

// API ƒë·ªÉ x√≥a assistant
router.delete('/assistants/:id', adminController.deleteAssistant);

// API ƒë·ªÉ check-in h√†nh kh√°ch
router.post('/assistants/:id/checkin', adminController.checkinPassenger);

// API ƒë·ªÉ c·∫≠p nh·∫≠t status booking
router.put('/bookings/:id/status', adminController.updateBookingStatus);

module.exports = router;


--- END OF FILE: backend\routes\adminRoutes.js ---


--- START OF FILE: backend\routes\assistantRoutes.js ---
// ...existing code...
const express = require('express');
const router = express.Router();
const assistantController = require('../controllers/assistantController');
const authMiddleware = require('../middleware/authMiddleware');

// ƒë·∫£m b·∫£o authMiddleware l√† middleware function tr∆∞·ªõc khi d√πng
if (typeof authMiddleware === 'function') {
  router.use(authMiddleware);
} else if (authMiddleware && typeof authMiddleware.authenticate === 'function') {
  router.use(authMiddleware.authenticate);
} else if (authMiddleware && typeof authMiddleware.verifyToken === 'function') {
  router.use(authMiddleware.verifyToken);
} // n·∫øu kh√¥ng t√¨m th·∫•y function th√¨ kh√¥ng ƒëƒÉng k√Ω middleware (ho·∫∑c s·ª≠a middleware file)

// routes (t·∫•t c·∫£ y√™u c·∫ßu x√°c th·ª±c n·∫øu middleware ƒë∆∞·ª£c ƒëƒÉng k√Ω)
router.get('/info', assistantController.getAssistantInfo);
router.get('/passengers', assistantController.getPassengerList);
router.post('/checkin', assistantController.checkInPassenger);
router.post('/report-seat', assistantController.reportSeatIssue);
router.post('/end-trip', assistantController.endTrip);
router.put('/rating', assistantController.updateRating);

module.exports = router;
--- END OF FILE: backend\routes\assistantRoutes.js ---


--- START OF FILE: backend\routes\authRoutes.js ---
const express = require("express");
const router = express.Router();
const authController = require("../controllers/authController");
const { protect } = require("../middleware/authMiddleware");

// Authentication routes
router.post("/register", authController.register);
router.post("/login", authController.login);
router.get("/logout", authController.logout);
router.get("/me", protect, authController.getMe);

module.exports = router;

--- END OF FILE: backend\routes\authRoutes.js ---


--- START OF FILE: backend\routes\bookingRoutes.js ---
// routes/bookingRoutes.js
const express = require('express');
const router = express.Router();

const bookingController = require('../controllers/bookingController');
const jwt = require("jsonwebtoken");
const User = require('../models/User');

// Middleware optional - n·∫øu c√≥ token th√¨ authenticate, kh√¥ng th√¨ b·ªè qua
const optionalAuth = async (req, res, next) => {
  try {
    let token;
    const authHeader = req.header("Authorization");
    if (authHeader && authHeader.startsWith("Bearer")) {
      token = authHeader.replace("Bearer ", "");
    } else if (req.cookies.token) {
      token = req.cookies.token;
    }

    if (token) {
      const decoded = jwt.verify(token, process.env.JWT_SECRET || "secretkey");
      const user = await User.findById(decoded.id).select('-password');
      if (user) {
        req.user = user;
      }
    }
  } catch (err) {
    // Ignore auth errors - continue without user
  }
  next();
};

// === Booking APIs ===

// FE b·∫•m "Thanh to√°n" g·ªçi endpoint n√†y -> l∆∞u Booking, Payment, c·∫≠p nh·∫≠t gh·∫ø
// Middleware optional - n·∫øu c√≥ user ƒëƒÉng nh·∫≠p th√¨ g·∫Øn v√†o booking
router.post('/checkout', optionalAuth, bookingController.checkout);

// L·∫•y danh s√°ch booking (tu·ª≥ √Ω d√πng cho "V√© c·ªßa t√¥i" ho·∫∑c admin)
// - N·∫øu c√≥ user ƒëƒÉng nh·∫≠p: t·ª± ƒë·ªông l·∫•y bookings c·ªßa user ƒë√≥
// - C√≥ th·ªÉ truy·ªÅn ?userId=... ho·∫∑c ?phone=... ƒë·ªÉ l·ªçc (cho admin)
router.get('/', optionalAuth, bookingController.listOfUser);

// L·∫•y chi ti·∫øt 1 booking theo id
router.get('/:id', bookingController.detail);

module.exports = router;

--- END OF FILE: backend\routes\bookingRoutes.js ---


--- START OF FILE: backend\routes\feedbackRoutes.js ---
const express = require("express");
const router = express.Router();
const feedbackController = require("../controllers/feedbackController");

router.get("/", feedbackController.getAllFeedbacks);
router.post("/", feedbackController.createFeedback);

module.exports = router;

--- END OF FILE: backend\routes\feedbackRoutes.js ---


--- START OF FILE: backend\routes\paymentRoutes.js ---
const express = require("express");
const router = express.Router();
const paymentController = require("../controllers/paymentController");
const authMiddleware = require("../middleware/authMiddleware");

router.get("/", paymentController.getAllPayments);
router.post("/", paymentController.createPayment);
router.get("/", authMiddleware, paymentController.getAllPayments);
router.post("/", authMiddleware, paymentController.createPayment);

module.exports = router;

--- END OF FILE: backend\routes\paymentRoutes.js ---


--- START OF FILE: backend\routes\routeRoutes.js ---
// routes/routeRoutes.js
const express = require('express');
const router = express.Router();
const routeController = require('../controllers/routeController');

// POST /api/routes  ‚Üí t·∫°o tuy·∫øn
router.post('/', routeController.createRoute);

// GET  /api/routes  ‚Üí l·∫•y t·∫•t c·∫£ tuy·∫øn (d√πng cho "popular routes")
router.get('/', routeController.getAllRoutes);

// GET  /api/routes/detailed  ‚Üí l·∫•y t·∫•t c·∫£ tuy·∫øn v·ªõi th√¥ng tin chi ti·∫øt
router.get('/detailed', routeController.getAllRoutesDetailed);

// POST /api/routes/:routeId/stops ‚Üí t·∫°o ƒëi·ªÉm d·ª´ng cho tuy·∫øn
router.post('/:routeId/stops', routeController.createStop);

// GET  /api/routes/:routeId/stops ‚Üí l·∫•y ƒëi·ªÉm d·ª´ng theo tuy·∫øn (sort by order ASC)
router.get('/:routeId/stops', routeController.getStops);

// GET /api/routes/:routeId ‚Üí chi ti·∫øt tuy·∫øn (route + stops + trips summary)
router.get('/:routeId', routeController.getRouteDetail);

module.exports = router;

--- END OF FILE: backend\routes\routeRoutes.js ---


--- START OF FILE: backend\routes\ticketRoutes.js ---
const express = require("express");
const router = express.Router();
const ticketController = require("../controllers/ticketController");
const authMiddleware = require("../middleware/authMiddleware");


router.get("/", authMiddleware, ticketController.getAllTickets);
router.post("/", authMiddleware, ticketController.createTicket);

router.get("/", ticketController.getAllTickets);
router.post("/", ticketController.createTicket);

module.exports = router;

--- END OF FILE: backend\routes\ticketRoutes.js ---


--- START OF FILE: backend\routes\tripRoutes.js ---
const express = require('express');
const router = express.Router();
const Trip = require('../models/Trip');
const Bus = require('../models/Bus');
const TripSeatStatus = require('../models/TripSeatStatus');
const RouteStop = require('../models/RouteStop');
const tripController = require('../controllers/tripController');


router.get('/route/:routeId', tripController.getTripsByRoute);
router.get('/:tripId/seats', tripController.getSeatsByTrip);

router.get('/', async (req, res) => {
  const trips = await Trip.find().populate('route').populate('bus');
  res.json(trips);
});

router.post('/', async (req, res) => {
  try {
    const trip = await Trip.create(req.body);
    const bus = await Bus.findById(trip.bus);

    const seatCount = bus?.seat_count || 0;
    const seatDocs = [];

    for (let i = 1; i <= seatCount; i++) {
      seatDocs.push({ trip: trip._id, seat_number: String(i), status: 'available' });
    }

    if (seatDocs.length) await TripSeatStatus.insertMany(seatDocs);

    res.status(201).json(trip);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
});

// GET /api/trips/:id  ‚Üí l·∫•y chi ti·∫øt chuy·∫øn + tr·∫°ng th√°i gh·∫ø
router.get('/:id', async (req, res) => {
  try {
    const trip = await Trip.findById(req.params.id)
      .populate('route')
      .populate('bus');

    if (!trip) return res.status(404).json({ error: 'Trip not found' });

    // L·∫•y danh s√°ch gh·∫ø hi·ªán c√≥
    let seats = await TripSeatStatus.find({ trip: trip._id }).sort({ seat_number: 1 });

    // N·∫øu ch∆∞a c√≥ gh·∫ø n√†o v√† trip c√≥ bus v·ªõi seat_count, t·ª± ƒë·ªông t·∫°o gh·∫ø
    if (seats.length === 0 && trip.bus && trip.bus.seat_count) {
      const seatCount = trip.bus.seat_count;
      const seatDocs = [];
      
      for (let i = 1; i <= seatCount; i++) {
        seatDocs.push({
          trip: trip._id,
          seat_number: String(i),
          status: 'available',
          booking_id: null
        });
      }

      if (seatDocs.length > 0) {
        await TripSeatStatus.insertMany(seatDocs);
        // L·∫•y l·∫°i danh s√°ch gh·∫ø sau khi t·∫°o
        seats = await TripSeatStatus.find({ trip: trip._id }).sort({ seat_number: 1 });
      }
    }

    // L·∫•y danh s√°ch ƒëi·ªÉm d·ª´ng c·ªßa tuy·∫øn
    const stops = trip.route && trip.route._id 
      ? await RouteStop.find({ route: trip.route._id }).sort({ order: 1 }).lean()
      : [];

    res.json({ trip, seats, stops });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});


module.exports = router;

--- END OF FILE: backend\routes\tripRoutes.js ---


--- START OF FILE: backend\routes\userRoutes.js ---
const express = require('express');
const router = express.Router();
const User = require('../models/User'); // ‚úÖ ƒê∆∞·ªùng d·∫´n ƒë√∫ng

// create user
router.post('/', async (req, res) => {
  try {
    const u = await User.create(req.body);
    res.status(201).json(u);
  } catch (err) {
    res.status(400).json({ error: err.message });
  }
});

router.get('/', async (req, res) => {
  const users = await User.find();
  res.json(users);
});

module.exports = router;

--- END OF FILE: backend\routes\userRoutes.js ---


--- START OF FILE: backend\scripts\migrate_bookings_total.js ---
const connectDB = require('../db');
const Booking = require('../models/Booking');

(async () => {
  try {
    await connectDB();
    console.log('Starting bookings migration...');

    const res = await Booking.updateMany(
      { $or: [{ total_price: { $exists: false } }, { total_price: null }] },
      [{ $set: { total_price: { $ifNull: ['$total_price', '$total_amount'] } } }]
    );

    console.log('Migration result:', res);
    console.log('Done.');
    process.exit(0);
  } catch (err) {
    console.error('Migration error:', err);
    process.exit(1);
  }
})();

--- END OF FILE: backend\scripts\migrate_bookings_total.js ---


--- START OF FILE: backend\seed.js ---
require('dotenv').config();
const connectDB = require('./db');
const User = require('./models/User');
const Bus = require('./models/Bus');
const Route = require('./models/Route');
const RouteStop = require('./models/RouteStop');
const Trip = require('./models/Trip');
const Booking = require('./models/Booking');

(async () => {
  try {
    await connectDB();
    
    console.log('üóëÔ∏è  X√≥a d·ªØ li·ªáu c≈©...');
    await User.deleteMany();
    await Bus.deleteMany();
    await Route.deleteMany();
    await RouteStop.deleteMany();
    await Trip.deleteMany();
    await Booking.deleteMany();

    console.log('üë• T·∫°o users...');
    // Admin
    const admin = await User.create({ 
      full_name: 'Admin H·ªá Th·ªëng', 
      phone: '0901111111', 
      email: 'admin@basevex.com', 
      password_hash: '$2b$10$example', 
      role: 'admin' 
    });

    // Customers
    const customer1 = await User.create({ 
      full_name: 'Nguy·ªÖn VƒÉn An', 
      phone: '0901234567', 
      email: 'an@gmail.com', 
      role: 'customer' 
    });
    const customer2 = await User.create({ 
      full_name: 'Tr·∫ßn Th·ªã B√¨nh', 
      phone: '0912345678', 
      email: 'binh@gmail.com', 
      role: 'customer' 
    });
    const customer3 = await User.create({ 
      full_name: 'L√™ VƒÉn C∆∞·ªùng', 
      phone: '0923456789', 
      email: 'cuong@gmail.com', 
      role: 'customer' 
    });

    // Drivers
    const driver1 = await User.create({ 
      full_name: 'Ph·∫°m VƒÉn ƒê·ª©c', 
      phone: '0934567890', 
      email: 'duc.tx@gmail.com', 
      role: 'driver' 
    });
    const driver2 = await User.create({ 
      full_name: 'Ho√†ng VƒÉn H√πng', 
      phone: '0945678901', 
      email: 'hung.tx@gmail.com', 
      role: 'driver' 
    });

    // Assistants
    const assistant1 = await User.create({ 
      full_name: 'Nguy·ªÖn Th·ªã Lan', 
      phone: '0956789012', 
      email: 'lan.phuxe@gmail.com', 
      role: 'assistant' 
    });
    const assistant2 = await User.create({ 
      full_name: 'Tr·∫ßn Th·ªã Mai', 
      phone: '0967890123', 
      email: 'mai.phuxe@gmail.com', 
      role: 'assistant' 
    });

    console.log('üöå T·∫°o xe bu√Ωt...');
    const buses = [];
    buses.push(await Bus.create({ 
      license_plate: '29B-12345', 
      bus_type: 'Gh·∫ø ng·ªìi 29 ch·ªó c√≥ ƒëi·ªÅu h√≤a', 
      seat_count: 29,
      active: true
    }));
    buses.push(await Bus.create({ 
      license_plate: '29B-67890', 
      bus_type: 'Gi∆∞·ªùng n·∫±m 40 ch·ªó c√≥ ƒëi·ªÅu h√≤a', 
      seat_count: 40,
      active: true
    }));
    buses.push(await Bus.create({ 
      license_plate: '29B-11111', 
      bus_type: 'Gh·∫ø ng·ªìi 45 ch·ªó cao c·∫•p', 
      seat_count: 45,
      active: true
    }));
    buses.push(await Bus.create({ 
      license_plate: '30B-22222', 
      bus_type: 'Gi∆∞·ªùng n·∫±m 32 ch·ªó VIP', 
      seat_count: 32,
      active: true
    }));

    console.log('üìç T·∫°o tuy·∫øn ƒë∆∞·ªùng...');
    
    // Route 1: Th√°i Nguy√™n - H√† N·ªôi
    const route1 = await Route.create({ 
      name: 'Th√°i Nguy√™n - H√† N·ªôi', 
      from_city: 'Th√°i Nguy√™n', 
      to_city: 'H√† N·ªôi', 
      total_distance_km: 80, 
      estimated_duration_min: 120,
      active: true
    });

    await RouteStop.create({ route: route1._id, stop_name: 'B·∫øn xe Th√°i Nguy√™n', order: 1, type: 'pickup' });
    await RouteStop.create({ route: route1._id, stop_name: 'C·∫ßu Nh·∫≠t T√¢n', order: 2, type: 'both' });
    await RouteStop.create({ route: route1._id, stop_name: 'B·∫øn xe M·ªπ ƒê√¨nh', order: 3, type: 'dropoff' });

    // Route 2: H√† N·ªôi - S√†i G√≤n
    const route2 = await Route.create({ 
      name: 'H√† N·ªôi - TP. H·ªì Ch√≠ Minh', 
      from_city: 'H√† N·ªôi', 
      to_city: 'TP. H·ªì Ch√≠ Minh', 
      total_distance_km: 1700, 
      estimated_duration_min: 1440,
      active: true
    });

    await RouteStop.create({ route: route2._id, stop_name: 'B·∫øn xe M·ªπ ƒê√¨nh', order: 1, type: 'pickup' });
    await RouteStop.create({ route: route2._id, stop_name: 'B·∫øn xe Vinh', order: 2, type: 'both' });
    await RouteStop.create({ route: route2._id, stop_name: 'B·∫øn xe N∆∞·ªõc Ng·∫ßm', order: 3, type: 'dropoff' });

    // Route 3: H√† N·ªôi - ƒê√† N·∫µng
    const route3 = await Route.create({ 
      name: 'H√† N·ªôi - ƒê√† N·∫µng', 
      from_city: 'H√† N·ªôi', 
      to_city: 'ƒê√† N·∫µng', 
      total_distance_km: 760, 
      estimated_duration_min: 840,
      active: true
    });

    await RouteStop.create({ route: route3._id, stop_name: 'B·∫øn xe M·ªπ ƒê√¨nh', order: 1, type: 'pickup' });
    await RouteStop.create({ route: route3._id, stop_name: 'B·∫øn xe Hu·∫ø', order: 2, type: 'both' });
    await RouteStop.create({ route: route3._id, stop_name: 'B·∫øn xe ƒê√† N·∫µng', order: 3, type: 'dropoff' });

    console.log('üïê T·∫°o chuy·∫øn xe...');
    const trips = [];
    
    // Trips for Route 1
    for (let i = 0; i < 3; i++) {
      const startTime = new Date();
      startTime.setDate(startTime.getDate() + i);
      startTime.setHours(8, 0, 0, 0);
      
      const endTime = new Date(startTime);
      endTime.setHours(10, 0, 0, 0);

      trips.push(await Trip.create({ 
        route: route1._id, 
        bus: buses[0]._id, 
        start_time: startTime, 
        end_time: endTime, 
        base_price: 100000, 
        direction: 'go',
        status: 'scheduled'
      }));

      const returnStartTime = new Date(startTime);
      returnStartTime.setHours(14, 0, 0, 0);
      const returnEndTime = new Date(returnStartTime);
      returnEndTime.setHours(16, 0, 0, 0);

      trips.push(await Trip.create({ 
        route: route1._id, 
        bus: buses[0]._id, 
        start_time: returnStartTime, 
        end_time: returnEndTime, 
        base_price: 100000, 
        direction: 'return',
        status: 'scheduled'
      }));
    }

    // Trips for Route 2
    const trip2Start = new Date();
    trip2Start.setDate(trip2Start.getDate() + 1);
    trip2Start.setHours(18, 0, 0, 0);
    const trip2End = new Date(trip2Start);
    trip2End.setDate(trip2End.getDate() + 2);
    trip2End.setHours(18, 0, 0, 0);

    trips.push(await Trip.create({ 
      route: route2._id, 
      bus: buses[1]._id, 
      start_time: trip2Start, 
      end_time: trip2End, 
      base_price: 500000, 
      direction: 'go',
      status: 'scheduled'
    }));

    // Trips for Route 3
    const trip3Start = new Date();
    trip3Start.setDate(trip3Start.getDate() + 1);
    trip3Start.setHours(20, 0, 0, 0);
    const trip3End = new Date(trip3Start);
    trip3End.setDate(trip3End.getDate() + 1);
    trip3End.setHours(8, 0, 0, 0);

    trips.push(await Trip.create({ 
      route: route3._id, 
      bus: buses[2]._id, 
      start_time: trip3Start, 
      end_time: trip3End, 
      base_price: 450000, 
      direction: 'go',
      status: 'scheduled'
    }));

    console.log('üé´ T·∫°o ƒë·∫∑t ch·ªó...');
    // Create bookings
    await Booking.create({
      user: customer1._id,
      trip: trips[0]._id,
      seat_numbers: ['A1', 'A2'],
      total_price: 200000,
      status: 'paid'
    });

    await Booking.create({
      user: customer2._id,
      trip: trips[0]._id,
      seat_numbers: ['B3'],
      total_price: 100000,
      status: 'paid'
    });

    await Booking.create({
      user: customer3._id,
      trip: trips[2]._id,
      seat_numbers: ['C5', 'C6'],
      total_price: 200000,
      status: 'completed'
    });

    await Booking.create({
      user: customer1._id,
      trip: trips[5]._id,
      seat_numbers: ['A1', 'A2', 'A3'],
      total_price: 1500000,
      status: 'pending'
    });

    await Booking.create({
      user: customer2._id,
      trip: trips[6]._id,
      seat_numbers: ['D1', 'D2'],
      total_price: 900000,
      status: 'paid'
    });

    console.log('‚úÖ Seed ho√†n t·∫•t!');
    console.log(`- ${await User.countDocuments()} users`);
    console.log(`- ${await Bus.countDocuments()} buses`);
    console.log(`- ${await Route.countDocuments()} routes`);
    console.log(`- ${await Trip.countDocuments()} trips`);
    console.log(`- ${await Booking.countDocuments()} bookings`);
    
    process.exit(0);
  } catch (err) {
    console.error('‚ùå L·ªói seed:', err);
    process.exit(1);
  }
})();

--- END OF FILE: backend\seed.js ---


--- START OF FILE: backend\server.js ---
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const cookieParser = require('cookie-parser');
const path = require('path');
const connectDB = require('./db');

// routes
const userRoutes = require('./routes/userRoutes');
const routeRoutes = require('./routes/routeRoutes');
const tripRoutes = require('./routes/tripRoutes');
const bookingRoutes = require('./routes/bookingRoutes');
const adminRoutes = require('./routes/adminRoutes');
const authRoutes = require('./routes/authRoutes');
const assistantRoutes = require('./routes/assistantRoutes');

const app = express();

// CORS configuration
app.use(cors({
  origin: ['http://localhost:5173', 'http://localhost:3000'],
  credentials: true
}));

app.use(express.json());
app.use(cookieParser());
// parse application/x-www-form-urlencoded for form submissions from admin EJS
app.use(express.urlencoded({ extended: true }));

// Set EJS as view engine
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));

// connect
connectDB();

// ensure certain models are compiled early
require('./models/RouteStop');        // collection: route_stops
require('./models/TripSeatStatus');   // collection: trip_seat_status

// API routes
app.use('/api/auth', authRoutes);
app.use('/api/users', userRoutes);
app.use('/api/routes', routeRoutes);
app.use('/api/trips', tripRoutes);
app.use('/api/bookings', bookingRoutes);
app.use('/api/assistant', assistantRoutes);

// Admin EJS routes
app.use('/admin', adminRoutes);

// static / health
app.get('/', (req, res) => res.send('BaseVeXe backend running'));

// error handler (basic)
app.use((err, req, res, next) => {
  console.error(err);
  res.status(500).json({ error: err.message || 'Server error' });
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server started on port ${PORT}`));
--- END OF FILE: backend\server.js ---


--- START OF FILE: backend\utils\mailer.js ---
const nodemailer = require('nodemailer');


async function createTransporter() {
  const host = process.env.SMTP_HOST;
  const port = Number(process.env.SMTP_PORT || 587);
  const user = (process.env.SMTP_USER || '').trim();
  const pass = (process.env.SMTP_PASS || '').replace(/\s+/g, ''); // Gmail app password: remove spaces

  if (!host || !user || !pass) {
    // Fallback: Ethereal test account (for development/demo)
    if (String(process.env.USE_ETHEREAL || 'false').toLowerCase() === 'true') {
      try {
        const testAccount = await nodemailer.createTestAccount();
        const etherealTransport = nodemailer.createTransport({
          host: 'smtp.ethereal.email',
          port: 587,
          secure: false,
          auth: { user: testAccount.user, pass: testAccount.pass }
        });
        console.log('[mailer] Using Ethereal test SMTP. Emails will NOT deliver to real inbox.');
        return etherealTransport;
      } catch (e) {
        console.warn('[mailer] Failed to init Ethereal transport:', e.message);
        return null;
      }
    }
    return null;
  }

  const transport = nodemailer.createTransport({
    host,
    port,
    secure: port === 465, // true for 465, false for other ports
    auth: { user, pass }
  });
  console.log('[mailer] Using real SMTP host:', host, 'port:', port);
  return transport;
}

let transporterPromise = null;
function getTransporter() {
  if (!transporterPromise) transporterPromise = createTransporter();
  return transporterPromise;
}

async function sendMail({ to, subject, html, text }) {
  const transporter = await getTransporter();
  if (!transporter) {
    console.log('[mailer] Transporter not configured. Skip sending to:', to);
    return { skipped: true };
  }
  const from = process.env.MAIL_FROM || process.env.SMTP_USER;
  const info = await transporter.sendMail({ from, to, subject, html, text });
  const preview = nodemailer.getTestMessageUrl(info);
  if (preview) {
    console.log('[mailer] Preview URL:', preview);
  }
  return info;
}

function renderBookingHtml(bookingSummary) {
  const {
    route,
    times,
    seats,
    passenger,
    totalAmount,
    paymentMethod,
    bookingId,
    paymentId,
  } = bookingSummary || {};

  return `
    <div style="font-family: Arial, sans-serif; line-height: 1.6;">
      <h2>Thanh to√°n th√†nh c√¥ng</h2>
      <p>C·∫£m ∆°n b·∫°n ƒë√£ ƒë·∫∑t v√©. D∆∞·ªõi ƒë√¢y l√† th√¥ng tin chi ti·∫øt:</p>
      <ul>
        <li><strong>M√£ ƒë·∫∑t ch·ªó:</strong> ${bookingId || '-'}</li>
        <li><strong>M√£ thanh to√°n:</strong> ${paymentId || '-'}</li>
        <li><strong>Tuy·∫øn:</strong> ${(route?.from || '-') + ' ‚Üí ' + (route?.to || '-')}</li>
        <li><strong>Th·ªùi gian:</strong> Kh·ªüi h√†nh ${times?.departureTime ? new Date(times.departureTime).toLocaleString('vi-VN') : '-'}${times?.arrivalTime ? `, ƒê·∫øn ${new Date(times.arrivalTime).toLocaleString('vi-VN')}` : ''}</li>
        <li><strong>Gh·∫ø:</strong> ${(seats || []).join(', ') || '-'}</li>
        <li><strong>H√†nh kh√°ch:</strong> ${(passenger?.name || '-')}, ${passenger?.phone || '-'}</li>
        <li><strong>T·ªïng ti·ªÅn:</strong> ${(Number(totalAmount || 0)).toLocaleString('vi-VN')}‚Ç´</li>
        <li><strong>Ph∆∞∆°ng th·ª©c:</strong> ${paymentMethod || '-'}</li>
      </ul>
      <p>Ch√∫c b·∫°n c√≥ chuy·∫øn ƒëi an to√†n v√† tho·∫£i m√°i!</p>
    </div>
  `;
}

async function sendBookingConfirmationEmail(to, bookingSummary) {
  if (!to) return;
  const subject = 'X√°c nh·∫≠n thanh to√°n & ƒë·∫∑t v√© th√†nh c√¥ng';
  const html = renderBookingHtml(bookingSummary);
  const text = `Thanh to√°n th√†nh c√¥ng. M√£ ƒë·∫∑t ch·ªó: ${bookingSummary?.bookingId || ''}.`;
  try {
    await sendMail({ to, subject, html, text });
  } catch (e) {
    console.error('[mailer] sendBookingConfirmationEmail error:', e);
  }
}

module.exports = {
  sendBookingConfirmationEmail,
};



--- END OF FILE: backend\utils\mailer.js ---


--- START OF FILE: backend\utils\send_test_email.js ---
const { sendBookingConfirmationEmail } = require('./mailer');

async function main() {
  const to = process.argv[2];
  if (!to) {
    console.error('Usage: node send_test_email.js recipient@example.com');
    process.exit(1);
  }

  const samplePayload = {
    bookingId: 'TEST123456',
    paymentId: 'PAY123456',
    route: { from: 'H√† N·ªôi', to: 'H·ªì Ch√≠ Minh', durationMin: 1800 },
    times: { departureTime: new Date(), arrivalTime: new Date(Date.now() + 1000 * 60 * 60 * 12) },
    bus: { busType: 'Sleeper', seatCount: 40 },
    seats: [1, 2],
    passenger: { name: 'Ng∆∞·ªùi d√πng th·ª≠', phone: '0900000000' },
    pricePerSeat: 200000,
    totalAmount: 400000,
    paymentMethod: 'banking'
  };

  try {
    const info = await sendBookingConfirmationEmail(to, samplePayload);
    console.log('Send test email: done', info || 'skipped');
  } catch (e) {
    console.error('Send test email error:', e);
    process.exit(2);
  }
}

main();

--- END OF FILE: backend\utils\send_test_email.js ---


--- START OF FILE: frontend\index.html ---
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VeXe7TV - ƒê·∫∑t v√© xe bu√Ωt tr·ª±c tuy·∫øn</title>
    <meta name="description" content="ƒê·∫∑t v√© xe bu√Ωt tr·ª±c tuy·∫øn nhanh ch√≥ng, ti·ªán l·ª£i v√† gi√° c·∫£ h·ª£p l√Ω. BaseVeXe - d·ªãch v·ª• ƒë·∫∑t v√© xe bu√Ωt h√†ng ƒë·∫ßu Vi·ªát Nam." />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

--- END OF FILE: frontend\index.html ---


--- START OF FILE: frontend\package.json ---
{
  "name": "basevexe-frontend",
  "version": "1.0.0",
  "description": "Frontend for BaseVeXe bus booking application",
  "main": "index.js",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.8.1",
    "lucide-react": "^0.263.1"
  },
  "devDependencies": {
    "@types/react": "^18.2.15",
    "@types/react-dom": "^18.2.7",
    "@typescript-eslint/eslint-plugin": "^6.0.0",
    "@typescript-eslint/parser": "^6.0.0",
    "@vitejs/plugin-react": "^4.0.3",
    "eslint": "^8.45.0",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.3",
    "typescript": "^5.0.2",
    "vite": "^4.4.5"
  }
}

--- END OF FILE: frontend\package.json ---


--- START OF FILE: frontend\src\App.css ---
/* Reset v√† base styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  line-height: 1.6;
  color: #333;
}

.App {
  min-height: 100vh;
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Responsive utilities */
@media (max-width: 768px) {
  .hidden-mobile {
    display: none !important;
  }
}

@media (min-width: 769px) {
  .hidden-desktop {
    display: none !important;
  }
}

--- END OF FILE: frontend\src\App.css ---


--- START OF FILE: frontend\src\App.tsx ---
import React, { createContext, useContext, useState, useEffect } from 'react';
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import HomePage from './components/HomePage';
import BookingDetail from './components/BookingDetail';
import PaymentPage from './components/PaymentPage';
import PaymentSuccess from './components/PaymentSuccess';
import RoutesPage from './components/RoutesPage';
import MyTicketsPage from './components/MyTicketsPage';
import TicketDetailPage from './components/TicketDetailPage';
import ContactPage from './components/ContactPage';
import AdminPage from './components/AdminPage';
import LoginPage from './components/LoginPage';
import RegisterPage from './components/RegisterPage';
import './App.css';

// 1. Th√™m isLoading v√†o Context Type
interface AuthContextType {
  user: any;
  isLoading: boolean; 
  login: (userData: any) => void;
  logout: () => void;
}

const AuthContext = createContext<AuthContextType>({
  user: null,
  isLoading: true, // M·∫∑c ƒë·ªãnh l√† ƒëang load
  login: () => {},
  logout: () => {},
});

export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [user, setUser] = useState<any>(null);
  const [isLoading, setIsLoading] = useState(true); // State ƒë·ªÉ theo d√µi qu√° tr√¨nh check login

  useEffect(() => {
    const validateAuth = async () => {
      setIsLoading(true); // B·∫Øt ƒë·∫ßu check
      const userData = localStorage.getItem('user');
      
      if (userData) {
        try {
          // L·∫•y URL Backend t·ª´ bi·∫øn m√¥i tr∆∞·ªùng ho·∫∑c fallback v·ªÅ localhost
          const API_BASE = ((import.meta as any)?.env?.VITE_BACKEND_URL as string) || 'http://localhost:5000';
          
          const response = await fetch(`${API_BASE}/api/auth/me`, {
            credentials: 'include' // Quan tr·ªçng ƒë·ªÉ g·ª≠i cookie token
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.data) {
              setUser(data.data);
              localStorage.setItem('user', JSON.stringify(data.data));
            } else {
              setUser(JSON.parse(userData));
            }
          } else {
            // Token h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá
            logout();
          }
        } catch (error) {
          logout();
        }
      } else {
        // Kh√¥ng c√≥ data trong storage
        setIsLoading(false);
      }
      setIsLoading(false); // K·∫øt th√∫c check
    };

    validateAuth();
  }, []);

  const login = (userData: any) => {
    setUser(userData);
    localStorage.setItem('user', JSON.stringify(userData));
  };

  const logout = () => {
    setUser(null);
    localStorage.removeItem('user');
    setIsLoading(false);
  };

  return (
    <AuthContext.Provider value={{ user, isLoading, login, logout }}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => useContext(AuthContext);

// Protected route component ƒë√£ ƒë∆∞·ª£c n√¢ng c·∫•p
const ProtectedRoute: React.FC<{ children: React.ReactNode; allowedRoles?: string[] }> = ({ 
  children, 
  allowedRoles = [] 
}) => {
  const { user, isLoading } = useAuth();

  // 2. N·∫øu ƒëang check login th√¨ hi·ªán m√†n h√¨nh ch·ªù, ƒê·ª™NG redirect v·ªôi
  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center">
          <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
          <p className="text-gray-500 text-sm">ƒêang t·∫£i...</p>
        </div>
      </div>
    );
  }

  // Check xong r·ªìi m√† kh√¥ng c√≥ user th√¨ m·ªõi ƒë√° v·ªÅ login
  if (!user) {
    return <Navigate to="/login" replace />;
  }

  if (allowedRoles.length > 0 && !allowedRoles.includes(user.role)) {
    return <Navigate to="/" replace />;
  }

  return <>{children}</>;
};

const App: React.FC = () => {
  return (
    <AuthProvider>
      <Router>
        <div className="App">
          <Routes>
            <Route path="/" element={<HomePage />} />
            <Route path="/routes" element={<RoutesPage />} />
            <Route path="/login" element={<LoginPage />} />
            <Route path="/register" element={<RegisterPage />} />
            <Route path="/contact" element={<ContactPage />} />
            
            {/* C√°c route c·∫ßn b·∫£o v·ªá */}
            <Route
              path="/my-tickets"
              element={
                <ProtectedRoute>
                  <MyTicketsPage />
                </ProtectedRoute>
              }
            />
            <Route
              path="/ticket-detail"
              element={
                <ProtectedRoute>
                  <TicketDetailPage />
                </ProtectedRoute>
              }
            />
            <Route
              path="/booking/:routeId"
              element={
                <ProtectedRoute>
                  <BookingDetail />
                </ProtectedRoute>
              }
            />
            <Route
              path="/payment"
              element={
                <ProtectedRoute>
                  <PaymentPage />
                </ProtectedRoute>
              }
            />
            <Route
              path="/payment-success"
              element={
                <ProtectedRoute>
                  <PaymentSuccess />
                </ProtectedRoute>
              }
            />
            <Route
              path="/admin"
              element={
                <ProtectedRoute allowedRoles={['admin']}>
                  <AdminPage />
                </ProtectedRoute>
              }
            />
          </Routes>
        </div>
      </Router>
    </AuthProvider>
  );
};

export default App;
--- END OF FILE: frontend\src\App.tsx ---


--- START OF FILE: frontend\src\components\AdminPage.tsx ---
import React, { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';

interface Trip {
  _id: string;
  route: any;
  bus: any;
  start_time: string;
  end_time: string;
  base_price: number;
  direction: string;
}

interface Booking {
  _id: string;
  trip: any;
  user: any;
  seats: string[];
  total_price: number;
  status: string;
  createdAt: string;
}

const AdminPage: React.FC = () => {
  const [trips, setTrips] = useState<Trip[]>([]);
  const [bookings, setBookings] = useState<Booking[]>([]);
  const [activeTab, setActiveTab] = useState<'trips' | 'bookings'>('trips');

  useEffect(() => {
    fetchTrips();
    fetchBookings();
  }, []);

  const fetchTrips = async () => {
    try {
      const response = await fetch('http://localhost:5000/api/trips');
      const data = await response.json();
      setTrips(data);
    } catch (error) {
      console.error('Error fetching trips:', error);
    }
  };

  const fetchBookings = async () => {
    try {
      const response = await fetch('http://localhost:5000/api/bookings');
      const data = await response.json();
      setBookings(data);
    } catch (error) {
      console.error('Error fetching bookings:', error);
    }
  };

  const handleDeleteBooking = async (bookingId: string) => {
    if (!window.confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë·∫∑t ch·ªó n√†y?')) {
      return;
    }

    try {
      const response = await fetch(`http://localhost:5000/api/admin/bookings/${bookingId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        throw new Error('Error deleting booking');
      }

      // Refresh the bookings list
      fetchBookings();
    } catch (error) {
      console.error('Error:', error);
      alert('C√≥ l·ªói khi x√≥a ƒë·∫∑t ch·ªó. Vui l√≤ng th·ª≠ l·∫°i.');
    }
  };

  return (
    <div style={{ minHeight: '100vh', backgroundColor: '#f5f5f5' }}>
      {/* Header */}
      <header style={{
        backgroundColor: '#1e3a8a',
        color: 'white',
        padding: '1.5rem',
        boxShadow: '0 2px 10px rgba(0,0,0,0.1)'
      }}>
        <div style={{ maxWidth: '1200px', margin: '0 auto', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <h1 style={{ margin: 0 }}>Admin Dashboard</h1>
          <Link to="/" style={{ color: 'white', textDecoration: 'none' }}>‚Üê V·ªÅ trang ch·ªß</Link>
        </div>
      </header>

      {/* Main Content */}
      <div style={{ maxWidth: '1200px', margin: '2rem auto', padding: '0 1rem' }}>
        {/* Tabs */}
        <div style={{ 
          display: 'flex', 
          gap: '1rem', 
          marginBottom: '2rem',
          backgroundColor: 'white',
          padding: '0.5rem',
          borderRadius: '8px',
          boxShadow: '0 2px 5px rgba(0,0,0,0.1)'
        }}>
          <button
            onClick={() => setActiveTab('trips')}
            style={{
              flex: 1,
              padding: '1rem',
              border: 'none',
              borderRadius: '6px',
              backgroundColor: activeTab === 'trips' ? '#1e3a8a' : 'transparent',
              color: activeTab === 'trips' ? 'white' : '#333',
              cursor: 'pointer',
              fontSize: '1rem',
              fontWeight: '600',
              transition: 'all 0.3s'
            }}
          >
            Qu·∫£n l√Ω Chuy·∫øn xe ({trips.length})
          </button>
          <button
            onClick={() => setActiveTab('bookings')}
            style={{
              flex: 1,
              padding: '1rem',
              border: 'none',
              borderRadius: '6px',
              backgroundColor: activeTab === 'bookings' ? '#1e3a8a' : 'transparent',
              color: activeTab === 'bookings' ? 'white' : '#333',
              cursor: 'pointer',
              fontSize: '1rem',
              fontWeight: '600',
              transition: 'all 0.3s'
            }}
          >
            Qu·∫£n l√Ω ƒê·∫∑t ch·ªó ({bookings.length})
          </button>
        </div>

        {/* Trips Tab */}
        {activeTab === 'trips' && (
          <div style={{
            backgroundColor: 'white',
            borderRadius: '8px',
            padding: '1.5rem',
            boxShadow: '0 2px 10px rgba(0,0,0,0.1)'
          }}>
            <h2 style={{ marginTop: 0, color: '#1e3a8a' }}>Danh s√°ch Chuy·∫øn xe</h2>
            <div style={{ overflowX: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                <thead>
                  <tr style={{ backgroundColor: '#f3f4f6' }}>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>ID</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Tuy·∫øn</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Th·ªùi gian</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Gi√° c∆° b·∫£n</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>H∆∞·ªõng</th>
                  </tr>
                </thead>
                <tbody>
              {trips.map((trip) => (
                    <tr key={trip._id} style={{ borderBottom: '1px solid #e5e7eb' }}>
                      <td style={{ padding: '1rem' }}>{trip._id.substring(0, 8)}...</td>
                      <td style={{ padding: '1rem' }}>{trip.route?.name || 'N/A'}</td>
                      <td style={{ padding: '1rem' }}>
                        {new Date(trip.start_time).toLocaleString('vi-VN')}
                      </td>
                      <td style={{ padding: '1rem' }}>
                        {trip.base_price?.toLocaleString('vi-VN')} ‚Ç´
                      </td>
                      <td style={{ padding: '1rem' }}>
                        <span style={{
                          padding: '0.25rem 0.75rem',
                          borderRadius: '4px',
                          backgroundColor: trip.direction === 'go' ? '#dbeafe' : '#fed7aa',
                          color: trip.direction === 'go' ? '#1e40af' : '#c2410c'
                        }}>
                          {trip.direction === 'go' ? 'ƒêi' : 'V·ªÅ'}
                        </span>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              {trips.length === 0 && (
                <p style={{ textAlign: 'center', padding: '2rem', color: '#6b7280' }}>
                  Ch∆∞a c√≥ chuy·∫øn xe n√†o
                </p>
              )}
            </div>
          </div>
        )}

        {/* Bookings Tab */}
        {activeTab === 'bookings' && (
          <div style={{
            backgroundColor: 'white',
            borderRadius: '8px',
            padding: '1.5rem',
            boxShadow: '0 2px 10px rgba(0,0,0,0.1)'
          }}>
            <h2 style={{ marginTop: 0, color: '#1e3a8a' }}>Danh s√°ch ƒê·∫∑t ch·ªó</h2>
            <div style={{ overflowX: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                <thead>
                  <tr style={{ backgroundColor: '#f3f4f6' }}>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>ID</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Kh√°ch h√†ng</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Gh·∫ø</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>T·ªïng ti·ªÅn</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Tr·∫°ng th√°i</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Ng√†y ƒë·∫∑t</th>
                    <th style={{ padding: '1rem', textAlign: 'left', borderBottom: '2px solid #e5e7eb' }}>Thao t√°c</th>
                  </tr>
                </thead>
                <tbody>
                  {bookings.map((booking) => (
                    <tr key={booking._id} style={{ borderBottom: '1px solid #e5e7eb' }}>
                      <td style={{ padding: '1rem' }}>{booking._id.substring(0, 8)}...</td>
                      <td style={{ padding: '1rem' }}>{booking.user?.name || 'N/A'}</td>
                      <td style={{ padding: '1rem' }}>{booking.seats?.join(', ') || 'N/A'}</td>
                      <td style={{ padding: '1rem' }}>
                        {booking.total_price?.toLocaleString('vi-VN')} ‚Ç´
                      </td>
                      <td style={{ padding: '1rem' }}>
                        <span style={{
                          padding: '0.25rem 0.75rem',
                          borderRadius: '4px',
                          backgroundColor: booking.status === 'confirmed' ? '#d1fae5' : '#fee2e2',
                          color: booking.status === 'confirmed' ? '#065f46' : '#991b1b'
                        }}>
                          {booking.status}
                        </span>
                      </td>
                      <td style={{ padding: '1rem' }}>
                        {new Date(booking.createdAt).toLocaleString('vi-VN')}
                      </td>
                      <td style={{ padding: '1rem' }}>
                        <button 
                          onClick={() => handleDeleteBooking(booking._id)}
                          style={{
                            padding: '0.5rem 1rem',
                            backgroundColor: '#ef4444',
                            color: 'white',
                            border: 'none',
                            borderRadius: '4px',
                            cursor: 'pointer',
                            transition: 'all 0.2s'
                          }}
                          onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#dc2626'}
                          onMouseOut={(e) => e.currentTarget.style.backgroundColor = '#ef4444'}
                        >
                          X√≥a
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              {bookings.length === 0 && (
                <p style={{ textAlign: 'center', padding: '2rem', color: '#6b7280' }}>
                  Ch∆∞a c√≥ ƒë·∫∑t ch·ªó n√†o
                </p>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default AdminPage;


--- END OF FILE: frontend\src\components\AdminPage.tsx ---


--- START OF FILE: frontend\src\components\BookingDetail.tsx ---
// src/components/BookingDetail.tsx
import React, { useEffect, useMemo, useState } from 'react';
import { useAuth } from '../App';
import { useParams, useNavigate } from 'react-router-dom';
import { ArrowLeft, Bus, MapPin, Clock, Users, Calendar } from 'lucide-react';

/** Types matching backend responses */
type TripDoc = {
  _id: string;
  route: {
    _id: string;
    name?: string;
    from_city?: string;
    to_city?: string;
    estimated_duration_min?: number;
  };
  bus: {
    _id: string;
    license_plate?: string;
    bus_type?: string;
    seat_count?: number;
  };
  start_time: string; // ISO
  end_time?: string | null;
  base_price?: number;
  direction?: 'go' | 'return';
  status?: 'scheduled' | 'departed' | 'completed' | 'cancelled';
};

type SeatDoc = {
  _id: string;
  trip: string;
  seat_number: string; // "1", "2", ...
  status: 'available' | 'reserved' | 'booked' | 'checked_in';
  booking_id?: string | null;
};

type RouteStopDoc = {
  _id: string;
  route: string;
  stop_name: string;
  order: number;
  type: 'pickup' | 'dropoff' | 'both';
};

type TripDetailResponse = {
  trip: TripDoc;
  seats: SeatDoc[];
  stops?: RouteStopDoc[];
};

const API_BASE = ((import.meta as any)?.env?.VITE_BACKEND_URL as string) || 'http://localhost:5000';

const BookingDetail: React.FC = () => {
  const { routeId } = useParams<{ routeId: string }>();
  const navigate = useNavigate();

  const [searchDate, setSearchDate] = useState(new Date().toISOString().split('T')[0]);
  const [allTrips, setAllTrips] = useState<TripDoc[]>([]);
  const [loadingTrips, setLoadingTrips] = useState(true);
  const [errTrips, setErrTrips] = useState<string | null>(null);

  const [selectedTrip, setSelectedTrip] = useState<TripDoc | null>(null);

  const [tripDetail, setTripDetail] = useState<TripDetailResponse | null>(null);
  const [loadingDetail, setLoadingDetail] = useState(false);
  const [errDetail, setErrDetail] = useState<string | null>(null);

  const [selectedSeats, setSelectedSeats] = useState<number[]>([]);
  const [passengerInfo, setPassengerInfo] = useState({ name: '', phone: '', email: '', note: '' });
  const [phoneError, setPhoneError] = useState<string | null>(null);
  const { user } = useAuth();

  useEffect(() => {
    // If the visitor is logged in and passenger email not filled yet, prefill it
    if (user && user.email && !passengerInfo.email) {
      setPassengerInfo(prev => ({ ...prev, email: user.email }));
    }
  }, [user]);

  const isValidPhone = (phone: string) => {
    if (!phone) return false;
    const p = phone.trim();
    // Accept Vietnamese mobile numbers starting with 0 or +84 followed by valid operator and 8 digits
    // Examples: 0912345678 or +84912345678
    const re = /^(?:\+84|0)(?:3|5|7|8|9)\d{8}$/;
    return re.test(p);
  };
  const [selectedPickupId, setSelectedPickupId] = useState<string | null>(null);
  const [selectedDropoffId, setSelectedDropoffId] = useState<string | null>(null);

  // Reset selections when user chooses a different trip
  useEffect(() => {
    setSelectedPickupId(null);
    setSelectedDropoffId(null);
    setSelectedSeats([]);
  }, [selectedTrip?._id]);

  // Validate selected stops when tripDetail/stops change
  useEffect(() => {
    if (!tripDetail?.stops) return;
    const hasPickup = selectedPickupId ? tripDetail.stops.some(s => s._id === selectedPickupId) : true;
    const hasDropoff = selectedDropoffId ? tripDetail.stops.some(s => s._id === selectedDropoffId) : true;
    if (!hasPickup) setSelectedPickupId(null);
    if (!hasDropoff) setSelectedDropoffId(null);
    // if both present, ensure order validity
    if (selectedPickupId && selectedDropoffId) {
      const pu = tripDetail.stops.find(s => s._id === selectedPickupId);
      const dr = tripDetail.stops.find(s => s._id === selectedDropoffId);
      if (pu && dr && pu.order >= dr.order) {
        // dropoff invalid after stops changed; clear dropoff
        setSelectedDropoffId(null);
      }
    }
  }, [tripDetail?.stops]);

  useEffect(() => {
    let mounted = true;
    const fetchTrips = async () => {
      try {
        setLoadingTrips(true);
        setErrTrips(null);
        const res = await fetch(`${API_BASE}/api/trips`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data: TripDoc[] = await res.json();
        if (!mounted) return;
        
        // Filter and sort trips
        const filtered = data
            .filter(t => {
              const tid = t?.route && (t.route._id ? String(t.route._id) : String(t.route));
              const tripTime = new Date(t.start_time);
              const now = new Date();
              
              // B·∫¨T L·∫†I D√íNG N√ÄY:
              return tid === routeId && tripTime > now;
          })
          .sort((a, b) => new Date(a.start_time).getTime() - new Date(b.start_time).getTime());

        // Only update state if data has actually changed
        setAllTrips(prev => {
          if (prev.length === filtered.length && 
              prev.every((trip, i) => trip._id === filtered[i]._id)) {
            return prev;
          }
          return filtered;
        });

        // Only update selectedTrip if necessary
        setSelectedTrip(prev => {
          if (prev && filtered.find(f => f._id === prev._id)) return prev;
          if (!prev && filtered.length > 0) return filtered[0];
          return prev;
        });
      } catch (e: any) {
        if (!mounted) return;
        setErrTrips(e?.message || 'L·ªói t·∫£i danh s√°ch chuy·∫øn');
      } finally {
        if (mounted) setLoadingTrips(false);
      }
    };

    fetchTrips();
    return () => { mounted = false; };
  }, [routeId]);

  // Poll trip details (seats) for the selected trip so UI reflects changes made by admin
  // Function to compare seats arrays
  const seatsEqual = (a?: SeatDoc[], b?: SeatDoc[]) => {
    if (!a && !b) return true;
    if (!a || !b) return false;
    if (a.length !== b.length) return false;
    return a.every((seat, i) => 
      seat.seat_number === b[i].seat_number && 
      seat.status === b[i].status
    );
  };

  // Effect for handling trip details and polling
  useEffect(() => {
    if (!selectedTrip?._id) {
      setTripDetail(null);
      return;
    }

    let mounted = true;
    let timeoutId: ReturnType<typeof setTimeout>;

    const fetchTripDetails = async () => {
      if (!mounted) return;

      try {
        if (!tripDetail) setLoadingDetail(true);
        setErrDetail(null);

        const res = await fetch(`${API_BASE}/api/trips/${selectedTrip._id}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data: TripDetailResponse = await res.json();

        if (!mounted) return;

        // Check if any selected seats are no longer available
        const unavailableSelected = selectedSeats.some(sn => {
          const seat = data.seats.find(s => s.seat_number === String(sn));
          return !seat || seat.status !== 'available';
        });

        // Only update states if there are actual changes
        if (unavailableSelected) {
          setSelectedSeats(prev => 
            prev.filter(sn => {
              const seat = data.seats.find(s => s.seat_number === String(sn));
              return seat && seat.status === 'available';
            })
          );
        }

        // Only update trip detail if seats have changed
        if (!tripDetail || !seatsEqual(tripDetail.seats, data.seats)) {
          setTripDetail(data);
        }
      } catch (e: any) {
        if (!mounted) return;
        setErrDetail(e?.message || 'L·ªói t·∫£i chi ti·∫øt chuy·∫øn');
      } finally {
        if (mounted) {
          setLoadingDetail(false);
          // Schedule next poll
          timeoutId = setTimeout(fetchTripDetails, 5000); // Increased poll interval to 5s
        }
      }
    };

    fetchTripDetails();

    return () => {
      mounted = false;
      if (timeoutId) clearTimeout(timeoutId);
    };
  }, [selectedTrip?._id, seatsEqual]);

  // Debug: detect mounts/unmounts and page unloads to help diagnose unexpected reloads
  useEffect(() => {
    console.info('[BookingDetail] mounted');
    const onBeforeUnload = (e: BeforeUnloadEvent) => {
      console.warn('[BookingDetail] beforeunload', e);
    };
    const onVisibility = () => {
      console.info('[BookingDetail] visibilitychange', document.visibilityState);
    };
    window.addEventListener('beforeunload', onBeforeUnload);
    document.addEventListener('visibilitychange', onVisibility);
    return () => {
      console.info('[BookingDetail] unmounted');
      window.removeEventListener('beforeunload', onBeforeUnload);
      document.removeEventListener('visibilitychange', onVisibility);
    };
  }, []);

  const fmtTime = (iso?: string | null) => {
    if (!iso) return '-';
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return '-';
    return d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
  };

  const fmtDuration = (mins?: number) => {
    if (typeof mins !== 'number' || Number.isNaN(mins)) return '-';
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    if (h && m) return `${h}h ${m}m`;
    if (h) return `${h}h`;
    return `${m}m`;
  };

  // ƒê·∫øm s·ªë gh·∫ø tr·ªëng th·ª±c t·∫ø (kh√¥ng tr·ª´ gh·∫ø ƒë√£ ch·ªçn)
  const availableSeatsCount = useMemo(() => {
    return (tripDetail?.seats || []).filter(s => s.status === 'available').length;
  }, [tripDetail?.seats]);

  // S·ªë gh·∫ø ƒë√£ ch·ªçn (ch·ªâ t√≠nh nh·ªØng gh·∫ø available)
  const selectedAvailableCount = useMemo(() => {
    const availableSeats = tripDetail?.seats?.filter(s => s.status === 'available') || [];
    return selectedSeats.filter(sn => availableSeats.some(s => s.seat_number === String(sn))).length;
  }, [tripDetail?.seats, selectedSeats]);

  const handleSeatSelect = (seatNumber: number) => {
    const status = tripDetail?.seats?.find(s => s.seat_number === String(seatNumber))?.status;
    if (status && status !== 'available') return;
    setSelectedSeats(prev => prev.includes(seatNumber) ? prev.filter(s => s !== seatNumber) : [...prev, seatNumber]);
  };

  // Component implementation inline since we only use it in one place
  const handleSeatClick = (seatNumber: number, status: SeatDoc['status']) => {
    if (status !== 'available') return;
    handleSeatSelect(seatNumber);
  };

  const handleBooking = () => {
    if (!tripDetail?.trip?._id) { alert('Ch∆∞a ch·ªçn chuy·∫øn.'); return; }
    if (selectedSeats.length === 0) { alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt gh·∫ø'); return; }
    if (!selectedPickupId || !selectedDropoffId) { alert('Vui l√≤ng ch·ªçn ƒëi·ªÉm ƒë√≥n v√† ƒëi·ªÉm tr·∫£'); return; }

    // Ensure pickup is before dropoff by order
    const pickup = tripDetail?.stops?.find(s => s._id === selectedPickupId);
    const dropoff = tripDetail?.stops?.find(s => s._id === selectedDropoffId);
    if (!pickup || !dropoff) { alert('ƒêi·ªÉm d·ª´ng kh√¥ng h·ª£p l·ªá'); return; }
    if (pickup.order >= dropoff.order) { alert('Vui l√≤ng ch·ªçn ƒëi·ªÉm ƒë√≥n tr∆∞·ªõc ƒëi·ªÉm tr·∫£'); return; }
    if (!passengerInfo.name || !passengerInfo.phone) { alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin h√†nh kh√°ch'); return; }
    if (!isValidPhone(passengerInfo.phone)) { setPhoneError('S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë b·∫Øt ƒë·∫ßu b·∫±ng 0 ho·∫∑c +84, v√≠ d·ª• 0912345678.'); return; }
    navigate('/payment', { state: {
      tripId: tripDetail.trip._id,
      seats: selectedSeats,
      passenger: passengerInfo,
      stops: { pickupId: selectedPickupId, dropoffId: selectedDropoffId, pickupName: pickup.stop_name, dropoffName: dropoff.stop_name },
      route: { from: tripDetail.trip.route?.from_city || '', to: tripDetail.trip.route?.to_city || '', durationMin: tripDetail.trip.route?.estimated_duration_min || null },
      bus: { busType: tripDetail.trip.bus?.bus_type || '', licensePlate: tripDetail.trip.bus?.license_plate || '', seatCount: tripDetail.trip.bus?.seat_count || 0 },
      times: { departureTime: tripDetail.trip.start_time, arrivalTime: tripDetail.trip.end_time || null },
      pricePerSeat: computedPricePerSeat
    } });
  };

  // Compute price per seat based on selected stops (same logic as server-side)
  const computedPricePerSeat = React.useMemo(() => {
    const base = tripDetail?.trip?.base_price || selectedTrip?.base_price || 0;
    if (!tripDetail?.stops || !selectedPickupId || !selectedDropoffId) return base;
    const pickup = tripDetail.stops.find(s => s._id === selectedPickupId);
    const dropoff = tripDetail.stops.find(s => s._id === selectedDropoffId);
    if (!pickup || !dropoff) return base;
    const orders = tripDetail.stops.map(s => (typeof s.order === 'number' ? s.order : 0));
    const minOrder = Math.min(...orders);
    const maxOrder = Math.max(...orders);
    const totalSegments = (maxOrder - minOrder) || 1;
    const segmentsBetween = Math.max(0, dropoff.order - pickup.order);
    const fraction = Math.min(1, segmentsBetween / totalSegments);
    let price = Math.round(base * fraction);
    if (price <= 0) price = Math.max(1, Math.floor(base * 0.2));
    return price;
  }, [tripDetail?.stops, tripDetail?.trip?.base_price, selectedPickupId, selectedDropoffId, selectedTrip?.base_price]);

  const computedTotalAmount = React.useMemo(() => {
    return (computedPricePerSeat || 0) * (selectedSeats.length || 0);
  }, [computedPricePerSeat, selectedSeats.length]);

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button
              onClick={() => navigate('/')}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay l·∫°i
            </button>
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Ch·ªçn chuy·∫øn */}
        <div className="mb-6">
          {loadingTrips ? (
            <div className="text-gray-500">ƒêang t·∫£i danh s√°ch chuy·∫øn‚Ä¶</div>
          ) : errTrips ? (
            <div className="text-red-600">L·ªói: {errTrips}</div>
          ) : allTrips.length === 0 ? (
            <div className="text-gray-600">Kh√¥ng t√¨m th·∫•y chuy·∫øn n√†o cho tuy·∫øn n√†y.</div>
          ) : (
            <div className="flex items-center gap-3">
              <span className="text-sm text-gray-600">Ch·ªçn chuy·∫øn:</span>
              <select
                className="border border-gray-300 rounded-lg px-3 py-2 bg-white w-full max-w-xl" // Th√™m w-full ƒë·ªÉ r·ªông ra x√≠u
                value={selectedTrip?._id || ''}
                onChange={(e) => {
                  const t = allTrips.find(x => x._id === e.target.value) || null;
                  setSelectedTrip(t);
                }}
              >
                {allTrips.map(t => {
                  // T·∫°o h√†m format hi·ªÉn th·ªã c·∫£ Ng√†y v√† Gi·ªù
                  const d = new Date(t.start_time);
                  const dateStr = d.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
                  const timeStr = d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                  
                  // T√≠nh gi·ªù ƒë·∫øn d·ª± ki·∫øn
                  const dEnd = t.end_time ? new Date(t.end_time) : null;
                  const timeEndStr = dEnd ? dEnd.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : '...';

                  return (
                    <option key={t._id} value={t._id}>
                      {/* Hi·ªÉn th·ªã: 24/11 | 08:00 - 10:00 | Th√°i Nguy√™n -> H√† N·ªôi */}
                      {dateStr} | {timeStr} - {timeEndStr} | {t.route?.from_city || '-'} ‚Üí {t.route?.to_city || '-'}
                    </option>
                  );
                })}
              </select>
            </div>
          )}
        </div>

        {selectedTrip && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Th√¥ng tin tuy·∫øn/chuy·∫øn */}
            <div className="lg:col-span-2">
              <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                <h2 className="text-2xl font-bold text-gray-900 mb-6">Chi ti·∫øt tuy·∫øn ƒë∆∞·ªùng</h2>

                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center">
                    <MapPin className="h-6 w-6 text-blue-600 mr-3" />
                    <div>
                      <p className="text-lg font-semibold text-gray-900">
                        {selectedTrip.route?.from_city || '-'}
                      </p>
                      <p className="text-sm text-gray-600">ƒêi·ªÉm ƒëi</p>
                    </div>
                  </div>

                  <div className="flex-1 mx-6">
                    <div className="border-t-2 border-dashed border-gray-300"></div>
                    <div className="text-center mt-2">
                      <Clock className="h-4 w-4 inline mr-1" />
                      <span className="text-sm text-gray-600">
                        {fmtDuration(selectedTrip.route?.estimated_duration_min)}
                      </span>
                    </div>
                  </div>

                  <div className="flex items-center">
                    <MapPin className="h-6 w-6 text-green-600 mr-3" />
                    <div>
                      <p className="text-lg font-semibold text-gray-900">
                        {selectedTrip.route?.to_city || '-'}
                      </p>
                      <p className="text-sm text-gray-600">ƒêi·ªÉm ƒë·∫øn</p>
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                  {/* √î 1: Gi·ªù kh·ªüi h√†nh */}
                  <div className="text-center p-4 bg-gray-50 rounded-lg">
                    <Calendar className="h-6 w-6 text-blue-600 mx-auto mb-2" />
                    <p className="font-semibold text-gray-900">Gi·ªù kh·ªüi h√†nh</p>
                    <p className="text-gray-600">{fmtTime(selectedTrip.start_time)}</p>
                  </div>
                  
                  {/* √î 2: Gi·ªù ƒë·∫øn */}
                  <div className="text-center p-4 bg-gray-50 rounded-lg">
                    <Calendar className="h-6 w-6 text-green-600 mx-auto mb-2" />
                    <p className="font-semibold text-gray-900">Gi·ªù ƒë·∫øn</p>
                    <p className="text-gray-600">{fmtTime(selectedTrip.end_time || undefined)}</p>
                  </div>

                  {/* √î 3: BI·ªÇN S·ªê XE  */}
                  <div className="text-center p-4 bg-gray-50 rounded-lg">
                    {/* Icon BS ƒë∆°n gi·∫£n */}
                    <div className="h-6 w-8 mx-auto mb-2 flex items-center justify-center bg-blue-600 text-white rounded text-xs font-bold">
                      BS
                    </div>
                    <p className="font-semibold text-gray-900">Bi·ªÉn s·ªë</p>
                    <p className="text-blue-700 font-bold text-lg">
                      {selectedTrip.bus?.license_plate || '---'}
                    </p>
                  </div>

                  {/* √î 4: Lo·∫°i xe */}
                  <div className="text-center p-4 bg-gray-50 rounded-lg">
                    <Bus className="h-6 w-6 text-purple-600 mx-auto mb-2" />
                    <p className="font-semibold text-gray-900">Lo·∫°i xe</p>
                    <p className="text-gray-600">{selectedTrip.bus?.bus_type || '-'}</p>
                  </div>

                  {/* √î 5: S·ªë gh·∫ø */}
                  <div className="text-center p-4 bg-gray-50 rounded-lg">
                    <Users className="h-6 w-6 text-orange-600 mx-auto mb-2" />
                    <p className="font-semibold text-gray-900">S·ªë gh·∫ø</p>
                    <p className="text-gray-600">
                      {loadingDetail ? '‚Ä¶' : `${availableSeatsCount - selectedAvailableCount} gh·∫ø tr·ªëng`}
                    </p>
                  </div>
                </div>

                {/* Hi·ªÉn th·ªã ƒëi·ªÉm d·ª´ng */}
                {tripDetail?.stops && tripDetail.stops.length > 0 && (
                  <div className="mt-6 pt-6 border-t border-gray-200">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                      <MapPin className="h-5 w-5 text-blue-600 mr-2" />
                      C√°c ƒëi·ªÉm d·ª´ng tr√™n tuy·∫øn
                    </h3>
                    <div className="relative">
                      {/* ƒê∆∞·ªùng th·∫≥ng n·ªëi c√°c ƒëi·ªÉm */}
                      <div className="absolute left-4 top-0 bottom-0 w-0.5 bg-blue-200"></div>
                      
                      <div className="space-y-4 relative">
                        {(() => {
                          const stops = tripDetail?.stops || [];
                          return stops.map((stop, index) => {
                          const isFirst = index === 0;
                          const isLast = index === stops.length - 1;
                          const getTypeColor = () => {
                            if (stop.type === 'pickup') return 'bg-green-100 text-green-700 border-green-300';
                            if (stop.type === 'dropoff') return 'bg-red-100 text-red-700 border-red-300';
                            return 'bg-blue-100 text-blue-700 border-blue-300';
                          };
                          const getTypeLabel = () => {
                            if (stop.type === 'pickup') return 'ƒêi·ªÉm ƒë√≥n';
                            if (stop.type === 'dropoff') return 'ƒêi·ªÉm tr·∫£';
                            return 'ƒêi·ªÉm ƒë√≥n/tr·∫£';
                          };

                          const isSelectedPickup = selectedPickupId === stop._id;
                          const isSelectedDropoff = selectedDropoffId === stop._id;

                          const handleStopClick = () => {
                            if (isSelectedPickup) { setSelectedPickupId(null); return; }
                            if (isSelectedDropoff) { setSelectedDropoffId(null); return; }

                            if (!selectedPickupId) {
                              if (stop.type === 'dropoff') {
                                alert('Kh√¥ng th·ªÉ ch·ªçn ƒëi·ªÉm tr·∫£ l√†m ƒëi·ªÉm ƒë√≥n. Vui l√≤ng ch·ªçn ƒëi·ªÉm ƒë√≥n h·ª£p l·ªá.');
                                return;
                              }
                              setSelectedPickupId(stop._id);
                              return;
                            }

                            if (selectedPickupId && !selectedDropoffId) {
                                  const pickup = stops.find(s => s._id === selectedPickupId);
                              if (pickup && stop.order <= pickup.order) {
                                alert('Vui l√≤ng ch·ªçn ƒëi·ªÉm tr·∫£ n·∫±m sau ƒëi·ªÉm ƒë√≥n.');
                                return;
                              }
                              if (stop.type === 'pickup') {
                                alert('Vui l√≤ng ch·ªçn ƒëi·ªÉm tr·∫£ h·ª£p l·ªá.');
                                return;
                              }
                              setSelectedDropoffId(stop._id);
                              return;
                            }

                            setSelectedPickupId(stop._id);
                            setSelectedDropoffId(null);
                          };

                          return (
                            <div key={stop._id} className="relative flex items-start pl-10">
                              <div className={`absolute left-0 w-8 h-8 rounded-full flex items-center justify-center font-semibold text-sm border-2 ${
                                isFirst 
                                  ? 'bg-blue-600 text-white border-blue-600' 
                                  : isLast
                                  ? 'bg-green-600 text-white border-green-600'
                                  : 'bg-white text-blue-600 border-blue-400'
                              }`}>
                                {stop.order}
                              </div>

                              <div
                                onClick={handleStopClick}
                                role="button"
                                tabIndex={0}
                                className={[
                                  'flex-1 rounded-lg p-3 border transition-colors cursor-pointer',
                                  isSelectedPickup ? 'bg-blue-50 border-blue-400' : 'bg-gray-50 border-gray-200',
                                  isSelectedDropoff ? 'bg-indigo-50 border-indigo-400' : ''
                                ].join(' ')}
                                onKeyDown={(e: React.KeyboardEvent) => { if (e.key === 'Enter') handleStopClick(); }}
                              >
                                <div className="flex items-center justify-between">
                                  <p className="font-medium text-gray-900">{stop.stop_name}</p>
                                  <div className="ml-4 text-right">
                                    <span className={`inline-block mt-2 px-2 py-1 rounded text-xs font-medium border ${getTypeColor()}`}>
                                      {getTypeLabel()}
                                    </span>
                                  </div>
                                </div>

                                <div className="mt-2 flex items-center gap-2">
                                  {isSelectedPickup && (
                                    <span className="text-xs font-semibold text-blue-700">B·∫°n ch·ªçn ƒëi·ªÉm ƒë√≥n</span>
                                  )}
                                  {isSelectedDropoff && (
                                    <span className="text-xs font-semibold text-indigo-700">B·∫°n ch·ªçn ƒëi·ªÉm tr·∫£</span>
                                  )}
                                </div>
                              </div>
                            </div>
                          );
                          });
                        })()}
                      </div>
                    </div>
                  </div>
                )}
              </div>

              {/* Ch·ªçn gh·∫ø */}
              <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                <h3 className="text-xl font-bold text-gray-900 mb-4">Ch·ªçn gh·∫ø</h3>

                {loadingDetail ? (
                  <div className="text-gray-500">ƒêang t·∫£i s∆° ƒë·ªì gh·∫ø‚Ä¶</div>
                ) : errDetail ? (
                  <div className="text-red-600">L·ªói: {errDetail}</div>
                ) : (
                  <>
                    <div className="grid grid-cols-4 gap-3">
                    {(tripDetail?.seats || [])
                      .sort((a, b) => parseInt(a.seat_number) - parseInt(b.seat_number))
                      .map((seat) => {
                        const seatNumber = parseInt(seat.seat_number, 10);
                        
                        // Find the current status of this seat
                        const seatStatus = tripDetail?.seats?.find(
                          s => s.seat_number === String(seatNumber)
                        );
                        const status = seatStatus?.status || 'available';
                        const isSelected = selectedSeats.includes(seatNumber);

                        return (
                          <button
                            key={seatNumber}
                            onClick={() => handleSeatClick(seatNumber, status)}
                            disabled={status !== 'available'}
                            className={[
                              'p-3 rounded-lg border-2 text-center font-medium transition-colors',
                              status !== 'available'
                                ? 'bg-red-100 text-gray-500 border-red-300 cursor-not-allowed'
                                : isSelected
                                  ? 'bg-blue-600 text-white border-blue-600'
                                  : 'bg-gray-100 text-gray-700 border-gray-300 hover:bg-gray-200'
                            ].join(' ')}
                            title={status !== 'available' ? `Gh·∫ø ${seatNumber} ƒë√£ b√°n/gi·ªØ` : `Gh·∫ø ${seatNumber}`}
                          >
                            {seatNumber}
                          </button>
                        );
                    })}
                  </div>

                    <div className="mt-4 flex flex-wrap items-center gap-4">
                      <div className="flex items-center">
                        <div className="w-4 h-4 bg-gray-100 border-2 border-gray-300 rounded mr-2"></div>
                        <span className="text-sm text-gray-600">Gh·∫ø tr·ªëng ({availableSeatsCount - selectedAvailableCount})</span>
                      </div>
                      <div className="flex items-center">
                        <div className="w-4 h-4 bg-red-100 border-2 border-red-300 rounded mr-2"></div>
                        <span className="text-sm text-gray-600">Gh·∫ø ƒë√£ b√°n/gi·ªØ ({(tripDetail?.seats?.length || 0) - availableSeatsCount})</span>
                      </div>
                      <div className="flex items-center">
                        <div className="w-4 h-4 bg-blue-600 border-2 border-blue-600 rounded mr-2"></div>
                        <span className="text-sm text-gray-600">ƒê√£ ch·ªçn ({selectedAvailableCount})</span>
                      </div>
                    </div>
                  </>
                )}
              </div>

              {/* Th√¥ng tin h√†nh kh√°ch */}
              <div className="bg-white rounded-xl shadow-md p-6">
                <h3 className="text-xl font-bold text-gray-900 mb-4">Th√¥ng tin h√†nh kh√°ch</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">H·ªç v√† t√™n *</label>
                    <input
                      type="text"
                      value={passengerInfo.name}
                      onChange={(e) => setPassengerInfo({ ...passengerInfo, name: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Nh·∫≠p h·ªç v√† t√™n"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">S·ªë ƒëi·ªán tho·∫°i *</label>
                    <input
                      type="tel"
                      value={passengerInfo.phone}
                      onChange={(e) => { setPassengerInfo({ ...passengerInfo, phone: e.target.value }); if (phoneError) setPhoneError(null); }}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
                    />
                    {phoneError && (
                      <p className="text-sm text-red-600 mt-1">{phoneError}</p>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input
                      type="email"
                      value={passengerInfo.email}
                      onChange={(e) => setPassengerInfo({ ...passengerInfo, email: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Nh·∫≠p email"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Ghi ch√∫</label>
                    <input
                      type="text"
                      value={passengerInfo.note}
                      onChange={(e) => setPassengerInfo({ ...passengerInfo, note: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Ghi ch√∫ th√™m"
                    />
                  </div>
                </div>
              </div>
            </div>

            {/* T√≥m t·∫Øt ƒë·∫∑t v√© */}
            <div className="lg:col-span-1">
              <div className="bg-white rounded-xl shadow-md p-6 sticky top-8">
                <h3 className="text-xl font-bold text-gray-900 mb-4">T√≥m t·∫Øt ƒë·∫∑t v√©</h3>

                <div className="space-y-4 mb-6">
                  <div className="flex justify-between">
                    <span className="text-gray-600">Tuy·∫øn ƒë∆∞·ªùng:</span>
                    <span className="font-medium">
                      {(selectedTrip.route?.from_city || '-')} - {(selectedTrip.route?.to_city || '-')}
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">S·ªë gh·∫ø:</span>
                    <span className="font-medium">{selectedSeats.length} gh·∫ø</span>
                  </div>
                  {tripDetail?.stops && (
                    <div className="flex justify-between">
                      <span className="text-gray-600">ƒêi·ªÉm ƒë√≥n / tr·∫£:</span>
                      <span className="font-medium text-right">
                        {selectedPickupId ? (tripDetail.stops.find(s => s._id === selectedPickupId)?.stop_name || '-') : '-'}
                        {' '} / {' '}
                        {selectedDropoffId ? (tripDetail.stops.find(s => s._id === selectedDropoffId)?.stop_name || '-') : '-'}
                      </span>
                    </div>
                  )}
                  <div className="flex justify-between">
                    <span className="text-gray-600">Gi√°/gh·∫ø:</span>
                    <span className="font-medium">{(computedPricePerSeat || 0).toLocaleString()}‚Ç´</span>
                  </div>
                  <div className="border-t pt-4">
                    <div className="flex justify-between text-lg font-bold">
                      <span>T·ªïng c·ªông:</span>
                      <span className="text-blue-600">{(computedTotalAmount || 0).toLocaleString()}‚Ç´</span>
                    </div>
                  </div>
                </div>

                <button
                  onClick={handleBooking}
                  className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium text-lg"
                >
                  Ti·∫øp t·ª•c thanh to√°n
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default BookingDetail;

--- END OF FILE: frontend\src\components\BookingDetail.tsx ---


--- START OF FILE: frontend\src\components\ContactPage.tsx ---
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { ArrowLeft, Bus, Phone, Mail, MapPin, Clock, MessageCircle, Send, CheckCircle } from 'lucide-react';

const ContactPage: React.FC = () => {
  const navigate = useNavigate();
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    subject: '',
    message: ''
  });
  const [isSubmitted, setIsSubmitted] = useState(false);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    // Simulate form submission
    setIsSubmitted(true);
    setTimeout(() => {
      setIsSubmitted(false);
      setFormData({
        name: '',
        email: '',
        phone: '',
        subject: '',
        message: ''
      });
    }, 3000);
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button 
              onClick={() => navigate('/')}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay l·∫°i
            </button>
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Page Header */}
        <div className="text-center mb-12">
          <h2 className="text-3xl font-bold text-gray-900 mb-2">Li√™n h·ªá v·ªõi ch√∫ng t√¥i</h2>
          <p className="text-gray-600">Ch√∫ng t√¥i lu√¥n s·∫µn s√†ng h·ªó tr·ª£ b·∫°n 24/7</p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
          {/* Contact Information */}
          <div className="space-y-8">
            {/* Contact Cards */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-6">Th√¥ng tin li√™n h·ªá</h3>
              
              <div className="space-y-6">
                <div className="flex items-start">
                  <div className="bg-blue-100 p-3 rounded-lg mr-4">
                    <Phone className="h-6 w-6 text-blue-600" />
                  </div>
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-1">Hotline</h4>
                    <p className="text-gray-600 mb-1">1900 1234</p>
                    <p className="text-sm text-gray-500">H·ªó tr·ª£ 24/7</p>
                  </div>
                </div>

                <div className="flex items-start">
                  <div className="bg-green-100 p-3 rounded-lg mr-4">
                    <Mail className="h-6 w-6 text-green-600" />
                  </div>
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-1">Email</h4>
                    <p className="text-gray-600 mb-1">support@vexe7tv.com</p>
                    <p className="text-sm text-gray-500">Ph·∫£n h·ªìi trong 24h</p>
                  </div>
                </div>

                <div className="flex items-start">
                  <div className="bg-purple-100 p-3 rounded-lg mr-4">
                    <MapPin className="h-6 w-6 text-purple-600" />
                  </div>
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-1">ƒê·ªãa ch·ªâ</h4>
                    <p className="text-gray-600 mb-1">123 ƒê∆∞·ªùng Tr·ªãnh VƒÉn B√¥, Qu·∫≠n Nam T·ª´ Li√™m</p>
                    <p className="text-gray-600 mb-1">TP.H√† N·ªôi, Vi·ªát Nam</p>
                    <p className="text-sm text-gray-500">Tr·ª• s·ªü ch√≠nh</p>
                  </div>
                </div>

                <div className="flex items-start">
                  <div className="bg-orange-100 p-3 rounded-lg mr-4">
                    <Clock className="h-6 w-6 text-orange-600" />
                  </div>
                  <div>
                    <h4 className="font-semibold text-gray-900 mb-1">Gi·ªù l√†m vi·ªác</h4>
                    <p className="text-gray-600 mb-1">Th·ª© 2 - Th·ª© 6: 8:00 - 18:00</p>
                    <p className="text-gray-600 mb-1">Th·ª© 7: 8:00 - 12:00</p>
                    <p className="text-sm text-gray-500">Hotline ho·∫°t ƒë·ªông 24/7</p>
                  </div>
                </div>
              </div>
            </div>

            {/* FAQ */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-6">C√¢u h·ªèi th∆∞·ªùng g·∫∑p</h3>
              
              <div className="space-y-4">
                <div className="border-l-4 border-blue-500 pl-4">
                  <h4 className="font-semibold text-gray-900 mb-1">L√†m th·∫ø n√†o ƒë·ªÉ ƒë·∫∑t v√©?</h4>
                  <p className="text-gray-600 text-sm">Ch·ªçn tuy·∫øn ƒë∆∞·ªùng, ch·ªçn gh·∫ø, nh·∫≠p th√¥ng tin v√† thanh to√°n.</p>
                </div>
                
                <div className="border-l-4 border-green-500 pl-4">
                  <h4 className="font-semibold text-gray-900 mb-1">C√≥ th·ªÉ h·ªßy v√© kh√¥ng?</h4>
                  <p className="text-gray-600 text-sm">C√≥ th·ªÉ h·ªßy v√© tr∆∞·ªõc gi·ªù kh·ªüi h√†nh 2 ti·∫øng.</p>
                </div>
                
                <div className="border-l-4 border-purple-500 pl-4">
                  <h4 className="font-semibold text-gray-900 mb-1">Thanh to√°n nh∆∞ th·∫ø n√†o?</h4>
                  <p className="text-gray-600 text-sm">H·ªó tr·ª£ MoMo, chuy·ªÉn kho·∫£n ng√¢n h√†ng v√† thanh to√°n t·∫°i xe.</p>
                </div>
                
                <div className="border-l-4 border-orange-500 pl-4">
                  <h4 className="font-semibold text-gray-900 mb-1">C√≥ h·ªó tr·ª£ ho√†n ti·ªÅn kh√¥ng?</h4>
                  <p className="text-gray-600 text-sm">C√≥ ch√≠nh s√°ch ho√†n ti·ªÅn theo ƒëi·ªÅu kho·∫£n d·ªãch v·ª•.</p>
                </div>
              </div>
            </div>
          </div>

          {/* Contact Form */}
          <div className="bg-white rounded-xl shadow-md p-6">
            <h3 className="text-xl font-bold text-gray-900 mb-6">G·ª≠i tin nh·∫Øn</h3>
            
            {isSubmitted ? (
              <div className="text-center py-8">
                <div className="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                  <CheckCircle className="h-8 w-8 text-green-600" />
                </div>
                <h4 className="text-lg font-semibold text-gray-900 mb-2">Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c g·ª≠i!</h4>
                <p className="text-gray-600">Ch√∫ng t√¥i s·∫Ω ph·∫£n h·ªìi trong th·ªùi gian s·ªõm nh·∫•t.</p>
              </div>
            ) : (
              <form onSubmit={handleSubmit} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      H·ªç v√† t√™n *
                    </label>
                    <input
                      type="text"
                      name="name"
                      value={formData.name}
                      onChange={handleInputChange}
                      required
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Nh·∫≠p h·ªç v√† t√™n"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Email *
                    </label>
                    <input
                      type="email"
                      name="email"
                      value={formData.email}
                      onChange={handleInputChange}
                      required
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Nh·∫≠p email"
                    />
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      S·ªë ƒëi·ªán tho·∫°i
                    </label>
                    <input
                      type="tel"
                      name="phone"
                      value={formData.phone}
                      onChange={handleInputChange}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Ch·ªß ƒë·ªÅ *
                    </label>
                    <select
                      name="subject"
                      value={formData.subject}
                      onChange={handleInputChange}
                      required
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="">Ch·ªçn ch·ªß ƒë·ªÅ</option>
                      <option value="booking">ƒê·∫∑t v√©</option>
                      <option value="cancel">H·ªßy v√©</option>
                      <option value="refund">Ho√†n ti·ªÅn</option>
                      <option value="complaint">Khi·∫øu n·∫°i</option>
                      <option value="suggestion">G√≥p √Ω</option>
                      <option value="other">Kh√°c</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    N·ªôi dung tin nh·∫Øn *
                  </label>
                  <textarea
                    name="message"
                    value={formData.message}
                    onChange={handleInputChange}
                    required
                    rows={6}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Nh·∫≠p n·ªôi dung tin nh·∫Øn..."
                  />
                </div>

                <button
                  type="submit"
                  className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center justify-center"
                >
                  <Send className="h-5 w-5 mr-2" />
                  G·ª≠i tin nh·∫Øn
                </button>
              </form>
            )}
          </div>
        </div>

        {/* Additional Info */}
        <div className="mt-12 grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="bg-blue-50 rounded-xl p-6 text-center">
            <div className="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
              <MessageCircle className="h-6 w-6 text-blue-600" />
            </div>
            <h4 className="font-semibold text-gray-900 mb-2">Chat tr·ª±c tuy·∫øn</h4>
            <p className="text-gray-600 text-sm">H·ªó tr·ª£ tr·ª±c tuy·∫øn 24/7 qua chat</p>
          </div>
          
          <div className="bg-green-50 rounded-xl p-6 text-center">
            <div className="bg-green-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
              <Phone className="h-6 w-6 text-green-600" />
            </div>
            <h4 className="font-semibold text-gray-900 mb-2">Hotline</h4>
            <p className="text-gray-600 text-sm">G·ªçi ngay 1900 1234 ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£</p>
          </div>
          
          <div className="bg-purple-50 rounded-xl p-6 text-center">
            <div className="bg-purple-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
              <Mail className="h-6 w-6 text-purple-600" />
            </div>
            <h4 className="font-semibold text-gray-900 mb-2">Email</h4>
            <p className="text-gray-600 text-sm">G·ª≠i email ƒë·∫øn support@vexe7tv.com</p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ContactPage;

--- END OF FILE: frontend\src\components\ContactPage.tsx ---


--- START OF FILE: frontend\src\components\HomePage.tsx ---
import React, { useEffect, useState } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { Bus, MapPin, Clock, Users, Star, Search, Calendar, LogOut, User } from 'lucide-react';
import { useAuth } from '../App';

type RouteDoc = {
  _id: string;
  name?: string;
  from_city?: string;
  to_city?: string;
  total_distance_km?: number;
  estimated_duration_min?: number;
  active?: boolean;
};

const API_BASE =
  (typeof import.meta !== 'undefined' && (import.meta as any)?.env?.VITE_BACKEND_URL) || '';

const HomePage: React.FC = () => {
  const navigate = useNavigate();
  const auth = useAuth();

  const [routes, setRoutes] = useState<RouteDoc[]>([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);

  // Search form state
  const [fromCity, setFromCity] = useState('');
  const [toCity, setToCity] = useState('');
  const [searchDate, setSearchDate] = useState('');

  const handleBookingClick = (routeId: string) => {
    navigate(`/booking/${routeId}`);
  };

  const handleSearch = (e: React.FormEvent) => {
    e.preventDefault();
    // Navigate to routes page with search params
    const params = new URLSearchParams();
    if (fromCity.trim()) {
      params.append('from', fromCity.trim());
    }
    if (toCity.trim()) {
      params.append('to', toCity.trim());
    }
    if (searchDate) {
      params.append('date', searchDate);
    }
    
    // Navigate to routes page with search query
    const queryString = params.toString();
    navigate(`/routes${queryString ? `?${queryString}` : ''}`);
  };

  useEffect(() => {
    let mounted = true;
    (async () => {
      try {
        setLoading(true);
        setErr(null);
        const res = await fetch(`${API_BASE}/api/routes`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data: RouteDoc[] = await res.json();
        if (!mounted) return;

        // l·∫•y 6 tuy·∫øn ƒëang active l√†m "popular"
        const popular = (Array.isArray(data) ? data : [])
          .filter(r => r?.active !== false)
          .slice(0, 6);
        setRoutes(popular);
      } catch (e: any) {
        if (!mounted) return;
        setErr(e?.message || 'L·ªói t·∫£i d·ªØ li·ªáu');
      } finally {
        if (mounted) setLoading(false);
      }
    })();
    return () => { mounted = false; };
  }, []);

  const fmtDuration = (mins?: number) => {
    if (typeof mins !== 'number' || Number.isNaN(mins)) return '-';
    const h = Math.floor(mins / 60);
    const m = Math.floor(mins % 60);
    if (h && m) return `${h}h ${m}m`;
    if (h) return `${h}h`;
    return `${m}m`;
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-6">
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
            <nav className="hidden md:flex space-x-8">
              <button className="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">
                Trang ch·ªß
              </button>
              <Link to="/routes" className="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">
                Tuy·∫øn ƒë∆∞·ªùng
              </Link>
              <button onClick={() => navigate('/my-tickets')}
                className="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">
                V√© c·ªßa t√¥i
              </button>
              <button onClick={() => navigate('/contact')}
                className="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">
                Li√™n h·ªá
              </button>
            </nav>
            <div className="flex items-center space-x-4">
              {auth.user ? (
                <div className="flex items-center space-x-4">
                  <div className="flex items-center text-gray-700">
                    <User className="h-5 w-5 mr-2" />
                    <span className="font-medium">{auth.user.name}</span>
                  </div>
                  <button
                    onClick={() => {
                      auth.logout();
                      navigate('/');
                    }}
                    className="flex items-center text-gray-700 hover:text-red-600"
                  >
                    <LogOut className="h-5 w-5 mr-2" />
                    ƒêƒÉng xu·∫•t
                  </button>
                </div>
              ) : (
                <>
                  <button 
                    onClick={() => navigate('/login')}
                    className="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
                  >
                    ƒêƒÉng nh·∫≠p
                  </button>
                  <button 
                    onClick={() => navigate('/register')}
                    className="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700"
                  >
                    ƒêƒÉng k√Ω
                  </button>
                </>
              )}
            </div>
          </div>
        </div>
      </header>

      {/* Hero */}
      <section className="relative py-20">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="text-center">
            <h2 className="text-4xl md:text-6xl font-bold text-gray-900 mb-6">
              ƒê·∫∑t v√© xe kh√°ch <span className="text-blue-600">d·ªÖ d√†ng</span>
            </h2>
            <p className="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">
              T√¨m ki·∫øm v√† ƒë·∫∑t v√© xe kh√°ch nhanh ch√≥ng v·ªõi gi√° c·∫£ h·ª£p l√Ω. H√†nh tr√¨nh thu·∫≠n ti·ªán, an to√†n v√† ti·∫øt ki·ªám.
            </p>
          </div>

          {/* Search Form */}
          <div className="max-w-4xl mx-auto">
            <form onSubmit={handleSearch} className="bg-white rounded-2xl shadow-xl p-8">
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div className="relative">
                  <MapPin className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
                  <input 
                    type="text" 
                    placeholder="ƒêi·ªÉm ƒëi (v√≠ d·ª•: H√† N·ªôi)"
                    value={fromCity}
                    onChange={(e) => setFromCity(e.target.value)}
                    className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                  />
                </div>
                <div className="relative">
                  <MapPin className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
                  <input 
                    type="text" 
                    placeholder="ƒêi·ªÉm ƒë·∫øn (v√≠ d·ª•: TP. H·ªì Ch√≠ Minh)"
                    value={toCity}
                    onChange={(e) => setToCity(e.target.value)}
                    className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                  />
                </div>
                <div className="relative">
                  <Calendar className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
                  <input 
                    type="date"
                    value={searchDate}
                    onChange={(e) => setSearchDate(e.target.value)}
                    min={new Date().toISOString().split('T')[0]}
                    className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                  />
                </div>
                <button 
                  type="submit"
                  className="bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 flex items-center justify-center font-medium transition-colors"
                >
                  <Search className="h-5 w-5 mr-2" /> T√¨m ki·∫øm
                </button>
              </div>
            </form>
          </div>
        </div>
      </section>

      {/* Features */}
      <section className="py-20 bg-white">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="text-center mb-16">
            <h3 className="text-3xl font-bold text-gray-900 mb-4">T·∫°i sao ch·ªçn VeXe7TV?</h3>
            <p className="text-xl text-gray-600">D·ªãch v·ª• ƒë·∫∑t v√© xe kh√°ch h√†ng ƒë·∫ßu v·ªõi nhi·ªÅu ∆∞u ƒëi·ªÉm v∆∞·ª£t tr·ªôi</p>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div className="text-center p-6">
              <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <Clock className="h-8 w-8 text-blue-600" />
              </div>
              <h4 className="text-xl font-semibold text-gray-900 mb-2">ƒê·∫∑t v√© nhanh ch√≥ng</h4>
              <p className="text-gray-600">Ch·ªâ v·ªõi v√†i c√∫ click, b·∫°n c√≥ th·ªÉ ƒë·∫∑t v√© m·ªôt c√°ch d·ªÖ d√†ng.</p>
            </div>
            <div className="text-center p-6">
              <div className="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <Users className="h-8 w-8 text-green-600" />
              </div>
              <h4 className="text-xl font-semibold text-gray-900 mb-2">H·ªó tr·ª£ 24/7</h4>
              <p className="text-gray-600">CSKH lu√¥n s·∫µn s√†ng m·ªçi l√∫c, m·ªçi n∆°i.</p>
            </div>
            <div className="text-center p-6">
              <div className="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <Star className="h-8 w-8 text-yellow-600" />
              </div>
              <h4 className="text-xl font-semibold text-gray-900 mb-2">Ch·∫•t l∆∞·ª£ng cao</h4>
              <p className="text-gray-600">D·ªãch v·ª• uy t√≠n, gi√° h·ª£p l√Ω.</p>
            </div>
          </div>
        </div>
      </section>

      {/* Popular Routes: ƒë·ªçc t·ª´ /api/routes */}
      <section className="py-20 bg-gray-50">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="text-center mb-16">
            <h3 className="text-3xl font-bold text-gray-900 mb-4">Tuy·∫øn ƒë∆∞·ªùng ph·ªï bi·∫øn</h3>
            <p className="text-xl text-gray-600">Kh√°m ph√° c√°c tuy·∫øn ƒë∆∞·ªùng ƒë∆∞·ª£c y√™u th√≠ch nh·∫•t</p>
          </div>

          {loading ? (
            <div className="text-center text-gray-500">ƒêang t·∫£i tuy·∫øn ƒë∆∞·ªùng‚Ä¶</div>
          ) : err ? (
            <div className="text-center text-red-600">L·ªói: {err}</div>
          ) : routes.length === 0 ? (
            <div className="text-center text-gray-500">Ch∆∞a c√≥ d·ªØ li·ªáu tuy·∫øn ƒë∆∞·ªùng.</div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {routes.map(route => (
                <div key={route._id} className="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition-shadow">
                  <div className="flex items-center justify-between mb-4">
                    <div className="flex items-center">
                      <MapPin className="h-5 w-5 text-blue-600 mr-2" />
                      <span className="font-medium text-gray-900">{route.from_city || '-'}</span>
                    </div>
                    <div className="flex-1 mx-4"><div className="border-t border-dashed border-gray-300"></div></div>
                    <div className="flex items-center">
                      <MapPin className="h-5 w-5 text-green-600 mr-2" />
                      <span className="font-medium text-gray-900">{route.to_city || '-'}</span>
                    </div>
                  </div>

                  <div className="flex justify-between items-center text-sm text-gray-600">
                    <div className="flex items-center">
                      <Clock className="h-4 w-4 inline mr-1" />
                      {fmtDuration(route.estimated_duration_min)}
                    </div>
                    <div className="font-medium">
                      {typeof route.total_distance_km === 'number' ? `${route.total_distance_km} km` : '-'}
                    </div>
                  </div>

                  <button
                    onClick={() => handleBookingClick(route._id)}
                    className="w-full mt-4 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    ƒê·∫∑t v√© ngay
                  </button>
                </div>
              ))}
            </div>
          )}
        </div>
      </section>

      {/* Footer */}
      <footer className="bg-gray-900 text-white py-12">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
            <div>
              <div className="flex items-center mb-4">
                <Bus className="h-8 w-8 text-blue-400" />
                <h4 className="ml-2 text-xl font-bold">VeXe7TV</h4>
              </div>
              <p className="text-gray-400">D·ªãch v·ª• ƒë·∫∑t v√© xe kh√°ch tr·ª±c tuy·∫øn h√†ng ƒë·∫ßu Vi·ªát Nam.</p>
            </div>
            <div>
              <h5 className="text-lg font-semibold mb-4">D·ªãch v·ª•</h5>
              <ul className="space-y-2 text-gray-400">
                <li><a href="#" className="hover:text-white">ƒê·∫∑t v√© xe kh√°ch</a></li>
                <li><a href="#" className="hover:text-white">Tra c·ª©u tuy·∫øn ƒë∆∞·ªùng</a></li>
                <li><a href="#" className="hover:text-white">H·ªó tr·ª£ kh√°ch h√†ng</a></li>
                <li><a href="#" className="hover:text-white">Ch√≠nh s√°ch ho√†n v√©</a></li>
              </ul>
            </div>
            <div>
              <h5 className="text-lg font-semibold mb-4">H·ªó tr·ª£</h5>
              <ul className="space-y-2 text-gray-400">
                <li><a href="#" className="hover:text-white">C√¢u h·ªèi th∆∞·ªùng g·∫∑p</a></li>
                <li><a href="#" className="hover:text-white">H∆∞·ªõng d·∫´n ƒë·∫∑t v√©</a></li>
                <li><a href="#" className="hover:text-white">Li√™n h·ªá</a></li>
                <li><a href="#" className="hover:text-white">B√°o c√°o s·ª± c·ªë</a></li>
              </ul>
            </div>
            <div>
              <h5 className="text-lg font-semibold mb-4">Li√™n h·ªá</h5>
              <div className="space-y-2 text-gray-400">
                <p>üìû Hotline: 1900 1234</p>
                <p>üìß Email: support@vexe7tv.com</p>
                <p>üìç 123 Tr·ªãnh VƒÉn B√¥, Nam T·ª´ Li√™m, H√† N·ªôi</p>
              </div>
            </div>
          </div>
          <div className="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
            <p>&copy; 2025 VeXe7TV. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
          </div>
        </div>
      </footer>
    </div>
  );
};

export default HomePage;

--- END OF FILE: frontend\src\components\HomePage.tsx ---


--- START OF FILE: frontend\src\components\LoginPage.tsx ---
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { ArrowLeft, Lock, Mail } from 'lucide-react';
import { useAuth } from '../App';

const API_BASE = ((import.meta as any)?.env?.VITE_BACKEND_URL as string) || 'http://localhost:5000';

const LoginPage: React.FC = () => {
  const navigate = useNavigate();
  const { login: authLogin } = useAuth();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setLoading(true);

    try {
      const response = await fetch(`${API_BASE}/api/auth/login`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email, password }),
        credentials: 'include', // Important for cookies
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
      }

      // Use auth context to manage user state
      authLogin(data.user);
      
      // Redirect based on role
      if (data.user.role === 'admin') {
        navigate('/admin');
      } else {
        navigate('/');
      }
    } catch (err: any) {
      setError(err.message || 'ƒê√£ x·∫£y ra l·ªói khi ƒëƒÉng nh·∫≠p');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button
              onClick={() => navigate('/')}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay l·∫°i
            </button>
          </div>
        </div>
      </header>

      <div className="flex-grow flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div className="max-w-md w-full space-y-8">
          <div>
            <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
              ƒêƒÉng nh·∫≠p v√†o t√†i kho·∫£n
            </h2>
            <p className="mt-2 text-center text-sm text-gray-600">
              Ho·∫∑c{' '}
              <button
                onClick={() => navigate('/register')}
                className="font-medium text-blue-600 hover:text-blue-500"
              >
                ƒëƒÉng k√Ω t√†i kho·∫£n m·ªõi
              </button>
            </p>
          </div>

          <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
            {error && (
              <div className="rounded-md bg-red-50 p-4">
                <div className="text-sm text-red-700">{error}</div>
              </div>
            )}

            <div className="rounded-md shadow-sm -space-y-px">
              <div>
                <label htmlFor="email" className="sr-only">
                  Email
                </label>
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Mail className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="email"
                    name="email"
                    type="email"
                    autoComplete="email"
                    required
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    className="appearance-none rounded-none relative block w-full px-3 py-2 pl-10 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                    placeholder="Email"
                  />
                </div>
              </div>
              <div>
                <label htmlFor="password" className="sr-only">
                  M·∫≠t kh·∫©u
                </label>
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Lock className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="password"
                    name="password"
                    type="password"
                    autoComplete="current-password"
                    required
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="appearance-none rounded-none relative block w-full px-3 py-2 pl-10 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                    placeholder="M·∫≠t kh·∫©u"
                  />
                </div>
              </div>
            </div>

            <div className="flex items-center justify-between">
              <div className="text-sm">
                <button
                  type="button"
                  onClick={() => navigate('/forgot-password')}
                  className="font-medium text-blue-600 hover:text-blue-500"
                >
                  Qu√™n m·∫≠t kh·∫©u?
                </button>
              </div>
            </div>

            <div>
              <button
                type="submit"
                disabled={loading}
                className={`group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white ${
                  loading
                    ? 'bg-blue-400 cursor-not-allowed'
                    : 'bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500'
                }`}
              >
                {loading ? 'ƒêang x·ª≠ l√Ω...' : 'ƒêƒÉng nh·∫≠p'}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
};

export default LoginPage;
--- END OF FILE: frontend\src\components\LoginPage.tsx ---


--- START OF FILE: frontend\src\components\MyTicketsPage.tsx ---
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { ArrowLeft, Bus, MapPin, Clock, Calendar, Download, Eye, Trash2, XCircle } from 'lucide-react';
import { useAuth } from '../App';

interface Ticket {
  id: string;
  bookingId: string;
  route: {
    from: string;
    to: string;
    price: string;
    duration: string;
    departureTime: string;
    arrivalTime: string;
    busType: string;
  };
  seats: number[];
  passenger: {
    name: string;
    phone: string;
    email: string;
    note: string;
  };
  totalAmount: number;
  paymentMethod: string;
  bookingDate: string;
  status: 'confirmed' | 'cancelled' | 'used';
}

type BookingDoc = {
  _id: string;
  user?: any;
  trip?: any;
  route_snapshot?: {
    from: string;
    to: string;
    estimated_duration_min?: number;
  };
  bus_snapshot?: {
    bus_type: string;
    license_plate: string;
    seat_count: number;
  };
  start_time: string;
  end_time?: string | null;
  seat_numbers: string[];
  total_amount?: number;
  total_price?: number;
  passenger?: {
    name: string;
    phone: string;
    email: string;
    note: string;
  };
  status: 'pending' | 'paid' | 'cancelled' | 'completed';
  createdAt: string;
};

const API_BASE = ((import.meta as any)?.env?.VITE_BACKEND_URL as string) || 'http://localhost:5000';

const MyTicketsPage: React.FC = () => {
  const navigate = useNavigate();
  const { user } = useAuth();
  const [tickets, setTickets] = useState<Ticket[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [filterStatus, setFilterStatus] = useState<'all' | 'confirmed' | 'cancelled' | 'used'>('all');

  useEffect(() => {
    const fetchBookings = async () => {
      try {
        setLoading(true);
        setError(null);
        
        // Fetch t·ª´ API v·ªõi credentials ƒë·ªÉ g·ª≠i cookie token
        const res = await fetch(`${API_BASE}/api/bookings`, {
          credentials: 'include', // Quan tr·ªçng ƒë·ªÉ g·ª≠i cookie
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        
        const bookings: BookingDoc[] = await res.json();
        
        // Chuy·ªÉn ƒë·ªïi Booking format sang Ticket format
        const convertedTickets: Ticket[] = bookings.map((booking) => {
          const fmtTime = (iso?: string | null) => {
            if (!iso) return '-';
            const d = new Date(iso);
            if (Number.isNaN(d.getTime())) return '-';
            return d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
          };

          const fmtDate = (iso?: string | null) => {
            if (!iso) return new Date().toISOString();
            return iso;
          };

          const durationMin = booking.route_snapshot?.estimated_duration_min || 0;
          const duration = durationMin 
            ? `${Math.floor(durationMin / 60)}h ${durationMin % 60}m`
            : '-';

          // Map status t·ª´ booking sang ticket
          const mapStatus = (status: string): 'confirmed' | 'cancelled' | 'used' => {
            if (status === 'cancelled') return 'cancelled';
            if (status === 'completed') return 'used';
            return 'confirmed'; // pending, paid -> confirmed
          };

          return {
            id: booking._id,
            bookingId: booking._id.substring(0, 8).toUpperCase(),
            route: {
              from: booking.route_snapshot?.from || '-',
              to: booking.route_snapshot?.to || '-',
              price: String(booking.total_amount || booking.total_price || 0),
              duration,
              departureTime: fmtTime(booking.start_time),
              arrivalTime: fmtTime(booking.end_time),
              busType: booking.bus_snapshot?.bus_type || '-',
            },
            seats: booking.seat_numbers.map(s => parseInt(s, 10)).filter(n => !Number.isNaN(n)),
            passenger: booking.passenger || {
              name: '',
              phone: '',
              email: '',
              note: '',
            },
            totalAmount: booking.total_amount || booking.total_price || 0,
            paymentMethod: 'banking', // C√≥ th·ªÉ l·∫•y t·ª´ payment n·∫øu c·∫ßn
            bookingDate: fmtDate(booking.createdAt),
            status: mapStatus(booking.status),
          };
        });

        setTickets(convertedTickets);
      } catch (err: any) {
        setError(err.message || 'L·ªói khi t·∫£i danh s√°ch v√©');
        console.error('Error fetching bookings:', err);
      } finally {
        setLoading(false);
      }
    };

    fetchBookings();
  }, [user]); // Re-fetch khi user thay ƒë·ªïi

  const filteredTickets = tickets.filter(ticket => {
    if (filterStatus === 'all') return true;
    return ticket.status === filterStatus;
  });

  const handleViewTicket = (ticket: Ticket) => {
    // Chuy·ªÉn ƒë·∫øn trang chi ti·∫øt v√©
    navigate('/ticket-detail', { state: { ticket } });
  };

  const handleDownloadTicket = (ticket: Ticket) => {
    // Simulate download
    alert(`ƒêang t·∫£i xu·ªëng v√© ${ticket.bookingId}`);
  };

  const handleCancelTicket = (ticketId: string) => {
    if (window.confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy v√© n√†y?')) {
      const updatedTickets = tickets.map(ticket => 
        ticket.id === ticketId ? { ...ticket, status: 'cancelled' as const } : ticket
      );
      setTickets(updatedTickets);
      localStorage.setItem('vexe7tv_tickets', JSON.stringify(updatedTickets));
    }
  };

  const handleDeleteTicket = (ticketId: string) => {
    if (window.confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a v√© n√†y?')) {
      const updatedTickets = tickets.filter(ticket => ticket.id !== ticketId);
      setTickets(updatedTickets);
      localStorage.setItem('vexe7tv_tickets', JSON.stringify(updatedTickets));
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'confirmed': return 'bg-green-100 text-green-800';
      case 'cancelled': return 'bg-red-100 text-red-800';
      case 'used': return 'bg-gray-100 text-gray-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const getStatusText = (status: string) => {
    switch (status) {
      case 'confirmed': return 'ƒê√£ x√°c nh·∫≠n';
      case 'cancelled': return 'ƒê√£ h·ªßy';
      case 'used': return 'ƒê√£ s·ª≠ d·ª•ng';
      default: return 'Kh√¥ng x√°c ƒë·ªãnh';
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button 
              onClick={() => navigate('/')}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay l·∫°i
            </button>
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Page Header */}
        <div className="text-center mb-8">
          <h2 className="text-3xl font-bold text-gray-900 mb-2">V√© c·ªßa t√¥i</h2>
          <p className="text-gray-600">Qu·∫£n l√Ω v√† theo d√µi c√°c v√© ƒë√£ ƒë·∫∑t</p>
        </div>

        {/* Filter */}
        <div className="bg-white rounded-xl shadow-md p-6 mb-8">
          <div className="flex flex-wrap gap-4">
            <button
              onClick={() => setFilterStatus('all')}
              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                filterStatus === 'all'
                  ? 'bg-blue-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              T·∫•t c·∫£ ({tickets.length})
            </button>
            <button
              onClick={() => setFilterStatus('confirmed')}
              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                filterStatus === 'confirmed'
                  ? 'bg-green-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              ƒê√£ x√°c nh·∫≠n ({tickets.filter(t => t.status === 'confirmed').length})
            </button>
            <button
              onClick={() => setFilterStatus('cancelled')}
              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                filterStatus === 'cancelled'
                  ? 'bg-red-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              ƒê√£ h·ªßy ({tickets.filter(t => t.status === 'cancelled').length})
            </button>
            <button
              onClick={() => setFilterStatus('used')}
              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                filterStatus === 'used'
                  ? 'bg-gray-600 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              ƒê√£ s·ª≠ d·ª•ng ({tickets.filter(t => t.status === 'used').length})
            </button>
          </div>
        </div>

        {/* Loading State */}
        {loading && (
          <div className="text-center py-12">
            <div className="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p className="text-gray-600">ƒêang t·∫£i danh s√°ch v√©...</p>
          </div>
        )}

        {/* Error State */}
        {error && !loading && (
          <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <p className="text-red-700">{error}</p>
            {!user && (
              <p className="text-sm text-red-600 mt-2">
                Vui l√≤ng <button onClick={() => navigate('/login')} className="underline font-medium">ƒëƒÉng nh·∫≠p</button> ƒë·ªÉ xem v√© c·ªßa b·∫°n.
              </p>
            )}
          </div>
        )}

        {/* Tickets List */}
        {!loading && !error && filteredTickets.length > 0 ? (
          <div className="space-y-6">
            {filteredTickets.map((ticket) => (
              <div key={ticket.id} className="bg-white rounded-xl shadow-md p-6">
                <div className="flex items-start justify-between mb-4">
                  <div className="flex items-center">
                    <div className="bg-blue-100 p-3 rounded-lg mr-4">
                      <Bus className="h-6 w-6 text-blue-600" />
                    </div>
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900">
                        {ticket.route.from} ‚Üí {ticket.route.to}
                      </h3>
                      <p className="text-sm text-gray-600">M√£ ƒë·∫∑t v√©: {ticket.bookingId}</p>
                    </div>
                  </div>
                  <div className="flex items-center space-x-2">
                    <span className={`px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(ticket.status)}`}>
                      {getStatusText(ticket.status)}
                    </span>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                  <div className="flex items-center">
                    <Calendar className="h-5 w-5 text-blue-600 mr-2" />
                    <div>
                      <p className="text-sm text-gray-600">Ng√†y ƒë·∫∑t</p>
                      <p className="font-medium">{new Date(ticket.bookingDate).toLocaleDateString('vi-VN')}</p>
                    </div>
                  </div>
                  <div className="flex items-center">
                    <Clock className="h-5 w-5 text-green-600 mr-2" />
                    <div>
                      <p className="text-sm text-gray-600">Gi·ªù kh·ªüi h√†nh</p>
                      <p className="font-medium">{ticket.route.departureTime}</p>
                    </div>
                  </div>
                  <div className="flex items-center">
                    <MapPin className="h-5 w-5 text-purple-600 mr-2" />
                    <div>
                      <p className="text-sm text-gray-600">Gh·∫ø</p>
                      <p className="font-medium">{ticket.seats.join(', ')}</p>
                    </div>
                  </div>
                  <div className="flex items-center">
                    <Bus className="h-5 w-5 text-orange-600 mr-2" />
                    <div>
                      <p className="text-sm text-gray-600">Lo·∫°i xe</p>
                      <p className="font-medium">{ticket.route.busType}</p>
                    </div>
                  </div>
                </div>

                <div className="flex items-center justify-between">
                  <div className="text-lg font-bold text-blue-600">
                    {ticket.totalAmount.toLocaleString()}‚Ç´
                  </div>
                  <div className="flex space-x-2">
                    <button
                      onClick={() => handleViewTicket(ticket)}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center"
                    >
                      <Eye className="h-4 w-4 mr-2" />
                      Xem chi ti·∫øt
                    </button>
                    {ticket.status === 'confirmed' && (
                      <>
                        <button
                          onClick={() => handleDownloadTicket(ticket)}
                          className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center"
                        >
                          <Download className="h-4 w-4 mr-2" />
                          T·∫£i v√©
                        </button>
                        <button
                          onClick={() => handleCancelTicket(ticket.id)}
                          className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center"
                        >
                          <XCircle className="h-4 w-4 mr-2" />
                          H·ªßy v√©
                        </button>
                      </>
                    )}
                    <button
                      onClick={() => handleDeleteTicket(ticket.id)}
                      className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center"
                    >
                      <Trash2 className="h-4 w-4 mr-2" />
                      X√≥a
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        ) : !loading && !error ? (
          <div className="text-center py-12">
            <Bus className="h-16 w-16 text-gray-400 mx-auto mb-4" />
            <h3 className="text-xl font-semibold text-gray-900 mb-2">Ch∆∞a c√≥ v√© n√†o</h3>
            <p className="text-gray-600 mb-6">
              {user 
                ? 'B·∫°n ch∆∞a ƒë·∫∑t v√© n√†o. H√£y ƒë·∫∑t v√© ƒë·ªÉ b·∫Øt ƒë·∫ßu h√†nh tr√¨nh!'
                : 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem v√© c·ªßa b·∫°n ho·∫∑c ƒë·∫∑t v√© m·ªõi.'}
            </p>
            <div className="flex gap-4 justify-center">
              {!user && (
                <button
                  onClick={() => navigate('/login')}
                  className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                  ƒêƒÉng nh·∫≠p
                </button>
              )}
              <button
                onClick={() => navigate('/')}
                className="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-medium"
              >
                ƒê·∫∑t v√© ngay
              </button>
            </div>
          </div>
        ) : null}

        {/* Stats */}
        {tickets.length > 0 && (
          <div className="mt-12 bg-white rounded-xl shadow-md p-6">
            <h3 className="text-xl font-bold text-gray-900 mb-4">Th·ªëng k√™</h3>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div className="text-center p-4 bg-blue-50 rounded-lg">
                <div className="text-2xl font-bold text-blue-600">{tickets.length}</div>
                <div className="text-sm text-gray-600">T·ªïng v√©</div>
              </div>
              <div className="text-center p-4 bg-green-50 rounded-lg">
                <div className="text-2xl font-bold text-green-600">
                  {tickets.filter(t => t.status === 'confirmed').length}
                </div>
                <div className="text-sm text-gray-600">ƒê√£ x√°c nh·∫≠n</div>
              </div>
              <div className="text-center p-4 bg-red-50 rounded-lg">
                <div className="text-2xl font-bold text-red-600">
                  {tickets.filter(t => t.status === 'cancelled').length}
                </div>
                <div className="text-sm text-gray-600">ƒê√£ h·ªßy</div>
              </div>
              <div className="text-center p-4 bg-purple-50 rounded-lg">
                <div className="text-2xl font-bold text-purple-600">
                  {tickets.reduce((sum, ticket) => sum + ticket.totalAmount, 0).toLocaleString()}‚Ç´
                </div>
                <div className="text-sm text-gray-600">T·ªïng chi ph√≠</div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default MyTicketsPage;

--- END OF FILE: frontend\src\components\MyTicketsPage.tsx ---


--- START OF FILE: frontend\src\components\PaymentPage.tsx ---
// components/PaymentPage.tsx
import React, { useMemo, useState } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { ArrowLeft, Bus, MapPin, Clock, CreditCard, Shield, Lock } from 'lucide-react';

const API_BASE = 'http://localhost:5000';

type PaymentState = {
  tripId: string;
  seats: number[]; // ƒë√£ ch·ªçn ·ªü BookingDetail
  passenger: { name: string; phone: string; email?: string; note?: string; };
  stops?: { pickupId?: string; dropoffId?: string; pickupName?: string; dropoffName?: string };
  route?: { from?: string; to?: string; durationMin?: number | null };
  bus?: { busType?: string; licensePlate?: string; seatCount?: number };
  times?: { departureTime?: string; arrivalTime?: string | null };
  pricePerSeat?: number;
};

const PaymentPage: React.FC = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const st = (location.state || {}) as PaymentState;

  const [paymentMethod, setPaymentMethod] = useState<'momo' | 'banking' | 'cod'>('banking');
  const [isProcessing, setIsProcessing] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  const totalAmount = useMemo(() => {
    const price = Number(st.pricePerSeat || 0);
    return price * (st.seats?.length || 0);
  }, [st.pricePerSeat, st.seats]);

  if (!st?.tripId || !Array.isArray(st?.seats)) {
    navigate('/');
    return null;
  }

  const handlePayment = async () => {
    try {
      setIsProcessing(true);
      setErr(null);

      const res = await fetch(`${API_BASE}/api/bookings/checkout`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include', // Quan tr·ªçng ƒë·ªÉ g·ª≠i cookie token
        body: JSON.stringify({
          tripId: st.tripId,
          seatNumbers: st.seats,
          passenger: st.passenger,
          paymentMethod,
          amount: totalAmount
        })
      });
      if (!res.ok) {
        const e = await res.json().catch(() => ({}));
        throw new Error(e?.error || `HTTP ${res.status}`);
      }
      const payload = await res.json();

      // ƒêi·ªÅu h∆∞·ªõng sang trang th√†nh c√¥ng, c·∫ßm d·ªØ li·ªáu th·∫≠t t·ª´ BE
      navigate('/payment-success', { state: payload });
    } catch (e: any) {
      setErr(e?.message || 'C√≥ l·ªói khi thanh to√°n');
    } finally {
      setIsProcessing(false);
    }
  };

  const fmtTime = (iso?: string | null) => {
    if (!iso) return '-';
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return '-';
    return d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button
              onClick={() => navigate(-1)}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay l·∫°i
            </button>
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="text-center mb-8">
          <h2 className="text-3xl font-bold text-gray-900 mb-2">Thanh to√°n</h2>
          <p className="text-gray-600">Ho√†n t·∫•t ƒë·∫∑t v√© c·ªßa b·∫°n</p>
          {err && <div className="text-red-600 mt-2">{err}</div>}
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {/* Th√¥ng tin ƒë·∫∑t v√© (t·ª´ state) */}
          <div className="space-y-6">
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Th√¥ng tin chuy·∫øn ƒëi</h3>

              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center">
                  <MapPin className="h-5 w-5 text-blue-600 mr-2" />
                  <div>
                    <p className="font-semibold text-gray-900">{st.stops?.pickupName || st.route?.from || '-'}</p>
                    <p className="text-sm text-gray-600">ƒêi·ªÉm ƒëi</p>
                  </div>
                </div>

                <div className="flex-1 mx-4">
                  <div className="border-t border-dashed border-gray-300"></div>
                  <div className="text-center mt-1">
                    <Clock className="h-4 w-4 inline mr-1" />
                    <span className="text-sm text-gray-600">
                      {st.route?.durationMin ? `${Math.floor((st.route.durationMin||0)/60)}h ${(st.route.durationMin||0)%60}m` : '-'}
                    </span>
                  </div>
                </div>

                <div className="flex items-center">
                  <MapPin className="h-5 w-5 text-green-600 mr-2" />
                  <div>
                    <p className="font-semibold text-gray-900">{st.stops?.dropoffName || st.route?.to || '-'}</p>
                    <p className="text-sm text-gray-600">ƒêi·ªÉm ƒë·∫øn</p>
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span className="text-gray-600">Gi·ªù kh·ªüi h√†nh:</span>
                  <span className="ml-2 font-medium">{fmtTime(st.times?.departureTime)}</span>
                </div>
                <div>
                  <span className="text-gray-600">Gi·ªù ƒë·∫øn:</span>
                  <span className="ml-2 font-medium">{fmtTime(st.times?.arrivalTime || null)}</span>
                </div>
                <div>
                  <span className="text-gray-600">Lo·∫°i xe:</span>
                  <span className="ml-2 font-medium">{st.bus?.busType || '-'}</span>
                </div>
              </div>
            </div>

            {/* H√†nh kh√°ch */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Th√¥ng tin h√†nh kh√°ch</h3>
              <div className="space-y-3 text-sm">
                <div className="flex justify-between">
                  <span className="text-gray-600">H·ªç v√† t√™n:</span>
                  <span className="font-medium">{st.passenger?.name || '-'}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">S·ªë ƒëi·ªán tho·∫°i:</span>
                  <span className="font-medium">{st.passenger?.phone || '-'}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Email:</span>
                  <span className="font-medium">{st.passenger?.email || 'Kh√¥ng c√≥'}</span>
                </div>
                {st.passenger?.note && (
                  <div className="flex justify-between">
                    <span className="text-gray-600">Ghi ch√∫:</span>
                    <span className="font-medium">{st.passenger?.note}</span>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Thanh to√°n */}
          <div className="space-y-6">
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Ph∆∞∆°ng th·ª©c thanh to√°n</h3>

              {/* MoMo */}
              <div
                className={`border-2 rounded-lg p-4 cursor-pointer transition-colors ${paymentMethod==='momo' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300'}`}
                onClick={() => setPaymentMethod('momo')}
              >
                <div className="flex items-center">
                  <div className="w-6 h-6 rounded-full border-2 mr-3 flex items-center justify-center">
                    {paymentMethod === 'momo' && <div className="w-3 h-3 bg-pink-500 rounded-full"></div>}
                  </div>
                  <div className="flex items-center">
                    <div className="w-8 h-8 bg-pink-500 rounded mr-3 flex items-center justify-center">
                      <span className="text-white font-bold text-sm">M</span>
                    </div>
                    <div>
                      <p className="font-semibold text-gray-900">V√≠ MoMo</p>
                      <p className="text-sm text-gray-600">Thanh to√°n qua v√≠ ƒëi·ªán t·ª≠ MoMo</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Banking */}
              <div
                className={`border-2 rounded-lg p-4 cursor-pointer transition-colors ${paymentMethod==='banking' ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
                onClick={() => setPaymentMethod('banking')}
              >
                <div className="flex items-center">
                  <div className="w-6 h-6 rounded-full border-2 mr-3 flex items-center justify-center">
                    {paymentMethod === 'banking' && <div className="w-3 h-3 bg-blue-500 rounded-full"></div>}
                  </div>
                  <div className="flex items-center">
                    <CreditCard className="h-8 w-8 text-blue-600 mr-3" />
                    <div>
                      <p className="font-semibold text-gray-900">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</p>
                      <p className="text-sm text-gray-600">Thanh to√°n qua Internet Banking</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* COD */}
              <div
                className={`border-2 rounded-lg p-4 cursor-pointer transition-colors ${paymentMethod==='cod' ? 'border-green-500 bg-green-50' : 'border-gray-200 hover:border-gray-300'}`}
                onClick={() => setPaymentMethod('cod')}
              >
                <div className="flex items-center">
                  <div className="w-6 h-6 rounded-full border-2 mr-3 flex items-center justify-center">
                    {paymentMethod === 'cod' && <div className="w-3 h-3 bg-green-500 rounded-full"></div>}
                  </div>
                  <div className="flex items-center">
                    <Bus className="h-8 w-8 text-green-600 mr-3" />
                    <div>
                      <p className="font-semibold text-gray-900">Thanh to√°n t·∫°i xe</p>
                      <p className="text-sm text-gray-600">Tr·∫£ ti·ªÅn khi l√™n xe</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* T√≥m t·∫Øt */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">T√≥m t·∫Øt thanh to√°n</h3>
              <div className="space-y-3 mb-6">
                <div className="flex justify-between">
                  <span className="text-gray-600">S·ªë gh·∫ø:</span>
                  <span className="font-medium">{st.seats.length} gh·∫ø</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Gi√° v√©/gh·∫ø:</span>
                  <span className="font-medium">{(st.pricePerSeat || 0).toLocaleString()}‚Ç´</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Ph√≠ d·ªãch v·ª•:</span>
                  <span className="font-medium">0‚Ç´</span>
                </div>
                <div className="border-t pt-3">
                  <div className="flex justify-between text-lg font-bold">
                    <span>T·ªïng c·ªông:</span>
                    <span className="text-blue-600">{totalAmount.toLocaleString()}‚Ç´</span>
                  </div>
                </div>
              </div>

              <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                <div className="flex items-center">
                  <Shield className="h-5 w-5 text-green-600 mr-2" />
                  <span className="text-sm text-green-800">Giao d·ªãch ƒë∆∞·ª£c b·∫£o m·∫≠t v√† m√£ h√≥a SSL</span>
                </div>
              </div>

              <button
                onClick={handlePayment}
                disabled={isProcessing}
                className={`w-full py-3 px-4 rounded-lg font-medium text-lg transition-colors flex items-center justify-center ${isProcessing ? 'bg-gray-400 text-gray-200 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`}
              >
                {isProcessing ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                    ƒêang x·ª≠ l√Ω...
                  </>
                ) : (
                  <>
                    <Lock className="h-5 w-5 mr-2" />
                    Thanh to√°n {totalAmount.toLocaleString()}‚Ç´
                  </>
                )}
              </button>

              <p className="text-xs text-gray-500 text-center mt-3">
                B·∫±ng c√°ch thanh to√°n, b·∫°n ƒë·ªìng √Ω v·ªõi
                <a href="#" className="text-blue-600 hover:underline"> ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a> v√†
                <a href="#" className="text-blue-600 hover:underline"> Ch√≠nh s√°ch b·∫£o m·∫≠t</a>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default PaymentPage;

--- END OF FILE: frontend\src\components\PaymentPage.tsx ---


--- START OF FILE: frontend\src\components\PaymentSuccess.tsx ---
// components/PaymentSuccess.tsx
import React, { useEffect } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { CheckCircle, Bus, MapPin, Clock, Calendar } from 'lucide-react';

type SuccessPayload = {
  bookingId: string;
  paymentId: string;
  route: { from: string; to: string; durationMin: number | null };
  times: { departureTime: string; arrivalTime: string | null };
  bus: { busType: string; seatCount: number };
  seats: (number|string)[];
  passenger: { name?: string; phone?: string; email?: string; note?: string } | null;
  pricePerSeat: number;
  totalAmount: number;
  paymentMethod: 'momo'|'banking'|'cod';
};

const PaymentSuccess: React.FC = () => {
  const { state } = useLocation();
  const navigate = useNavigate();
  const s = (state || null) as SuccessPayload | null;

  if (!s) {
    // n·∫øu F5 m·∫•t state th√¨ quay v·ªÅ trang ch·ªß (ho·∫∑c b·∫°n c√≥ th·ªÉ g·ªçi GET /api/bookings/:id n·∫øu truy·ªÅn id qua query)
    navigate('/');
    return null;
  }

  const fmtTime = (iso?: string | null) => {
    if (!iso) return '-';
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return '-';
    return d.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
  };

  

  // Save the ticket into localStorage so MyTicketsPage (which reads localStorage) shows it
  useEffect(() => {
    if (!s) return;

    try {
      const key = 'vexe7tv_tickets';
      const existing = JSON.parse(localStorage.getItem(key) || '[]');

      // Build ticket shape compatible with MyTicketsPage
      const ticket = {
        id: s.bookingId,
        bookingId: s.bookingId,
        route: {
          from: s.route.from,
          to: s.route.to,
          price: (s.pricePerSeat || 0).toString(),
          duration: s.route.durationMin?.toString() || '',
          departureTime: s.times.departureTime,
          arrivalTime: s.times.arrivalTime || '',
          busType: s.bus.busType || ''
        },
        seats: (s.seats || []).map((x: any) => Number(x)),
        passenger: s.passenger || { name: '', phone: '', email: '', note: '' },
        totalAmount: s.totalAmount || 0,
        paymentMethod: s.paymentMethod,
        bookingDate: new Date().toISOString(),
        status: 'confirmed'
      };

      // avoid duplicates
      const exists = existing.some((t: any) => t.bookingId === ticket.bookingId);
      if (!exists) {
        const updated = [ticket, ...existing];
        localStorage.setItem(key, JSON.stringify(updated));
      }
    } catch (err) {
      console.error('Failed to save ticket to localStorage', err);
    }
  }, [s]);

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4">
            <CheckCircle className="h-12 w-12 text-green-600" />
          </div>
          <h2 className="text-3xl font-bold text-gray-900 mb-2">ƒê·∫∑t v√© th√†nh c√¥ng!</h2>
          <p className="text-gray-600">M√£ ƒë·∫∑t v√©: {s.bookingId}</p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {/* V√© ƒëi·ªán t·ª≠ */}
          <div className="space-y-6">
            <div className="bg-white rounded-xl shadow-lg p-6 border-2 border-green-200">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-bold text-gray-900">V√© ƒëi·ªán t·ª≠</h3>
                <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">ƒê√£ thanh to√°n</span>
              </div>

              <div className="bg-gray-50 rounded-lg p-4 mb-4">
                <div className="text-center mb-4">
                  <div className="text-2xl font-bold text-gray-900 mb-1">VeXe7TV</div>
                  <div className="text-sm text-gray-600">M√£ ƒë·∫∑t v√©: {s.bookingId}</div>
                </div>

                <div className="flex items-center justify-between mb-4">
                  <div className="text-center">
                    <MapPin className="h-6 w-6 text-blue-600 mx-auto mb-1" />
                    <div className="font-semibold text-gray-900">{s.route.from}</div>
                    <div className="text-sm text-gray-600">{fmtTime(s.times.departureTime)}</div>
                  </div>

                  <div className="flex-1 mx-4">
                    <div className="border-t border-dashed border-gray-300"></div>
                    <div className="text-center mt-1">
                      <Clock className="h-4 w-4 inline mr-1" />
                      <span className="text-sm text-gray-600">
                        {s.route.durationMin ? `${Math.floor((s.route.durationMin||0)/60)}h ${(s.route.durationMin||0)%60}m` : '-'}
                      </span>
                    </div>
                  </div>

                  <div className="text-center">
                    <MapPin className="h-6 w-6 text-green-600 mx-auto mb-1" />
                    <div className="font-semibold text-gray-900">{s.route.to}</div>
                    <div className="text-sm text-gray-600">{fmtTime(s.times.arrivalTime)}</div>
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div><span className="text-gray-600">Gh·∫ø:</span><span className="ml-2 font-medium">{s.seats.join(', ')}</span></div>
                  <div><span className="text-gray-600">Lo·∫°i xe:</span><span className="ml-2 font-medium">{s.bus.busType}</span></div>
                  <div><span className="text-gray-600">H√†nh kh√°ch:</span><span className="ml-2 font-medium">{s.passenger?.name || '-'}</span></div>
                  <div><span className="text-gray-600">SƒêT:</span><span className="ml-2 font-medium">{s.passenger?.phone || '-'}</span></div>
                </div>
              </div>

              <button
                onClick={() => window.print()}
                className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
              >
                In / T·∫£i v√© ƒëi·ªán t·ª≠
              </button>
            </div>

            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Th√¥ng tin chuy·∫øn ƒëi</h3>
              <div className="space-y-4">
                <div className="flex items-center">
                  <Calendar className="h-5 w-5 text-blue-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">Ng√†y kh·ªüi h√†nh</p>
                    <p className="text-gray-600">{new Date(s.times.departureTime).toLocaleDateString('vi-VN')}</p>
                  </div>
                </div>
                <div className="flex items-center">
                  <Clock className="h-5 w-5 text-green-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">Gi·ªù kh·ªüi h√†nh</p>
                    <p className="text-gray-600">{fmtTime(s.times.departureTime)}</p>
                  </div>
                </div>
                <div className="flex items-center">
                  <Bus className="h-5 w-5 text-purple-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">Lo·∫°i xe</p>
                    <p className="text-gray-600">{s.bus.busType}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Thanh to√°n */}
          <div className="space-y-6">
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Chi ti·∫øt thanh to√°n</h3>
              <div className="space-y-3 mb-4">
                <div className="flex justify-between"><span className="text-gray-600">M√£ ƒë·∫∑t v√©:</span><span className="font-medium">{s.bookingId}</span></div>
                <div className="flex justify-between"><span className="text-gray-600">M√£ thanh to√°n:</span><span className="font-medium">{s.paymentId}</span></div>
                <div className="flex justify-between"><span className="text-gray-600">Ph∆∞∆°ng th·ª©c:</span><span className="font-medium">{s.paymentMethod === 'momo' ? 'V√≠ MoMo' : s.paymentMethod === 'cod' ? 'Thanh to√°n t·∫°i xe' : 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng'}</span></div>
                <div className="flex justify-between"><span className="text-gray-600">S·ªë gh·∫ø:</span><span className="font-medium">{s.seats.length} gh·∫ø</span></div>
                <div className="flex justify-between"><span className="text-gray-600">Gi√° v√©/gh·∫ø:</span><span className="font-medium">{(s.pricePerSeat || 0).toLocaleString()}‚Ç´</span></div>
                <div className="border-t pt-3">
                  <div className="flex justify-between text-lg font-bold">
                    <span>T·ªïng thanh to√°n:</span>
                    <span className="text-green-600">{(s.totalAmount || 0).toLocaleString()}‚Ç´</span>
                  </div>
                </div>
              </div>
              <button
                onClick={() => navigate('/')}
                className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium"
              >
                V·ªÅ trang ch·ªß
              </button>
            </div>
          </div>
        </div>

        {/* footer nh·ªè */}
        <div className="mt-12 text-center text-sm text-gray-500">
          C·∫ßn h·ªó tr·ª£? Hotline 1900 1234 ‚Ä¢ support@vexe7tv.com
        </div>
      </div>
    </div>
  );
};

export default PaymentSuccess;

--- END OF FILE: frontend\src\components\PaymentSuccess.tsx ---


--- START OF FILE: frontend\src\components\RegisterPage.tsx ---
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { ArrowLeft, Lock, Mail, User, Phone } from 'lucide-react';

const API_BASE = ((import.meta as any)?.env?.VITE_BACKEND_URL as string) || 'http://localhost:5000';

const RegisterPage: React.FC = () => {
  const navigate = useNavigate();
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    password: '',
    confirmPassword: ''
  });
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);

    // Validate password match
    if (formData.password !== formData.confirmPassword) {
      setError('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp');
      return;
    }

    setLoading(true);

    try {
      const response = await fetch(`${API_BASE}/api/auth/register`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify({
          name: formData.name,
          email: formData.email,
          phone: formData.phone,
          password: formData.password
        }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.message || 'ƒêƒÉng k√Ω th·∫•t b·∫°i');
      }

      // Redirect to login page with success message
      navigate('/login', { state: { message: 'ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.' } });
    } catch (err: any) {
      setError(err.message || 'ƒê√£ x·∫£y ra l·ªói khi ƒëƒÉng k√Ω');
    } finally {
      setLoading(false);
    }
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button
              onClick={() => navigate('/')}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay l·∫°i
            </button>
          </div>
        </div>
      </header>

      <div className="flex-grow flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div className="max-w-md w-full space-y-8">
          <div>
            <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
              ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi
            </h2>
            <p className="mt-2 text-center text-sm text-gray-600">
              Ho·∫∑c{' '}
              <button
                onClick={() => navigate('/login')}
                className="font-medium text-blue-600 hover:text-blue-500"
              >
                ƒëƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n hi·ªán c√≥
              </button>
            </p>
          </div>

          <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
            {error && (
              <div className="rounded-md bg-red-50 p-4">
                <div className="text-sm text-red-700">{error}</div>
              </div>
            )}

            <div className="rounded-md shadow-sm -space-y-px">
              <div>
                <label htmlFor="name" className="sr-only">
                  H·ªç v√† t√™n
                </label>
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <User className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="name"
                    name="name"
                    type="text"
                    required
                    value={formData.name}
                    onChange={handleChange}
                    className="appearance-none rounded-none relative block w-full px-3 py-2 pl-10 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                    placeholder="H·ªç v√† t√™n"
                  />
                </div>
              </div>
              <div>
                <label htmlFor="email" className="sr-only">
                  Email
                </label>
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Mail className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="email"
                    name="email"
                    type="email"
                    autoComplete="email"
                    required
                    value={formData.email}
                    onChange={handleChange}
                    className="appearance-none rounded-none relative block w-full px-3 py-2 pl-10 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                    placeholder="Email"
                  />
                </div>
              </div>
              <div>
                <label htmlFor="phone" className="sr-only">
                  S·ªë ƒëi·ªán tho·∫°i
                </label>
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Phone className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="phone"
                    name="phone"
                    type="tel"
                    required
                    value={formData.phone}
                    onChange={handleChange}
                    className="appearance-none rounded-none relative block w-full px-3 py-2 pl-10 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                    placeholder="S·ªë ƒëi·ªán tho·∫°i"
                  />
                </div>
              </div>
              <div>
                <label htmlFor="password" className="sr-only">
                  M·∫≠t kh·∫©u
                </label>
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Lock className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="password"
                    name="password"
                    type="password"
                    required
                    value={formData.password}
                    onChange={handleChange}
                    className="appearance-none rounded-none relative block w-full px-3 py-2 pl-10 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                    placeholder="M·∫≠t kh·∫©u"
                  />
                </div>
              </div>
              <div>
                <label htmlFor="confirmPassword" className="sr-only">
                  X√°c nh·∫≠n m·∫≠t kh·∫©u
                </label>
                <div className="relative">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Lock className="h-5 w-5 text-gray-400" />
                  </div>
                  <input
                    id="confirmPassword"
                    name="confirmPassword"
                    type="password"
                    required
                    value={formData.confirmPassword}
                    onChange={handleChange}
                    className="appearance-none rounded-none relative block w-full px-3 py-2 pl-10 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                    placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u"
                  />
                </div>
              </div>
            </div>

            <div>
              <button
                type="submit"
                disabled={loading}
                className={`group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white ${
                  loading
                    ? 'bg-blue-400 cursor-not-allowed'
                    : 'bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500'
                }`}
              >
                {loading ? 'ƒêang x·ª≠ l√Ω...' : 'ƒêƒÉng k√Ω'}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
};

export default RegisterPage;
--- END OF FILE: frontend\src\components\RegisterPage.tsx ---


--- START OF FILE: frontend\src\components\RoutesPage.tsx ---
import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { ArrowLeft, Bus, MapPin, Clock, Star, Search, Calendar, Filter } from 'lucide-react';

interface Route {
  id: string;
  from: string;
  to: string;
  price: string;
  duration: string;
  departureTime: string;
  arrivalTime: string;
  busType: string;
  availableSeats: number;
  rating: number;
  company: string;
  features: string[];
}

const API_BASE = ((import.meta as any)?.env?.VITE_BACKEND_URL as string) || '';

const RoutesPage: React.FC = () => {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  
  // Get initial search values from URL params
  const fromParam = searchParams.get('from') || '';
  const toParam = searchParams.get('to') || '';
  const dateParam = searchParams.get('date') || '';
  
  // Build search term from from/to params
  const initialSearchTerm = [fromParam, toParam].filter(Boolean).join(' ');
  
  const [searchTerm, setSearchTerm] = useState(initialSearchTerm);
  const [selectedDate, setSelectedDate] = useState(dateParam);
  const [sortBy, setSortBy] = useState<'price' | 'duration' | 'rating'>('price');
  const [filterBusType, setFilterBusType] = useState<string>('all');
  const [routes, setRoutes] = useState<Route[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  // Debounced search term to prevent frequent re-renders
  const [debouncedSearchTerm, setDebouncedSearchTerm] = useState(searchTerm);
  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedSearchTerm(searchTerm);
    }, 300);
    return () => clearTimeout(timer);
  }, [searchTerm]);

  // Update search term when URL params change
  useEffect(() => {
    const newSearchTerm = [fromParam, toParam].filter(Boolean).join(' ');
    if (newSearchTerm && newSearchTerm !== searchTerm) {
      setSearchTerm(newSearchTerm);
    }
  }, [fromParam, toParam]);

  const handleDateChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const newDate = e.target.value;
    setSelectedDate(newDate);
    
    // Update URL to trigger data refetch
    const params = new URLSearchParams(window.location.search);
    if (newDate) {
      params.set('date', newDate);
    } else {
      params.delete('date');
    }
    navigate(`?${params.toString()}`, { replace: true });
  };

  useEffect(() => {
    let mounted = true;
    const fetchRoutes = async () => {
      try {
        setLoading(true);
        // Build the URL with date query param if available
        let url = `${API_BASE}/api/routes/detailed`;
        if (dateParam) {
          url += `?date=${dateParam}`;
        }
        
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (mounted) {
          setRoutes(data.map((r: any) => ({
            id: r._id || r.id,
            from: r.from_city || r.from || r.name || '‚Äî',
            to: r.to_city || r.to || '‚Äî',
            price: r.base_price ? String(r.base_price) : '',
            duration: r.estimated_duration_min ? `${Math.round(r.estimated_duration_min/60)}h` : (r.duration || ''),
            departureTime: r.start_time ? new Date(r.start_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '',
            arrivalTime: r.end_time ? new Date(r.end_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '',
            busType: r.bus_type || '',
            availableSeats: typeof r.availableSeats === 'number' ? r.availableSeats : 0,
            rating: r.avgRating ? Math.round(r.avgRating * 10) / 10 : 0,
            company: r.company || '',
            features: r.features || []
          })));
          setLoading(false);
        }
      } catch (err: any) {
        if (mounted) {
          setError(err.message || 'L·ªói khi t·∫£i tuy·∫øn');
          setLoading(false);
        }
      }
    };

    fetchRoutes();
    return () => { mounted = false; };
  }, [dateParam]);

  // Memoize filtered and sorted routes
  const filteredRoutes = useMemo(() => {
    return routes
      .filter(route => {
        // If we have specific from/to params, match them exactly
        let matchesSearch = true;
        if (fromParam || toParam) {
          const fromMatch = !fromParam || route.from.toLowerCase().includes(fromParam.toLowerCase());
          const toMatch = !toParam || route.to.toLowerCase().includes(toParam.toLowerCase());
          matchesSearch = fromMatch && toMatch;
        } else if (debouncedSearchTerm) {
          // Otherwise use general search
          matchesSearch = route.from.toLowerCase().includes(debouncedSearchTerm.toLowerCase()) ||
                         route.to.toLowerCase().includes(debouncedSearchTerm.toLowerCase());
        }
        const matchesBusType = filterBusType === 'all' || route.busType.includes(filterBusType);
        return matchesSearch && matchesBusType;
      })
      .sort((a, b) => {
        switch (sortBy) {
          case 'price':
            return parseInt(a.price.replace(',', '')) - parseInt(b.price.replace(',', ''));
          case 'duration':
            return parseInt(a.duration.replace('h', '')) - parseInt(b.duration.replace('h', ''));
          case 'rating':
            return b.rating - a.rating;
          default:
            return 0;
        }
      });
  }, [routes, debouncedSearchTerm, filterBusType, sortBy]);

  const handleBookingClick = useCallback((routeId: string) => {
    navigate(`/booking/${routeId}`);
  }, [navigate]);

  // Memoize stats calculations
  const stats = useMemo(() => ({
    totalRoutes: routes.length,
    totalSeats: routes.reduce((sum, route) => sum + route.availableSeats, 0),
    averageRating: routes.length ? Math.round((routes.reduce((sum, route) => sum + route.rating, 0) / routes.length) * 10) / 10 : 0,
    uniqueCompanies: new Set(routes.map(route => route.company)).size
  }), [routes]);

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <Bus className="h-16 w-16 text-gray-400 mx-auto mb-4" />
          <div className="text-lg font-medium">ƒêang t·∫£i danh s√°ch tuy·∫øn...</div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center text-red-600">L·ªói: {error}</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button 
              onClick={() => navigate('/')}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay l·∫°i
            </button>
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Page Header */}
        <div className="text-center mb-8">
          <h2 className="text-3xl font-bold text-gray-900 mb-2">T·∫•t c·∫£ tuy·∫øn ƒë∆∞·ªùng</h2>
          <p className="text-gray-600">Kh√°m ph√° c√°c tuy·∫øn ƒë∆∞·ªùng xe kh√°ch c√≥ s·∫µn</p>
        </div>

        {/* Search and Filter */}
        <div className="bg-white rounded-xl shadow-md p-6 mb-8">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div className="relative">
              <Search className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
              <input
                type="text"
                placeholder="T√¨m ki·∫øm tuy·∫øn ƒë∆∞·ªùng..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div className="relative">
              <Calendar className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
              <input
                type="date"
                value={selectedDate}
                onChange={handleDateChange}
                className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
            
            <div className="relative">
              <Filter className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
              <select
                value={filterBusType}
                onChange={(e) => setFilterBusType(e.target.value)}
                className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none"
              >
                <option value="all">T·∫•t c·∫£ lo·∫°i xe</option>
                <option value="Xe ng·ªìi">Xe ng·ªìi</option>
                <option value="Xe gi∆∞·ªùng n·∫±m">Xe gi∆∞·ªùng n·∫±m</option>
                <option value="VIP">Xe VIP</option>
              </select>
            </div>
            
            <div className="relative">
              <Calendar className="absolute left-3 top-3 h-5 w-5 text-gray-400" />
              <select
                value={sortBy}
                onChange={(e) => setSortBy(e.target.value as 'price' | 'duration' | 'rating')}
                className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none"
              >
                <option value="price">S·∫Øp x·∫øp theo gi√°</option>
                <option value="duration">S·∫Øp x·∫øp theo th·ªùi gian</option>
                <option value="rating">S·∫Øp x·∫øp theo ƒë√°nh gi√°</option>
              </select>
            </div>
          </div>
        </div>

        {/* Routes Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredRoutes.map((route) => (
            <div key={route.id} className="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition-shadow">
              {/* Route Header */}
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center">
                  <MapPin className="h-5 w-5 text-blue-600 mr-2" />
                  <span className="font-medium text-gray-900">{route.from}</span>
                </div>
                <div className="flex-1 mx-4">
                  <div className="border-t border-dashed border-gray-300"></div>
                </div>
                <div className="flex items-center">
                  <MapPin className="h-5 w-5 text-green-600 mr-2" />
                  <span className="font-medium text-gray-900">{route.to}</span>
                </div>
              </div>

              {/* Route Info */}
              <div className="space-y-3 mb-4">
                <div className="flex justify-between items-center">
                  <div className="flex items-center text-sm text-gray-600">
                    <Clock className="h-4 w-4 mr-1" />
                    {route.duration}
                  </div>
                  <div className="text-lg font-bold text-blue-600">
                    {route.price}‚Ç´
                  </div>
                </div>
                
                <div className="flex justify-between items-center text-sm">
                  <span className="text-gray-600">Gi·ªù kh·ªüi h√†nh:</span>
                  <span className="font-medium">{route.departureTime}</span>
                </div>
                
                <div className="flex justify-between items-center text-sm">
                  <span className="text-gray-600">Lo·∫°i xe:</span>
                  <span className="font-medium">{route.busType}</span>
                </div>
                
                <div className="flex justify-between items-center text-sm">
                  <span className="text-gray-600">Nh√† xe:</span>
                  <span className="font-medium">{route.company}</span>
                </div>
                
                <div className="flex justify-between items-center text-sm">
                  <span className="text-gray-600">Gh·∫ø tr·ªëng:</span>
                  <span className="font-medium text-green-600">{route.availableSeats} gh·∫ø</span>
                </div>
              </div>

              {/* Rating */}
              <div className="flex items-center mb-4">
                <div className="flex items-center">
                  {[...Array(5)].map((_, i) => (
                    <Star
                      key={i}
                      className={`h-4 w-4 ${
                        i < Math.floor(route.rating)
                          ? 'text-yellow-400 fill-current'
                          : 'text-gray-300'
                      }`}
                    />
                  ))}
                </div>
                <span className="ml-2 text-sm text-gray-600">{route.rating}/5</span>
              </div>

              {/* Features */}
              <div className="mb-4">
                <div className="flex flex-wrap gap-2">
                  {route.features.map((feature, index) => (
                    <span
                      key={index}
                      className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full"
                    >
                      {feature}
                    </span>
                  ))}
                </div>
              </div>

              {/* Book Button */}
              <button
                onClick={() => handleBookingClick(route.id)}
                className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium"
              >
                ƒê·∫∑t v√© ngay
              </button>
            </div>
          ))}
        </div>

        {/* No Results */}
        {filteredRoutes.length === 0 && (
          <div className="text-center py-12">
            <Bus className="h-16 w-16 text-gray-400 mx-auto mb-4" />
            <h3 className="text-xl font-semibold text-gray-900 mb-2">Kh√¥ng t√¨m th·∫•y tuy·∫øn ƒë∆∞·ªùng</h3>
            <p className="text-gray-600">Vui l√≤ng th·ª≠ l·∫°i v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c b·ªô l·ªçc kh√°c</p>
          </div>
        )}

        {/* Stats */}
        <div className="mt-12 bg-white rounded-xl shadow-md p-6">
          <h3 className="text-xl font-bold text-gray-900 mb-4">Th·ªëng k√™</h3>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div className="text-center p-4 bg-blue-50 rounded-lg">
              <div className="text-2xl font-bold text-blue-600">{stats.totalRoutes}</div>
                <div className="text-sm text-gray-600">T·ªïng tuy·∫øn ƒë∆∞·ªùng</div>
            </div>
            <div className="text-center p-4 bg-green-50 rounded-lg">
                <div className="text-2xl font-bold text-green-600">
                  {stats.totalSeats}
                </div>
              <div className="text-sm text-gray-600">Gh·∫ø c√≥ s·∫µn</div>
            </div>
            <div className="text-center p-4 bg-yellow-50 rounded-lg">
              <div className="text-2xl font-bold text-yellow-600">
                  {stats.averageRating}
              </div>
              <div className="text-sm text-gray-600">ƒê√°nh gi√° trung b√¨nh</div>
            </div>
            <div className="text-center p-4 bg-purple-50 rounded-lg">
              <div className="text-2xl font-bold text-purple-600">
                  {stats.uniqueCompanies}
              </div>
              <div className="text-sm text-gray-600">Nh√† xe</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default RoutesPage;

--- END OF FILE: frontend\src\components\RoutesPage.tsx ---


--- START OF FILE: frontend\src\components\TicketDetailPage.tsx ---
import React from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { ArrowLeft, Bus, MapPin, Clock, Calendar, Download, Home, User, Phone, Mail, FileText } from 'lucide-react';

interface Ticket {
  id: string;
  bookingId: string;
  route: {
    from: string;
    to: string;
    price: string;
    duration: string;
    departureTime: string;
    arrivalTime: string;
    busType: string;
  };
  seats: number[];
  passenger: {
    name: string;
    phone: string;
    email: string;
    note: string;
  };
  totalAmount: number;
  paymentMethod: string;
  bookingDate: string;
  status: 'confirmed' | 'cancelled' | 'used';
}

const TicketDetailPage: React.FC = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const ticket = location.state?.ticket as Ticket;

  if (!ticket) {
    navigate('/my-tickets');
    return null;
  }

  const handleDownloadTicket = () => {
    // Simulate ticket download
    alert(`ƒêang t·∫£i xu·ªëng v√© ${ticket.bookingId}`);
  };

  const handleBackToTickets = () => {
    navigate('/my-tickets');
  };

  const handleBackToHome = () => {
    navigate('/');
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'confirmed': return 'bg-green-100 text-green-800';
      case 'cancelled': return 'bg-red-100 text-red-800';
      case 'used': return 'bg-gray-100 text-gray-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const getStatusText = (status: string) => {
    switch (status) {
      case 'confirmed': return 'ƒê√£ x√°c nh·∫≠n';
      case 'cancelled': return 'ƒê√£ h·ªßy';
      case 'used': return 'ƒê√£ s·ª≠ d·ª•ng';
      default: return 'Kh√¥ng x√°c ƒë·ªãnh';
    }
  };

  const getPaymentMethodText = (method: string) => {
    switch (method) {
      case 'momo': return 'V√≠ MoMo';
      case 'banking': return 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng';
      case 'cod': return 'Thanh to√°n t·∫°i xe';
      default: return 'Kh√¥ng x√°c ƒë·ªãnh';
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center py-4">
            <button 
              onClick={handleBackToTickets}
              className="flex items-center text-gray-600 hover:text-blue-600 mr-4"
            >
              <ArrowLeft className="h-5 w-5 mr-2" />
              Quay l·∫°i
            </button>
            <div className="flex items-center">
              <Bus className="h-8 w-8 text-blue-600" />
              <h1 className="ml-2 text-2xl font-bold text-gray-900">VeXe7TV</h1>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Page Header */}
        <div className="text-center mb-8">
          <h2 className="text-3xl font-bold text-gray-900 mb-2">Chi ti·∫øt v√©</h2>
          <p className="text-gray-600">Th√¥ng tin ƒë·∫ßy ƒë·ªß v·ªÅ v√© ƒë√£ ƒë·∫∑t</p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {/* V√© ƒëi·ªán t·ª≠ */}
          <div className="space-y-6">
            {/* V√© ƒëi·ªán t·ª≠ */}
            <div className="bg-white rounded-xl shadow-lg p-6 border-2 border-green-200">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-bold text-gray-900">V√© ƒëi·ªán t·ª≠</h3>
                <span className={`px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(ticket.status)}`}>
                  {getStatusText(ticket.status)}
                </span>
              </div>
              
              <div className="bg-gray-50 rounded-lg p-4 mb-4">
                <div className="text-center mb-4">
                  <div className="text-2xl font-bold text-gray-900 mb-1">VeXe7TV</div>
                  <div className="text-sm text-gray-600">M√£ ƒë·∫∑t v√©: {ticket.bookingId}</div>
                </div>
                
                <div className="flex items-center justify-between mb-4">
                  <div className="text-center">
                    <MapPin className="h-6 w-6 text-blue-600 mx-auto mb-1" />
                    <div className="font-semibold text-gray-900">{ticket.route.from}</div>
                    <div className="text-sm text-gray-600">{ticket.route.departureTime}</div>
                  </div>
                  
                  <div className="flex-1 mx-4">
                    <div className="border-t border-dashed border-gray-300"></div>
                    <div className="text-center mt-1">
                      <Clock className="h-4 w-4 inline mr-1" />
                      <span className="text-sm text-gray-600">{ticket.route.duration}</span>
                    </div>
                  </div>
                  
                  <div className="text-center">
                    <MapPin className="h-6 w-6 text-green-600 mx-auto mb-1" />
                    <div className="font-semibold text-gray-900">{ticket.route.to}</div>
                    <div className="text-sm text-gray-600">{ticket.route.arrivalTime}</div>
                  </div>
                </div>
                
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span className="text-gray-600">Gh·∫ø:</span>
                    <span className="ml-2 font-medium">{ticket.seats.join(', ')}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">Lo·∫°i xe:</span>
                    <span className="ml-2 font-medium">{ticket.route.busType}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">H√†nh kh√°ch:</span>
                    <span className="ml-2 font-medium">{ticket.passenger.name}</span>
                  </div>
                  <div>
                    <span className="text-gray-600">SƒêT:</span>
                    <span className="ml-2 font-medium">{ticket.passenger.phone}</span>
                  </div>
                </div>
              </div>
              
              <button
                onClick={handleDownloadTicket}
                className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center"
              >
                <Download className="h-5 w-5 mr-2" />
                T·∫£i v√© ƒëi·ªán t·ª≠
              </button>
            </div>

            {/* Th√¥ng tin chuy·∫øn ƒëi */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Th√¥ng tin chuy·∫øn ƒëi</h3>
              
              <div className="space-y-4">
                <div className="flex items-center">
                  <Calendar className="h-5 w-5 text-blue-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">Ng√†y ƒë·∫∑t v√©</p>
                    <p className="text-gray-600">{new Date(ticket.bookingDate).toLocaleDateString('vi-VN')}</p>
                  </div>
                </div>
                
                <div className="flex items-center">
                  <Clock className="h-5 w-5 text-green-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">Gi·ªù kh·ªüi h√†nh</p>
                    <p className="text-gray-600">{ticket.route.departureTime}</p>
                  </div>
                </div>
                
                <div className="flex items-center">
                  <Bus className="h-5 w-5 text-purple-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">Lo·∫°i xe</p>
                    <p className="text-gray-600">{ticket.route.busType}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Th√¥ng tin chi ti·∫øt */}
          <div className="space-y-6">
            {/* Th√¥ng tin h√†nh kh√°ch */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Th√¥ng tin h√†nh kh√°ch</h3>
              
              <div className="space-y-4">
                <div className="flex items-center">
                  <User className="h-5 w-5 text-blue-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">H·ªç v√† t√™n</p>
                    <p className="text-gray-600">{ticket.passenger.name}</p>
                  </div>
                </div>
                
                <div className="flex items-center">
                  <Phone className="h-5 w-5 text-green-600 mr-3" />
                  <div>
                    <p className="font-semibold text-gray-900">S·ªë ƒëi·ªán tho·∫°i</p>
                    <p className="text-gray-600">{ticket.passenger.phone}</p>
                  </div>
                </div>
                
                {ticket.passenger.email && (
                  <div className="flex items-center">
                    <Mail className="h-5 w-5 text-purple-600 mr-3" />
                    <div>
                      <p className="font-semibold text-gray-900">Email</p>
                      <p className="text-gray-600">{ticket.passenger.email}</p>
                    </div>
                  </div>
                )}
                
                {ticket.passenger.note && (
                  <div className="flex items-center">
                    <FileText className="h-5 w-5 text-orange-600 mr-3" />
                    <div>
                      <p className="font-semibold text-gray-900">Ghi ch√∫</p>
                      <p className="text-gray-600">{ticket.passenger.note}</p>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Chi ti·∫øt thanh to√°n */}
            <div className="bg-white rounded-xl shadow-md p-6">
              <h3 className="text-xl font-bold text-gray-900 mb-4">Chi ti·∫øt thanh to√°n</h3>
              
              <div className="space-y-3 mb-4">
                <div className="flex justify-between">
                  <span className="text-gray-600">M√£ ƒë·∫∑t v√©:</span>
                  <span className="font-medium">{ticket.bookingId}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Ph∆∞∆°ng th·ª©c thanh to√°n:</span>
                  <span className="font-medium">{getPaymentMethodText(ticket.paymentMethod)}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">S·ªë gh·∫ø:</span>
                  <span className="font-medium">{ticket.seats.length} gh·∫ø</span>
                </div>
                {/* Removed explicit 'Gh·∫ø ƒë√£ ch·ªçn' row to avoid duplicate display */}
                <div className="flex justify-between">
                  <span className="text-gray-600">Gi√° v√©/gh·∫ø:</span>
                  <span className="font-medium">{ticket.route.price}‚Ç´</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Ph√≠ d·ªãch v·ª•:</span>
                  <span className="font-medium">0‚Ç´</span>
                </div>
                <div className="border-t pt-3">
                  <div className="flex justify-between text-lg font-bold">
                    <span>T·ªïng thanh to√°n:</span>
                    <span className="text-green-600">{ticket.totalAmount.toLocaleString()}‚Ç´</span>
                  </div>
                </div>
              </div>
            </div>

            {/* L∆∞u √Ω quan tr·ªçng */}
            <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-6">
              <h3 className="text-lg font-bold text-yellow-800 mb-3">L∆∞u √Ω quan tr·ªçng</h3>
              <ul className="space-y-2 text-sm text-yellow-700">
                <li>‚Ä¢ Vui l√≤ng c√≥ m·∫∑t t·∫°i b·∫øn xe tr∆∞·ªõc gi·ªù kh·ªüi h√†nh 30 ph√∫t</li>
                <li>‚Ä¢ Mang theo CMND/CCCD ƒë·ªÉ ƒë·ªëi chi·∫øu khi l√™n xe</li>
                <li>‚Ä¢ V√© ƒëi·ªán t·ª≠ ƒë√£ ƒë∆∞·ª£c g·ª≠i v·ªÅ email c·ªßa b·∫°n</li>
                <li>‚Ä¢ Li√™n h·ªá hotline 1900 1234 n·∫øu c·∫ßn h·ªó tr·ª£</li>
              </ul>
            </div>

            {/* H√†nh ƒë·ªông */}
            <div className="space-y-3">
              <button
                onClick={handleBackToTickets}
                className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center font-medium"
              >
                <ArrowLeft className="h-5 w-5 mr-2" />
                V·ªÅ danh s√°ch v√©
              </button>
              
              <button
                onClick={handleBackToHome}
                className="w-full bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center font-medium"
              >
                <Home className="h-5 w-5 mr-2" />
                V·ªÅ trang ch·ªß
              </button>
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="mt-12 text-center">
          <div className="bg-white rounded-xl shadow-md p-6">
            <h3 className="text-lg font-bold text-gray-900 mb-2">C·∫ßn h·ªó tr·ª£?</h3>
            <p className="text-gray-600 mb-4">
              N·∫øu b·∫°n c√≥ b·∫•t k·ª≥ th·∫Øc m·∫Øc n√†o v·ªÅ chuy·∫øn ƒëi, vui l√≤ng li√™n h·ªá v·ªõi ch√∫ng t√¥i
            </p>
            <div className="flex justify-center space-x-6 text-sm">
              <div className="flex items-center">
                <span className="font-medium">Hotline:</span>
                <span className="ml-2 text-blue-600">1900 1234</span>
              </div>
              <div className="flex items-center">
                <span className="font-medium">Email:</span>
                <span className="ml-2 text-blue-600">support@vexe7tv.com</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default TicketDetailPage;

--- END OF FILE: frontend\src\components\TicketDetailPage.tsx ---


--- START OF FILE: frontend\src\main.tsx ---
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const root = ReactDOM.createRoot(
  document.getElementById('root') as HTMLElement
);

root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);

--- END OF FILE: frontend\src\main.tsx ---


--- START OF FILE: frontend\tsconfig.json ---
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}

--- END OF FILE: frontend\tsconfig.json ---


--- START OF FILE: frontend\tsconfig.node.json ---
{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}

--- END OF FILE: frontend\tsconfig.node.json ---


--- START OF FILE: frontend\vite.config.ts ---
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:5000',
        changeOrigin: true
      }
    }
  }
})

--- END OF FILE: frontend\vite.config.ts ---
