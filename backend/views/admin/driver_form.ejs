<!DOCTYPE html>
<html lang="vi">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title><%= driver ? 'Sửa tài xế' : 'Thêm tài xế mới' %> - Admin</title>
	<style>
		body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:#f5f7fa;color:#333}
		.container{max-width:900px;margin:3rem auto;background:white;padding:2rem;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
		h2{margin-bottom:1.5rem;color:#1e3a8a}
		label{display:block;margin-top:1rem;font-weight:600;color:#374151}
		input[type=text], input[type=email], input[type=tel], input[type=number], select {
			width:100%; padding:0.75rem; border:1px solid #e5e7eb; border-radius:6px; font-size:0.95rem; margin-top: 0.25rem;
		}
		input:focus, select:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.1)}
		.form-group{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
		.trips-section{margin-top:2rem;padding-top:2rem;border-top:2px solid #e5e7eb}
		.trips-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(240px, 1fr));gap:0.75rem;margin-top:1rem;max-height:320px;overflow-y:auto;padding:1rem;background:#f9fafb;border-radius:6px}
		.trip-item{display:flex;align-items:center;gap:0.5rem}
		.trip-item input[type=checkbox]{width:auto}
		.actions{margin-top:2rem;display:flex;gap:0.75rem}
		.btn{padding:0.75rem 1.5rem;border-radius:6px;border:none;cursor:pointer;font-weight:600;text-decoration:none;display:inline-block}
		.btn-primary{background:#6366f1;color:white}
		.btn-primary:hover{background:#4f46e5}
		.btn-secondary{background:#e5e7eb;color:#374151}
		.btn-secondary:hover{background:#d1d5db}
		.help-text{font-size:0.875rem;color:#6b7280;margin-top:0.25rem}
		.error-msg { color: #dc2626; font-size: 0.85rem; margin-top: 0.25rem; display: none; }
		.input-error { border-color: #dc2626 !important; background-color: #fef2f2; }
	</style>
</head>
<body>
	<div class="container">
		<h2><%= driver ? 'Sửa thông tin tài xế' : 'Thêm tài xế mới' %></h2>

		<form id="driverForm" method="post" action="<%= driver ? ('/admin/drivers/' + driver._id) : '/admin/drivers' %>">

			<div class="form-group">
				<div>
					<label>Họ tên *</label>
					<input type="text" id="name" name="name" value="<%= driver ? driver.name : '' %>" placeholder="Nhập họ tên" />
					<div class="error-msg" id="error-name">Vui lòng nhập họ tên</div>
				</div>
				<div>
					<label>Email *</label>
					<input type="email" id="email" name="email" value="<%= driver ? driver.email : '' %>" placeholder="email@example.com" />
					<div class="error-msg" id="error-email">Email không hợp lệ</div>
				</div>
			</div>

			<div class="form-group">
				<div>
					<label>Số điện thoại *</label>
					<input type="tel" id="phone" name="phone" value="<%= driver ? driver.phone : '' %>" placeholder="09xx..." maxlength="11" oninput="this.value = this.value.replace(/[^0-9\+]/g, '')" />
					<div class="error-msg" id="error-phone">Số điện thoại không hợp lệ</div>
				</div>
				<div>
					<label>Mã nhân viên</label>
					<input type="text" name="employee_id" value="<%= driver ? driver.employee_id : '' %>" placeholder="VD: TX001" />
				</div>
			</div>

			<div class="form-group">
				<div>
					<label>Số giấy phép lái xe</label>
					<input type="text" name="license_number" value="<%= driver ? driver.license_number : '' %>" placeholder="VD: BKS-12345" />
				</div>
				<div>
					<label>Số năm kinh nghiệm</label>
					<input type="number" name="experience_years" value="<%= driver ? driver.experience_years : 0 %>" min="0" />
				</div>
			</div>

			<div>
				<label>Trạng thái</label>
				<select name="status">
					<option value="active" <%= driver && driver.status === 'active' ? 'selected' : '' %>>Đang hoạt động</option>
					<option value="inactive" <%= driver && driver.status === 'inactive' ? 'selected' : '' %>>Không hoạt động</option>
				</select>
			</div>

			<% if (trips) { %>
				<div class="trips-section">
					<h3 style="margin-bottom:1rem;color:#1e3a8a">Gán chuyến cho tài xế</h3>
					<div class="help-text">Chọn các chuyến mà tài xế này sẽ phụ trách (tuỳ chọn).</div>
					<div class="trips-grid">
						<% trips.forEach(function(trip) { 
							const isAssigned = driver && driver.assigned_trips && driver.assigned_trips.some(t => {
								const tid = typeof t === 'object' ? (t._id ? t._id.toString() : '') : t.toString();
								return tid === trip._id.toString();
							});
						%>
							<div class="trip-item">
								<input type="checkbox" name="assigned_trips" value="<%= trip._id %>" <%= isAssigned ? 'checked' : '' %> />
								<label style="font-weight:normal;margin:0;cursor:pointer;">
									<%= (trip.route && (trip.route.from_city || trip.route.origin) ? (trip.route.from_city || trip.route.origin) : '---') %> → 
									<%= (trip.route && (trip.route.to_city || trip.route.destination) ? (trip.route.to_city || trip.route.destination) : '---') %>
									<span style="color:#6b7280;font-size:0.85rem;display:block;margin-top:0.25rem;">
										<%= trip.start_time ? (new Date(trip.start_time)).toLocaleString() : 'Thời gian chưa đặt' %>
										<% if (trip.bus && trip.bus.license_plate) { %> · <%= trip.bus.license_plate %> <% } %>
									</span>
								</label>
							</div>
						<% }); %>
					</div>
				</div>
			<% } %>

			<div class="actions">
				<button type="submit" class="btn btn-primary"><%= driver ? 'Cập nhật' : 'Tạo mới' %></button>
				<a href="/admin/drivers" class="btn btn-secondary">Hủy</a>
			</div>
		</form>
	</div>

	<script>
		const form = document.getElementById('driverForm');
		const nameInput = document.getElementById('name');
		const phoneInput = document.getElementById('phone');
		const emailInput = document.getElementById('email');

		function showError(input, errorId, show) {
				const errorDiv = document.getElementById(errorId);
				if (show) {
						errorDiv.style.display = 'block';
						input.classList.add('input-error');
				} else {
						errorDiv.style.display = 'none';
						input.classList.remove('input-error');
				}
		}

		form.addEventListener('submit', function(e) {
				let isValid = true;

				if (!nameInput.value.trim()) {
						showError(nameInput, 'error-name', true);
						isValid = false;
				} else {
						showError(nameInput, 'error-name', false);
				}

				const phoneRegex = /^(0|\+84)[0-9]{9,10}$/;
				if (!phoneInput.value.match(phoneRegex)) {
						showError(phoneInput, 'error-phone', true);
						isValid = false;
				} else {
						showError(phoneInput, 'error-phone', false);
				}

				const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
				if (!emailInput.value.trim() || !emailInput.value.match(emailRegex)) {
						showError(emailInput, 'error-email', true);
						isValid = false;
				} else {
						showError(emailInput, 'error-email', false);
				}

				if (!isValid) e.preventDefault();
		});

		[nameInput, phoneInput, emailInput].forEach(input => {
				input.addEventListener('input', function() {
						this.classList.remove('input-error');
						if(this.id === 'name') document.getElementById('error-name').style.display = 'none';
						if(this.id === 'phone') document.getElementById('error-phone').style.display = 'none';
						if(this.id === 'email') document.getElementById('error-email').style.display = 'none';
				});
		});
	</script>
</body>
</html>
