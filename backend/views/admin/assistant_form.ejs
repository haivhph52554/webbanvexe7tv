<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= assistant ? 'Sửa phụ xe' : 'Thêm phụ xe mới' %> - Admin</title>
  <style>
    body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:#f5f7fa;color:#333}
    .container{max-width:800px;margin:3rem auto;background:white;padding:2rem;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
    h2{margin-bottom:1.5rem;color:#1e3a8a}
    label{display:block;margin-top:1rem;font-weight:600;color:#374151}
    input[type=text], input[type=email], input[type=tel], input[type=number], input[type=password], select{width:100%;padding:0.75rem;border:1px solid #e5e7eb;border-radius:6px;font-size:0.95rem}
    input:focus, select:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,0.1)}
    .form-group{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .checkbox-group{margin-top:1rem;display:flex;align-items:center;gap:0.5rem}
    .checkbox-group input[type=checkbox]{width:auto}
    .trips-section{margin-top:2rem;padding-top:2rem;border-top:2px solid #e5e7eb}
    .trips-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));gap:0.75rem;margin-top:1rem;max-height:300px;overflow-y:auto;padding:1rem;background:#f9fafb;border-radius:6px}
    .trip-item{display:flex;align-items:center;gap:0.5rem}
    .trip-item input[type=checkbox]{width:auto}
    .actions{margin-top:2rem;display:flex;gap:0.75rem}
    .btn{padding:0.75rem 1.5rem;border-radius:6px;border:none;cursor:pointer;font-weight:600;text-decoration:none;display:inline-block}
    .btn-primary{background:#6366f1;color:white}
    .btn-primary:hover{background:#4f46e5}
    .btn-secondary{background:#e5e7eb;color:#374151}
    .btn-secondary:hover{background:#d1d5db}
    .help-text{font-size:0.875rem;color:#6b7280;margin-top:0.25rem}
  </style>
</head>
<body>
  <div class="container">
    <h2><%= assistant ? 'Sửa thông tin phụ xe' : 'Thêm phụ xe mới' %></h2>
    <form method="post" action="<%= assistant ? ('/admin/assistants/' + assistant._id) : '/admin/assistants' %>">
      
      <div class="form-group">
        <div>
          <label>Họ tên *</label>
          <input type="text" name="name" value="<%= assistant ? assistant.name : '' %>" required />
        </div>
        <div>
          <label>Email *</label>
          <input type="email" name="email" value="<%= assistant ? assistant.email : '' %>" required />
        </div>
      </div>

      <div class="form-group">
        <div>
          <label>Số điện thoại *</label>
          <input type="tel" name="phone" value="<%= assistant ? assistant.phone : '' %>" required />
        </div>
        <div>
          <label>Mã nhân viên</label>
          <input type="text" name="employee_id" value="<%= assistant ? assistant.employee_id : '' %>" placeholder="VD: PX001" />
          <div class="help-text">Mã định danh phụ xe</div>
        </div>
      </div>

      <div class="form-group">
        <div>
          <label>Số giấy phép</label>
          <input type="text" name="license_number" value="<%= assistant ? assistant.license_number : '' %>" placeholder="VD: PX-LN-2024-001" />
        </div>
        <div>
          <label>Số năm kinh nghiệm</label>
          <input type="number" name="experience_years" value="<%= assistant ? assistant.experience_years : 0 %>" min="0" />
        </div>
      </div>

      <div>
        <label>Trạng thái</label>
        <select name="status">
          <option value="active" <%= assistant && assistant.status === 'active' ? 'selected' : '' %>>Đang hoạt động</option>
          <option value="inactive" <%= assistant && assistant.status === 'inactive' ? 'selected' : '' %>>Không hoạt động</option>
        </select>
      </div>

      <% if (routes) { %>
        <div class="trips-section">
          <h3 style="margin-bottom:1rem;color:#1e3a8a">Gán tuyến cho phụ xe</h3>
          <div class="help-text">Chọn các tuyến mà phụ xe này sẽ phụ trách. Phụ xe sẽ check-in hành khách cho tất cả các chuyến thuộc tuyến được chọn.</div>
          <div class="trips-grid">
            <% routes.forEach(function(route) { 
              const isAssigned = assistant && assistant.assigned_routes && assistant.assigned_routes.some(r => {
                const routeId = typeof r === 'object' ? r._id.toString() : r.toString();
                return routeId === route._id.toString();
              });
            %>
              <div class="trip-item">
                <input type="checkbox" name="assigned_routes" value="<%= route._id %>" <%= isAssigned ? 'checked' : '' %> />
                <label style="font-weight:normal;margin:0;cursor:pointer;">
                  <%= (route.origin || route.from_city) + ' → ' + (route.destination || route.to_city) %>
                  <% if (route.distance) { %>
                    <br>
                    <small style="color:#6b7280">
                      Khoảng cách: <%= route.distance %> km
                    </small>
                  <% } %>
                </label>
              </div>
            <% }); %>
          </div>
          <% if (routes.length === 0) { %>
            <p style="color:#6b7280;margin-top:1rem;">Chưa có tuyến nào trong hệ thống</p>
          <% } %>
        </div>
      <% } %>

      <div class="actions">
        <button type="submit" class="btn btn-primary"><%= assistant ? 'Cập nhật' : 'Tạo mới' %></button>
        <a href="/admin/assistants" class="btn btn-secondary">Hủy</a>
      </div>
    </form>
  </div>
</body>
</html>

