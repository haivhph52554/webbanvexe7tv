<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= trip ? 'Sửa chuyến' : 'Thêm chuyến mới' %> - Admin</title>
  <style>
    body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:#f5f7fa;color:#333}
    .container{max-width:900px;margin:3rem auto;background:white;padding:1.5rem;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
    label{display:block;margin-top:0.75rem;font-weight:600}
    input[type=text], input[type=datetime-local], input[type=number], select{width:100%;padding:0.6rem;border:1px solid #e5e7eb;border-radius:6px}
    .actions{margin-top:1rem;display:flex;gap:0.5rem}
    .btn{padding:0.6rem 1rem;border-radius:6px;border:none;cursor:pointer}
    .btn-primary{background:#1e3a8a;color:white}
    .btn-secondary{background:#e5e7eb}
  </style>
</head>
<body>
  <div class="container">
    <h2><%= trip ? 'Sửa thông tin chuyến' : 'Thêm chuyến mới' %></h2>
    <form method="post" action="<%= trip ? ('/admin/trips/' + trip._id) : '/admin/trips' %>">
      <label>Tuyến</label>
      <select name="route" required>
        <% routes.forEach(function(r){ %>
          <option value="<%= r._id %>" <%= trip && trip.route && trip.route.toString()===r._id.toString() ? 'selected' : '' %>><%= r.name %> — <%= r.from_city %> → <%= r.to_city %></option>
        <% }) %>
      </select>

      <label>Xe</label>
      <select name="bus" required>
        <% buses.forEach(function(b){ %>
          <option value="<%= b._id %>" <%= trip && trip.bus && trip.bus.toString()===b._id.toString() ? 'selected' : '' %>><%= b.license_plate %> — <%= b.bus_type %></option>
        <% }) %>
      </select>

      <label>Thời gian bắt đầu</label>
      <input type="datetime-local" name="start_time" required value="<%= trip && trip.start_time ? new Date(trip.start_time).toISOString().slice(0,16) : '' %>" />

      <label>Thời gian kết thúc</label>
      <input type="datetime-local" name="end_time" value="<%= trip && trip.end_time ? new Date(trip.end_time).toISOString().slice(0,16) : '' %>" />

      <label>Giá cơ bản (VND)</label>
      <input type="number" name="base_price" value="<%= trip ? trip.base_price : 0 %>" min="0" required />

      <label>Hướng</label>
      <select name="direction">
        <option value="go" <%= trip && trip.direction==='go' ? 'selected' : '' %>>Đi</option>
        <option value="return" <%= trip && trip.direction==='return' ? 'selected' : '' %>>Về</option>
      </select>

      <label>Trạng thái</label>
      <select name="status">
        <option value="scheduled" <%= trip && trip.status==='scheduled' ? 'selected' : '' %>>Đã lên lịch</option>
        <option value="departed" <%= trip && trip.status==='departed' ? 'selected' : '' %>>Đã khởi hành</option>
        <option value="completed" <%= trip && trip.status==='completed' ? 'selected' : '' %>>Hoàn thành</option>
        <option value="cancelled" <%= trip && trip.status==='cancelled' ? 'selected' : '' %>>Đã hủy</option>
      </select>

      <% if (typeof errors !== 'undefined' && errors) { %>
        <div style="margin-top:0.75rem;padding:0.75rem;border:1px solid #fecaca;background:#fee2e2;color:#991b1b;border-radius:6px"><%= errors %></div>
      <% } %>
      <div class="actions">
        <button type="submit" class="btn btn-primary">Lưu</button>
        <a href="/admin/trips" class="btn btn-secondary">Hủy</a>
      </div>
    </form>

    <hr style="margin:2rem 0;border:none;border-top:1px solid #e5e7eb" />
    <h2>Tạo chuyến cố định theo lịch</h2>
    <form method="post" action="/admin/trips/recurring">
      <label>Tuyến</label>
      <select name="route" required>
        <% routes.forEach(function(r){ %>
          <option value="<%= r._id %>"><%= r.name %> — <%= r.from_city %> → <%= r.to_city %></option>
        <% }) %>
      </select>

      <label>Xe</label>
      <select name="bus" required>
        <% buses.forEach(function(b){ %>
          <option value="<%= b._id %>"><%= b.license_plate %> — <%= b.bus_type %></option>
        <% }) %>
      </select>

      <label>Giá cơ bản (VND)</label>
      <input type="number" name="base_price" value="0" min="0" />

      <label>Hướng</label>
      <select name="direction">
        <option value="go">Đi</option>
        <option value="return">Về</option>
      </select>

      <label>Loại lặp</label>
      <select name="frequency">
        <option value="daily">Hằng ngày</option>
        <option value="weekly">Theo tuần</option>
      </select>

      <label>Ngày bắt đầu</label>
      <input type="date" name="start_date" />

      <label>Ngày kết thúc (mặc định 6 tháng)</label>
      <input type="date" name="end_date" />

      <label>Giờ khởi hành cố định</label>
      <input type="time" name="time_of_day" value="08:00" />

      <label>Thứ trong tuần (khi chọn theo tuần)</label>
      <div style="display:flex;flex-wrap:wrap;gap:0.5rem">
        <label><input type="checkbox" name="days_of_week" value="1" /> Thứ 2</label>
        <label><input type="checkbox" name="days_of_week" value="2" /> Thứ 3</label>
        <label><input type="checkbox" name="days_of_week" value="3" /> Thứ 4</label>
        <label><input type="checkbox" name="days_of_week" value="4" /> Thứ 5</label>
        <label><input type="checkbox" name="days_of_week" value="5" /> Thứ 6</label>
        <label><input type="checkbox" name="days_of_week" value="6" /> Thứ 7</label>
        <label><input type="checkbox" name="days_of_week" value="0" /> Chủ nhật</label>
      </div>

      <div class="actions">
        <button type="submit" class="btn btn-primary">Tạo chuyến cố định</button>
        <a href="/admin/trips" class="btn btn-secondary">Hủy</a>
      </div>
    </form>
  </div>
</body>
</html>
